# **Chapter 2.3: Database Migrations**
**Time to learn:** 50 minutes

---

#### **1. Migrations: Building the Space Station**
**Migrations** in Laravel are a version control system for your database.

Imagine that you:

1. ðŸ—ï¸ Create a blueprint for the station (the `create_planets_table` migration)
2. ðŸš€ Deploy the modules (run the migrations)
3. ðŸ”§ Upgrade the structure (new migrations)
4. âª Can roll back to a previous version (rollback)

> ðŸ’¡ **Important:** Migrations allow a team to work in a coordinated wayâ€”like engineers on different continents building the ISS!

---

#### **2. Running Migrations**
After creating the migration in Chapter 2.2, execute:
```bash
php artisan migrate
```

**Output in the terminal:**
```
Migration table created successfully.
Migrating: 2014_10_12_000000_create_users_table
Migrated:  2014_10_12_000000_create_users_table (25.12ms)
Migrating: 2014_10_12_100000_create_password_reset_tokens_table
Migrated:  2014_10_12_100000_create_password_reset_tokens_table (18.07ms)
Migrating: 2019_08_19_000000_create_failed_jobs_table
Migrated:  2019_08_19_000000_create_failed_jobs_table (21.33ms)
Migrating: 2019_12_14_000001_create_personal_access_tokens_table
Migrated:  2019_12_14_000001_create_personal_access_tokens_table (30.45ms)
Migrating: 2025_08_04_000000_create_planets_table
Migrated:  2025_08_04_000000_create_planets_table (15.67ms)  # Your table!
```

**Checking in pgAdmin 4:**

1. Open the `space_api` database â†’ Schemas â†’ Tables
2. Make sure the following have appeared: - `planets` - `users` - `password_reset_tokens`

---

#### **3. Rolling Back Migrations: Emergency Return**
If you need to correct the structure:
```bash
php artisan migrate:rollback  # Roll back the last batch of migrations
```
```bash
php artisan migrate:reset    # Completely roll back all migrations
```

- ```php artisan migrate:fresh``` â€” **the most useful command in development!** It drops all tables and re-runs all migrations.
- ```php artisan migrate:fresh --seed``` â€” does the same as `fresh`, but also runs seeders immediately after migrating. This is the command for a complete "rebuild" of the database from scratch.


**Usage Scenario:**
```bash
# Step 1: Realized there's an error in the migration. Completely rebuild the database.
php artisan migrate:fresh
# Step 2: Edit the migration file
# Step 3: Rebuild the database again with the corrected migration
php artisan migrate:fresh
```

---

#### **4. Adding New Fields: Upgrading the Station**
**Example:** Let's add an `is_habitable` field.

**Step 1: Create a new migration**
```bash
php artisan make:migration add_is_habitable_to_planets_table
```

**Step 2: Edit the file** `database/migrations/..._add_is_habitable_to_planets_table.php`
```php
<?php
public function up()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->boolean('is_habitable')
              ->default(false);
    });
}

public function down()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->dropColumn('is_habitable');
    });
}
```

**Step 3: Run the update**
```bash
php artisan migrate
```

---

#### **5. Seeding the Database: The First Planets**
We create a **Seeder**â€”a script for generating test data.

**Step 1: Generate the seeder**
```bash
php artisan make:seeder PlanetSeeder
```

**Step 2: Edit** `database/seeders/PlanetSeeder.php`
```php
<?php
use App\Models\Planet; // Import the Planet model - you'll get an error without it!


class PlanetSeeder extends Seeder
{
    public function run()
    {
        Planet::create([
            'name' => 'Earth',
            'description' => 'A blue planet with diverse life',
            'size_km' => 12742,
            'solar_system' => 'Solar System',
            'image_url' => 'https://example.com/earth.jpg',
            'is_habitable' => true
        ]);

        Planet::create([
            'name' => 'Mars',
            'description' => 'The red planet, a target for future colonization',
            'size_km' => 6779,
            'solar_system' => 'Solar System',
            'is_habitable' => false
        ]);
    }
}
```

**Step 3: Register the seeder in** `database/seeders/DatabaseSeeder.php`
```php
<?php
public function run()
{
    $this->call([
        PlanetSeeder::class
    ]);
}
```

**Step 4: Run the seeder**
```bash
php artisan db:seed
```

---

#### **6. Working with PostgreSQL: Specifics**
**Data Type Peculiarities:**

| Feature | PostgreSQL | MySQL | Laravel Comment |
|---|---|---|---|
| **Boolean Type** | `boolean` (true `true`/`false`) | `tinyint(1)` (stores `0`/`1`) | `$table->boolean('...')` works for both |
| **JSON** | `jsonb` (binary, indexable) | `json` (text-based) | `$table->jsonb('...')` - very powerful in PG |
| **Arrays** | `text[]`, `integer[]` (native arrays) | No (emulated via JSON or strings) | `$table->array('...')` (PG exclusive) |
| **Column Order** | Cannot be controlled (`after()` doesn't work) | Can be controlled (`after()`) | Laravel abstracts this, but you need to know the limitation |


**Example of creating an index:**
```php
// In a migration
$table->index('solar_system');
```

---

#### **7. Verifying Data in psql**

You can use any graphical client and select `space_api` to view it.

If using the console:
```bash
psql -U postgres -d space_api
# The terminal may ask for the password you set during the PostgreSQL installation.
```
```sql
SELECT * FROM planets;
```

In either case, the output should be as follows:

 id |  name  | description | size_km |  solar_system   | image_url | is_habitable |
|---|---|---|---|---|---|---|
  1 | Earth  | A blue planet with diverse life   |   12742 | Solar System| ...       | true |
  2 | Mars   | The red planet, a target for future colonization        |    6779 | Solar System| null      | false |


---

#### **Review Quiz**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. The command to run migrations is:</p>
      <label><input type="radio" name="q1" value="a"> a) php artisan migrate:run</label>
      <label><input type="radio" name="q1" value="b"> b) php artisan migrate</label>
      <label><input type="radio" name="q1" value="c"> c) php artisan db:migrate</label>
    </div>
    <div class="question">
      <p>2. How do you roll back the last migration?</p>
      <label><input type="radio" name="q2" value="a"> a) migrate:undo</label>
      <label><input type="radio" name="q2" value="b"> b) migrate:rollback</label>
      <label><input type="radio" name="q2" value="c"> c) migrate:reset</label>
    </div>
    <div class="question">
      <p>3. Seeders are used for:</p>
      <label><input type="radio" name="q3" value="a"> a) Deleting tables</label>
      <label><input type="radio" name="q3" value="b"> b) Populating the DB with test data</label>
      <label><input type="radio" name="q3" value="c"> c) Creating models</label>
    </div>
    <div class="question">
      <p>4. The method for adding a column to an existing table is:</p>
      <label><input type="radio" name="q4" value="a"> a) Schema::addColumn()</label>
      <label><input type="radio" name="q4" value="b"> b) Schema::table()</label>
      <label><input type="radio" name="q4" value="c"> c) Schema::modify()</label>
    </div>
    <div class="question">
      <p>5. Where are seeders registered?</p>
      <label><input type="radio" name="q5" value="a"> a) DatabaseSeeder.php</label>
      <label><input type="radio" name="q5" value="b"> b) .env</label>
      <label><input type="radio" name="q5" value="c"> c) config/database.php</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Check</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Results:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> The correct answer is: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">No answer.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Your score: ${score} out of ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**ðŸš€ Chapter Summary:**

You have mastered "building cosmic infrastructure":

- âœ… Created and ran migrations
- ðŸ”§ Upgraded the table structure
- ðŸŒ Populated the DB with the first planets
- âš™ï¸ Learned to work with PostgreSQL

**Your universe has gained its first worlds!** Now you can move on to creating API interfaces to manage the planets.

> **ðŸ“Œ Checkpoint:**

> 1. Run `php artisan tinker`
> 2. Execute `App\Models\Planet::all()`
> 3. Make sure you see Earth and Mars