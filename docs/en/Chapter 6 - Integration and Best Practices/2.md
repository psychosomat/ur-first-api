# **Chapter 6.2: CORS Settings**
**Study Time:** 30 minutes

---
#### **1. CORS: What It Is and Why It's Needed**

As we've learned, **CORS (Cross-Origin Resource Sharing)** is a browser security policy. It prevents a malicious site `evil-site.com` from making requests to `your-bank.com` on your behalf (using your cookies) and stealing data.

**How it works:**

1.  **Frontend (browser)** from domain `A` wants to get data from domain `B`.
2.  The browser sends a special "preflight" request to domain `B` with the `OPTIONS` method, asking: "Hey, domain `B`, can I, domain `A`, make a `GET` request to you?"
3.  **Backend (server on domain `B`)** must respond with special HTTP headers, for example: `Access-Control-Allow-Origin: A`.
4.  If the server's response allows the request, the browser sends the main `GET` request. If not, it blocks it and issues a CORS error.

> üí° **Space Analogy:**
>
> Before teleporting the captain to a foreign station (sending a `POST` request), the ship (browser) sends a drone (`OPTIONS` request) with the question: "Station, do you accept teleportation from the starship 'Enterprise'?". The station (API) replies: "Yes, reception from 'Enterprise' is authorized" (`Access-Control-Allow-Origin` header). Only then does teleportation begin.

---

#### **2. Configuring CORS in Laravel (Modern Approach for Laravel 11+)**
In Laravel 11+, CORS configuration has become much simpler and does not require publishing the `config/cors.php` file if you need basic settings. Everything is managed through the `.env` file and `bootstrap/app.php`.

**Step 1: Configuration via Environment Variables**

Open your `.env` file. Laravel provides variables by default to manage CORS for the API.

```env
# .env

# ... other variables

# Specify the paths for which CORS will be active.
# 'api/*' is the standard value for all API routes.
CORS_PATHS=api/*

# Specify the allowed origins (domains).
# For development, specify the address of your frontend.
# You can list them separated by commas, without spaces.
CORS_ALLOWED_ORIGINS=http://localhost:5500,http://127.0.0.1:5500

# Other settings (usually can be left as default)
CORS_ALLOWED_METHODS=*
CORS_ALLOWED_HEADERS=*
CORS_EXPOSED_HEADERS=
CORS_MAX_AGE=0
CORS_SUPPORTS_CREDENTIALS=false
```

**Key variables:**

- `CORS_ALLOWED_ORIGINS`: **The most important variable.** Here you list the domains from which requests are allowed. `*` allows everyone, but this is

**extremely insecure for production**.

- `CORS_PATHS`: The paths to which these rules apply. `api/*` means everything that starts with `/api/`.

After changing `.env`, you do **not** need to restart the server if you are using `php artisan serve`. The changes will be picked up automatically.

**Step 2 (Optional): Advanced Configuration in `bootstrap/app.php`**

If you need more complex logic (for example, allowing subdomains with patterns), you will still have to publish the configuration file and configure the middleware. But for 95% of cases, the `.env` file is sufficient.

The `php artisan install:api` command automatically configures the basic CORS middleware for API routes in the `bootstrap/app.php` file. It looks like this:

```php
// bootstrap/app.php
->withMiddleware(function (Middleware $middleware) {
    // This line will already be added by the install:api command
    // It enables CORS handling for all API routes
    $middleware->api(base_path('routes/api.php'));
})
```

Inside `->api()`, Laravel already uses the `HandleCors` middleware, which reads the settings from your `.env`. Everything is simple and out of the box.

> ‚ö†Ô∏è **Important!** Do not use `CORS_ALLOWED_ORIGINS='*'` on a production server if your API is not completely public. This opens up a potential vulnerability. Always list the specific domains of your frontend.

---

#### **3. Configuring CORS in FastAPI**

FastAPI uses the concept of **Middleware** to handle cross-cutting concerns like CORS.

**Step 1: Open the main file of your application**

This is the file where you create an instance of FastAPI (usually `main.py`).

**Step 2: Add `CORSMiddleware`**

FastAPI provides a ready-made middleware for configuring CORS.

```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware # 1. Import the middleware

app = FastAPI(
    title="SpaceAPI",
    description="API for managing planets in the galaxy",
    version="1.0.0"
)

# 2. List of allowed origins
origins = [
    "http://localhost:5500",
    "http://127.0.0.1:5500",
    # In production, this will be the domain of your frontend
    # "https://my-awesome-app.com",
]

# 3. Add the middleware to the application
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # Allow the specified origins
    allow_credentials=True, # Allow cookies (will be needed for authentication)
    allow_methods=["*"],    # Allow all methods (GET, POST, etc.)
    allow_headers=["*"],    # Allow all headers
)

# ... your routers and the rest of the code here
```

**Step 3: Restart the Uvicorn Server**
The Uvicorn server usually reloads automatically when the code changes. If not, restart it manually. Now your FastAPI server will correctly respond to `OPTIONS` requests from the frontend.

---

#### **Reinforcement Quiz**


<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. The request that the browser sends before the main one to check CORS is called:</p>
      <label><input type="radio" name="q1" value="a"> a) CHECK request</label>
      <label><input type="radio" name="q1" value="b"> b) Preflight request</label>
      <label><input type="radio" name="q1" value="c"> c) Handshake request</label>
    </div>
    <div class="question">
      <p>2. In modern Laravel (11+), basic CORS settings are mainly set in:</p>
      <label><input type="radio" name="q2" value="a"> a) The bootstrap/app.php file</label>
      <label><input type="radio" name="q2" value="b"> b) The .env file</label>
      <label><input type="radio" name="q2" value="c"> c) The routes/api.php file</label>
    </div>
    <div class="question">
      <p>3. In FastAPI, to configure CORS, you use:</p>
      <label><input type="radio" name="q3" value="a"> a) The @app.cors() decorator</label>
      <label><input type="radio" name="q3" value="b"> b) The built-in Security class</label>
      <label><input type="radio" name="q3" value="c"> c) Middleware</label>
    </div>
    <div class="question">
      <p>4. Which CORS_ALLOWED_ORIGINS value is the most secure for production?</p>
      <label><input type="radio" name="q4" value="a"> a) CORS_ALLOWED_ORIGINS='*'</label>
      <label><input type="radio" name="q4" value="b"> b) CORS_ALLOWED_ORIGINS=http://my-frontend.com,https://my-frontend.com`</label>
      <label><input type="radio" name="q4" value="c"> c) Do not set this variable</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Check</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Results:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> Correct answer: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">No answer.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Your score: ${score} out of ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Chapter Summary:**

You have become a "diplomat of interstellar communications"! Your APIs can now securely interact with external applications using modern and correct approaches.

- ‚úÖ Understood the mechanism of CORS and preflight requests.
- üîß Configured CORS for Laravel 11+ through the `.env` file.
- ‚öôÔ∏è Configured CORS for FastAPI using `CORSMiddleware`.
- üõ∞Ô∏è Successfully established communication between the frontend and backend.

**The communication bridge is built and secured.** Now you can think about how to let only "authorized personnel" cross this bridge.

> **üìå Check:**
>
> - The main success criterion is the absence of CORS errors in the browser console when requesting data from the frontend.
> - In the "Network" tab of the developer tools, you can see two requests to your API: the first with the `OPTIONS` method (status 200/204) and the second with the `GET` method (status 200). This is a clear demonstration of how CORS works.