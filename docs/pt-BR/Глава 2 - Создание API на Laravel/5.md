```markdown
# **Cap√≠tulo 2.5: Rotas da API**
**Tempo de estudo:** 45 minutos

---
#### **1. O que √© uma rota? Uma explica√ß√£o simples**

Imagine que seu controlador (`PlanetController`) √© um grande centro de escrit√≥rios, e cada um de seus m√©todos (`index`, `store`, `show`) √© um departamento que realiza seu trabalho.

Uma **Rota (Route)** √© uma placa de endere√ßo na entrada do edif√≠cio. Ela diz:

- "Se algu√©m chegou ao endere√ßo `/planets` pelo m√©todo **GET** ‚Äî envie-o para o departamento `index` (mostrar tudo)."
- "Se algu√©m chegou ao endere√ßo `/planets` pelo m√©todo **POST** com uma encomenda (dados) ‚Äî envie-o para o departamento `store` (criar novo)."

Sem rotas, nenhuma requisi√ß√£o do mundo exterior encontrar√° o departamento necess√°rio em seu c√≥digo. O arquivo principal para essas "placas de endere√ßo" na API √© `routes/api.php`.

No Laravel 11+, por padr√£o, n√£o h√° um "livro de endere√ßos da API". N√≥s o criamos executando o comando `php artisan install:api`. Agora temos o arquivo `routes/api.php` ‚Äî este √© o principal centro de controle para todas as rotas da nossa API.

A principal diferen√ßa de `api.php` para `web.php`:

- Prefixo /api: O Laravel adiciona automaticamente `/api` a todas as URLs deste arquivo. A rota `/planets` se torna `/api/planets`.
- "Sem estado" (Stateless): N√£o h√° sess√µes nem cookies aqui, como na web normal. Cada requisi√ß√£o √© independente e deve conter todas as informa√ß√µes de autentica√ß√£o (geralmente um token de API nos cabe√ßalhos).

---

#### **2. Caminho do Iniciante: Criando uma rota manualmente**

Vamos criar uma √∫nica rota manualmente para entender o princ√≠pio. Nosso objetivo √© fazer com que a URL `/api/planets` mostre uma lista de todos os planetas.

Abra `routes/api.php` e escreva:

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\PlanetController; // Indicamos onde est√° nosso controlador

//                    (1)           (2)                     (3)
Route::get(      '/planets',    [PlanetController::class, 'index']     );
//   ^               ^                       ^
// (M√©todo HTTP)   (Endere√ßo URL)          (Qual controlador e m√©todo chamar)
```

**Vamos analisar esta linha em partes:**

1.  `Route::get(...)` ‚Äî dizemos: "Esta rota funciona apenas para **requisi√ß√µes GET**".
2.  `'/planets'` ‚Äî esta √© a URL que o Laravel vai escutar. Considerando o prefixo `/api`, o endere√ßo completo ser√° `http://space-api.test/api/planets`.
3.  `[PlanetController::class, 'index']` ‚Äî este √© o "destino". Dizemos: "Quando a requisi√ß√£o chegar, encontre a classe `PlanetController` e chame o m√©todo `index()` nela".

**Agora est√° tudo conectado!** Requisi√ß√£o -> Rota -> Controlador -> M√©todo.

E se precisarmos obter um planeta pelo seu ID? Por exemplo, `/api/planets/5`.

```php
// Rota para obter um planeta espec√≠fico
Route::get('/planets/{planet}', [PlanetController::class, 'show']);
```

Aqui `{planet}` √© um "modelo" ou vari√°vel. O Laravel entende que neste lugar pode haver qualquer coisa (ID, slug). Ent√£o ele passa esse valor para o m√©todo `show(Planet $planet)`. Essa "m√°gica", onde o Laravel encontra o planeta pelo ID, √© chamada de **Route Model Binding**.

---

#### **3. Caminho do Mestre: `apiResource` ‚Äî uma linha para governar todos**

Criar cada rota manualmente (para `index`, `show`, `store`, `update`, `destroy`) √© cansativo. Os desenvolvedores do Laravel entendem isso, por isso criaram um poderoso auxiliar ‚Äî `apiResource`.

Apague tudo o que escrevemos e substitua por uma √∫nica linha:

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\PlanetController;

Route::apiResource('planets', PlanetController::class);
```

**O que esta √∫nica linha faz por baixo dos panos?** Ela cria automaticamente um conjunto completo de rotas para as opera√ß√µes CRUD padr√£o que j√° implementamos no controlador.

| M√©todo | URL | Encaminha para o m√©todo | Prop√≥sito |
|---|---|---|---|
| **GET** | `/api/planets` | `index()` | Obter lista de todos os planetas |
| **POST** | `/api/planets` | `store()` | Criar novo planeta |
| **GET** | `/api/planets/{planet}`| `show()` | Mostrar um planeta espec√≠fico |
| **PUT/PATCH**| `/api/planets/{planet}`| `update()` | Atualizar um planeta existente |
| **DELETE** | `/api/planets/{planet}`| `destroy()` | Deletar planeta |

Voc√™ pode verificar isso por si mesmo. Execute o comando no terminal:

```bash
php artisan route:list --path=api
```

Voc√™ ver√° uma tabela com todas as rotas criadas. `apiResource` √© seu melhor amigo para economizar tempo ao criar APIs padr√£o.

---

#### **4. Miss√µes especiais e ordem das rotas**

E se precisarmos de uma rota n√£o padr√£o que n√£o est√° no `apiResource`? Por exemplo, obter um planeta aleat√≥rio no endere√ßo `/api/planets/random`.

Vamos adicion√°-la. Mas h√° uma **armadilha mortalmente importante** aqui, na qual 9 em cada 10 iniciantes caem.

**Ordem incorreta (N√ÉO FUNCIONA!):**
```php
Route::apiResource('planets', PlanetController::class);
Route::get('/planets/random', [PlanetController::class, 'random']); // <-- N√ÉO FUNCIONAR√Å
```
**Por qu√™?** O Laravel l√™ as rotas de cima para baixo. Ele ver√° `Route::apiResource`, que criou a rota `GET /planets/{planet}`. Quando voc√™ requisitar `/planets/random`, o Laravel pensar√° que "random" √© o ID do planeta e tentar√° encontrar no banco de dados um planeta com o ID "random" e voc√™ receber√° um erro.

**Ordem correta (FUNCIONA!):**
```php
<?php
use App\Http\Controllers\PlanetController;
use Illuminate\Support\Facades\Route;

// 1. Primeiro declaramos as rotas ESPEC√çFICAS
Route::get('/planets/random', [PlanetController::class, 'random']);

// 2. E s√≥ depois declaramos as rotas GERAIS com vari√°veis
Route::apiResource('planets', PlanetController::class);
```

> #### ‚ö†Ô∏è Importante!
> Para testar a rota api/planets/random, voc√™ precisa adicionar um novo manipulador ao PlanetController:

>```php
><?php
>public function random(Request $request)
>{
>	$planet = Planet::inRandomOrder()->first();
>	return response()->json($planet);
>}
>```

**Regra:** Sempre declare rotas mais espec√≠ficas (como `/random`) **antes** de rotas mais gerais e com par√¢metros (como `/{planet}`).

---

#### **5. Agrupamento: Organizando**

Quando h√° muitas rotas, elas podem e devem ser agrupadas.

**A. Versionamento da API**
Para n√£o quebrar futuras aplica√ß√µes que usam sua API, √© comum adicionar uma vers√£o na URL, por exemplo `/api/v1/...`.

```php
<?php
Route::prefix('v1')->group(function () {
    // Todas as rotas dentro deste grupo receber√£o o prefixo /v1
    // URL final: /api/v1/planets
    Route::get('/planets/random', [PlanetController::class, 'random']);
    Route::apiResource('planets', PlanetController::class);
});
```

**B. Prote√ß√£o de rotas (Middleware)**
Imagine que qualquer um pode ver os planetas, mas criar, atualizar e deletar ‚Äî apenas usu√°rios autorizados.

```php
<?php
// Rotas p√∫blicas, acess√≠veis a todos
Route::get('/planets', [PlanetController::class, 'index']);
Route::get('/planets/{planet}', [PlanetController::class, 'show']);

// Grupo de rotas que requer "passe" (autentica√ß√£o)
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/planets', [PlanetController::class, 'store']);
    Route::put('/planets/{planet}', [PlanetController::class, 'update']);
    Route::delete('/planets/{planet}', [PlanetController::class, 'destroy']);
});
```

Aqui `middleware('auth:sanctum')` √© como um guarda que verifica o "passe" de todos que tentam acessar as rotas dentro do grupo.

---

#### **6. Testando via Postman**

Agora que todas as rotas foram definidas, √© hora de test√°-las.

1.  **Se voc√™ usa o Herd:** Seu site j√° est√° funcionando em um endere√ßo como `http://space-api.test`.
2.  **Se n√£o:** Inicie o servidor local com o comando `php artisan serve`. O endere√ßo ser√° `http://localhost:8000`.

Abra o Postman e envie as requisi√ß√µes:

- `GET http://space-api.test/api/planets`
- `GET http://space-api.test/api/planets/random`
- `POST http://space-api.test/api/planets` (n√£o se esque√ßa de adicionar o corpo da requisi√ß√£o JSON na aba `Body` -> `raw` -> `JSON`).

**Exemplo de requisi√ß√£o POST:**
```json
{
    "name": "Kepler-186f",
    "description": "Primeiro planeta do tamanho da Terra na zona habit√°vel",
    "size_km": 15000,
    "solar_system": "Kepler-186",
    "is_habitable": true
}
```

---

#### **8. Erros comuns de roteamento**

1. **404 N√£o Encontrado**
   - URL incorreta (`/api/planet` em vez de `/api/planets`)
   - Esqueceu `php artisan serve`
2. **405 M√©todo N√£o Permitido**
   - M√©todo HTTP incorreto (por exemplo, GET em vez de POST)
3. **Controlador Ausente**
   - Erro de digita√ß√£o no nome do controlador (`PlanetControler`)
4. **Colis√£o de Nome de Rota**
   - Nomes de rota duplicados

---

#### **Quiz para Fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>
```
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Arquivo para rotas de API no Laravel:</p>
      <label><input type="radio" name="q1" value="a"> a) routes/web.php</label>
      <label><input type="radio" name="q1" value="b"> b) routes/api.php</label>
      <label><input type="radio" name="q1" value="c"> c) routes/console.php</label>
    </div>
    <div class="question">
      <p>2. Prefixo autom√°tico para rotas de API:</p>
      <label><input type="radio" name="q2" value="a"> a) /admin</label>
      <label><input type="radio" name="q2" value="b"> b) /api</label>
      <label><input type="radio" name="q2" value="c"> c) /v1</label>
    </div>
    <div class="question">
      <p>3. M√©todo para criar 5 rotas CRUD:</p>
      <label><input type="radio" name="q3" value="a"> a) Route::api()</label>
      <label><input type="radio" name="q3" value="b"> b) Route::resource()</label>
      <label><input type="radio" name="q3" value="c"> c) Route::apiResource()</label>
    </div>
    <div class="question">
      <p>4. Route::prefix('v1') √© usado para:</p>
      <label><input type="radio" name="q4" value="a"> a) Autentica√ß√£o</label>
      <label><input type="radio" name="q4" value="b"> b) Versionamento da API</label>
      <label><input type="radio" name="q4" value="c"> c) Cache</label>
    </div>
    <div class="question">
      <p>5. Visualiza√ß√£o de todas as rotas:</p>
      <label><input type="radio" name="q5" value="a"> a) php artisan route:list</label>
      <label><input type="radio" name="q5" value="b"> b) php artisan list:routes</label>
      <label><input type="radio" name="q5" value="c"> c) php routes</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumo do Cap√≠tulo:**

Voc√™ construiu as "rotas hiperespaciais" para a API espacial! Agora:

- üó∫Ô∏è Todos os endpoints est√£o acess√≠veis via `/api/...`
- üîó Rotas de recurso est√£o conectadas ao controlador
- üõ°Ô∏è Rotas personalizadas para opera√ß√µes especiais foram adicionadas
- ‚úÖ Rotas testadas via Postman

**O universo est√° aberto para requisi√ß√µes!** A seguir, adicionaremos prote√ß√£o contra "lixo espacial" ‚Äî a valida√ß√£o de dados.

> **üìå Verifica√ß√£o:**

> 1. Execute `php artisan route:list`
> 2. Certifique-se de ver 5+ rotas para planets
> 3. Verifique o funcionamento de GET /api/planets no navegador/Postman

> **‚ö†Ô∏è Se erro 404:**

> - Verifique a exist√™ncia de `Route::apiResource` em `routes/api.php`
> - Certifique-se de que o servidor est√° em execu√ß√£o (`php artisan serve`)
> - Para Windows: permita a porta 8000 no firewall