# **Cap√≠tulo 6.1: Conectando o FastAPI ao Frontend**
**Tempo de estudo:** 30 minutos

---

#### **1. Retorno ao "hipermotor": Compara√ß√£o de Protocolos**
No cap√≠tulo anterior, acoplamos nosso MCC (frontend) √† "ISS" (Laravel API). Agora, retornaremos ao nosso **ca√ßa superluminal** (FastAPI) e realizaremos a mesma opera√ß√£o.

O objetivo deste cap√≠tulo n√£o √© apenas repetir as a√ß√µes, mas **comparar duas abordagens**. √â como se a mesma nave Dragon se acoplasse primeiro √† ISS e depois √† esta√ß√£o chinesa "Tiangong". O mecanismo de acoplagem √© o mesmo (REST), mas podem existir nuances nos procedimentos e na localiza√ß√£o das portas.

> üí° **Analogia Espacial:**

> O processo √© o mesmo: aproximar-se, alinhar-se, acoplar-se. Mas para a "ISS" era necess√°rio usar a porta `/api/planets`, e para a "Tiangong", a porta `/spaceships`. Nosso operador no MCC deve conhecer esses detalhes para que a miss√£o seja bem-sucedida.

---

#### **2. Preparando o "ca√ßa" (FastAPI) para o acoplamento**

J√° fizemos isso no Cap√≠tulo 4.2, mas vamos garantir que tudo esteja no lugar.

**Passo 1: Iniciando o servidor FastAPI**

1.  Pare o servidor Laravel, se estiver em execu√ß√£o (para evitar conflito de portas).
2.  Abra o terminal na pasta do seu projeto FastAPI.
3.  Ative o ambiente virtual:

    - **Windows:** `.\venv\Scripts\Activate.ps1`
    - **macOS / Linux:** `source venv/bin/activate`

4.  Inicie o servidor:
    ```bash
    uvicorn main:app --reload
    ```
    O servidor estar√° dispon√≠vel em `http://127.0.0.1:8000`.

**Passo 2: Verificando as configura√ß√µes CORS em `main.py`**

Certifique-se de que seu projeto FastAPI possui o `CORSMiddleware` configurado, que adicionamos anteriormente. Ele deve permitir requisi√ß√µes do endere√ßo do seu frontend.
```python
# main.py
from fastapi.middleware.cors import CORSMiddleware

# ...

origins = [
    "http://127.0.0.1:5500", # Endere√ßo do Live Server
    "null", # Para file:///
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ...
```
Se tudo estiver no lugar, seu servidor FastAPI est√° completamente pronto.

---

#### **3. Reconfigurando a "antena" do MCC de volta para o FastAPI**

Agora, o mais interessante ‚Äî as mudan√ßas m√≠nimas que precisamos fazer em nosso JavaScript para que ele funcione novamente com o FastAPI.

**Passo 1: Alterando a URL base**

Abra `api.js` e retorne `API_BASE_URL` ao seu valor original.
```javascript
// api.js

// Especificamos a URL da nossa API FastAPI
const API_BASE_URL = 'http://127.0.0.1:8000'; // <-- Sem /api!

// ... o restante do c√≥digo apiRequest ...
```

**Passo 2: Adapta√ß√£o √† estrutura de resposta do FastAPI**

Lembre-se que nosso `GET /spaceships` no FastAPI retorna um **array simples**, e n√£o um objeto com pagina√ß√£o. Isso significa que precisamos reverter o c√≥digo de `fetchAndDisplayFleet` para sua forma original.

**Altere a fun√ß√£o `fetchAndDisplayFleet` em `app.js`:**
```javascript
// app.js

async function fetchAndDisplayFleet() {
    try {
        fleetListContainer.innerHTML = '<p>Carregando telemetria do FastAPI...</p>';
        const ships = await apiRequest('/spaceships'); // <-- Requisi√ß√£o para /spaceships

        // No FastAPI, temos um array simples, ent√£o a chave .data n√£o √© necess√°ria!

        fleetListContainer.innerHTML = '';
        if (ships.length === 0) {
            fleetListContainer.innerHTML = '<p>N√£o h√° naves registradas.</p>';
            return;
        }

        ships.forEach(ship => {
            // Revertendo para nossa fun√ß√£o original para criar cart√µes
            const card = createShipCard(ship);
            fleetListContainer.appendChild(card);
        });
    } catch (error) {
        fleetListContainer.innerHTML = `<p style="color: #ff6b6b;">Erro ao carregar a frota: ${error.message}</p>`;
    }
}

// Fun√ß√£o original para criar cart√µes de naves
function createShipCard(ship) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <h3>${ship.name} (ID: ${ship.id})</h3>
        <p>Tipo: ${ship.type}</p>
        <p>Ano de Lan√ßamento: ${ship.launch_year}</p>
        <p>Status: ${ship.status}</p>
        <div class="card-actions">
            <button class="edit-btn" data-ship-id="${ship.id}">Editar</button>
            <button class="delete-btn" data-ship-id="${ship.id}">Desativar</button>
        </div>
    `;
    return card;
}
```

**Passo 3: Verifica√ß√£o das opera√ß√µes CRUD**

Como nossos modelos Pydantic no FastAPI e os campos no formul√°rio HTML coincidem (`name`, `type`, `launch_year`, `status`), as fun√ß√µes `handleSaveShip` e `handleDeleteShip` devem funcionar **sem altera√ß√µes**, pois j√° est√£o direcionadas para o endpoint `/spaceships`.

---

#### **4. Conclus√µes da compara√ß√£o: O que isso significa para o desenvolvedor frontend?**

- **Universalidade do REST:** Voc√™ viu claramente que, para o frontend, n√£o importa em qual tecnologia o backend foi escrito (PHP/Laravel ou Python/FastAPI), desde que ele siga os princ√≠pios REST.
- **Import√¢ncia da documenta√ß√£o:** As principais diferen√ßas estavam nas **URLs dos endpoints** e na **estrutura das respostas JSON**. √â exatamente isso que deve ser descrito na documenta√ß√£o da API. Sem ela, o desenvolvedor frontend trabalhar√° "√†s cegas".
- **Flexibilidade do frontend:** Seu c√≥digo JavaScript deve ser flex√≠vel o suficiente para se adaptar facilmente a diferentes formatos de dados (por exemplo, verificar se existe uma chave `data`, ou se √© apenas um array).

**Conclus√£o:** A habilidade de trabalhar com a API REST √© uma **chave universal** que abre portas para a intera√ß√£o com qualquer backend moderno.

---

#### **Quiz para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. A principal diferen√ßa na URL entre nossa API Laravel e a API FastAPI foi em...</p>
      <label><input type="radio" name="q1" value="a"> a) No uso de portas diferentes</label>
      <label><input type="radio" name="q1" value="b"> b) Na presen√ßa do prefixo `/api` no Laravel</label>
      <label><input type="radio" name="q1" value="c"> c) No uso de HTTPS pelo FastAPI</label>
    </div>
    <div class="question">
      <p>2. Qual foi a principal mudan√ßa no c√≥digo JS necess√°ria ao alternar da resposta paginada do Laravel para um array simples do FastAPI?</p>
      <label><input type="radio" name="q2" value="a"> a) Parar de acessar `responseData.data` e usar `responseData` diretamente</label>
      <label><input type="radio" name="q2" value="b"> b) Usar outro m√©todo `fetch`</label>
      <label><input type="radio" name="q2" value="c"> c) Alterar o `Content-Type` nos cabe√ßalhos</label>
    </div>
    <div class="question">
      <p>3. Este experimento prova que, para o desenvolvedor frontend...</p>
      <label><input type="radio" name="q3" value="a"> a) √â importante conhecer tanto PHP quanto Python</label>
      <label><input type="radio" name="q3" value="b"> b) √â importante entender os princ√≠pios REST e saber ler a documenta√ß√£o da API</label>
      <label><input type="radio" name="q3" value="c"> c) Laravel e FastAPI s√£o absolutamente id√™nticos</label>
    </div>
    <div class="question">
      <p>4. A configura√ß√£o do CORS √© uma tarefa...</p>
      <label><input type="radio" name="q4" value="a"> a) Do desenvolvedor frontend</label>
      <label><input type="radio" name="q4" value="b"> b) Do administrador de sistemas</label>
      <label><input type="radio" name="q4" value="c"> c) Do desenvolvedor backend</label>
    </div>
    <div class="question">
      <p>5. Se o FastAPI usasse pagina√ß√£o, como no Laravel, o que ter√≠amos que fazer no frontend?</p>
      <label><input type="radio" name="q5" value="a"> a) Nada, o c√≥digo funcionaria sozinho</label>
      <label><input type="radio" name="q5" value="b"> b) Mudar a l√≥gica novamente para extrair o array da chave `data` (ou similar)</label>
      <label><input type="radio" name="q5" value="c"> c) Mudar de `fetch` para a biblioteca Axios</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'b', q4: 'c', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;
</script>
```javascript
      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumo do Cap√≠tulo:**

Voc√™ conseguiu alternar os "protocolos de comunica√ß√£o" do seu Centro de Controle de Miss√£o (CCM) e comparar na pr√°tica o trabalho com dois sistemas de backend diferentes.

- ‚úÖ Voc√™ consolidou a habilidade de configurar `API_BASE_URL` para alternar entre servidores.
- ‚úÖ Voc√™ entendeu a import√¢ncia da estrutura da resposta (`data` vs array simples) e como adaptar o frontend a ela.
- ‚úÖ Voc√™ percebeu que um bom desenvolvedor frontend deve estar preparado para trabalhar com qualquer API RESTful, estudando cuidadosamente sua documenta√ß√£o.

**Habilidade de conex√£o universal adquirida!** Agora que sabemos como configurar a comunica√ß√£o b√°sica, √© hora de falar sobre protocolos mais complexos ‚Äî CORS, autentica√ß√£o e seguran√ßa.

> **üìå Verifica√ß√£o:**

> - Certifique-se de que seu servidor FastAPI esteja rodando.
> - Certifique-se de ter retornado `API_BASE_URL` e a l√≥gica de tratamento de resposta em `app.js` para a variante do FastAPI.
> - Verifique se seu frontend est√° novamente executando corretamente todas as opera√ß√µes CRUD com o backend FastAPI.

> **‚ö†Ô∏è Em caso de erros:**

> - **CORS error:** Certifique-se de que o servidor FastAPI esteja rodando com as configura√ß√µes CORS corretas.
> - **Erro `Cannot read properties of undefined (reading 'length')`:** Possivelmente, voc√™ esqueceu de remover a chamada a `.data` de `responseData`.
> - **404 Not Found:** Verifique `API_BASE_URL` ‚Äî o FastAPI n√£o tem o prefixo `/api`.
```