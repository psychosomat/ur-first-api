# **Cap√≠tulo 6.5: Fundamentos de Seguran√ßa da API**
**Tempo de estudo:** 45 minutos

---

#### **1. Seguran√ßa da API: Defesa Multin√≠vel da Esta√ß√£o**

Imagine que sua esta√ß√£o espacial (API) est√° em um setor hostil do espa√ßo. Um √∫nico campo de for√ßa (autentica√ß√£o) n√£o √© suficiente. Voc√™ precisa de um sistema de defesa abrangente:

- **Escudos (HTTPS):** Criptografia de todo o tr√°fego.
- **Sensores de Anomalias (Rate Limiting):** Prote√ß√£o contra solicita√ß√µes excessivamente frequentes.
- **Compartimentos Internos (Autoriza√ß√£o):** Separa√ß√£o de direitos de acesso.
- **Verifica√ß√£o de Cargas (Valida√ß√£o):** N√£o confiar em nenhum dado de entrada.
- **Cofre Secreto (Vari√°veis de Ambiente):** Armazenamento seguro de chaves.

Vamos configurar cada um desses n√≠veis.

---

#### **2. Escudos: Sempre use HTTPS**

**O que √©?** HTTPS (HyperText Transfer Protocol Secure) √© uma vers√£o do protocolo HTTP que criptografa todos os dados entre o cliente e o servidor. Sem ele, qualquer pessoa que esteja "escutando" a rede (por exemplo, em um Wi-Fi p√∫blico) pode interceptar logins, senhas e tokens.

**Como implementar?**

- **Em produ√ß√£o ‚Äî obrigat√≥rio.** Ao implantar sua API em um servidor real (Heroku, DigitalOcean, etc.), configure o servidor web (Nginx, Apache) para trabalhar com um certificado SSL. Servi√ßos como o **Let's Encrypt** fornecem certificados gratuitos.
- **No desenvolvimento local** √© menos cr√≠tico, mas ferramentas como **Laravel Herd** ou **mkcert** permitem configurar facilmente o HTTPS local.

> üí° **Regra n¬∫1 em seguran√ßa da API:** **Sem HTTPS ‚Äî sem seguran√ßa.**

---

#### **3. Sensores de Anomalias: Limita√ß√£o de Frequ√™ncia de Requisi√ß√µes (Rate Limiting)**

**O que √©?** Prote√ß√£o contra **ataques de for√ßa bruta** (quando um invasor tenta adivinhar uma senha enviando milhares de solicita√ß√µes por segundo) e contra **ataques DoS** (quando o servidor √© "sobrecarregado" com solicita√ß√µes para que pare de responder). O Rate Limiting limita o n√∫mero de solicita√ß√µes que um usu√°rio (ou endere√ßo IP) pode fazer em um determinado per√≠odo de tempo.

**Como implementar?**

- **No Laravel:** O Middleware de limita√ß√£o j√° est√° integrado!
  Abra `app/Http/Kernel.php` e veja a chave `middlewareGroups['api']`. L√° voc√™ j√° encontrar√° `'throttle:api'`. As configura√ß√µes dessa limita√ß√£o est√£o em `app/Providers/RouteServiceProvider.php` no m√©todo `configureRateLimiting()`.
  ```php
  // app/Providers/RouteServiceProvider.php
  protected function configureRateLimiting()
  {
      RateLimiter::for('api', function (Request $request) {
          return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
      });
  }
  ```
  Isso significa: 60 requisi√ß√µes por minuto por usu√°rio (se autenticado) ou por endere√ßo IP.

- **No FastAPI:** √â usado um pacote de terceiros, por exemplo, **`slowapi`**.

  1.  Instala√ß√£o: `pip install slowapi`
  2.  Integra√ß√£o em `main.py`:
      ```python
      # main.py
      from slowapi import Limiter, _rate_limit_exceeded_handler
      from slowapi.util import get_remote_address
      from slowapi.errors import RateLimitExceeded

      limiter = Limiter(key_func=get_remote_address)
      app = FastAPI(...)

      # Conecta o manipulador de erros e o pr√≥prio limitador
      app.state.limiter = limiter
      app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

      # Aplica a um endpoint espec√≠fico
      @router.get("/planets")
      @limiter.limit("5/minute") # 5 requisi√ß√µes por minuto
      def get_planets(request: Request):
          # ...
      ```

---

#### **4. Compartimentos Internos: Autoriza√ß√£o (n√£o confundir com autentica√ß√£o!)**

**O que √©?**

- **Autentica√ß√£o** responde √† pergunta "Quem √© voc√™?".
- **Autoriza√ß√£o** responde √† pergunta "O que voc√™ tem permiss√£o para fazer?".

Por exemplo, um usu√°rio comum pode visualizar planetas, mas apenas um usu√°rio com a fun√ß√£o de "administrador" pode exclu√≠-los.

**Como implementar?**

- **No Laravel:** S√£o utilizadas **Policies** (Pol√≠ticas) ou **Gates** (Port√µes).

  1.  Criamos uma pol√≠tica: `php artisan make:policy PlanetPolicy --model=Planet`
  2.  Descrevemos as regras em `app/Policies/PlanetPolicy.php`:
      ```php
      class PlanetPolicy
      {
          // Permitir a exclus√£o apenas para usu√°rios com a fun√ß√£o 'admin'
          public function delete(User $user, Planet $planet): bool
          {
              return $user->role === 'admin';
          }
      }
      ```
  3.  Aplicamos a pol√≠tica no controlador `PlanetController.php`:
      ```php
      public function destroy(Planet $planet)
      {
          // Verifica se o usu√°rio atual tem permiss√£o para excluir
          $this->authorize('delete', $planet);

          $planet->delete();
          return response()->json(null, 204);
      }
      ```

- **No FastAPI:** A l√≥gica de autoriza√ß√£o geralmente √© escrita manualmente dentro dos endpoints, usando informa√ß√µes do usu√°rio obtidas do token.

  ```python
  # (assumimos que o token cont√©m um campo 'roles')
  def get_current_active_user(token: str = Depends(oauth2_scheme)):
      # ... decodificamos o token e obtemos o usu√°rio com as fun√ß√µes do DB
      # user = get_user_from_db(username)
      return user # retorna o objeto do usu√°rio

  @router.delete("/planets/{planet_id}")
  def delete_planet(
      planet_id: int,
      current_user: User = Depends(get_current_active_user)
  ):
      if "admin" not in current_user.roles:
          raise HTTPException(
              status_code=status.HTTP_403_FORBIDDEN,
              detail="Permiss√µes insuficientes para executar esta opera√ß√£o",
          )
      # ... l√≥gica de exclus√£o ...
  ```

---

#### **5. Verifica√ß√£o de Cargas e Cofre Secreto: Valida√ß√£o e Vari√°veis de Ambiente**

Estes dois pontos j√° implementamos, mas √© importante destacar seu papel na seguran√ßa.

- **Nunca confie em dados de entrada (Valida√ß√£o):**

  - Usamos `$request->validate()` no Laravel e modelos Pydantic no FastAPI. Isso nos protege de **inje√ß√µes SQL** (ao usar Eloquent/SQLAlchemy) e dados incorretos que podem quebrar a aplica√ß√£o. **Sempre valide tudo o que vem de fora!**

- **Armazene segredos em `.env` (Vari√°veis de Ambiente):**

  - Chaves de banco de dados, chaves secretas para JWT (`SECRET_KEY`), chaves de servi√ßos de terceiros ‚Äî tudo isso **nunca** deve ir para o sistema de controle de vers√£o (Git). Para isso, existem os arquivos `.env`, que s√£o adicionados ao `.gitignore`.

---

#### **Question√°rio para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Para proteger contra a intercepta√ß√£o de dados em redes p√∫blicas, utiliza-se:</p>
      <label><input type="radio" name="q1" value="a"> a) Rate Limiting</label>
      <label><input type="radio" name="q1" value="b"> b) HTTPS</label>
      <label><input type="radio" name="q1" value="c"> c) CORS</label>
    </div>
    <div class="question">
      <p>2. A limita√ß√£o de frequ√™ncia de requisi√ß√µes (Rate Limiting) protege principalmente contra:</p>
      <label><input type="radio" name="q2" value="a"> a) Inje√ß√µes SQL</label>
      <label><input type="radio" name="q2" value="b"> b) Ataques de for√ßa bruta e DoS</label>
      <label><input type="radio" name="q2" value="c"> c) Cross-site scripting (XSS)</label>
    </div>
    <div class="question">
      <p>3. A pergunta "O que este usu√°rio tem permiss√£o para fazer?" √© resolvida por:</p>
      <label><input type="radio" name="q3" value="a"> a) Autentica√ß√£o</label>
      <label><input type="radio" name="q3" value="b"> b) Autoriza√ß√£o</label>
      <label><input type="radio" name="q3" value="c"> c) Valida√ß√£o</label>
    </div>
    <div class="question">
      <p>4. Chaves secretas da API e senhas de BD devem ser armazenadas:</p>
      <label><input type="radio" name="q4" value="a"> a) Direto no c√≥digo para conveni√™ncia</label>
      <label><input type="radio" name="q4" value="b"> b) Em um reposit√≥rio p√∫blico no GitHub</label>
      <label><input type="radio" name="q4" value="c"> c) Em um arquivo `.env`, que √© exclu√≠do do Git</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'c' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

</script>
if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Conclus√£o do Curso**
**Parab√©ns, comandante! Voc√™ concluiu com sucesso todas as miss√µes.**

Voc√™ percorreu o caminho de um novato que apenas ouviu falar de APIs para um engenheiro capaz de projetar, desenvolver, documentar, proteger e testar de forma independente um servi√ßo web completo usando as duas tecnologias mais populares em seus ecossistemas.

Voc√™ dominou a linguagem universal REST, aprendeu Laravel e FastAPI e construiu um "Centro de Controle de Voo" para eles em JavaScript puro.

**Esta √© uma conquista enorme.** O mundo do desenvolvimento de APIs est√° agora aberto para voc√™. Continue a explorar, aprender e construir coisas incr√≠veis.

**Fim da comunica√ß√£o.** üöÄ
---
<h2>‚òÑ Apoie a miss√£o</h2>
<p>Criar este tutorial √© um voo longo e complexo que exige muito tempo e energia. Se o material foi √∫til para voc√™, pode ajudar a reabastecer os tanques de combust√≠vel da nossa expedi√ß√£o.
Cada apoio √© mais uma √≥rbita em dire√ß√£o a novos materiais √∫teis.</p>
<a href='https://ko-fi.com/K3K41JFJ32' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi4.png?v=6' border='0' alt='Compre-me um caf√© em ko-fi.com' /></a>