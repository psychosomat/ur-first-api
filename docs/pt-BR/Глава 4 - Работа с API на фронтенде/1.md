# **Cap√≠tulo 4.1: Fundamentos da Fetch API**
**Tempo de estudo:** 45 minutos

---

#### **1. Fetch API: A "Antena Principal" do C.O.P.**
Imagine que em seu Centro de Opera√ß√µes de Voo (C.O.P.) h√° uma **enorme antena de r√°dio** para se comunicar com as espa√ßonaves. Voc√™ pode sintoniz√°-la na frequ√™ncia certa, enviar um comando e esperar uma resposta.

A **Fetch API** √© uma "antena embutida" semelhante nos navegadores modernos. √â uma interface JavaScript padr√£o para fazer requisi√ß√µes HTTP a servidores. Ela permite:

- üì° Enviar "comandos" (GET, POST, PUT, DELETE) para nossa API.
- üõ∞Ô∏è Receber "telemetria" (dados JSON) do servidor.
- ‚öôÔ∏è Trabalhar assincronamente, sem "congelar" a interface do usu√°rio enquanto aguarda uma resposta.

> üí° **Analogia espacial:**

> `fetch()` √© o comando "Antena, estabelecer comunica√ß√£o!". Voc√™ a alimenta com:

> - **Coordenadas do alvo** (URL da nossa API).
> - **Tipo de comando** (m√©todo: GET, POST).
> - **Conte√∫do do comando** (corpo da requisi√ß√£o, cabe√ßalhos).

> Em resposta, voc√™ n√£o recebe os dados em si, mas uma **promessa (Promise)** de que os dados chegar√£o.

---

#### **2. Assincronicidade: Comunica√ß√£o em velocidades de luz**
A comunica√ß√£o com uma nave espacial distante leva tempo. Voc√™ n√£o pode simplesmente parar todo o trabalho do C.O.P. e esperar a resposta. Voc√™ envia um comando e **continua trabalhando**, e quando a resposta chega, o sistema o notifica.

Isso √© a **assincronicidade**. O JavaScript n√£o bloqueia a execu√ß√£o do restante do c√≥digo enquanto espera uma resposta do servidor. Para gerenciar esse processo, a Fetch API usa **Promises**.

Uma **Promise** √© um "recibo" de que voc√™ enviou uma requisi√ß√£o. Ela tem tr√™s estados:

- **`pending` (pendente):** O sinal ainda est√° a caminho.
- **`fulfilled` (cumprida):** A resposta foi recebida com sucesso!
- **`rejected` (rejeitada):** Ocorreu um erro (por exemplo, sem conex√£o).

---

#### **3. Primeira requisi√ß√£o: Descobrir onde est√° a ISS**
Vamos enviar nossa primeira requisi√ß√£o usando `fetch`. Usaremos um arquivo HTML simples e tags `<script>`.

**Passo 1: Criar `index.html`**
Crie um arquivo `index.html` em uma nova pasta (por exemplo, `frontend_fleet_control`).
```html
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>C.O.P. - Fetch API</title>
</head>
<body>
    <h1>Status de comunica√ß√£o com a ISS</h1>
    <div id="iss-status">Aguardando dados...</div>

    <script>
        // Nosso c√≥digo JavaScript estar√° aqui
    </script>
</body>
</html>
```

**Passo 2: Escrever c√≥digo com `fetch`**
Dentro da tag `<script>`, adicionaremos nossa primeira requisi√ß√£o `fetch` para a API p√∫blica Open Notify.
```javascript
// index.html -> <script>

const issApiUrl = 'http://api.open-notify.org/iss-now.json';
const statusDiv = document.getElementById('iss-status');

console.log('Enviando solicita√ß√£o para obter as coordenadas da ISS...');

fetch(issApiUrl)
    .then(response => {
        // O primeiro .then() lida com a pr√≥pria resposta HTTP
        console.log('Resposta recebida do servidor!', response);
        // Convertemos o corpo da resposta em JSON, isso tamb√©m √© uma opera√ß√£o ass√≠ncrona
        return response.json();
    })
    .then(data => {
        // O segundo .then() recebe os dados JSON j√° parseados
        console.log('Dados convertidos para JSON com sucesso!', data);
        const position = data.iss_position;
        statusDiv.innerHTML = `A ISS est√° atualmente aqui:
                               <strong>Latitude:</strong> ${position.latitude},
                               <strong>Longitude:</strong> ${position.longitude}`;
    })
    .catch(error => {
        // .catch() ser√° ativado se ocorrer um erro de rede
        console.error('Erro de comunica√ß√£o com a ISS!', error);
        statusDiv.textContent = 'N√£o foi poss√≠vel obter os dados. Verifique a conex√£o.';
    });
```

- **`fetch(url)`:** Envia uma requisi√ß√£o GET. Retorna uma Promise.
- **`.then(callback)`:** Executado quando a Promise √© resolvida com sucesso (`fulfilled`). O primeiro `.then` recebe um objeto `Response`.
- **`response.json()`:** M√©todo que l√™ o corpo da resposta e o analisa como JSON. Ele tamb√©m retorna uma Promise!
- **`.catch(callback)`:** Executado se a Promise for rejeitada (`rejected`), por exemplo, devido a um erro de rede.

**Passo 3: Abrir no navegador**
Basta abrir o arquivo `index.html` em seu navegador. Voc√™ deve ver "Aguardando dados..." ser substitu√≠do pelas coordenadas atuais da ISS. Abra o console do desenvolvedor (F12) para ver os logs.

---

#### **4. "E se...": Tratamento de erros do servidor**
E se solicitarmos uma URL inexistente?
`fetch('http://api.open-notify.org/non-existent-endpoint')`

O `fetch` √© constru√≠do de tal forma que `.catch()` s√≥ ser√° ativado em **erros de rede** (sem internet, DNS n√£o encontrado). No entanto, respostas com c√≥digos `404` ou `500` para o `fetch` s√£o uma **resposta recebida com sucesso**! Simplesmente cont√©m um c√≥digo de erro.

**Maneira correta de verificar:**
```javascript
fetch('http://api.open-notify.org/non-existent-endpoint')
    .then(response => {
        // Verificamos a propriedade .ok, que √© true para status 200-299
        if (!response.ok) {
            // Se a resposta n√£o for "OK", criamos nosso pr√≥prio erro para cair no .catch()
            throw new Error(`Erro HTTP! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(data);
    })
    .catch(error => {
        console.error('Ocorreu um erro ao executar a solicita√ß√£o:', error);
    });
```

- `response.ok`: Este √© o seu principal indicador de sucesso.
- `throw new Error()`: "Falhamos" manualmente a cadeia de Promises para cair no bloco `.catch`.

---

#### **Quiz para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. A Fetch API √©...</p>
      <label><input type="radio" name="q1" value="a"> a) Uma biblioteca externa que precisa ser baixada</label>
      <label><input type="radio" name="q1" value="b"> b) Uma interface integrada ao navegador para requisi√ß√µes HTTP</label>
      <label><input type="radio" name="q1" value="c"> c) Uma linguagem de programa√ß√£o para trabalhar com a rede</label>
    </div>
    <div class="question">
      <p>2. O que a chamada `fetch(url)` retorna?</p>
      <label><input type="radio" name="q2" value="a"> a) Imediatamente dados JSON</label>
      <label><input type="radio" name="q2" value="b"> b) Um objeto `Promise` (promessa)</label>
      <label><input type="radio" name="q2" value="c"> c) Uma p√°gina HTML</label>
    </div>
    <div class="question">
      <p>3. O m√©todo `.then()` em uma cadeia de promises √© chamado quando...</p>
      <label><input type="radio" name="q3" value="a"> a) Ocorre um erro de rede</label>
      <label><input type="radio" name="q3" value="b"> b) A requisi√ß√£o √© conclu√≠da com sucesso</label>
      <label><input type="radio" name="q3" value="c"> c) O usu√°rio fecha a aba</label>
    </div>
    <div class="question">
      <p>4. O m√©todo `response.json()` √© usado para...</p>
      <label><input type="radio" name="q4" value="a"> a) Converter o corpo da resposta em um objeto JavaScript</label>
      <label><input type="radio" name="q4" value="b"> b) Verificar se a resposta √© um JSON v√°lido</label>
      <label><input type="radio" name="q4" value="c"> c) Enviar dados para o servidor no formato JSON</label>
    </div>
    <div class="question">
      <p>5. Como verificar corretamente se o servidor n√£o retornou um erro (por exemplo, 404)?</p>
      <label><input type="radio" name="q5" value="a"> a) Verificar a propriedade `response.ok`</label>
      <label><input type="radio" name="q5" value="b"> b) Verificar se o bloco `.catch()` ser√° ativado</label>
      <label><input type="radio" name="q5" value="c"> c) Verificar se `response.status` √© igual a "OK"</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'a', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';
    
    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

```
if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumo do Cap√≠tulo:**

Voc√™ configurou a "antena principal" do seu MCC e aprendeu a enviar requisi√ß√µes e receber respostas.

- üì° Voc√™ dominou a sintaxe b√°sica de `fetch()`.
- üõ∞Ô∏è Entendeu o que s√£o **Promises** e como trabalhar com `.then()` e `.catch()`.
- ‚öôÔ∏è Aprendeu a processar corretamente as respostas do servidor, verificando `response.ok`.

**Conex√£o estabelecida!** No pr√≥ximo cap√≠tulo, conectaremos nosso MCC √† API da frota espacial que criamos no FastAPI, e aprenderemos a obter e exibir a lista de nossas naves.

> **üìå Verifica√ß√£o:**

> - Certifique-se de que seu arquivo `index.html` exibe corretamente as coordenadas da ISS.
> - Tente quebrar intencionalmente a URL e veja no console do desenvolvedor qual erro ser√° exibido.

> **‚ö†Ô∏è Se o c√≥digo n√£o funcionar:**

> - **Erro CORS:** Se voc√™ tentar fazer uma requisi√ß√£o para sua API local do FastAPI (por exemplo, `http://127.0.0.1:8000`) a partir de um arquivo aberto como `file:///...`, o navegador bloquear√° a requisi√ß√£o devido √† pol√≠tica de seguran√ßa CORS. Resolveremos este problema no pr√≥ximo cap√≠tulo. Por enquanto, estamos usando APIs p√∫blicas que permitem isso.
> - **HTTP/HTTPS:** `http://api.open-notify.org` funciona via HTTP. Alguns navegadores podem avisar sobre isso. Se voc√™ estiver trabalhando em um site HTTPS, as requisi√ß√µes para recursos HTTP podem ser bloqueadas.