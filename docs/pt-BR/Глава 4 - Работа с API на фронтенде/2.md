# **Cap√≠tulo 4.2: Envio de Requisi√ß√µes GET**
**Tempo de estudo:** 45 minutos

---

#### **1. GET: Requisi√ß√£o de Telemetria da Frota Espacial**
**Uma requisi√ß√£o GET** √© o comando principal para obter dados. Em nosso Centro de Controle de Miss√£o (CCM), isso √© equivalente √† pergunta: "Centro de Controle da Frota, relate a situa√ß√£o!"

Usaremos `fetch` para enviar dois tipos de requisi√ß√µes GET ao nosso servidor FastAPI:

1.  **Obten√ß√£o de toda a cole√ß√£o:** "Mostre-me toda a minha frota".
2.  **Obten√ß√£o de um √∫nico recurso:** "Forne√ßa informa√ß√µes detalhadas sobre a nave com ID 2".

> üí° **Analogia espacial:**

> `GET /spaceships` ‚Äî √© uma requisi√ß√£o de broadcast para toda a frota solicitando seus indicativos de chamada.

> `GET /spaceships/3` ‚Äî √© uma requisi√ß√£o direcionada a uma nave espec√≠fica (ISS) solicitando a transmiss√£o de dados completos de seus sistemas.

---

#### **2. Problema CORS: "Interfer√™ncia Interplanet√°ria"**
Antes de enviarmos a requisi√ß√£o, precisamos resolver um problema importante. Por padr√£o, por raz√µes de seguran√ßa, os navegadores impedem que uma p√°gina web (nosso CCM), carregada de um "dom√≠nio" (`file:///...` ou `http://localhost:5500`), fa√ßa requisi√ß√µes a uma API em outro "dom√≠nio" (`http://127.0.0.1:8000`).

Essa pol√≠tica √© chamada de **CORS (Compartilhamento de Recursos de Origem Cruzada)**.

Para permitir que nosso frontend se comunique com o backend, √© preciso configurar o servidor FastAPI para que ele diga ao navegador: "Est√° tudo bem, confio nas requisi√ß√µes deste endere√ßo".

**Passo 1: Instalar `python-multipart`**
Isso √© necess√°rio para o funcionamento correto do middleware.
```bash
pip install python-multipart
```

**Passo 2: Configurar CORS em `main.py`**
Abra seu arquivo `main.py` do projeto FastAPI e adicione o seguinte c√≥digo:
```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware  # <-- Importamos o middleware

# ... seu restante do c√≥digo (modelos, db_spaceships) ...

app = FastAPI(
    title="Fleet Management API",
    # ...
)

# --- CONFIGURA√á√ÉO CORS ---
# Indicamos quais "dom√≠nios" (origens) podem enviar requisi√ß√µes
origins = [
    "http://localhost",
    "http://localhost:8080",
    "http://127.0.0.1:5500",  # Endere√ßo para Live Server no VS Code
    "null"  # Para requisi√ß√µes de arquivos locais file:///
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # Permite as origens especificadas
    allow_credentials=True,
    allow_methods=["*"],  # Permite todos os m√©todos (GET, POST, etc.)
    allow_headers=["*"],  # Permite todos os cabe√ßalhos
)

# --- SEUS ENDPOINTS ABAIXO ---
@app.get("/")
# ...
```
Agora nosso servidor API est√° pronto para aceitar requisi√ß√µes do frontend. **Reinicie o `uvicorn`** para que as altera√ß√µes entrem em vigor!

---

#### **3. Obtendo a lista de todas as naves**
Criaremos uma interface para exibir nossa frota.

**Passo 1: Atualizar `index.html`**
```html
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>CCM - Gerenciamento de Frota</title>
    <style>
        body { font-family: sans-serif; }
        .ship-list { list-style: none; padding: 0; }
        .ship-list li { border: 1px solid #ccc; margin-bottom: 10px; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Painel de Controle da Frota Espacial</h1>

    <button id="load-fleet-btn">Requisitar dados da frota</button>

    <h2>Lista de aparelhos:</h2>
    <ul id="fleet-list" class="ship-list">
        <li>Aguardando comando...</li>
    </ul>

    <script src="app.js"></script> <!-- Conectando script externo -->
</body>
</html>
```

**Passo 2: Criar `app.js`**
Ao lado de `index.html`, crie o arquivo `app.js`. Nele, extrairemos toda a l√≥gica.
```javascript
// app.js

const API_BASE_URL = 'http://127.0.0.1:8000'; // URL do nosso servidor FastAPI

const loadFleetBtn = document.getElementById('load-fleet-btn');
const fleetList = document.getElementById('fleet-list');

// Fun√ß√£o para carregar e exibir a frota
async function fetchAndDisplayFleet() {
    try {
        fleetList.innerHTML = '<li>Carregando telemetria...</li>';

        // Enviando requisi√ß√£o GET para /spaceships
        const response = await fetch(`${API_BASE_URL}/spaceships`);

        if (!response.ok) {
            throw new Error(`Erro de rede: ${response.status}`);
        }

        const ships = await response.json(); // Obtemos o array de naves

        // Limpamos a lista e exibimos os dados
        fleetList.innerHTML = '';
        if (ships.length === 0) {
            fleetList.innerHTML = '<li>Nenhum aparelho encontrado no registro.</li>';
            return;
        }

        ships.forEach(ship => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <strong>${ship.name} (ID: ${ship.id})</strong><br>
                Tipo: ${ship.type}<br>
                Ano de lan√ßamento: ${ship.launch_year}<br>
                Status: ${ship.status}
            `;
            fleetList.appendChild(listItem);
        });

    } catch (error) {
        console.error('N√£o foi poss√≠vel carregar os dados da frota:', error);
        fleetList.innerHTML = `<li>Erro: ${error.message}</li>`;
    }
}

// Adiciona o manipulador de evento ao bot√£o
loadFleetBtn.addEventListener('click', fetchAndDisplayFleet);
```

- **async/await:** Usamos uma nova e mais conveniente sintaxe para trabalhar com Promises. Abordaremos isso em detalhes no Cap√≠tulo 4.5. Por enquanto, saiba apenas que `await` "espera" a execu√ß√£o de uma Promise sem bloquear a p√°gina.
- `try...catch`: Uma excelente maneira de lidar com erros em fun√ß√µes `async`.

**Passo 3: Testar**
Abra `index.html` no navegador (preferencialmente via extens√£o Live Server no VS Code, que o executar√° em `http://127.0.0.1:5500`). Clique no bot√£o "Requisitar dados da frota". A lista das suas naves do FastAPI dever√° aparecer na p√°gina!

---

#### **4. Obtendo dados de uma √∫nica nave**
Agora adicionaremos um formul√°rio para requisitar informa√ß√µes por um ID espec√≠fico.

**Passo 1: Adicionar formul√°rio em `index.html`**
```html
<!-- index.html, ap√≥s a lista -->
<hr>
<h2>Requisi√ß√£o por ID</h2>
<form id="ship-form">
    <input type="number" id="ship-id-input" placeholder="Digite o ID do aparelho" required>
    <button type="submit">Encontrar aparelho</button>
</form>
<div id="ship-details" class="ship-list"></div>
```

**Passo 2: Adicionar l√≥gica em `app.js`**
```javascript
// app.js, no final do arquivo

const shipForm = document.getElementById('ship-form');
const shipIdInput = document.getElementById('ship-id-input');
const shipDetails = document.getElementById('ship-details');

async function fetchShipById(event) {
    event.preventDefault(); // Impede o recarregamento da p√°gina
    const shipId = shipIdInput.value;

    if (!shipId) {
        alert('Por favor, insira o ID.');
        return;
    }

    try {
        shipDetails.innerHTML = '<li>Buscando aparelho...</li>';

        // Enviando requisi√ß√£o GET para /spaceships/{id}
        const response = await fetch(`${API_BASE_URL}/spaceships/${shipId}`);

        if (response.status === 404) {
             throw new Error('Aparelho com este ID n√£o encontrado no registro.');
        }
        if (!response.ok) {
            throw new Error(`Erro de rede: ${response.status}`);
        }

        const ship = await response.json();

        shipDetails.innerHTML = `
            <li>
                <strong>${ship.name} (ID: ${ship.id})</strong><br>
                Tipo: ${ship.type}<br>
                Ano de lan√ßamento: ${ship.launch_year}<br>
                Status: ${ship.status}
            </li>
        `;
    } catch (error) {
        console.error(`Erro ao buscar aparelho ${shipId}:`, error);
        shipDetails.innerHTML = `<li>Erro: ${error.message}</li>`;
    }
}

shipForm.addEventListener('submit', fetchShipById);
```

- Adicionamos um tratamento separado para o status `404` para fornecer ao usu√°rio uma mensagem de erro mais clara.

**Passo 3: Testar**
Atualize a p√°gina, insira o ID de uma nave existente (por exemplo, 1) e clique em "Encontrar aparelho". Voc√™ dever√° ver seus dados. Tente inserir um ID inexistente (por exemplo, 99) ‚Äî voc√™ ver√° uma mensagem de erro.

---

#### **Quiz para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. A pol√≠tica CORS no navegador √© necess√°ria para...</p>
      <label><input type="radio" name="q1" value="a"> a) Acelerar o carregamento de p√°ginas</label>
      <label><input type="radio" name="q1" value="b"> b) Proteger contra requisi√ß√µes cross-site maliciosas</label>
      <label><input type="radio" name="q1" value="c"> c) Compactar dados JSON</label>
    </div>
    <div class="question">
      <p>2. Para permitir que o frontend em `localhost:5500` acesse o FastAPI, √© preciso...</p>
      <label><input type="radio" name="q2" value="a"> a) Configurar `CORSMiddleware` no FastAPI</label>
      <label><input type="radio" name="q2" value="b"> b) Alterar as configura√ß√µes do navegador</label>
      <label><input type="radio" name="q2" value="c"> c) Nada √© preciso, isso funciona por padr√£o</label>
    </div>
    <div class="question">
      <p>3. Para obter dados de um recurso espec√≠fico com ID=5, a URL da requisi√ß√£o ser√° assim:</p>
      <label><input type="radio" name="q3" value="a"> a) `/resources?id=5`</label>
      <label><input type="radio" name="q3" value="b"> b) `/resources/5`</label>
      <label><input type="radio" name="q3" value="c"> c) `/get/resources/5`</label>
    </div>
    <div class="question">
      <p>4. A palavra-chave `await` em JavaScript pode ser usada apenas dentro de uma fun√ß√£o declarada com...</p>
      <label><input type="radio" name="q4" value="a"> a) `function`</label>
      <label><input type="radio" name="q4" value="b"> b) `promise`</label>
      <label><input type="radio" name="q4" value="c"> c) `async`</label>
    </div>
    <div class="question">
      <p>5. `event.preventDefault()` no manipulador de envio do formul√°rio √© necess√°rio para...</p>
      <label><input type="radio" name="q5" value="a"> a) Prevenir o comportamento padr√£o do navegador (recarregamento da p√°gina)</label>
      <label><input type="radio" name="q5" value="b"> b) Parar a execu√ß√£o do script</label>
      <label><input type="radio" name="q5" value="c"> c) Cancelar o envio da requisi√ß√£o</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'b', q4: 'c', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ Resumo do Cap√≠tulo:**

Voc√™ configurou com sucesso o canal de comunica√ß√£o entre a "Terra" e o "espa√ßo" e aprendeu a solicitar telemetria!

- üõ°Ô∏è Voc√™ resolveu o problema de "interfer√™ncia interplanet√°ria" configurando o **CORS** em seu servidor FastAPI.
- üõ∞Ô∏è Implementou a fun√ß√£o para obter e exibir a **lista completa** de espa√ßonaves.
- üî≠ Criou uma interface para solicitar dados sobre uma **nave espec√≠fica** pelo seu ID.

**O MCC est√° recebendo dados!** No pr√≥ximo cap√≠tulo, passaremos para a√ß√µes ativas: enviaremos comandos para criar, atualizar e excluir nossas naves espaciais.

> **üìå Verifica√ß√£o:**

> - Certifique-se de que seu servidor FastAPI esteja rodando com o `CORSMiddleware` configurado.
> - Verifique se, ao clicar no bot√£o "Solicitar dados", uma lista de naves aparece na p√°gina.
> - Certifique-se de que o formul√°rio de busca por ID encontra corretamente as naves existentes e reporta um erro para as n√£o existentes.

> **‚ö†Ô∏è Se houver erros:**

> - **Erro de CORS no console do navegador:** Ou voc√™ n√£o reiniciou o `uvicorn` ap√≥s adicionar o `CORSMiddleware`, ou o endere√ßo do seu frontend (por exemplo, `http://127.0.0.1:5500`) n√£o foi adicionado √† lista de `origins`.
> - **Failed to fetch:** Verifique se seu servidor FastAPI est√° rodando e acess√≠vel no endere√ßo especificado em `API_BASE_URL`.