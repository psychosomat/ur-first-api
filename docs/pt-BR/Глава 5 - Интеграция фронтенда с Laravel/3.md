# **Cap√≠tulo 5.3: Incorporando JavaScript em Laravel Views**
**Tempo de estudo:** 50 minutos

---

### **1. Duas abordagens para JavaScript na Web**
At√© agora, trabalhamos com **Server-Side Rendering (SSR)** ‚Äî o servidor (Laravel) gerava o HTML pronto (via Blade) e o enviava para o navegador. Isso √© excelente para SEO e carregamento r√°pido da primeira p√°gina.

Agora adicionaremos **Client-Side Interactions** ‚Äî o navegador, ap√≥s carregar a p√°gina, executar√° c√≥digo JavaScript para:

-   Enviar requisi√ß√µes √† nossa API sem recarregar a p√°gina.
-   Atualizar dinamicamente partes da p√°gina (por exemplo, adicionando um novo planeta √† lista).
-   Exibir notifica√ß√µes e janelas modais.

> üí° **Analogia Espacial:**

> Imagine que **SSR** √© receber um mapa completo do sistema estelar, impresso no Centro de Controle de Miss√µes (servidor). Voc√™ v√™ todos os objetos no momento da impress√£o.

> **Client-Side JS** √© o seu tablet pessoal (navegador), que se comunica em tempo real com os sat√©lites (API) e atualiza a posi√ß√£o dos objetos no seu mapa, sem solicitar um novo mapa em papel do CCM.

---

### **2. Onde armazenar e como incluir o c√≥digo JS**
Como j√° descobrimos, todos os ativos p√∫blicos (CSS, JS, imagens) devem estar na pasta `public`.

**Estrutura Correta:**

1.  **Arquivos Originais:** Todo o seu c√≥digo JS principal deve estar em `public/js/`. Por exemplo, `public/js/planets.js`.
2.  **Inclus√£o no Blade:** Use o helper `asset()` para gerar o URL correto.

**Exemplo de inclus√£o no layout `layouts/app.blade.php`:**
```blade
<!DOCTYPE html>
<html>
<head>
    {{-- ... --}}
</head>
<body>
    {{-- ... header e main ... --}}

    <footer>
        <p>&copy; {{ date('Y') }} Space Command.</p>
    </footer>

    {{-- Scripts s√£o melhores para incluir no final do body para acelerar a renderiza√ß√£o da p√°gina --}}
    <script src="{{ asset('js/planets.js') }}"></script>
    @stack('scripts') {{-- Criamos um "slot" para scripts de uma p√°gina espec√≠fica --}}
</body>
</html>
```

-   `@stack('scripts')` ‚Äî esta √© uma diretiva Blade poderosa. Ela permite que as views filhas "empurrem" seu pr√≥prio c√≥digo JS para este local. Isso √© √∫til quando uma p√°gina precisa de um script exclusivo e outra n√£o.

---

### **3. Exemplo: Bot√£o "Excluir" com confirma√ß√£o**
Vamos adicionar √† p√°gina de lista de planetas (`planets/index.blade.php`) um bot√£o "Excluir" para cada planeta, que funcionar√° via JavaScript e Fetch API.

**Passo 1: Adicione o bot√£o em `resources/views/planets/index.blade.php`**

Modifique o cart√£o do planeta, adicionando um bot√£o com data-atributos:
```html
{{-- ... dentro do ciclo @forelse ... --}}
<div class="planet-card" id="planet-card-{{ $planet->id }}">
    <h3>{{ $planet->name }}</h3>
    <p>Sistema Solar: {{ $planet->solar_system }}</p>
    <p>Di√¢metro: {{ number_format($planet->size_km, 0, '.', ' ') }} km</p>
    <a href="/planets/{{ $planet->id }}">Saber mais &rarr;</a>
    <button class="delete-btn" data-id="{{ $planet->id }}" data-url="/api/planets/{{ $planet->id }}">
        Descomissionar
    </button>
</div>
<!-- ... Antes da tag de fechamento do body ... -->
<script src="{{ asset('js/planets.js') }}" defer></script>
```

-   `id="planet-card-{{ $planet->id }}"` ‚Äî ID √∫nico para o cart√£o inteiro, para que possamos remov√™-lo do DOM.
-   `data-id` e `data-url` ‚Äî uma maneira conveniente de passar dados do PHP (Blade) para o JavaScript.

**Passo 2: Escreva a l√≥gica JavaScript**

Crie o arquivo `public/js/planets.js` e adicione o seguinte c√≥digo:
```javascript
document.addEventListener('DOMContentLoaded', () => {
    // Encontra todos os bot√µes "Excluir"
    const deleteButtons = document.querySelectorAll('.delete-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const planetId = event.target.dataset.id;
            const apiUrl = event.target.dataset.url;

            if (!confirm(`Tem certeza de que deseja descomissionar o planeta com ID ${planetId}? Esta a√ß√£o √© irrevers√≠vel.`)) {
                return; // O usu√°rio clicou em "Cancelar"
            }

            try {
                // Envia uma requisi√ß√£o DELETE para nossa API
                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        // Mais tarde adicionaremos o token CSRF aqui
                    }
                });

                if (response.status === 204) { // 204 No Content - exclus√£o bem-sucedida
                    // Remove o cart√£o do planeta da p√°gina
                    const cardToRemove = document.getElementById(`planet-card-${planetId}`);
                    if (cardToRemove) {
                        cardToRemove.remove();
                    }
                    alert('Planeta descomissionado com sucesso.');
                } else {
                    // Se a API retornou um erro
                    const errorData = await response.json();
                    alert(`Erro: ${errorData.message || 'N√£o foi poss√≠vel descomissionar o planeta.'}`);
                }
            } catch (error) {
                console.error('Erro ao enviar a requisi√ß√£o:', error);
                alert('Ocorreu um erro de rede. Tente novamente.');
            }
        });
    });
});
```

Agora, se voc√™ atualizar a p√°gina `/planets`, aparecer√£o os bot√µes "Descomissionar", e ao clicar neles, nosso c√≥digo JavaScript ser√° executado!

---

### **4. Passando dados de Blade para JavaScript**
√Äs vezes √© necess√°rio passar para o JS n√£o apenas uma string, mas um array ou objeto inteiro.

**Maneira incorreta (vulner√°vel):**
```javascript
let planets = {{ $planets }}; // Isso levar√° a um erro de sintaxe e √© inseguro
```

**Maneira correta (via JSON):**
Use a diretiva `@json`. Ela converte com seguran√ßa um array/objeto PHP em um objeto JSON v√°lido.

**Exemplo em `planets/index.blade.php`:**
```blade
@extends('layouts.app')
{{-- ... --}}
@section('content')
    {{-- ... --}}
@endsection

@push('scripts') {{-- "Empurra" nosso script para o slot @stack('scripts') no layout --}}
<script>
    // Laravel converte com seguran√ßa a cole√ß√£o $planets em um array JSON
    const planetsData = @json($planets);

    // Agora podemos trabalhar com este array em JS
    console.log('Dados dos planetas passados do Blade:', planetsData);
    alert(`Carregados ${planetsData.length} planetas!`);
</script>
@endpush
```

-   `@push('scripts')` insere o conte√∫do dentro de `@stack('scripts')` em `layouts/app.blade.php`. Isso permite adicionar scripts apenas nas p√°ginas onde eles s√£o realmente necess√°rios.

---

### **Quiz para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Onde os arquivos JS e CSS p√∫blicos devem ser armazenados em um projeto Laravel?</p>
      <label><input type="radio" name="q1" value="a"> a) resources/js</label>
      <label><input type="radio" name="q1" value="b"> b) storage/app/public</label>
      <label><input type="radio" name="q1" value="c"> c) public/</label>
    </div>
    <div class="question">
      <p>2. Qual helper do Blade √© usado para a gera√ß√£o correta de URLs para ativos (JS, CSS)?</p>
      <label><input type="radio" name="q2" value="a"> a) url()</label>
      <label><input type="radio" name="q2" value="b"> b) asset()</label>
      <label><input type="radio" name="q2" value="c"> c) public_path()</label>
    </div>
    <div class="question">
      <p>3. O que o par de diretivas `@push('scripts')` / `@stack('scripts')` faz?</p>
      <label><input type="radio" name="q3" value="a"> a) Permite que uma view filha adicione seu c√≥digo JS em um local espec√≠fico no layout pai</label>
      <label><input type="radio" name="q3" value="b"> b) Combina todos os arquivos JS em um s√≥</label>
      <label><input type="radio" name="q3" value="c"> c) Envia o c√≥digo JS para o servidor</label>
    </div>
    <div class="question">
      <p>4. Como passar com seguran√ßa um array PHP `$data` para JavaScript do Blade?</p>
      <label><input type="radio" name="q4" value="a"> a) let jsData = {{ $data }};</label>
      <label><input type="radio" name="q4" value="b"> b) let jsData = '@php echo json_encode($data); @endphp';</label>
      <label><input type="radio" name="q4" value="c"> c) let jsData = @json($data);</label>
    </div>
    <div class="question">
      <p>5. Por que √© recomendado incluir scripts JS no final da tag body?</p>
      <label><input type="radio" name="q5" value="a"> a) Para que n√£o bloqueiem a renderiza√ß√£o do conte√∫do HTML principal da p√°gina</label>
      <label><input type="radio" name="q5" value="b"> b) √â um requisito do padr√£o HTML5</label>
      <label><input type="radio" name="q5" value="c"> c) Assim os scripts s√£o executados mais rapidamente</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'a', q4: 'c', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';
```
for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumo do cap√≠tulo:**

Voc√™ aprendeu a dar vida a p√°ginas Blade est√°ticas, adicionando l√≥gica do lado do cliente. Habilidades essenciais:

-   Organiza√ß√£o e conex√£o corretas de arquivos JS em um projeto Laravel.
-   Uso de atributos `data-*` para transferir dados de HTML para JS.
-   Intera√ß√£o din√¢mica com API usando Fetch sem recarregar a p√°gina.
-   Transfer√™ncia segura de vari√°veis PHP para JavaScript usando a diretiva `@json`.
-   Organiza√ß√£o de scripts usando `@push` e `@stack`.

**Seus "pain√©is de controle" tornaram-se interativos.** No entanto, nossas requisi√ß√µes de modifica√ß√£o (POST, PUT, DELETE) est√£o vulner√°veis agora. No pr√≥ximo cap√≠tulo, adicionaremos um mecanismo de prote√ß√£o crucial ‚Äî tokens CSRF.