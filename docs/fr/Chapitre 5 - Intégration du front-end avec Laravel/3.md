# **Chapitre 5.3 : Int√©gration de JavaScript dans les vues Laravel**
**Temps d'√©tude :** 50 minutes

---

### **1. Deux approches de JavaScript sur le web**
Jusqu'√† pr√©sent, nous avons travaill√© avec le **Server-Side Rendering (SSR)** ‚Äî le serveur (Laravel) g√©n√©rait le HTML pr√™t (via Blade) et l'envoyait au navigateur. C'est excellent pour le SEO et un premier chargement rapide.

Maintenant, nous allons ajouter des **Client-Side Interactions** ‚Äî le navigateur, une fois la page charg√©e, ex√©cutera du code JavaScript pour :

-   Envoyer des requ√™tes √† notre API sans recharger la page.
-   Mettre √† jour dynamiquement des parties de la page (par exemple, ajouter une nouvelle plan√®te √† la liste).
-   Afficher des notifications et des fen√™tres modales.

> üí° **Analogie spatiale :**

> Imaginez que le **SSR** est l'obtention d'une carte compl√®te d'un syst√®me stellaire, imprim√©e au centre de contr√¥le (serveur). Vous voyez tous les objets au moment de l'impression.

> Le **Client-Side JS** est votre tablette personnelle (navigateur) qui se connecte en temps r√©el aux satellites (API) et met √† jour la position des objets sur votre carte, sans demander une nouvelle carte papier au centre de contr√¥le.

---

### **2. O√π stocker et comment inclure le code JS**
Comme nous l'avons d√©j√† √©tabli, tous les actifs publics (CSS, JS, images) doivent se trouver dans le dossier `public`.

**Structure correcte :**

1.  **Fichiers source :** Tout votre code JS principal doit se trouver dans `public/js/`. Par exemple, `public/js/planets.js`.
2.  **Inclusion dans Blade :** Utilisez l'aideur `asset()` pour g√©n√©rer l'URL correcte.

**Exemple d'inclusion dans le gabarit `layouts/app.blade.php` :**
```blade
<!DOCTYPE html>
<html>
<head>
    {{-- ... --}}
</head>
<body>
    {{-- ... header et main ... --}}

    <footer>
        <p>&copy; {{ date('Y') }} Space Command.</p>
    </footer>

    {{-- Il est pr√©f√©rable d'inclure les scripts √† la fin du corps pour acc√©l√©rer le rendu de la page --}}
    <script src="{{ asset('js/planets.js') }}"></script>
    @stack('scripts') {{-- Nous cr√©ons un "slot" pour les scripts d'une page sp√©cifique --}}
</body>
</html>
```

-   `@stack('scripts')` est une directive Blade puissante. Elle permet aux vues enfants de "pousser" leur propre code JS √† cet endroit. C'est utile lorsqu'une page n√©cessite un script unique et qu'une autre non.

---

### **3. Exemple : Bouton "Supprimer" avec confirmation**
Ajoutons un bouton "Supprimer" pour chaque plan√®te sur la page de liste des plan√®tes (`planets/index.blade.php`), qui fonctionnera via JavaScript et l'API Fetch.

**√âtape 1 : Ajout du bouton dans `resources/views/planets/index.blade.php`**

Modifiez la carte de la plan√®te en ajoutant un bouton avec des attributs data :
```html
{{-- ... √† l'int√©rieur de la boucle @forelse ... --}}
<div class="planet-card" id="planet-card-{{ $planet->id }}">
    <h3>{{ $planet->name }}</h3>
    <p>Syst√®me solaire : {{ $planet->solar_system }}</p>
    <p>Diam√®tre : {{ number_format($planet->size_km, 0, '.', ' ') }} km</p>
    <a href="/planets/{{ $planet->id }}">En savoir plus &rarr;</a>
    <button class="delete-btn" data-id="{{ $planet->id }}" data-url="/api/planets/{{ $planet->id }}">
        D√©saffecter
    </button>
</div>
<!-- ... Avant la balise de fermeture body ... -->
<script src="{{ asset('js/planets.js') }}" defer></script>
```

-   `id="planet-card-{{ $planet->id }}"` ‚Äî ID unique pour toute la carte, afin que nous puissions la supprimer du DOM.
-   `data-id` et `data-url` ‚Äî un moyen pratique de transmettre des donn√©es de PHP (Blade) √† JavaScript.

**√âtape 2 : √âcriture de la logique JavaScript**

Cr√©ez le fichier `public/js/planets.js` et ajoutez-y le code suivant :
```javascript
document.addEventListener('DOMContentLoaded', () => {
    // Trouver tous les boutons "Supprimer"
    const deleteButtons = document.querySelectorAll('.delete-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const planetId = event.target.dataset.id;
            const apiUrl = event.target.dataset.url;

            if (!confirm(`√ätes-vous s√ªr de vouloir d√©saffecter la plan√®te avec l'ID ${planetId} ? Cette action est irr√©versible.`)) {
                return; // L'utilisateur a cliqu√© sur "Annuler"
            }

            try {
                // Envoyer une requ√™te DELETE √† notre API
                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        // Plus tard, nous ajouterons le jeton CSRF ici
                    }
                });

                if (response.status === 204) { // 204 No Content - suppression r√©ussie
                    // Supprimer la carte de la plan√®te de la page
                    const cardToRemove = document.getElementById(`planet-card-${planetId}`);
                    if (cardToRemove) {
                        cardToRemove.remove();
                    }
                    alert('La plan√®te a √©t√© d√©saffect√©e avec succ√®s.');
                } else {
                    // Si l'API a renvoy√© une erreur
                    const errorData = await response.json();
                    alert(`Erreur : ${errorData.message || 'Impossible de supprimer la plan√®te.'}`);
                }
            } catch (error) {
                console.error('Erreur lors de l\'envoi de la requ√™te :', error);
                alert('Une erreur r√©seau est survenue. Veuillez r√©essayer.');
            }
        });
    });
});
```

Maintenant, si vous rafra√Æchissez la page `/planets`, vous verrez les boutons "D√©saffecter", et en cliquant dessus, notre code JavaScript se d√©clenchera !

---

### **4. Transmission de donn√©es de Blade vers JavaScript**
Parfois, il est n√©cessaire de transmettre √† JS non pas une simple cha√Æne de caract√®res, mais un tableau ou un objet entier.

**M√©thode incorrecte (vuln√©rable) :**
```javascript
let planets = {{ $planets }}; // Cela entra√Ænera une erreur de syntaxe et est dangereux.
```

**M√©thode correcte (via JSON) :**
Utilisez la directive `@json`. Elle convertit en toute s√©curit√© un tableau/objet PHP en un objet JSON valide.

**Exemple dans `planets/index.blade.php` :**
```blade
@extends('layouts.app')
{{-- ... --}}
@section('content')
    {{-- ... --}}
@endsection

@push('scripts') {{-- Nous "poussons" notre script dans le slot @stack('scripts') du gabarit --}}
<script>
    // Laravel convertit en toute s√©curit√© la collection $planets en un tableau JSON
    const planetsData = @json($planets);

    // Maintenant, nous pouvons travailler avec ce tableau en JS
    console.log('Donn√©es sur les plan√®tes transmises depuis Blade :', planetsData);
    alert(`${planetsData.length} plan√®tes charg√©es !`);
</script>
@endpush
```

-   `@push('scripts')` place le contenu √† l'int√©rieur de `@stack('scripts')` dans `layouts/app.blade.php`. Cela permet d'ajouter des scripts uniquement aux pages o√π ils sont r√©ellement n√©cessaires.

---

### **Quiz de consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. O√π les fichiers JS et CSS publics doivent-ils √™tre stock√©s dans un projet Laravel ?</p>
      <label><input type="radio" name="q1" value="a"> a) resources/js</label>
      <label><input type="radio" name="q1" value="b"> b) storage/app/public</label>
      <label><input type="radio" name="q1" value="c"> c) public/</label>
    </div>
    <div class="question">
      <p>2. Quel aideur Blade est utilis√© pour g√©n√©rer correctement l'URL des actifs (JS, CSS) ?</p>
      <label><input type="radio" name="q2" value="a"> a) url()</label>
      <label><input type="radio" name="q2" value="b"> b) asset()</label>
      <label><input type="radio" name="q2" value="c"> c) public_path()</label>
    </div>
    <div class="question">
      <p>3. Que fait la paire de directives `@push('scripts')` / `@stack('scripts')` ?</p>
      <label><input type="radio" name="q3" value="a"> a) Permet √† une vue enfant d'ajouter son code JS √† un endroit sp√©cifique du gabarit parent</label>
      <label><input type="radio" name="q3" value="b"> b) Fusionne tous les fichiers JS en un seul</label>
      <label><input type="radio" name="q3" value="c"> c) Envoie le code JS au serveur</label>
    </div>
    <div class="question">
      <p>4. Comment transmettre en toute s√©curit√© un tableau PHP `$data` √† JavaScript depuis Blade ?</p>
      <label><input type="radio" name="q4" value="a"> a) let jsData = {{ $data }};</label>
      <label><input type="radio" name="q4" value="b"> b) let jsData = '@php echo json_encode($data); @endphp';</label>
      <label><input type="radio" name="q4" value="c"> c) let jsData = @json($data);</label>
    </div>
    <div class="question">
      <p>5. Pourquoi est-il recommand√© d'inclure les scripts JS √† la fin de la balise body ?</p>
      <label><input type="radio" name="q5" value="a"> a) Pour qu'ils ne bloquent pas le rendu du contenu HTML principal de la page</label>
      <label><input type="radio" name="q5" value="b"> b) C'est une exigence de la norme HTML5</label>
      <label><input type="radio" name="q5" value="c"> c) Ainsi, les scripts s'ex√©cutent plus rapidement</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'a', q4: 'c', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:red;">Incorrect.</span> Bonne r√©ponse : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre score : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Conclusion du chapitre :**

Vous avez appris √† donner vie aux pages Blade statiques en ajoutant de la logique c√¥t√© client. Comp√©tences cl√©s :

-   Organisation et inclusion correctes des fichiers JS dans un projet Laravel.
-   Utilisation des attributs `data-*` pour transmettre des donn√©es de HTML √† JS.
-   Interaction dynamique avec l'API via Fetch sans rechargement de page.
-   Transmission s√©curis√©e des variables PHP √† JavaScript √† l'aide de la directive `@json`.
-   Organisation des scripts avec `@push` et `@stack`.
**Vos "panneaux de contr√¥le" sont devenus interactifs.** Cependant, nos requ√™tes de modification (POST, PUT, DELETE) sont d√©sormais vuln√©rables. Dans le chapitre suivant, nous ajouterons un m√©canisme de protection crucial : les jetons CSRF.