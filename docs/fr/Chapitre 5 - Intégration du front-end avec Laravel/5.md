# **Chapitre 5.5 : Routage pour les pages web**
**Temps d'√©tude :** 40 minutes

---

### **1. `routes/web.php` vs `routes/api.php` : Deux panneaux de contr√¥le diff√©rents**

Il est important de bien comprendre la diff√©rence fondamentale :

| Caract√©ristique         | `routes/web.php` (Panneau web)                              | `routes/api.php` (Panneau API)                                 |
| ----------------------- | ----------------------------------------------------------- | -------------------------------------------------------------- |
| **T√¢che principale**    | Affichage de pages HTML, traitement de formulaires          | Fourniture de donn√©es au format JSON pour d'autres applications |
| **√âtat (State)**        | **Stateful** (avec √©tat) ‚Äî utilise les sessions et les cookies | **Stateless** (sans √©tat) ‚Äî chaque requ√™te est ind√©pendante     |
| **Middleware par d√©faut** | `web` (inclut les sessions, la protection CSRF, le chiffrement des cookies) | `api` (inclut le "throttling" ‚Äî limitation de la fr√©quence des requ√™tes) |
| **Pr√©fixe d'URL**       | Aucun (racine de votre site)                                | `/api/` (configurable dans `RouteServiceProvider`)             |
| **Authentification**    | Habituellement via sessions (Login/Mot de passe)           | Habituellement via tokens (Sanctum, Passport)                  |

Nous travaillons avec `routes/web.php` pour construire une interface pour un √™tre humain.

---

### **2. Routes de ressources pour le web**

Semblable √† `Route::apiResource`, il existe `Route::resource` pour le web. Il cr√©e des routes pour un cycle CRUD complet, y compris des pages pour afficher les formulaires de cr√©ation et d'√©dition.

Cr√©ons un ensemble complet de routes pour g√©rer nos plan√®tes via l'interface web.

**√âtape 1 : Cr√©er la route dans `routes/web.php`**

Commentez ou supprimez les anciennes routes pour `/planets` et remplacez-les par une seule ligne :

```php
use App\Http\Controllers\Web\PlanetPageController;

// Route::get('/planets', [PlanetPageController::class, 'index']);
// Route::get('/planets/{planet}', [PlanetPageController::class, 'show']);

Route::resource('planets', PlanetPageController::class);
```

**√âtape 2 : V√©rifier ce qui a √©t√© cr√©√©**
Ex√©cutez la commande `php artisan route:list --except-vendor` dans le terminal :

```
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
| Method | URI       | Name                   | Action           | Middleware                                      |
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
| GET|HEAD | planets                | planets.index          | ...\PlanetPageController@index                    | web        |
| POST   | planets                | planets.store          | ...\PlanetPageController@store                    | web        |
| GET|HEAD | planets/create         | planets.create         | ...\PlanetPageController@create                   | web        |
| GET|HEAD | planets/{planet}       | planets.show           | ...\PlanetPageController@show                     | web        |
| PUT|PATCH | planets/{planet}       | planets.update         | ...\PlanetPageController@update                   | web        |
| DELETE | planets/{planet}       | planets.destroy        | ...\PlanetPageController@destroy                  | web        |
| GET|HEAD | planets/{planet}/edit  | planets.edit           | ...\PlanetPageController@edit                     | web        |
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
```

`Route::resource` a cr√©√© 7 routes pour nous, incluant :

-   `planets.create` (GET `/planets/create`) : page avec le formulaire de cr√©ation.
-   `planets.store` (POST `/planets`) : traitement de ce formulaire.
-   `planets.edit` (GET `/planets/{planet}/edit`) : page avec le formulaire d'√©dition.
-   `planets.update` (PUT/PATCH `/planets/{planet}`) : traitement du formulaire d'√©dition.
-   `planets.destroy` (DELETE `/planets/{planet}`) : suppression de la ressource.

---

### **3. Routes nomm√©es : Des "coordonn√©es spatiales" pratiques**
Notez la colonne `Name`. Laravel a automatiquement attribu√© un nom unique √† chaque route (par exemple, `planets.index`). Utiliser des noms au lieu d'URL cod√©es en dur est une **meilleure pratique**.

**Pourquoi ?** Si vous d√©cidez de changer l'URL de `/planets` √† `/worlds`, vous n'aurez pas √† chercher et modifier tous les liens dans vos templates. Vous le changez simplement √† un seul endroit ‚Äî dans le fichier de routes, et les noms restent les m√™mes.

**Exemple d'utilisation dans Blade :**

Avant, nous √©crivions ceci :

```blade
<a href="/planets/{{ $planet->id }}">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ &rarr;</a>
```

Maintenant, nous √©crirons ceci, en utilisant l'aideur `route()` :
```blade
<a href="{{ route('planets.show', ['planet' => $planet->id]) }}">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ &rarr;</a>
```

-   `route('planets.show', ...)` ‚Äî g√©n√®re une URL pour la route nomm√©e `planets.show`.
-   `['planet' => $planet->id]` ‚Äî transmet les param√®tres n√©cessaires √† l'URL. Laravel substituera l'ID dans `{planet}`. On peut m√™me passer le mod√®le entier : `['planet' => $planet]`.

---

### **4. Impl√©mentation des m√©thodes manquantes dans le contr√¥leur**
`Route::resource` a cr√©√© les routes, mais nous devons cr√©er nous-m√™mes les m√©thodes correspondantes dans `PlanetPageController`.

Ouvrez `app/Http/Controllers/Web/PlanetPageController.php` et ajoutons-les.

```php
<?php
use Illuminate\Http\Request; // <-- √Ä ajouter

class PlanetPageController extends Controller
{
    // index() et show() sont d√©j√† pr√©sents

    /**
     * Affiche le formulaire pour cr√©er une nouvelle plan√®te.
     */
    public function create()
    {
        return view('planets.create'); // Nous retournons simplement la vue avec le formulaire
    }

    /**
     * Enregistre une nouvelle plan√®te dans la base de donn√©es.
     */
    public function store(Request $request)
    {
        // Validation des donn√©es du formulaire
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:planets',
            'solar_system' => 'required|string|max:100',
            // ... autres r√®gles
        ]);

        Planet::create($validated);

        // Redirige l'utilisateur vers la page de liste avec un message de succ√®s
        return redirect()->route('planets.index')->with('success', 'Plan√®te cr√©√©e avec succ√®s !');
    }

    /**
     * Affiche le formulaire pour modifier une plan√®te.
     */
    public function edit(Planet $planet)
    {
        return view('planets.edit', ['planet' => $planet]);
    }

    /**
     * Met √† jour les donn√©es de la plan√®te dans la base de donn√©es.
     */
    public function update(Request $request, Planet $planet)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:planets,name,' . $planet->id,
            'solar_system' => 'required|string|max:100',
        ]);

        $planet->update($validated);

        return redirect()->route('planets.show', $planet)->with('success', 'Donn√©es de la plan√®te mises √† jour !');
    }

    /**
     * Supprime une plan√®te.
     */
    public function destroy(Planet $planet)
    {
        $planet->delete();

        return redirect()->route('planets.index')->with('success', 'Plan√®te supprim√©e.');
    }
}
```

-   `redirect()->route(...)` ‚Äî redirige l'utilisateur vers une autre route nomm√©e.
-   `->with('success', '...')` ‚Äî ajoute un "message flash" √† la session, qui sera disponible sur la page suivante une seule fois. Nous pouvons l'afficher dans notre template Blade.

---

### **5. Groupement de routes**
Si vous avez de nombreuses routes avec des caract√©ristiques communes (par exemple, toutes sont destin√©es au panneau d'administration et doivent avoir le pr√©fixe `/admin` et un middleware sp√©cial), elles peuvent √™tre regroup√©es.

```php
<?php
Route::middleware(['auth', 'admin'])->prefix('admin')->name('admin.')->group(function () {
    // Toutes les routes √† l'int√©rieur de ce groupe auront :
    // 1. Les middlewares 'auth' et 'admin'
    // 2. Le pr√©fixe d'URL '/admin' (par exemple, /admin/planets)
    // 3. Le pr√©fixe de nom 'admin.' (par exemple, admin.planets.index)

    Route::resource('planets', PlanetPageController::class);
    // Route::get('/dashboard', ...)->name('dashboard'); // -> admin.dashboard
});
```

---

### **Quiz de consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Quelle commande dans `routes/web.php` cr√©era un ensemble complet de routes CRUD pour l'interface web ?</p>
      <label><input type="radio" name="q1" value="a"> a) Route::crud('planets', Controller::class)</label>
      <label><input type="radio" name="q1" value="b"> b) Route::apiResource('planets', Controller::class)</label>
      <label><input type="radio" name="q1" value="c"> c) Route::resource('planets', Controller::class)</label>
    </div>
    <div class="question">
      <p>2. Quel est le principal avantage de l'utilisation des routes nomm√©es ?</p>
      <label><input type="radio" name="q2" value="a"> a) Elles sont plus rapides que les URL directes</label>
      <label><input type="radio" name="q2" value="b"> b) Elles permettent de modifier facilement l'URL dans le fichier de routes sans casser les liens dans les templates</label>
      <label><input type="radio" name="q2" value="c"> c) Elles sont automatiquement prot√©g√©es contre le CSRF</label>
    </div>
    <div class="question">
      <p>3. Quelle route sera g√©n√©r√©e pour la m√©thode `create()` dans `Route::resource('articles', ...)` ?</p>
      <label><input type="radio" name="q3" value="a"> a) GET `/articles/new`</label>
      <label><input type="radio" name="q3" value="b"> b) GET `/articles/create`</label>
      <label><input type="radio" name="q3" value="c"> c) POST `/articles/create`</label>
    </div>
    <div class="question">
      <p>4. Que fait le code `redirect()->route('home')->with('status', 'OK')` ?</p>
      <label><input type="radio" name="q4" value="a"> a) Il retourne un JSON avec 'status' => 'OK' √† l'URL `/home`</label>
      <label><input type="radio" name="q4" value="b"> b) Il redirige vers la route nomm√©e `home` et ajoute un message flash 'status' √† la session</label>
      <label><input type="radio" name="q4" value="c"> c) Il affiche la vue `home.blade.php` avec la variable `$status`</label>
    </div>
    <div class="question">
      <p>5. √Ä quoi sert `Route::prefix('dashboard')` ?</p>
      <label><input type="radio" name="q5" value="a"> a) Pour ajouter un pr√©fixe √† toutes les URL √† l'int√©rieur du groupe</label>
      <label><input type="radio" name="q5" value="b"> b) Pour ajouter un pr√©fixe √† tous les noms de routes √† l'int√©rieur du groupe</label>
      <label><input type="radio" name="q5" value="c"> c) Pour appliquer le middleware `dashboard`</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';
</script>
```javascript
    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> Bonne r√©ponse : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre r√©sultat : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ R√©sum√© du chapitre :**

Vous avez ma√Ætris√© une approche structur√©e et professionnelle pour l'organisation des routes web dans Laravel. Vous savez maintenant :

-   Distinguer les routes `web` et `api` et leur objectif.
-   Utiliser `Route::resource` pour g√©n√©rer rapidement des routes CRUD standard.
-   Appliquer des routes nomm√©es pour cr√©er un code flexible et maintenable.
-   Cr√©er des op√©rations CRUD compl√®tes dans le contr√¥leur avec validation et redirections.
-   Grouper les routes pour appliquer des r√®gles communes.

**Le syst√®me de navigation de votre "navire" est d√©sormais r√©silient et pr√™t √† √™tre √©tendu.** Dans le dernier chapitre de cette section, nous combinerons toutes les connaissances acquises et afficherons les donn√©es des plan√®tes, obtenues via Fetch, sur notre page Blade.
```