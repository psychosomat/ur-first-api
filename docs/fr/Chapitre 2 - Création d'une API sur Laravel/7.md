# **Chapitre 2.7 : Gestion des erreurs**
**Temps d'√©tude :** 40 minutes

---

#### **1. Pourquoi les erreurs standards sont-elles mauvaises ?**

Si une erreur se produit dans votre application Laravel (par exemple, un enregistrement introuvable dans la base de donn√©es) et que vous ne l'avez pas g√©r√©e, l'utilisateur verra une √©norme page HTML avec des informations de d√©bogage ou un message non informatif "Server Error".

Pour une API, c'est une catastrophe. Votre application frontend s'attend √† recevoir du JSON, pas du HTML. Notre t√¢che est d'intercepter toute erreur et de la transformer en une r√©ponse JSON structur√©e.

---

#### **2. Dispatcher d'erreurs central : `bootstrap/app.php`**

Dans les anciennes versions de Laravel, il y avait un fichier volumineux `App\Exceptions\Handler.php`. Dans Laravel 11/12, tout est devenu beaucoup plus simple et √©l√©gant. Le centre de gestion des erreurs se trouve d√©sormais directement dans le fichier de configuration de votre application ‚Äî `bootstrap/app.php`.

Ouvrez `bootstrap/app.php`. Tout en bas, vous verrez le bloc `.withExceptions(...)`. C'est notre "dispatcher central".

```php
<?php
// bootstrap/app.php

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {
        // ...
    })
    ->withExceptions(function (Exceptions $exceptions) {
        // <-- C'EST ICI QUE NOUS ALLONS TRAVAILLER
    })->create();
```

---

#### **3. G√©rer l'erreur la plus courante : "Non trouv√©" (404)**

L'erreur la plus courante dans une API est lorsque l'utilisateur demande une ressource qui n'existe pas (par exemple, `GET /api/planets/999`). Dans ce cas, Laravel g√©n√®re une exception `ModelNotFoundException` ou `NotFoundHttpException`. Interceptons-les.

Ajoutez le code suivant √† l'int√©rieur de `.withExceptions(...)` :

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // Intercepte l'exception lorsque le mod√®le n'est pas trouv√© dans la base de donn√©es
    $exceptions->render(function (ModelNotFoundException $e, Request $request) {
        // V√©rifie que la requ√™te provient bien de notre API
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'La ressource demand√©e est introuvable dans notre galaxie.'
            ], 404);
        }
    });

    // Intercepte l'exception lorsque le chemin lui-m√™me n'est pas trouv√©
    $exceptions->render(function (NotFoundHttpException $e, Request $request) {
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'Une telle route spatiale n\'existe pas.'
            ], 404);
        }
    });

})->create();
```
**Qu'avons-nous fait ?**

1.  `$exceptions->render(...)` ‚Äî nous enregistrons un "gestionnaire". Il dit : "Si une exception de type `ModelNotFoundException` se produit, ex√©cute ce code".
2.  `if ($request->is('api/*'))` ‚Äî c'est une v√©rification importante. Elle garantit que notre belle r√©ponse JSON ne sera envoy√©e que pour les requ√™tes API, sans affecter les pages web normales.
3.  `return response()->json(...)` ‚Äî nous cr√©ons et renvoyons une r√©ponse JSON standardis√©e avec le code 404.

Maintenant, si vous demandez une plan√®te inexistante, au lieu d'une page HTML disgracieuse, vous obtiendrez un JSON propre.

---

#### **4. Exceptions personnalis√©es : Cr√©er nos propres "alertes"**

Parfois, les exceptions standards ne suffisent pas. Imaginons que nous ayons une r√®gle m√©tier : "il est interdit de supprimer la plan√®te 'Terre'". Si quelqu'un tente de le faire, nous devons renvoyer une erreur significative.

**√âtape 1 : Cr√©er notre classe d'exception**
Ex√©cuter dans le terminal :
```bash
php artisan make:exception CannotDeleteEarthException
```

**√âtape 2 : L'utiliser dans le contr√¥leur**
Ouvrez `PlanetController.php` et modifiez la m√©thode `destroy` :

```php
<?php
// app/Http/Controllers/PlanetController.php
use App\Exceptions\CannotDeleteEarthException; // <-- Importons notre exception
use App\Models\Planet;

public function destroy(Planet $planet)
{
    // Notre nouvelle r√®gle m√©tier
    if (strtolower($planet->name) === '–∑–µ–º–ª—è') {
        throw new CannotDeleteEarthException('La suppression de la plan√®te Terre est interdite par le Code Galactique.');
    }

    $planet->delete();
    return response()->json(null, 204);
}
```
Maintenant, si quelqu'un tente d'ex√©cuter `DELETE /api/planets/1` (o√π 1 est l'ID de la Terre), notre code l√®vera une exception `CannotDeleteEarthException`.

**√âtape 3 : Apprendre √† Laravel √† g√©rer joliment notre "alerte"**
Revenons √† `bootstrap/app.php` et ajoutons un nouveau gestionnaire pour notre exception.

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // Notre nouveau gestionnaire
    $exceptions->render(function (CannotDeleteEarthException $e, Request $request) {
        return response()->json([
            'message' => 'Op√©ration interdite.',
            'details' => $e->getMessage() // R√©cup√®re le message que nous avons pass√© √† throw
        ], 403); // 403 Forbidden - "Acc√®s interdit"
    });

    // ... (autres gestionnaires pour 404)

})->create();
```
C'est fait ! Nous avons cr√©√© notre propre exception nomm√©e, ce qui rend le code du contr√¥leur plus propre, et nous avons appris √† Laravel √† la transformer en une belle r√©ponse JSON significative avec le bon statut HTTP.

---

#### **5. Gestion de tous les autres √©checs (500 Internal Server Error)**

Que faire de toutes les autres erreurs impr√©vues ? Par exemple, si la base de donn√©es tombe en panne ou s'il y a une erreur de syntaxe dans le code. Pour cela, nous pouvons enregistrer un gestionnaire "universel" pour le type d'erreur le plus g√©n√©ral ‚Äî `Throwable`.

**Important :** Ce gestionnaire doit √™tre le **dernier** pour ne pas intercepter les exceptions plus sp√©cifiques que nous avons d√©finies ci-dessus.

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // ... (gestionnaires pour CannotDeleteEarthException et 404)

    // GESTIONNAIRE UNIVERSEL (√† la toute fin)
    $exceptions->render(function (Throwable $e, Request $request) {
        if ($request->is('api/*')) {
            // En mode d√©bogage, il est possible d'afficher le v√©ritable message d'erreur
            $message = config('app.debug')
                ? 'Une erreur est survenue : ' . $e->getMessage()
                : 'Une erreur inattendue est survenue √† bord. Les ing√©nieurs ont d√©j√† √©t√© appel√©s.';

            return response()->json(['message' => $message], 500);
        }
    });

})->create();
```

Maintenant, toute exception "inconnue" sera proprement intercept√©e et transform√©e en JSON avec le code 500, sans casser votre API et sans montrer d'informations superflues √† l'utilisateur.

---

#### **6. Journalisation des erreurs : La bo√Æte noire du vaisseau spatial**
Param√®tres de journalisation dans `config/logging.php` :
```php
<?php
'channels' => [
    'space_api' => [
        'driver' => 'daily',
        'path' => storage_path('logs/space_api.log'),
        'level' => 'error',
        'days' => 14,
    ],
],
```

**Ajouter une entr√©e au journal :**
```php
<?php
try {
    // Code avec risque d'erreur
} catch (Exception $e) {
    Log::channel('space_api')->error('Erreur d\'acc√®s aux plan√®tes', [
        'exception' => $e,
        'request' => request()->all(),
        'user_id' => auth()->id()
    ]);
    throw $e;
}
```

---

#### **Quiz de r√©vision**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Statut HTTP pour "Plan√®te introuvable" :</p>
      <label><input type="radio" name="q1" value="a"> a) 400</label>
      <label><input type="radio" name="q1" value="b"> b) 404</label>
      <label><input type="radio" name="q1" value="c"> c) 500</label>
    </div>
    <div class="question">
      <p>2. Classe pour le traitement global des erreurs :</p>
      <label><input type="radio" name="q2" value="a"> a) Handler.php</label>
      <label><input type="radio" name="q2" value="b"> b) ErrorController.php</label>
      <label><input type="radio" name="q2" value="c"> c) Middleware/Error.php</label>
    </div>
    <div class="question">
      <p>3. M√©thode pour cr√©er une exception personnalis√©e :</p>
      <label><input type="radio" name="q3" value="a"> a) php artisan make:exception</label>
      <label><input type="radio" name="q3" value="b"> b) php artisan exception:create</label>
      <label><input type="radio" name="q3" value="c"> c) php artisan generate:exception</label>
    </div>
    <div class="question">
      <p>4. Canal pour la journalisation s√©par√©e des erreurs d'API :</p>
      <label><input type="radio" name="q4" value="a"> a) Configuration dans config/logging.php</label>
      <label><input type="radio" name="q4" value="b"> b) Param√®tre dans .env</label>
      <label><input type="radio" name="q4" value="c"> c) Sp√©cification dans le contr√¥leur</label>
    </div>
    <div class="question">
      <p>5. Principal avantage de la cr√©ation d'exceptions personnalis√©es :</p>
      <label><input type="radio" name="q5" value="a"> a) Am√©lioration des performances</label>
      <label><input type="radio" name="q5" value="b"> b) Cr√©ation d'erreurs s√©mantiquement compr√©hensibles pour des sc√©narios m√©tier sp√©cifiques</label>
      <label><input type="radio" name="q5" value="c"> c) Ajout automatique dans .env</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'a', q4: 'a', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> Bonne r√©ponse : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre score : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ R√©sum√© du chapitre :**

Vous avez √©quip√© votre API d'un syst√®me de sauvetage fiable :
- üõü Interception globale des erreurs standard
- ü™ê Exceptions personnalis√©es avec des codes clairs
- üìù Format JSON unifi√© pour toutes les erreurs
- üîç Journalisation avec les d√©tails de l'incident
- üì° Int√©gration avec les syst√®mes de surveillance

**Le vaisseau spatial est pr√™t aux situations d'urgence !** Dans le chapitre final de cette section, nous allons tester tous les syst√®mes.

> **üìå V√©rification :**

> 1. Cr√©ez une exception `PlanetNotFoundException`
> 2. Ajoutez la gestion des erreurs 404 dans ```->withExceptions```
> 3. Testez une requ√™te vers une plan√®te inexistante

> **‚ö†Ô∏è Si les erreurs ne sont pas intercept√©es :**

> - Assurez-vous que ```is('api/*')``` correspond √† vos routes
> - V√©rifiez l'ordre des gestionnaires dans ```register()```
> - Pour les exceptions personnalis√©es, utilisez ```throw new```