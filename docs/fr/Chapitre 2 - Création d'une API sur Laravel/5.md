# **Chapitre 2.5 : Routes d'API**
**Temps d'√©tude :** 45 minutes

---
#### **1. Qu'est-ce qu'une route ? Explication simple**

Imaginez que votre contr√¥leur (`PlanetController`) est un grand centre de bureaux, et que chacune de ses m√©thodes (`index`, `store`, `show`) est un d√©partement effectuant son propre travail.

**Une route (Route)** est une plaque d'adresse √† l'entr√©e du b√¢timent. Elle indique :

- "Si quelqu'un est arriv√© √† l'adresse `/planets` avec la m√©thode **GET** ‚Äî envoyez-le au d√©partement `index` (afficher tout)."
- "Si quelqu'un est arriv√© √† l'adresse `/planets` avec la m√©thode **POST** et un colis (donn√©es) ‚Äî envoyez-le au d√©partement `store` (cr√©er un nouveau)."

Sans routes, aucune requ√™te du monde ext√©rieur ne trouvera le d√©partement dont elle a besoin dans votre code. Le fichier principal pour de telles "plaques d'adresse" dans une API est `routes/api.php`.

Dans Laravel 11+, il n'y a pas de "carnet d'adresses API" par d√©faut. Nous l'avons cr√©√© nous-m√™mes en ex√©cutant la commande php artisan install:api. Nous avons maintenant le fichier routes/api.php ‚Äî c'est le centre de contr√¥le principal pour toutes les routes de notre API.

Diff√©rence cl√© entre api.php et web.php :

- Pr√©fixe /api : Laravel ajoute automatiquement /api √† toutes les URL de ce fichier. La route /planets se transforme en /api/planets.
- "Sans √©tat" (Stateless) : Il n'y a pas de sessions ni de cookies ici, comme dans une application web normale. Chaque requ√™te est ind√©pendante et doit contenir toutes les informations d'authentification (g√©n√©ralement un jeton API dans les en-t√™tes).

---

#### **2. La voie du d√©butant : Cr√©er une route manuellement**

Cr√©ons une seule route manuellement pour comprendre le principe. Notre objectif est de faire en sorte que l'URL `/api/planets` affiche la liste de toutes les plan√®tes.

Ouvrez `routes/api.php` et √©crivez :

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\PlanetController; // Indique o√π se trouve notre contr√¥leur

//                    (1)           (2)                     (3)
Route::get(      '/planets',    [PlanetController::class, 'index']     );
//   ^               ^                       ^
// (M√©thode HTTP)   (URL)                (Quel contr√¥leur et quelle m√©thode appeler)
```

**Analysons cette ligne par parties :**

1.  `Route::get(...)` ‚Äî nous disons : "Cette route ne fonctionne que pour les **requ√™tes GET**".
2.  `'/planets'` ‚Äî c'est l'URL que Laravel √©coutera. Compte tenu du pr√©fixe `/api`, l'adresse compl√®te sera `http://space-api.test/api/planets`.
3.  `[PlanetController::class, 'index']` ‚Äî c'est la "destination". Nous disons : "Quand la requ√™te arrive, trouve la classe `PlanetController` et appelle la m√©thode `index()` en elle".

**Maintenant, tout est li√© !** Requ√™te -> Route -> Contr√¥leur -> M√©thode.

Et si nous devons obtenir une plan√®te par son ID ? Par exemple, `/api/planets/5`.

```php
// Route pour obtenir une plan√®te sp√©cifique
Route::get('/planets/{planet}', [PlanetController::class, 'show']);
```

Ici, `{planet}` est un "mod√®le" ou une variable. Laravel comprend que n'importe quoi peut se trouver √† cet endroit (ID, slug). Il transmet ensuite cette valeur √† la m√©thode `show(Planet $planet)`. Cette "magie", o√π Laravel trouve lui-m√™me la plan√®te par ID, est appel√©e **Route Model Binding**.

---

#### **3. La voie du ma√Ætre : `apiResource` ‚Äî une seule ligne pour les gouverner toutes**

Cr√©er chaque route manuellement (pour `index`, `show`, `store`, `update`, `destroy`) est fastidieux. Les d√©veloppeurs Laravel le comprennent, c'est pourquoi ils ont cr√©√© un assistant puissant ‚Äî `apiResource`.

Supprimez tout ce que nous avons √©crit et remplacez-le par une seule ligne :

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\PlanetController;

Route::apiResource('planets', PlanetController::class);
```

**Que fait cette seule ligne sous le capot ?** Elle cr√©e automatiquement un ensemble complet de routes pour les op√©rations CRUD standard que nous avons d√©j√† impl√©ment√©es dans le contr√¥leur.

| M√©thode | URL | Dirig√©e vers la m√©thode | Objectif |
|---|---|---|---|
| **GET** | `/api/planets` | `index()` | Obtenir la liste de toutes les plan√®tes |
| **POST** | `/api/planets` | `store()` | Cr√©er une nouvelle plan√®te |
| **GET** | `/api/planets/{planet}`| `show()` | Afficher une plan√®te sp√©cifique |
| **PUT/PATCH**| `/api/planets/{planet}`| `update()` | Mettre √† jour une plan√®te existante |
| **DELETE** | `/api/planets/{planet}`| `destroy()` | Supprimer une plan√®te |

Vous pouvez le v√©rifier par vous-m√™me. Ex√©cutez la commande dans le terminal :

```bash
php artisan route:list --path=api
```

Vous verrez un tableau avec toutes les routes cr√©√©es. `apiResource` est votre meilleur ami pour gagner du temps lors de la cr√©ation d'API standard.

---

#### **4. Missions sp√©ciales et ordre des routes**

Et si nous avons besoin d'une route non standard qui n'est pas incluse dans `apiResource` ? Par exemple, obtenir une plan√®te al√©atoire √† l'adresse `/api/planets/random`.

Ajoutons-la. Mais il y a ici un **pi√®ge mortel** dans lequel tombent 9 d√©butants sur 10.

**Ordre incorrect (NE FONCTIONNE PAS !) :**
```php
Route::apiResource('planets', PlanetController::class);
Route::get('/planets/random', [PlanetController::class, 'random']); // <-- NE FONCTIONNERA PAS
```
**Pourquoi ?** Laravel lit les routes de haut en bas. Il verra `Route::apiResource`, qui a cr√©√© la route `GET /planets/{planet}`. Lorsque vous demanderez `/planets/random`, Laravel pensera que "random" est l'ID de la plan√®te, et tentera de trouver une plan√®te avec l'ID "random" dans la base de donn√©es, et vous obtiendrez une erreur.

**Ordre correct (FONCTIONNE !) :**
```php
<?php
use App\Http\Controllers\PlanetController;
use Illuminate\Support\Facades\Route;

// 1. D√©clarons d'abord les routes SP√âCIFIQUES
Route::get('/planets/random', [PlanetController::class, 'random']);

// 2. Et seulement ensuite, d√©clarons les routes G√âN√âRIQUES avec des variables
Route::apiResource('planets', PlanetController::class);
```

> #### ‚ö†Ô∏è Important !
> Pour tester la route api/planets/random, vous devez ajouter un nouveau gestionnaire dans PlanetController :

>```php
><?php
>public function random(Request $request)
>{
>	$planet = Planet::inRandomOrder()->first();
>	return response()->json($planet);
>}
>```


R√®gle : D√©clarez toujours les routes plus sp√©cifiques (telles que `/random`) **avant** les routes plus g√©n√©riques et √† motifs (telles que `/{planet}`).

---

#### **5. Regroupement : Mettre de l'ordre**

Lorsque le nombre de routes devient important, il est possible et n√©cessaire de les regrouper.

**A. Versioning de l'API**
Pour ne pas casser √† l'avenir les anciennes applications qui utilisent votre API, il est courant d'ajouter une version √† l'URL, par exemple `/api/v1/...`.

```php
<?php
Route::prefix('v1')->group(function () {
    // Toutes les routes √† l'int√©rieur de ce groupe obtiendront le pr√©fixe /v1
    // URL finale : /api/v1/planets
    Route::get('/planets/random', [PlanetController::class, 'random']);
    Route::apiResource('planets', PlanetController::class);
});
```

**B. Protection des routes (Middleware)**
Imaginons que tout le monde puisse consulter les plan√®tes, mais que seules les utilisateurs autoris√©s puissent les cr√©er, les mettre √† jour et les supprimer.

```php
<?php
// Routes publiques, accessibles √† tous
Route::get('/planets', [PlanetController::class, 'index']);
Route::get('/planets/{planet}', [PlanetController::class, 'show']);

// Groupe de routes n√©cessitant un "pass" (authentification)
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/planets', [PlanetController::class, 'store']);
    Route::put('/planets/{planet}', [PlanetController::class, 'update']);
    Route::delete('/planets/{planet}', [PlanetController::class, 'destroy']);
});
```

Ici, `middleware('auth:sanctum')` est comme un garde qui v√©rifie le "pass" de quiconque tente d'acc√©der aux routes √† l'int√©rieur du groupe.

---

#### **6. Test via Postman**

Maintenant que toutes les routes sont √©tablies, il est temps de les tester.

1.  **Si vous utilisez Herd :** Votre site fonctionne d√©j√† √† une adresse de type `http://space-api.test`.
2.  **Sinon :** Lancez le serveur local avec la commande `php artisan serve`. L'adresse sera `http://localhost:8000`.

Ouvrez Postman et envoyez les requ√™tes :

- `GET http://space-api.test/api/planets`
- `GET http://space-api.test/api/planets/random`
- `POST http://space-api.test/api/planets` (n'oubliez pas d'ajouter le corps de requ√™te JSON dans l'onglet `Body` -> `raw` -> `JSON`).

**Exemple de requ√™te POST :**
```json
{
    "name": "Kepler-186f",
    "description": "–ü–µ—Ä–≤–∞—è –ø–ª–∞–Ω–µ—Ç–∞ –∑–µ–º–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –≤ –æ–±–∏—Ç–∞–µ–º–æ–π –∑–æ–Ω–µ",
    "size_km": 15000,
    "solar_system": "Kepler-186",
    "is_habitable": true
}
```

---

#### **8. Erreurs courantes de routage**

1. **404 Not Found**
   >- URL incorrecte (`/api/planet` au lieu de `/api/planets`)
   >- Oubli√© `php artisan serve`
2. **405 Method Not Allowed**
   >- M√©thode HTTP incorrecte (par exemple, GET au lieu de POST)
3. **Contr√¥leur Manquant**
   >- Faute de frappe dans le nom du contr√¥leur (`PlanetControler`)
4. **Collision de Noms de Route**
   >- Noms de routes en double

---

#### **Quiz de r√©vision**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Le fichier pour les routes API dans Laravel :</p>
      <label><input type="radio" name="q1" value="a"> a) routes/web.php</label>
      <label><input type="radio" name="q1" value="b"> b) routes/api.php</label>
      <label><input type="radio" name="q1" value="c"> c) routes/console.php</label>
    </div>
    <div class="question">
      <p>2. Le pr√©fixe automatique pour les routes API :</p>
      <label><input type="radio" name="q2" value="a"> a) /admin</label>
      <label><input type="radio" name="q2" value="b"> b) /api</label>
      <label><input type="radio" name="q2" value="c"> c) /v1</label>
    </div>
    <div class="question">
      <p>3. La m√©thode pour cr√©er 5 routes CRUD :</p>
      <label><input type="radio" name="q3" value="a"> a) Route::api()</label>
      <label><input type="radio" name="q3" value="b"> b) Route::resource()</label>
      <label><input type="radio" name="q3" value="c"> c) Route::apiResource()</label>
    </div>
    <div class="question">
      <p>4. Route::prefix('v1') est utilis√© pour :</p>
      <label><input type="radio" name="q4" value="a"> a) Authentification</label>
      <label><input type="radio" name="q4" value="b"> b) Versioning de l'API</label>
      <label><input type="radio" name="q4" value="c"> c) Mise en cache</label>
    </div>
    <div class="question">
      <p>5. Affichage de toutes les routes :</p>
      <label><input type="radio" name="q5" value="a"> a) php artisan route:list</label>
      <label><input type="radio" name="q5" value="b"> b) php artisan list:routes</label>
      <label><input type="radio" name="q5" value="c"> c) php routes</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

```
if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> Bonne r√©ponse: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre score: ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ R√©sum√© du chapitre :**

Vous avez construit des "routes hyperspatiales" pour l'API spatiale ! Maintenant :

- üó∫Ô∏è Tous les points de terminaison sont accessibles via `/api/...`
- üîó Les routes de ressources sont connect√©es au contr√¥leur
- üõ°Ô∏è Des routes personnalis√©es ont √©t√© ajout√©es pour les op√©rations sp√©ciales
- ‚úÖ Les routes ont √©t√© test√©es via Postman

**L'univers est ouvert aux requ√™tes !** Ensuite, nous allons ajouter une protection contre les "d√©bris spatiaux" ‚Äì la validation des donn√©es.

> **üìå V√©rification :**

> 1. Ex√©cutez `php artisan route:list`
> 2. Assurez-vous de voir 5+ routes pour planets
> 3. V√©rifiez le fonctionnement de GET /api/planets dans le navigateur/Postman

> **‚ö†Ô∏è Si erreur 404 :**

> - V√©rifiez la pr√©sence de `Route::apiResource` dans `routes/api.php`
> - Assurez-vous que le serveur est lanc√© (`php artisan serve`)
> - Pour Windows : autorisez le port 8000 dans le pare-feu