# **Chapitre 2.3 : Migrations de base de donn√©es**
**Temps d'√©tude :** 50 minutes

---

#### **1. Migrations : Construction d'une station spatiale**
Les **migrations** dans Laravel sont un syst√®me de contr√¥le de version pour votre base de donn√©es.

Imaginez que vous :

1. üèóÔ∏è Cr√©ez le plan d'une station (migration `create_planets_table`)
2. üöÄ D√©ployez des modules (ex√©cution des migrations)
3. üîß Modernisez la construction (nouvelles migrations)
4. ‚è™ Pouvez revenir √† une version pr√©c√©dente (rollback)

> üí° **Important :** Les migrations permettent √† l'√©quipe de travailler de mani√®re coh√©rente ‚Äî comme des ing√©nieurs sur diff√©rents continents construisant l'ISS !

---

#### **2. Ex√©cution des migrations**
Apr√®s avoir cr√©√© la migration au chapitre 2.2, ex√©cutez :
```bash
php artisan migrate
```

**Sortie dans le terminal :**
```
Migration table created successfully.
Migrating: 2014_10_12_000000_create_users_table
Migrated:  2014_10_12_000000_create_users_table (25.12ms)
Migrating: 2014_10_12_100000_create_password_reset_tokens_table
Migrated:  2014_10_12_100000_create_password_reset_tokens_table (18.07ms)
Migrating: 2019_08_19_000000_create_failed_jobs_table
Migrated:  2019_08_19_000000_create_failed_jobs_table (21.33ms)
Migrating: 2019_12_14_000001_create_personal_access_tokens_table
Migrated:  2019_12_14_000001_create_personal_access_tokens_table (30.45ms)
Migrating: 2025_08_04_000000_create_planets_table
Migrated:  2025_08_04_000000_create_planets_table (15.67ms)  # Votre table !
```

**V√©rification dans pgAdmin 4 :**

1. Ouvrez la base `space_api` ‚Üí Schemas ‚Üí Tables
2. Assurez-vous que les √©l√©ments suivants sont apparus :   - `planets`   - `users`   - `password_reset_tokens`

---

#### **3. Annulation des migrations : Retour d'urgence**
Si vous devez corriger la structure :
```bash
php artisan migrate:rollback  # Annule le dernier lot de migrations
```
```bash
php artisan migrate:reset    # Annule toutes les migrations
```

- ```php artisan migrate:fresh``` ‚Äî **la commande la plus utile en d√©veloppement !** Elle supprime toutes les tables et ex√©cute √† nouveau toutes les migrations.
- ```php artisan migrate:fresh --seed``` ‚Äî fait la m√™me chose que `fresh`, mais ex√©cute imm√©diatement les seeders apr√®s les migrations. C'est la commande pour "recr√©er" compl√®tement la base de donn√©es √† partir de z√©ro.


**Sc√©nario d'utilisation :**
```bash
# √âtape 1 : Vous avez r√©alis√© qu'il y a une erreur dans la migration. Recr√©ez enti√®rement la base.
php artisan migrate:fresh
# √âtape 2 : Modifiez la migration
# √âtape 3 : Recr√©ez √† nouveau la base avec la migration corrig√©e
php artisan migrate:fresh
```

---

#### **4. Ajout de nouveaux champs : Modernisation de la station**
**Exemple :** Ajoutons le champ `is_habitable` (la plan√®te est-elle habitable).

**√âtape 1 : Cr√©ez une nouvelle migration**
```bash
php artisan make:migration add_is_habitable_to_planets_table
```

**√âtape 2 : Modifiez le fichier** `database/migrations/..._add_is_habitable_to_planets_table.php`
```php
<?php
public function up()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->boolean('is_habitable')
              ->default(false);
    });
}

public function down()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->dropColumn('is_habitable');
    });
}
```

**√âtape 3 : Ex√©cutez la mise √† jour**
```bash
php artisan migrate
```

---

#### **5. Peuplement de la base : Premi√®res plan√®tes**
Nous cr√©ons un **seeder** ‚Äî un script pour g√©n√©rer des donn√©es de test.

**√âtape 1 : G√©n√©ration du seeder**
```bash
php artisan make:seeder PlanetSeeder
```

**√âtape 2 : Modifiez** `database/seeders/PlanetSeeder.php`
```php
<?php
use App\Models\Planet; // Importez le mod√®le Planet - Sans cela, vous obtiendrez une erreur !


class PlanetSeeder extends Seeder
{
    public function run()
    {
        Planet::create([
            'name' => 'Terre',
            'description' => 'Plan√®te bleue avec une vie diversifi√©e',
            'size_km' => 12742,
            'solar_system' => 'Syst√®me solaire',
            'image_url' => 'https://example.com/earth.jpg',
            'is_habitable' => true
        ]);

        Planet::create([
            'name' => 'Mars',
            'description' => 'Plan√®te rouge, cible des futures colonisations',
            'size_km' => 6779,
            'solar_system' => 'Syst√®me solaire',
            'is_habitable' => false
        ]);
    }
}
```

**√âtape 3 : Enregistrez le seeder dans** `database/seeders/DatabaseSeeder.php`
```php
<?php
public function run()
{
    $this->call([
        PlanetSeeder::class
    ]);
}
```

**√âtape 4 : Ex√©cutez le peuplement**
```bash
php artisan db:seed
```

---

#### **6. Travailler avec PostgreSQL : Sp√©cificit√©s**
**Sp√©cificit√©s des types de donn√©es :**

| Capacit√© | PostgreSQL | MySQL | Commentaire Laravel |
|---|---|---|---|
| **Type bool√©en** | `boolean` (vrai `true`/`false`) | `tinyint(1)` (stocke `0`/`1`) | `$table->boolean('...')` fonctionne pour les deux |
| **JSON** | `jsonb` (binaire, indexable) | `json` (textuel) | `$table->jsonb('...')` - tr√®s puissant en PG |
| **Tableaux** | `text[]`, `integer[]` (tableaux natifs) | Non (√©mul√© via JSON ou cha√Ænes de caract√®res) | `$table->array('...')` (exclusif √† PG) |
| **Ordre des colonnes** | Ne peut pas √™tre contr√¥l√© (`after()` ne fonctionne pas) | Peut √™tre contr√¥l√© (`after()`) | Laravel l'abstrait, mais il faut conna√Ætre la limitation |


**Exemple de cr√©ation d'index :**
```php
// Dans la migration
$table->index('solar_system');
```

---

#### **7. V√©rification des donn√©es dans psql**

Vous pouvez utiliser n'importe quel client graphique et y s√©lectionner space_api pour la visualisation.

Lors de l'utilisation de la console :
```bash
psql -U postgres -d space_api
# Le terminal peut vous demander le mot de passe que vous avez d√©fini lors de l'installation de PostgreSQL.
```
```sql
SELECT * FROM planets;
```

Dans tous les cas, la sortie devrait √™tre la suivante :

 id |  name  | description | size_km |  solar_system   | image_url | is_habitable |
|---|---|---|---|---|---|---|
  1 | Terre  | Plan√®te bleue avec une vie diversifi√©e   |   12742 | Syst√®me solaire| ...       | true |
  2 | Mars   | Plan√®te rouge, cible des colonisations        |    6779 | Syst√®me solaire| null      | false |


---

#### **Quiz pour la r√©vision**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Commande pour ex√©cuter les migrations :</p>
      <label><input type="radio" name="q1" value="a"> a) php artisan migrate:run</label>
      <label><input type="radio" name="q1" value="b"> b) php artisan migrate</label>
      <label><input type="radio" name="q1" value="c"> c) php artisan db:migrate</label>
    </div>
    <div class="question">
      <p>2. Comment annuler la derni√®re migration ?</p>
      <label><input type="radio" name="q2" value="a"> a) migrate:undo</label>
      <label><input type="radio" name="q2" value="b"> b) migrate:rollback</label>
      <label><input type="radio" name="q2" value="c"> c) migrate:reset</label>
    </div>
    <div class="question">
      <p>3. Les seeders sont utilis√©s pour :</p>
      <label><input type="radio" name="q3" value="a"> a) Supprimer des tables</label>
      <label><input type="radio" name="q3" value="b"> b) Peupler la BDD avec des donn√©es de test</label>
      <label><input type="radio" name="q3" value="c"> c) Cr√©er des mod√®les</label>
    </div>
    <div class="question">
      <p>4. M√©thode pour ajouter une colonne √† une table existante :</p>
      <label><input type="radio" name="q4" value="a"> a) Schema::addColumn()</label>
      <label><input type="radio" name="q4" value="b"> b) Schema::table()</label>
      <label><input type="radio" name="q4" value="c"> c) Schema::modify()</label>
    </div>
    <div class="question">
      <p>5. O√π les seeders sont-ils enregistr√©s ?</p>
      <label><input type="radio" name="q5" value="a"> a) DatabaseSeeder.php</label>
      <label><input type="radio" name="q5" value="b"> b) .env</label>
      <label><input type="radio" name="q5" value="c"> c) config/database.php</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:red;">Incorrect.</span> Bonne r√©ponse : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre score : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ R√©sum√© du chapitre :**

Vous avez ma√Ætris√© la "construction d'infrastructures spatiales" :

- ‚úÖ Cr√©√© et ex√©cut√© des migrations
- üîß Modernis√© la structure de la table
- üåç Peupl√© la BDD avec les premi√®res plan√®tes
- ‚öôÔ∏è Appris √† travailler avec PostgreSQL

**Votre univers a acquis ses premiers mondes !** Vous pouvez maintenant passer √† la cr√©ation d'interfaces API pour g√©rer les plan√®tes.

> **üìå V√©rification :**

> 1. Ex√©cutez `php artisan tinker`
> 2. Ex√©cutez `App\Models\Planet::all()`
> 3. Assurez-vous de voir la Terre et Mars