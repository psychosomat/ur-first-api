# **Chapitre 6.2 : Configuration CORS**
**Temps d'√©tude :** 30 minutes

---
#### **1. CORS : Qu'est-ce que c'est et pourquoi est-ce n√©cessaire ?**

Comme nous l'avons d√©couvert, le **CORS (Cross-Origin Resource Sharing)** est une politique de s√©curit√© des navigateurs. Elle emp√™che une situation o√π un site malveillant `evil-site.com`, en votre nom (en utilisant vos cookies), ferait des requ√™tes √† `your-bank.com` et volerait des donn√©es.

**Comment cela fonctionne-t-il ?**

1.  Le **Frontend (navigateur)** depuis le domaine `A` souhaite obtenir des donn√©es du domaine `B`.
2.  Le navigateur envoie au domaine `B` une requ√™te "pr√©liminaire" sp√©ciale (requ√™te de pr√©-vol ou "preflight request") avec la m√©thode `OPTIONS`, demandant : "H√©, domaine `B`, puis-je, moi, domaine `A`, te faire une requ√™te `GET` ?"
3.  Le **Backend (serveur sur le domaine `B`)** doit r√©pondre avec des en-t√™tes HTTP sp√©ciaux, par exemple : `Access-Control-Allow-Origin: A`.
4.  Si la r√©ponse du serveur autorise la requ√™te, le navigateur envoie la requ√™te `GET` principale. Sinon, il la bloque et affiche une erreur CORS.

> üí° **Analogie spatiale :**

> Avant de t√©l√©porter le capitaine vers une station √©trang√®re (envoyer une requ√™te `POST`), le vaisseau (le navigateur) envoie un drone (une requ√™te `OPTIONS`) avec la question : "Station, acceptez-vous la t√©l√©portation depuis le vaisseau 'Enterprise' ?". La station (l'API) r√©pond : "Oui, la r√©ception depuis l''Enterprise' est autoris√©e" (en-t√™te `Access-Control-Allow-Origin`). C'est seulement apr√®s cela que la t√©l√©portation commence.

---

#### **2. Configuration CORS dans Laravel (Approche moderne pour Laravel 11+)**
Dans Laravel 11+, la configuration CORS est devenue beaucoup plus simple et ne n√©cessite pas la publication du fichier `config/cors.php` si vous avez besoin de r√©glages de base. Tout est g√©r√© via le fichier `.env` et `bootstrap/app.php`.

**√âtape 1 : Configuration via les variables d'environnement**

Ouvrez votre fichier `.env`. Laravel fournit d√©j√† par d√©faut des variables pour g√©rer le CORS pour l'API.

```env
# .env

# ... autres variables

# Sp√©cifiez les chemins pour lesquels CORS sera actif.
# 'api/*' - valeur standard pour toutes les routes API.
CORS_PATHS=api/*

# Sp√©cifiez les origines (domaines) autoris√©es.
# Pour le d√©veloppement, indiquez l'adresse de votre frontend.
# Vous pouvez les lister s√©par√©es par des virgules, sans espaces.
CORS_ALLOWED_ORIGINS=http://localhost:5500,http://127.0.0.1:5500

# Autres param√®tres (g√©n√©ralement, peuvent √™tre laiss√©s par d√©faut)
CORS_ALLOWED_METHODS=*
CORS_ALLOWED_HEADERS=*
CORS_EXPOSED_HEADERS=
CORS_MAX_AGE=0
CORS_SUPPORTS_CREDENTIALS=false
```

**Variables cl√©s :**

- `CORS_ALLOWED_ORIGINS` : **La variable la plus importante.** Ici, vous listez les domaines √† partir desquels les requ√™tes sont autoris√©es. `*` autorise tout le monde, mais c'est

**extr√™mement dangereux pour la production**.

- `CORS_PATHS` : Chemins auxquels ces r√®gles s'appliquent. `api/*` signifie tout ce qui commence par `/api/`.

Apr√®s avoir modifi√© le `.env`, il **n'est pas n√©cessaire** de red√©marrer le serveur si vous utilisez `php artisan serve`. Les modifications seront prises en compte automatiquement.

**√âtape 2 (Optionnel) : Configuration avanc√©e dans `bootstrap/app.php`**

Si vous avez besoin d'une logique plus complexe (par exemple, autoriser les sous-domaines √† l'aide de motifs), vous devrez tout de m√™me publier le fichier de configuration et configurer le middleware. Mais pour 95% des cas, le fichier `.env` est suffisant.

La commande `php artisan install:api` configure automatiquement le middleware CORS de base pour les routes API dans le fichier `bootstrap/app.php`. Cela ressemble √† ceci :

```php
// bootstrap/app.php
->withMiddleware(function (Middleware $middleware) {
    // Cette ligne sera d√©j√† ajout√©e par la commande install:api
    // C'est elle qui active le traitement CORS pour toutes les routes API
    $middleware->api(base_path('routes/api.php'));
})
```

√Ä l'int√©rieur de `->api()`, Laravel utilise d√©j√† le middleware `HandleCors`, qui lit les param√®tres de votre `.env`. C'est simple et pr√™t √† l'emploi.

> ‚ö†Ô∏è **Important !** N'utilisez pas `CORS_ALLOWED_ORIGINS='*'` sur un serveur de production si votre API n'est pas enti√®rement publique. Cela ouvre une vuln√©rabilit√© potentielle. Listez toujours les domaines sp√©cifiques de votre frontend.

---

#### **3. Configuration CORS dans FastAPI**

FastAPI utilise le concept de **Middleware** (logiciel interm√©diaire) pour g√©rer des t√¢ches transversales telles que le CORS.

**√âtape 1 : Ouvrez le fichier principal de votre application**

C'est le fichier o√π vous cr√©ez une instance de FastAPI (g√©n√©ralement `main.py`).

**√âtape 2 : Ajoutez `CORSMiddleware`**

FastAPI fournit un middleware pr√™t √† l'emploi pour la configuration CORS.

```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware # 1. Importez le middleware

app = FastAPI(
    title="SpaceAPI",
    description="API pour la gestion des plan√®tes dans la galaxie",
    version="1.0.0"
)

# 2. Liste des origines autoris√©es
origins = [
    "http://localhost:5500",
    "http://127.0.0.1:5500",
    # En production, ce sera le domaine de votre frontend
    # "https://my-awesome-app.com",
]

# 3. Ajoutez le middleware √† l'application
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # Autorise les origines sp√©cifi√©es
    allow_credentials=True, # Autorise les cookies (n√©cessaire pour l'authentification)
    allow_methods=["*"],    # Autorise toutes les m√©thodes (GET, POST, etc.)
    allow_headers=["*"],    # Autorise tous les en-t√™tes
)

# ... ici vos routeurs et le reste du code
```

**√âtape 3 : Red√©marrez le serveur Uvicorn**
Le serveur Uvicorn se recharge g√©n√©ralement automatiquement lorsque le code est modifi√©. Si ce n'est pas le cas, red√©marrez-le manuellement. D√©sormais, votre serveur FastAPI r√©pondra correctement aux requ√™tes `OPTIONS` du frontend.

---

#### **Quiz pour la consolidation**


<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. La requ√™te que le navigateur envoie avant la requ√™te principale pour v√©rifier le CORS s'appelle :</p>
      <label><input type="radio" name="q1" value="a"> a) CHECK request</label>
      <label><input type="radio" name="q1" value="b"> b) Preflight request</label>
      <label><input type="radio" name="q1" value="c"> c) Handshake request</label>
    </div>
    <div class="question">
      <p>2. Dans Laravel moderne (11+), les param√®tres CORS de base sont principalement d√©finis dans :</p>
      <label><input type="radio" name="q2" value="a"> a) Le fichier bootstrap/app.php</label>
      <label><input type="radio" name="q2" value="b"> b) Le fichier .env</label>
      <label><input type="radio" name="q2" value="c"> c) Le fichier routes/api.php</label>
    </div>
    <div class="question">
      <p>3. Dans FastAPI, pour configurer CORS, on utilise :</p>
      <label><input type="radio" name="q3" value="a"> a) Le d√©corateur @app.cors()</label>
      <label><input type="radio" name="q3" value="b"> b) La classe Security int√©gr√©e</label>
      <label><input type="radio" name="q3" value="c"> c) Un logiciel interm√©diaire (`Middleware`)</label>
    </div>
    <div class="question">
      <p>4. Quelle valeur de CORS_ALLOWED_ORIGINS est la plus s√ªre pour la production ?</p>
      <label><input type="radio" name="q4" value="a"> a) CORS_ALLOWED_ORIGINS='*'</label>
      <label><input type="radio" name="q4" value="b"> b) CORS_ALLOWED_ORIGINS=http://my-frontend.com,https://my-frontend.com`</label>
      <label><input type="radio" name="q4" value="c"> c) Ne pas d√©finir cette variable</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:red;">Incorrect.</span> La bonne r√©ponse est : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre score : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ R√©sum√© du chapitre :**

Vous √™tes devenu un "diplomate des communications interstellaires" ! Vos API peuvent d√©sormais interagir en toute s√©curit√© avec des applications externes, en utilisant des approches modernes et correctes.

- ‚úÖ Compris le m√©canisme de fonctionnement du CORS et des requ√™tes de pr√©-vol.
- üîß Configur√© CORS pour Laravel 11+ via le fichier `.env`.
- ‚öôÔ∏è Configur√© CORS pour FastAPI √† l'aide de `CORSMiddleware`.
- üõ∞Ô∏è √âtabli avec succ√®s la connexion entre le frontend et le backend.

**Le pont de communication est construit et s√©curis√©.** Il est maintenant temps de r√©fl√©chir √† la mani√®re de n'autoriser que le "personnel autoris√©" √† emprunter ce pont.

> **üìå V√©rification :**

> - Le crit√®re principal de succ√®s est l'absence d'erreurs CORS dans la console du navigateur lors de la demande de donn√©es depuis le frontend.
> - Dans l'onglet "Network" (R√©seau) des outils de d√©veloppement, vous pouvez voir deux requ√™tes vers votre API : la premi√®re avec la m√©thode `OPTIONS` (statut 200/204) et la seconde avec la m√©thode `GET` (statut 200). C'est une d√©monstration visuelle du fonctionnement de CORS.