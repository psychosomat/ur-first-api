# **Chapitre 6.5 : Fondamentaux de la s√©curit√© des API**
**Temps d'√©tude :** 45 minutes

---

#### **1. S√©curit√© des API : Une d√©fense de station √† plusieurs niveaux**

Imaginez que votre station spatiale (API) se trouve dans un secteur hostile de l'espace. Un seul champ de force (authentification) ne suffit pas. Vous avez besoin d'un syst√®me de d√©fense complet :

- **Boucliers (HTTPS) :** Chiffrement de tout le trafic.
- **Capteurs d'anomalies (Rate Limiting) :** Protection contre les requ√™tes trop fr√©quentes.
- **Cloisons internes (Autorisation) :** S√©paration des droits d'acc√®s.
- **Inspection des cargaisons (Validation) :** Ne faire confiance √† aucune donn√©e entrante.
- **Coffre-fort secret (Variables d'environnement) :** Stockage s√©curis√© des cl√©s.

Param√©trons chacun de ces niveaux.

---

#### **2. Boucliers : Toujours utiliser HTTPS**

**Qu'est-ce que c'est ?** HTTPS (HyperText Transfer Protocol Secure) est une version du protocole HTTP qui chiffre toutes les donn√©es entre le client et le serveur. Sans lui, quiconque "√©coute" le r√©seau (par exemple, dans un Wi-Fi public) peut intercepter les identifiants, mots de passe et jetons.

**Comment impl√©menter ?**

- **En production ‚Äî obligatoire.** Lors du d√©ploiement de votre API sur un serveur r√©el (Heroku, DigitalOcean, etc.), configurez le serveur web (Nginx, Apache) pour qu'il fonctionne avec un certificat SSL. Des services comme **Let's Encrypt** fournissent des certificats gratuits.
- **En d√©veloppement local** c'est moins critique, mais des outils comme **Laravel Herd** ou **mkcert** permettent de configurer facilement le HTTPS local.

> üí° **R√®gle n¬∞1 de la s√©curit√© des API :** **Pas de HTTPS ‚Äî pas de s√©curit√©.**

---

#### **3. Capteurs d'anomalies : Limitation du taux de requ√™tes (Rate Limiting)**

**Qu'est-ce que c'est ?** Protection contre les **attaques par force brute** (lorsqu'un attaquant tente de deviner un mot de passe en envoyant des milliers de requ√™tes par seconde) et contre les **attaques DoS** (lorsque le serveur est "submerg√©" de requ√™tes pour le rendre indisponible). Le Rate Limiting limite le nombre de requ√™tes qu'un utilisateur (ou une adresse IP) peut effectuer dans un laps de temps donn√©.

**Comment impl√©menter ?**

- **Dans Laravel :** Le middleware de limitation est d√©j√† int√©gr√© !
  Ouvrez `app/Http/Kernel.php` et regardez la cl√© `middlewareGroups['api']`. Il y a d√©j√† `'throttle:api'`. Les param√®tres de cette limitation se trouvent dans `app/Providers/RouteServiceProvider.php` dans la m√©thode `configureRateLimiting()`.
  ```php
  // app/Providers/RouteServiceProvider.php
  protected function configureRateLimiting()
  {
      RateLimiter::for('api', function (Request $request) {
          return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
      });
  }
  ```
  Cela signifie : 60 requ√™tes par minute par utilisateur (s'il est authentifi√©) ou par adresse IP.

- **Dans FastAPI :** Un paquet tiers est utilis√©, par exemple, **`slowapi`**.

  1.  Installation : `pip install slowapi`
  2.  Int√©gration dans `main.py` :
      ```python
      # main.py
      from slowapi import Limiter, _rate_limit_exceeded_handler
      from slowapi.util import get_remote_address
      from slowapi.errors import RateLimitExceeded

      limiter = Limiter(key_func=get_remote_address)
      app = FastAPI(...)

      # On connecte le gestionnaire d'exceptions et le limiteur lui-m√™me
      app.state.limiter = limiter
      app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

      # Appliquer √† un point de terminaison sp√©cifique
      @router.get("/planets")
      @limiter.limit("5/minute") # 5 requ√™tes par minute
      def get_planets(request: Request):
          # ...
      ```

---

#### **4. Cloisons internes : Autorisation (√† ne pas confondre avec l'authentification !)**

**Qu'est-ce que c'est ?**

- **L'authentification** r√©pond √† la question "Qui es-tu ?".
- **L'autorisation** r√©pond √† la question "Qu'as-tu le droit de faire ?".

Par exemple, un utilisateur ordinaire peut consulter les plan√®tes, mais seul un utilisateur avec le r√¥le "administrateur" peut les supprimer.

**Comment impl√©menter ?**

- **Dans Laravel :** Les **Policies** (Politiques) ou les **Gates** (Portails) sont utilis√©s.

  1.  Cr√©ation d'une politique : `php artisan make:policy PlanetPolicy --model=Planet`
  2.  Description des r√®gles dans `app/Policies/PlanetPolicy.php` :
      ```php
      class PlanetPolicy
      {
          // Autoriser la suppression uniquement aux utilisateurs avec le r√¥le 'admin'
          public function delete(User $user, Planet $planet): bool
          {
              return $user->role === 'admin';
          }
      }
      ```
  3.  Application de la politique dans le contr√¥leur `PlanetController.php` :
      ```php
      public function destroy(Planet $planet)
      {
          // On v√©rifie si l'utilisateur actuel a le droit de supprimer
          $this->authorize('delete', $planet);

          $planet->delete();
          return response()->json(null, 204);
      }
      ```

- **Dans FastAPI :** La logique d'autorisation est g√©n√©ralement √©crite manuellement √† l'int√©rieur des points de terminaison, en utilisant les informations utilisateur obtenues √† partir du jeton.

  ```python
  # (nous supposons que le jeton contient un champ 'roles')
  def get_current_active_user(token: str = Depends(oauth2_scheme)):
      # ... nous d√©codons le jeton et obtenons l'utilisateur avec les r√¥les de la base de donn√©es
      # user = get_user_from_db(username)
      return user # retourne l'objet utilisateur

  @router.delete("/planets/{planet_id}")
  def delete_planet(
      planet_id: int,
      current_user: User = Depends(get_current_active_user)
  ):
      if "admin" not in current_user.roles:
          raise HTTPException(
              status_code=status.HTTP_403_FORBIDDEN,
              detail="Droits insuffisants pour effectuer cette op√©ration",
          )
      # ... logique de suppression ...
  ```

---

#### **5. Inspection des cargaisons et Coffre-fort secret : Validation et Variables d'environnement**

Nous avons d√©j√† impl√©ment√© ces deux points, mais il est important de souligner leur r√¥le dans la s√©curit√©.

- **Ne jamais faire confiance aux donn√©es entrantes (Validation) :**

  - Nous avons utilis√© `$request->validate()` dans Laravel et les mod√®les Pydantic dans FastAPI. Cela nous prot√®ge des **injections SQL** (lors de l'utilisation d'Eloquent/SQLAlchemy) et des donn√©es incorrectes qui pourraient casser l'application. **Toujours valider tout ce qui vient de l'ext√©rieur !**

- **Stocker les secrets dans `.env` (Variables d'environnement) :**

  - Les cl√©s de bases de donn√©es, les cl√©s secr√®tes pour JWT (`SECRET_KEY`), les cl√©s de services tiers ‚Äî tout cela ne doit **jamais** √™tre inclus dans le syst√®me de contr√¥le de version (Git). C'est pourquoi il existe des fichiers `.env` qui sont ajout√©s au `.gitignore`.

---

#### **Quiz pour la consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Pour se prot√©ger de l'interception de donn√©es sur les r√©seaux publics, on utilise :</p>
      <label><input type="radio" name="q1" value="a"> a) Rate Limiting</label>
      <label><input type="radio" name="q1" value="b"> b) HTTPS</label>
      <label><input type="radio" name="q1" value="c"> c) CORS</label>
    </div>
    <div class="question">
      <p>2. La limitation du taux de requ√™tes (Rate Limiting) prot√®ge principalement contre :</p>
      <label><input type="radio" name="q2" value="a"> a) les injections SQL</label>
      <label><input type="radio" name="q2" value="b"> b) les attaques par force brute et DoS</label>
      <label><input type="radio" name="q2" value="c"> c) le Cross-Site Scripting (XSS)</label>
    </div>
    <div class="question">
      <p>3. La question "Qu'est-ce que cet utilisateur a le droit de faire ?" est r√©solue par :</p>
      <label><input type="radio" name="q3" value="a"> a) l'Authentification</label>
      <label><input type="radio" name="q3" value="b"> b) l'Autorisation</label>
      <label><input type="radio" name="q3" value="c"> c) la Validation</label>
    </div>
    <div class="question">
      <p>4. Les cl√©s secr√®tes d'API et les mots de passe de la base de donn√©es doivent √™tre stock√©s :</p>
      <label><input type="radio" name="q4" value="a"> a) Directement dans le code pour plus de commodit√©</label>
      <label><input type="radio" name="q4" value="b"> b) Dans un d√©p√¥t public sur GitHub</label>
      <label><input type="radio" name="q4" value="c"> c) Dans un fichier `.env`, qui est exclu de Git</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'c' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> Bonne r√©ponse : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre r√©sultat : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Fin du cours**
**F√©licitations, commandant ! Vous avez men√© √† bien toutes les missions.**

Vous √™tes pass√© d'un d√©butant qui n'avait qu'entendu parler des API √† un ing√©nieur capable de concevoir, d√©velopper, documenter, s√©curiser et tester de mani√®re autonome un service web complet en utilisant deux des technologies les plus populaires de leurs √©cosyst√®mes respectifs.

Vous avez ma√Ætris√© le langage universel REST, appris Laravel et FastAPI et construit pour eux un "Centre de Contr√¥le de Mission" en JavaScript pur.

**C'est une √©norme r√©ussite.** Le monde du d√©veloppement API est d√©sormais ouvert √† vous. Continuez √† explorer, √† apprendre et √† construire des choses incroyables.

**Fin de la transmission.** üöÄ
---
<h2>‚òÑ Soutenez la mission</h2>
<p>La cr√©ation de ce tutoriel ‚Äî est un long et complexe voyage qui demande beaucoup de temps et d'√©nergie. Si ce contenu vous a √©t√© utile, vous pouvez nous aider √† remplir les r√©servoirs de carburant de notre exp√©dition.
Chaque soutien est un tour de plus sur l'orbite vers de nouveaux mat√©riaux utiles.</p>
<a href='https://ko-fi.com/K3K41JFJ32' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi4.png?v=6' border='0' alt='Buy Me a Coffee at ko-fi.com' /></a>