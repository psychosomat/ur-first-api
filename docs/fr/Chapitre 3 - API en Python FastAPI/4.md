# **Chapitre 3.4 : Op√©rations CRUD pour les vaisseaux spatiaux**
**Temps d'√©tude :** 1 heure

---

#### **1. CRUD : Cycle complet de gestion de mission spatiale**
Jusqu'√† pr√©sent, nous n'avons fait que lire des donn√©es (`Read`). Mais un v√©ritable Centre de Contr√¥le de Mission doit tout savoir faire :

- **C**reate (Cr√©er) : Lancer un nouveau satellite en orbite.
- **R**ead (Lire) : Demander le statut d'un vaisseau existant.
- **U**pdate (Mettre √† jour) : Corriger l'orbite ou mettre √† jour le logiciel.
- **D**elete (Supprimer) : D√©sorbiter un ancien satellite.

Ces quatre op√©rations ‚Äî **CRUD** ‚Äî constituent la base de la plupart des API. Dans ce chapitre, nous allons impl√©menter le cycle complet pour g√©rer notre flotte.

---

#### **2. Create : Lancement d'un nouveau vaisseau (POST)**
Pour cr√©er un nouveau vaisseau spatial, nous utiliserons la m√©thode `POST`. Les donn√©es du nouveau vaisseau seront transmises dans le corps de la requ√™te au format JSON.

**√âtape 1 : Cr√©er un nouveau mod√®le Pydantic pour les donn√©es entrantes**
Pourquoi un nouveau mod√®le est-il n√©cessaire ? Parce que lors de la cr√©ation d'un vaisseau, nous ne connaissons pas son `id` ‚Äì il doit √™tre attribu√© par le serveur.

**Ajoutez ce mod√®le √† `main.py` :**
```python
# main.py
from pydantic import BaseModel, Field

class SpaceshipCreate(BaseModel):
    """Mod√®le pour cr√©er un nouveau vaisseau (sans ID)."""
    name: str = Field(..., min_length=3, max_length=50)
    type: str
    launch_year: int = Field(..., gt=1950)
    status: str
```
Ce mod√®le est presque identique √† `Spaceship`, mais il sera utilis√© pour la **validation des donn√©es entrantes**.

**√âtape 2 : Impl√©menter le point d'acc√®s `POST /spaceships`**
```python
# main.py
import random # Ajoutez cet import en haut du fichier

# ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...

@app.post("/spaceships", response_model=Spaceship, status_code=201)
def create_spaceship(ship: SpaceshipCreate):
    """
    Ajoute un nouveau vaisseau spatial au registre.
    """
    # G√©n√©rer un nouvel ID unique pour le vaisseau
    new_id = max(db_spaceships.keys() or [0]) + 1

    # Cr√©er un objet vaisseau correspondant au mod√®le Spaceship complet
    new_ship = Spaceship(id=new_id, **ship.dict())

    # Sauvegarder dans notre "base de donn√©es"
    db_spaceships[new_id] = new_ship.dict()

    return new_ship
```
**Explication :**

- `@app.post(...)` : Utilise le d√©corateur pour les requ√™tes `POST`.
- `status_code=201` : Indique qu'un statut `201 Created` doit √™tre renvoy√© en cas de cr√©ation r√©ussie.
- `ship: SpaceshipCreate` : Voici la magie ! FastAPI prendra automatiquement le corps de la requ√™te (JSON), le validera selon le mod√®le `SpaceshipCreate` et le passera √† la fonction comme un objet `ship`.
- `new_id = ...` : Logique simple pour g√©n√©rer un nouvel ID.
- `**ship.dict()` : Nous "d√©ballons" les donn√©es du mod√®le `ship` re√ßu dans notre mod√®le complet.
- `response_model=Spaceship` : La r√©ponse correspondra au mod√®le complet, incluant l'`id`.

---

#### **3. Update : Correction de cap (PUT)**
La m√©thode `PUT` est utilis√©e pour la mise √† jour compl√®te d'une ressource existante.

**Impl√©menter le point d'acc√®s `PUT /spaceships/{ship_id}` :**
```python
# main.py
from fastapi import FastAPI, HTTPException # Mettez √† jour l'import

# ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...

@app.put("/spaceships/{ship_id}", response_model=Spaceship)
def update_spaceship(ship_id: int, ship_update: SpaceshipCreate):
    """
    Met √† jour compl√®tement les donn√©es d'un vaisseau spatial.
    """
    if ship_id not in db_spaceships:
        raise HTTPException(status_code=404, detail="Vaisseau spatial non trouv√©")

    updated_ship = Spaceship(id=ship_id, **ship_update.dict())
    db_spaceships[ship_id] = updated_ship.dict()

    return updated_ship
```

- `ship_update: SpaceshipCreate` : Nous utilisons √† nouveau notre mod√®le pour la validation des donn√©es entrantes.
- `HTTPException` : Si le vaisseau avec cet `id` n'est pas trouv√©, nous "levons" une exception FastAPI standard, qui se transformera en une belle r√©ponse JSON avec le code `404`.

---

#### **4. Delete : D√©sorbitation (DELETE)**
La m√©thode `DELETE` est utilis√©e pour supprimer une ressource. Habituellement, ce point d'acc√®s ne renvoie pas de corps de r√©ponse.

**Impl√©menter le point d'acc√®s `DELETE /spaceships/{ship_id}` :**
```python
# main.py
from fastapi import FastAPI, HTTPException, Response, status # Mettez √† jour l'import

# ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...

@app.delete("/spaceships/{ship_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_spaceship(ship_id: int):
    """
    Supprime un vaisseau spatial du registre.
    """
    if ship_id not in db_spaceships:
        raise HTTPException(status_code=404, detail="Vaisseau spatial non trouv√©")

    del db_spaceships[ship_id]

    # Retourne une r√©ponse vide avec le statut 204
    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

- `status_code=status.HTTP_204_NO_CONTENT` : Nous indiquons explicitement le statut `204 No Content`.
- `del db_spaceships[ship_id]` : Supprime l'entr√©e de notre dictionnaire.
- `return Response(...)` : Retourne une r√©ponse vide, car le client n'a pas besoin de donn√©es sur l'objet supprim√©.

---

#### **5. Test du cycle complet dans `/docs`**
Votre `uvicorn` devrait s'√™tre recharg√©.

1.  **Ouvrez `http://127.0.0.1:8000/docs`**. Vous disposez maintenant d'un ensemble complet d'op√©rations CRUD !
2.  **POST :** D√©veloppez le point d'acc√®s `POST /spaceships`, cliquez sur "Try it out", remplissez le corps JSON (par exemple, cr√©ez le "James Webb Telescope") et cliquez sur "Execute". Vous devriez recevoir une r√©ponse `201` avec les donn√©es du nouveau t√©lescope.
3.  **GET :** Ex√©cutez maintenant `GET /spaceships`. Votre nouveau t√©lescope devrait appara√Ætre dans la liste.
4.  **PUT :** Utilisez l'ID du nouveau t√©lescope pour mettre √† jour ses donn√©es via `PUT /spaceships/{ship_id}`. Par exemple, modifiez son statut.
5.  **DELETE :** Utilisez le m√™me ID pour supprimer le t√©lescope via `DELETE /spaceships/{ship_id}`. Vous devriez recevoir une r√©ponse vide avec le statut `204`.
6.  **V√©rification :** Ex√©cutez √† nouveau `GET /spaceships` pour vous assurer que le t√©lescope a √©t√© supprim√© de la liste.

---

#### **Quiz pour la consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Quelle m√©thode HTTP est utilis√©e pour cr√©er une nouvelle ressource ?</p>
      <label><input type="radio" name="q1" value="a"> a) GET</label>
      <label><input type="radio" name="q1" value="b"> b) PUT</label>
      <label><input type="radio" name="q1" value="c"> c) POST</label>
    </div>
    <div class="question">
      <p>2. Le code de statut de succ√®s standard pour une op√©ration `DELETE` :</p>
      <label><input type="radio" name="q2" value="a"> a) 200 OK</label>
      <label><input type="radio" name="q2" value="b"> b) 204 No Content</label>
      <label><input type="radio" name="q2" value="c"> c) 404 Not Found</label>
    </div>
    <div class="question">
      <p>3. Comment FastAPI re√ßoit-il les donn√©es du corps d'une requ√™te POST ?</p>
      <label><input type="radio" name="q3" value="a"> a) Via la variable globale `$_POST`</label>
      <label><input type="radio" name="q3" value="b"> b) Automatiquement, si un mod√®le Pydantic est sp√©cifi√© dans l'argument de la fonction</label>
      <label><input type="radio" name="q3" value="c"> c) Il faut lire manuellement le flux `request.body`</label>
    </div>
    <div class="question">
      <p>4. `raise HTTPException(status_code=404)` est utilis√© pour :</p>
      <label><input type="radio" name="q4" value="a"> a) G√©n√©rer une erreur serveur fatale (500)</label>
      <label><input type="radio" name="q4" value="b"> b) Retourner une r√©ponse HTTP correcte avec une erreur au client</label>
      <label><input type="radio" name="q4" value="c"> c) Enregistrer l'erreur dans un fichier</label>
    </div>
    <div class="question">
      <p>5. Pourquoi avons-nous cr√©√© un mod√®le `SpaceshipCreate` s√©par√© pour la cr√©ation de ressources (`POST`) ?</p>
      <label><input type="radio" name="q5" value="a"> a) Parce que l'objet cr√©√© n'a pas encore d'`id`</label>
      <label><input type="radio" name="q5" value="b"> b) Parce que FastAPI exige des noms de mod√®les diff√©rents pour chaque point d'acc√®s</label>
      <label><input type="radio" name="q5" value="c"> c) Pour acc√©l√©rer la validation</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:red;">Incorrect.</span> R√©ponse correcte : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre score : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ R√©sum√© du chapitre :**

Vous avez impl√©ment√© un **cycle CRUD** complet et transform√© votre API d'un simple "tableau d'information" en un v√©ritable **Centre de Contr√¥le de Flotte** !

- ‚úÖ **C**reate : `POST /spaceships` pour lancer de nouveaux vaisseaux.
- ‚úÖ **R**ead : `GET /spaceships` et `GET /spaceships/{id}` pour obtenir les donn√©es.
- ‚úÖ **U**pdate : `PUT /spaceships/{id}` pour mettre √† jour les missions.
- ‚úÖ **D**elete : `DELETE /spaceships/{id}` pour d√©sorbiter les vaisseaux.

**Votre flotte est sous contr√¥le total !** Dans le prochain chapitre, nous verrons comment FastAPI a automatiquement cr√©√© pour nous un "manuel d'utilisation" d√©taill√© ‚Äì la documentation interactive Swagger.

> **üìå V√©rification :**

> - Les 5 points d'acc√®s (`GET` (2), `POST`, `PUT`, `DELETE`) sont visibles et fonctionnent dans `/docs`.
> - Vous pouvez cr√©er, lire, mettre √† jour et supprimer une ressource avec succ√®s.
> - Lors d'une requ√™te avec un ID inexistant, une erreur `404` est renvoy√©e.

> **‚ö†Ô∏è En cas d'erreurs :**

> - `NameError` : V√©rifiez que vous avez import√© `HTTPException`, `Response`, `status`.
> - `KeyError` : Il est probable que vous essayiez d'acc√©der √† un ID d√©j√† supprim√©.
> - Fonctionnement incorrect de `PUT` ou `POST` : Assurez-vous d'utiliser le bon mod√®le Pydantic dans l'argument de la fonction (`SpaceshipCreate`).