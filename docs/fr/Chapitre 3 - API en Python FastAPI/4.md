# **Chapitre 3.4 : Opérations CRUD pour les vaisseaux spatiaux**
**Temps d'étude :** 1 heure

---

#### **1. CRUD : Cycle complet de gestion de mission spatiale**
Jusqu'à présent, nous n'avons fait que lire des données (`Read`). Mais un véritable Centre de Contrôle de Mission doit tout savoir faire :

- **C**reate (Créer) : Lancer un nouveau satellite en orbite.
- **R**ead (Lire) : Demander le statut d'un vaisseau existant.
- **U**pdate (Mettre à jour) : Corriger l'orbite ou mettre à jour le logiciel.
- **D**elete (Supprimer) : Désorbiter un ancien satellite.

Ces quatre opérations — **CRUD** — constituent la base de la plupart des API. Dans ce chapitre, nous allons implémenter le cycle complet pour gérer notre flotte.

---

#### **2. Create : Lancement d'un nouveau vaisseau (POST)**
Pour créer un nouveau vaisseau spatial, nous utiliserons la méthode `POST`. Les données du nouveau vaisseau seront transmises dans le corps de la requête au format JSON.

**Étape 1 : Créer un nouveau modèle Pydantic pour les données entrantes**
Pourquoi un nouveau modèle est-il nécessaire ? Parce que lors de la création d'un vaisseau, nous ne connaissons pas son `id` – il doit être attribué par le serveur.

**Ajoutez ce modèle à `main.py` :**
```python
# main.py
from pydantic import BaseModel, Field

class SpaceshipCreate(BaseModel):
    """Modèle pour créer un nouveau vaisseau (sans ID)."""
    name: str = Field(..., min_length=3, max_length=50)
    type: str
    launch_year: int = Field(..., gt=1950)
    status: str
```
Ce modèle est presque identique à `Spaceship`, mais il sera utilisé pour la **validation des données entrantes**.

**Étape 2 : Implémenter le point d'accès `POST /spaceships`**
```python
# main.py
import random # Ajoutez cet import en haut du fichier

# ... остальной код ...

@app.post("/spaceships", response_model=Spaceship, status_code=201)
def create_spaceship(ship: SpaceshipCreate):
    """
    Ajoute un nouveau vaisseau spatial au registre.
    """
    # Générer un nouvel ID unique pour le vaisseau
    new_id = max(db_spaceships.keys() or [0]) + 1

    # Créer un objet vaisseau correspondant au modèle Spaceship complet
    new_ship = Spaceship(id=new_id, **ship.dict())

    # Sauvegarder dans notre "base de données"
    db_spaceships[new_id] = new_ship.dict()

    return new_ship
```
**Explication :**

- `@app.post(...)` : Utilise le décorateur pour les requêtes `POST`.
- `status_code=201` : Indique qu'un statut `201 Created` doit être renvoyé en cas de création réussie.
- `ship: SpaceshipCreate` : Voici la magie ! FastAPI prendra automatiquement le corps de la requête (JSON), le validera selon le modèle `SpaceshipCreate` et le passera à la fonction comme un objet `ship`.
- `new_id = ...` : Logique simple pour générer un nouvel ID.
- `**ship.dict()` : Nous "déballons" les données du modèle `ship` reçu dans notre modèle complet.
- `response_model=Spaceship` : La réponse correspondra au modèle complet, incluant l'`id`.

---

#### **3. Update : Correction de cap (PUT)**
La méthode `PUT` est utilisée pour la mise à jour complète d'une ressource existante.

**Implémenter le point d'accès `PUT /spaceships/{ship_id}` :**
```python
# main.py
from fastapi import FastAPI, HTTPException # Mettez à jour l'import

# ... остальной код ...

@app.put("/spaceships/{ship_id}", response_model=Spaceship)
def update_spaceship(ship_id: int, ship_update: SpaceshipCreate):
    """
    Met à jour complètement les données d'un vaisseau spatial.
    """
    if ship_id not in db_spaceships:
        raise HTTPException(status_code=404, detail="Vaisseau spatial non trouvé")

    updated_ship = Spaceship(id=ship_id, **ship_update.dict())
    db_spaceships[ship_id] = updated_ship.dict()

    return updated_ship
```

- `ship_update: SpaceshipCreate` : Nous utilisons à nouveau notre modèle pour la validation des données entrantes.
- `HTTPException` : Si le vaisseau avec cet `id` n'est pas trouvé, nous "levons" une exception FastAPI standard, qui se transformera en une belle réponse JSON avec le code `404`.

---

#### **4. Delete : Désorbitation (DELETE)**
La méthode `DELETE` est utilisée pour supprimer une ressource. Habituellement, ce point d'accès ne renvoie pas de corps de réponse.

**Implémenter le point d'accès `DELETE /spaceships/{ship_id}` :**
```python
# main.py
from fastapi import FastAPI, HTTPException, Response, status # Mettez à jour l'import

# ... остальной код ...

@app.delete("/spaceships/{ship_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_spaceship(ship_id: int):
    """
    Supprime un vaisseau spatial du registre.
    """
    if ship_id not in db_spaceships:
        raise HTTPException(status_code=404, detail="Vaisseau spatial non trouvé")

    del db_spaceships[ship_id]

    # Retourne une réponse vide avec le statut 204
    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

- `status_code=status.HTTP_204_NO_CONTENT` : Nous indiquons explicitement le statut `204 No Content`.
- `del db_spaceships[ship_id]` : Supprime l'entrée de notre dictionnaire.
- `return Response(...)` : Retourne une réponse vide, car le client n'a pas besoin de données sur l'objet supprimé.

---

#### **5. Test du cycle complet dans `/docs`**
Votre `uvicorn` devrait s'être rechargé.

1.  **Ouvrez `http://127.0.0.1:8000/docs`**. Vous disposez maintenant d'un ensemble complet d'opérations CRUD !
2.  **POST :** Développez le point d'accès `POST /spaceships`, cliquez sur "Try it out", remplissez le corps JSON (par exemple, créez le "James Webb Telescope") et cliquez sur "Execute". Vous devriez recevoir une réponse `201` avec les données du nouveau télescope.
3.  **GET :** Exécutez maintenant `GET /spaceships`. Votre nouveau télescope devrait apparaître dans la liste.
4.  **PUT :** Utilisez l'ID du nouveau télescope pour mettre à jour ses données via `PUT /spaceships/{ship_id}`. Par exemple, modifiez son statut.
5.  **DELETE :** Utilisez le même ID pour supprimer le télescope via `DELETE /spaceships/{ship_id}`. Vous devriez recevoir une réponse vide avec le statut `204`.
6.  **Vérification :** Exécutez à nouveau `GET /spaceships` pour vous assurer que le télescope a été supprimé de la liste.

---

#### **Quiz pour la consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Quelle méthode HTTP est utilisée pour créer une nouvelle ressource ?</p>
      <label><input type="radio" name="q1" value="a"> a) GET</label>
      <label><input type="radio" name="q1" value="b"> b) PUT</label>
      <label><input type="radio" name="q1" value="c"> c) POST</label>
    </div>
    <div class="question">
      <p>2. Le code de statut de succès standard pour une opération `DELETE` :</p>
      <label><input type="radio" name="q2" value="a"> a) 200 OK</label>
      <label><input type="radio" name="q2" value="b"> b) 204 No Content</label>
      <label><input type="radio" name="q2" value="c"> c) 404 Not Found</label>
    </div>
    <div class="question">
      <p>3. Comment FastAPI reçoit-il les données du corps d'une requête POST ?</p>
      <label><input type="radio" name="q3" value="a"> a) Via la variable globale `$_POST`</label>
      <label><input type="radio" name="q3" value="b"> b) Automatiquement, si un modèle Pydantic est spécifié dans l'argument de la fonction</label>
      <label><input type="radio" name="q3" value="c"> c) Il faut lire manuellement le flux `request.body`</label>
    </div>
    <div class="question">
      <p>4. `raise HTTPException(status_code=404)` est utilisé pour :</p>
      <label><input type="radio" name="q4" value="a"> a) Générer une erreur serveur fatale (500)</label>
      <label><input type="radio" name="q4" value="b"> b) Retourner une réponse HTTP correcte avec une erreur au client</label>
      <label><input type="radio" name="q4" value="c"> c) Enregistrer l'erreur dans un fichier</label>
    </div>
    <div class="question">
      <p>5. Pourquoi avons-nous créé un modèle `SpaceshipCreate` séparé pour la création de ressources (`POST`) ?</p>
      <label><input type="radio" name="q5" value="a"> a) Parce que l'objet créé n'a pas encore d'`id`</label>
      <label><input type="radio" name="q5" value="b"> b) Parce que FastAPI exige des noms de modèles différents pour chaque point d'accès</label>
      <label><input type="radio" name="q5" value="c"> c) Pour accélérer la validation</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Vérifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Résultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:red;">Incorrect.</span> Réponse correcte : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:orange;">Pas de réponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre score : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**🚀 Résumé du chapitre :**

Vous avez implémenté un **cycle CRUD** complet et transformé votre API d'un simple "tableau d'information" en un véritable **Centre de Contrôle de Flotte** !

- ✅ **C**reate : `POST /spaceships` pour lancer de nouveaux vaisseaux.
- ✅ **R**ead : `GET /spaceships` et `GET /spaceships/{id}` pour obtenir les données.
- ✅ **U**pdate : `PUT /spaceships/{id}` pour mettre à jour les missions.
- ✅ **D**elete : `DELETE /spaceships/{id}` pour désorbiter les vaisseaux.

**Votre flotte est sous contrôle total !** Dans le prochain chapitre, nous verrons comment FastAPI a automatiquement créé pour nous un "manuel d'utilisation" détaillé – la documentation interactive Swagger.

> **📌 Vérification :**

> - Les 5 points d'accès (`GET` (2), `POST`, `PUT`, `DELETE`) sont visibles et fonctionnent dans `/docs`.
> - Vous pouvez créer, lire, mettre à jour et supprimer une ressource avec succès.
> - Lors d'une requête avec un ID inexistant, une erreur `404` est renvoyée.

> **⚠️ En cas d'erreurs :**

> - `NameError` : Vérifiez que vous avez importé `HTTPException`, `Response`, `status`.
> - `KeyError` : Il est probable que vous essayiez d'accéder à un ID déjà supprimé.
> - Fonctionnement incorrect de `PUT` ou `POST` : Assurez-vous d'utiliser le bon modèle Pydantic dans l'argument de la fonction (`SpaceshipCreate`).