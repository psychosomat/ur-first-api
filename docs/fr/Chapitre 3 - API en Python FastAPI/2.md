# **Chapitre 3.2 : Cr√©ation du premier endpoint d'API**
**Temps d'√©tude :** 30 minutes

---

#### **1. Endpoint : Le port d'amarrage des donn√©es**
Imaginez que notre API est une station spatiale. Un **endpoint** (point d'extr√©mit√©) est un **port d'amarrage** sp√©cifique, con√ßu pour un certain type de vaisseaux.

- Port `N¬∞1` ‚Äî pour les cargos (donn√©es sur les plan√®tes).
- Port `N¬∞2` ‚Äî pour les sondes d'exploration (donn√©es sur les missions).
- Port `N¬∞3` ‚Äî pour les navettes de passagers (donn√©es sur les astronautes).

Chaque endpoint est une URL unique qui est responsable d'une op√©ration sp√©cifique avec une ressource particuli√®re.

> üí° **Analogie spatiale :**
> `GET /spaceships` ‚Äî c'est la commande "Centre de Contr√¥le ‚Üí Station : Rapportez la liste de tous les vaisseaux amarr√©s". Cet endpoint renvoie une collection de ressources.

---

#### **2. Cr√©ation de la "flotte spatiale"**
Pour l'instant, nous n'avons pas de base de donn√©es, nous allons donc cr√©er une "simulation" ‚Äî une simple liste de vaisseaux spatiaux sous forme de dictionnaire Python.

**Ouvrez `main.py` et ajoutez ce code avant la d√©finition de `app` :**
```python
# main.py

# √âtape 1 : Cr√©ation d'une simulation de base de donn√©es
db_spaceships = {
    1: {
        "name": "Voyager-1",
        "type": "–ó–æ–Ω–¥",
        "launch_year": 1977,
        "status": "–ê–∫—Ç–∏–≤–µ–Ω"
    },
    2: {
        "name": "Hubble Space Telescope",
        "type": "–¢–µ–ª–µ—Å–∫–æ–ø",
        "launch_year": 1990,
        "status": "–ê–∫—Ç–∏–≤–µ–Ω"
    },
    3: {
        "name": "ISS",
        "type": "–°—Ç–∞–Ω—Ü–∏—è",
        "launch_year": 1998,
        "status": "–ù–∞ –æ—Ä–±–∏—Ç–µ"
    }
}

# ... ici le code app = FastAPI()
```
C'est notre "registre des vaisseaux spatiaux" avec lequel nous allons travailler.

---

#### **3. Premier endpoint : Liste des vaisseaux**
Nous allons maintenant cr√©er un endpoint qui renverra l'ensemble de notre flotte.

**Ajoutez ce code dans `main.py` apr√®s `@app.get("/")` :**
```python
# main.py

# ... code avec db_spaceships, FastAPI, app et read_root() ...

@app.get("/spaceships")
def get_spaceships():
    """
    Renvoie la liste de tous les vaisseaux spatiaux enregistr√©s.
    """
    return db_spaceships
```

- `@app.get("/spaceships")` : Nous avons cr√©√© une nouvelle route. D√©sormais, les requ√™tes `GET` vers l'URL `/spaceships` seront g√©r√©es par la fonction `get_spaceships`.
- `return db_spaceships` : FastAPI convertit automatiquement le dictionnaire Python en une r√©ponse JSON valide.

---

#### **4. V√©rification du fonctionnement du nouveau port d'amarrage**
Si votre serveur `uvicorn` est toujours en cours d'ex√©cution avec le drapeau `--reload`, il s'est d√©j√† recharg√© et est pr√™t √† fonctionner. Sinon, relancez-le :
```bash
uvicorn main:app --reload
```

**√âtape 1 : V√©rification dans le navigateur**

Ouvrez l'adresse `http://127.0.0.1:8000/spaceships` dans votre navigateur.
Vous devriez voir la liste compl√®te de vos vaisseaux au format JSON :
```json
{
  "1": {
    "name": "Voyager-1",
    "type": "–ó–æ–Ω–¥",
    "launch_year": 1977,
    "status": "–ê–∫—Ç–∏–≤–µ–Ω"
  },
  "2": {
    "name": "Hubble Space Telescope",
    "type": "–¢–µ–ª–µ—Å–∫–æ–ø",
    "launch_year": 1990,
    "status": "–ê–∫—Ç–∏–≤–µ–Ω"
  },
  "3": {
    "name": "ISS",
    "type": "–°—Ç–∞–Ω—Ü–∏—è",
    "launch_year": 1998,
    "status": "–ù–∞ –æ—Ä–±–∏—Ç–µ"
  }
}
```

**√âtape 2 : V√©rification dans la documentation automatique**

Rendez-vous sur `http://127.0.0.1:8000/docs`. Vous verrez qu'une nouvelle section est apparue dans la documentation pour l'endpoint `GET /spaceships`. Vous pouvez cliquer sur "Try it out" et "Execute" pour le tester directement de l√† !

---

#### **5. Endpoint avec param√®tre : Donn√©es sur un vaisseau sp√©cifique**
Et si nous n'avons besoin des donn√©es que sur le "Voyager-1" ? Pour cela, nous allons cr√©er un endpoint avec un **param√®tre de chemin (path parameter)**.

**Ajoutez ce code dans `main.py` :**
```python
# main.py

# ... le reste du code ...

@app.get("/spaceships/{ship_id}")
def get_spaceship(ship_id: int):
    """
    Renvoie les donn√©es d'un vaisseau spatial sp√©cifique par son ID.
    """
    return db_spaceships.get(ship_id)
```

- `"/spaceships/{ship_id}"` : Les accolades `{}` indiquent √† FastAPI que `ship_id` est une variable qui sera transmise depuis l'URL.
- `ship_id: int` : C'est une **indication de type (type hint)**. FastAPI v√©rifiera automatiquement que l'ID transmis est un nombre entier. Si quelqu'un demande `/spaceships/voyager`, FastAPI renverra une erreur de validation `422 Unprocessable Entity`. C'est de la magie !

**V√©rification :**

Ouvrez `http://127.0.0.1:8000/spaceships/2`. Vous devriez obtenir uniquement les donn√©es du t√©lescope "Hubble". Et si vous ouvrez `http://127.0.0.1:8000/spaceships/99`, vous obtiendrez `null`, car ce vaisseau n'existe pas.

---

#### **Quiz pour la consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Un endpoint dans une API est...</p>
      <label><input type="radio" name="q1" value="a"> a) Le point final de l'Univers</label>
      <label><input type="radio" name="q1" value="b"> b) Une URL unique pour une op√©ration sp√©cifique avec une ressource</label>
      <label><input type="radio" name="q1" value="c"> c) Le nom d'une base de donn√©es</label>
    </div>
    <div class="question">
      <p>2. Que fait le d√©corateur `@app.get("/users")` ?</p>
      <label><input type="radio" name="q2" value="a"> a) Cr√©e un nouvel utilisateur</label>
      <label><input type="radio" name="q2" value="b"> b) Associe une fonction √† une requ√™te GET sur `/users`</label>
      <label><input type="radio" name="q2" value="c"> c) Obtient la liste de tous les d√©corateurs</label>
    </div>
    <div class="question">
      <p>3. Que signifie l'√©criture `"/items/{item_id}"` dans le chemin ?</p>
      <label><input type="radio" name="q3" value="a"> a) Qu'il faut chercher un dossier nomm√© `{item_id}`</label>
      <label><input type="radio" name="q3" value="b"> b) Que `item_id` est un param√®tre qui sera extrait de l'URL</label>
      <label><input type="radio" name="q3" value="c"> c) C'est un commentaire qui sera ignor√©</label>
    </div>
    <div class="question">
      <p>4. Pourquoi l'indication de type `ship_id: int` est-elle n√©cessaire dans la fonction ?</p>
      <label><input type="radio" name="q4" value="a"> a) Pour que Python fonctionne plus vite</label>
      <label><input type="radio" name="q4" value="b"> b) Pour que FastAPI valide automatiquement que l'ID est un nombre</label>
      <label><input type="radio" name="q4" value="c"> c) Pour que la variable soit visible en dehors de la fonction</label>
    </div>
    <div class="question">
      <p>5. Si vous demandez `/spaceships/abc` et que FastAPI attend un `int`, que se passera-t-il ?</p>
      <label><input type="radio" name="q5" value="a"> a) Le serveur "plantera" avec une erreur 500</label>
      <label><input type="radio" name="q5" value="b"> b) FastAPI renverra une erreur 422</label>
      <label><input type="radio" name="q5" value="c"> c) FastAPI tentera de convertir "abc" en nombre</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:red;">Incorrect.</span> R√©ponse correcte : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre r√©sultat : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ R√©sum√© du chapitre :**

Vous avez cr√©√© avec succ√®s deux "ports d'amarrage" sur votre station spatiale API :

- üõ∞Ô∏è Un pour obtenir la liste de tous les vaisseaux (`/spaceships`)
- üî≠ Le second pour obtenir les donn√©es d'un appareil sp√©cifique (`/spaceships/{ship_id}`)

Vous avez √©galement d√©couvert la puissance de la validation automatique des types de FastAPI, qui prot√®ge votre API contre les requ√™tes incorrectes.

**Le syst√®me de navigation est configur√© !** Dans le prochain chapitre, nous allons cr√©er les "plans" de nos vaisseaux spatiaux √† l'aide de Pydantic, afin de rendre notre API encore plus intelligente et fiable.

> **üìå V√©rification :**

> - Le serveur `uvicorn` est lanc√© et fonctionne.
> - L'URL `http://127.0.0.1:8000/spaceships` renvoie un JSON avec la liste des vaisseaux.
> - L'URL `http://127.0.0.1:8000/spaceships/1` renvoie les donn√©es du "Voyager-1".
> - L'URL `http://127.0.0.1:8000/docs` affiche deux nouveaux endpoints.

> **‚ö†Ô∏è En cas d'erreurs :**

> - **404 Not Found :** V√©rifiez si l'URL est correctement √©crite dans le navigateur et dans le d√©corateur `@app.get(...)`.
> - **Erreur de code :** V√©rifiez attentivement la syntaxe, en particulier l'indentation en Python et les virgules dans le dictionnaire.