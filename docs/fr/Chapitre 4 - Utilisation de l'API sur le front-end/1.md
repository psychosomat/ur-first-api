```markdown
# **Chapitre 4.1 : Les bases de l'API Fetch**
**Temps d'√©tude :** 45 minutes

---

#### **1. API Fetch : L'"antenne principale" du Centre de Contr√¥le de Mission**
Imaginez que dans votre Centre de Contr√¥le de Mission, vous disposiez d'une **√©norme antenne radio** pour communiquer avec les engins spatiaux. Vous pouvez la r√©gler sur la bonne fr√©quence, envoyer une commande et attendre une r√©ponse.

L'**API Fetch** est une "antenne int√©gr√©e" similaire dans les navigateurs modernes. C'est une interface JavaScript standard pour effectuer des requ√™tes HTTP vers des serveurs. Elle permet de :

- üì° Envoyer des "commandes" (GET, POST, PUT, DELETE) √† notre API.
- üõ∞Ô∏è Recevoir des "donn√©es de t√©l√©m√©trie" (donn√©es JSON) du serveur.
- ‚öôÔ∏è Travailler de mani√®re asynchrone, sans "bloquer" l'interface utilisateur en attendant une r√©ponse.

> üí° **Analogie spatiale :**

> La fonction `fetch()` est la commande "Antenne, √©tablir la connexion !". Vous lui transmettez :

> - Les **coordonn√©es de la cible** (l'URL de notre API).
> - Le **type de commande** (m√©thode : GET, POST).
> - Le **contenu de la commande** (corps de la requ√™te, en-t√™tes).

> En r√©ponse, vous ne recevez pas les donn√©es elles-m√™mes, mais une **promesse (Promise)** que les donn√©es arriveront.

---

#### **2. Asynchronisme : Communication √† la vitesse de la lumi√®re**
La communication avec un vaisseau spatial lointain prend du temps. Vous ne pouvez pas simplement arr√™ter tout le travail du Centre de Contr√¥le de Mission et attendre la r√©ponse. Vous envoyez une commande et **continuez √† travailler**, et lorsque la r√©ponse arrive, le syst√®me vous en informe.

C'est cela l'**asynchronisme**. JavaScript ne bloque pas l'ex√©cution du reste du code pendant qu'il attend une r√©ponse du serveur. Pour g√©rer ce processus, l'API Fetch utilise les **Promesses (Promises)**.

Une **Promesse (Promise)** est un "re√ßu" indiquant que vous avez envoy√© une requ√™te. Elle a trois √©tats :

- **`pending` (en attente) :** Le signal est toujours en cours de transmission.
- **`fulfilled` (r√©alis√©e) :** La r√©ponse a √©t√© re√ßue avec succ√®s !
- **`rejected` (rejet√©e) :** Une erreur s'est produite (par exemple, pas de connexion).

---

#### **3. Premi√®re requ√™te : D√©couvrir la position de l'ISS**
Envoyons notre premi√®re requ√™te √† l'aide de `fetch`. Nous utiliserons un simple fichier HTML et des balises `<script>`.

**√âtape 1 : Cr√©ation de `index.html`**
Cr√©ez un fichier `index.html` dans un nouveau dossier (par exemple, `frontend_fleet_control`).
```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Centre de Contr√¥le de Mission - API Fetch</title>
</head>
<body>
    <h1>Statut de la communication avec l'ISS</h1>
    <div id="iss-status">En attente de donn√©es...</div>

    <script>
        // Notre code JavaScript sera ici
    </script>
</body>
</html>
```

**√âtape 2 : √âcrire le code avec `fetch`**
√Ä l'int√©rieur de la balise `<script>`, ajoutons notre premi√®re requ√™te `fetch` vers l'API publique Open Notify.
```javascript
// index.html -> <script>

const issApiUrl = 'http://api.open-notify.org/iss-now.json';
const statusDiv = document.getElementById('iss-status');

console.log('Envoi de la requ√™te pour obtenir les coordonn√©es de l\'ISS...');

fetch(issApiUrl)
    .then(response => {
        // Le premier .then() traite la r√©ponse HTTP elle-m√™me
        console.log('R√©ponse re√ßue du serveur !', response);
        // Convertissons le corps de la r√©ponse en JSON, c'est aussi une op√©ration asynchrone
        return response.json();
    })
    .then(data => {
        // Le second .then() re√ßoit les donn√©es JSON d√©j√† analys√©es
        console.log('Donn√©es converties en JSON avec succ√®s !', data);
        const position = data.iss_position;
        statusDiv.innerHTML = `L'ISS se trouve actuellement ici :
                               <strong>Latitude :</strong> ${position.latitude},
                               <strong>Longitude :</strong> ${position.longitude}`;
    })
    .catch(error => {
        // .catch() sera d√©clench√© si une erreur r√©seau se produit
        console.error('Erreur de communication avec l\'ISS !', error);
        statusDiv.textContent = 'Impossible de r√©cup√©rer les donn√©es. V√©rifiez votre connexion.';
    });
```

- **`fetch(url)` :** Envoie une requ√™te GET. Renvoie une promesse.
- **`.then(callback)` :** S'ex√©cute lorsque la promesse est r√©solue avec succ√®s (`fulfilled`). Le premier `.then` re√ßoit un objet `Response`.
- **`response.json()` :** M√©thode qui lit le corps de la r√©ponse et l'analyse comme du JSON. Elle renvoie √©galement une promesse !
- **`.catch(callback)` :** S'ex√©cute si la promesse est rejet√©e (`rejected`), par exemple en raison d'une erreur r√©seau.

**√âtape 3 : Ouvrir dans le navigateur**
Ouvrez simplement le fichier `index.html` dans votre navigateur. Vous devriez voir "En attente de donn√©es..." se transformer en coordonn√©es actuelles de l'ISS. Ouvrez la console d√©veloppeur (F12) pour voir les logs.

---

#### **4. "Et si..." : Gestion des erreurs du serveur**
Et si nous requ√™tions une URL inexistante ?
`fetch('http://api.open-notify.org/non-existent-endpoint')`

L'API `fetch` est con√ßue de telle sorte que `.catch()` ne se d√©clenche qu'en cas d'**erreurs r√©seau** (pas d'internet, DNS introuvable). Cependant, les r√©ponses avec les codes `404` ou `500` sont consid√©r√©es par `fetch` comme une **r√©ponse re√ßue avec succ√®s** ! Elle contient simplement un code d'erreur.

**La bonne fa√ßon de v√©rifier :**
```javascript
fetch('http://api.open-notify.org/non-existent-endpoint')
    .then(response => {
        // V√©rifions la propri√©t√© .ok, qui est vraie pour les statuts 200-299
        if (!response.ok) {
            // Si la r√©ponse n'est pas "OK", cr√©ons notre propre erreur pour passer au .catch()
            throw new Error(`Erreur HTTP ! Statut : ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(data);
    })
    .catch(error => {
        console.error('Une erreur s\'est produite lors de l\'ex√©cution de la requ√™te :', error);
    });
```

- `response.ok` : C'est votre principal indicateur de succ√®s.
- `throw new Error()` : Nous "√©chouons" manuellement la cha√Æne de promesses pour entrer dans le bloc `.catch`.

---

#### **Quiz de consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. L'API Fetch est...</p>
      <label><input type="radio" name="q1" value="a"> a) Une biblioth√®que externe qu'il faut t√©l√©charger</label>
      <label><input type="radio" name="q1" value="b"> b) Une interface int√©gr√©e au navigateur pour les requ√™tes HTTP</label>
      <label><input type="radio" name="q1" value="c"> c) Un langage de programmation pour le travail r√©seau</label>
    </div>
    <div class="question">
      <p>2. Que renvoie l'appel `fetch(url)` ?</p>
      <label><input type="radio" name="q2" value="a"> a) Directement les donn√©es JSON</label>
      <label><input type="radio" name="q2" value="b"> b) Un objet `Promise` (promesse)</label>
      <label><input type="radio" name="q2" value="c"> c) Une page HTML</label>
    </div>
    <div class="question">
      <p>3. La m√©thode `.then()` dans une cha√Æne de promesses est appel√©e lorsque...</p>
      <label><input type="radio" name="q3" value="a"> a) Une erreur r√©seau se produit</label>
      <label><input type="radio" name="q3" value="b"> b) La requ√™te est ex√©cut√©e avec succ√®s</label>
      <label><input type="radio" name="q3" value="c"> c) L'utilisateur ferme l'onglet</label>
    </div>
    <div class="question">
      <p>4. La m√©thode `response.json()` est utilis√©e pour...</p>
      <label><input type="radio" name="q4" value="a"> a) Convertir le corps de la r√©ponse en un objet JavaScript</label>
      <label><input type="radio" name="q4" value="b"> b) V√©rifier si la r√©ponse est un JSON valide</label>
      <label><input type="radio" name="q4" value="c"> c) Envoyer des donn√©es au serveur au format JSON</label>
    </div>
    <div class="question">
      <p>5. Comment v√©rifier correctement que le serveur n'a pas renvoy√© d'erreur (par exemple, 404) ?</p>
      <label><input type="radio" name="q5" value="a"> a) V√©rifier la propri√©t√© `response.ok`</label>
      <label><input type="radio" name="q5" value="b"> b) Voir si le bloc `.catch()` est d√©clench√©</label>
      <label><input type="radio" name="q5" value="c"> c) V√©rifier que `response.status` est √©gal √† "OK"</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'a', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:red;">Incorrect.</span> Bonne r√©ponse : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)} : <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre r√©sultat : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ R√©sum√© du chapitre :**

Vous avez configur√© l'"antenne principale" de votre Centre de Contr√¥le de Mission et appris √† envoyer des requ√™tes et √† recevoir des r√©ponses.

- üì° Vous avez ma√Ætris√© la syntaxe de base de `fetch()`.
- üõ∞Ô∏è Vous avez compris ce que sont les **Promesses (Promises)** et comment travailler avec `.then()` et `.catch()`.
- ‚öôÔ∏è Vous avez appris √† traiter correctement les r√©ponses du serveur en v√©rifiant `response.ok`.

**Communication √©tablie !** Dans le prochain chapitre, nous connecterons notre Centre de Contr√¥le de Mission √† l'API de la flotte spatiale que nous avons cr√©√©e avec FastAPI, et nous apprendrons √† r√©cup√©rer et √† afficher la liste de nos vaisseaux.

> **üìå V√©rification :**

> - Assurez-vous que votre fichier `index.html` affiche correctement les coordonn√©es de l'ISS.
> - Essayez de casser intentionnellement l'URL et voyez quelle erreur est affich√©e dans la console du d√©veloppeur.

> **‚ö†Ô∏è Si le code ne fonctionne pas :**

> - **Erreur CORS :** Si vous essayez de faire une requ√™te vers votre API FastAPI locale (par exemple, `http://127.0.0.1:8000`) √† partir d'un fichier ouvert en tant que `file:///...`, le navigateur bloquera la requ√™te en raison de la politique de s√©curit√© CORS. Nous r√©soudrons ce probl√®me dans le prochain chapitre. Pour l'instant, nous utilisons des API publiques qui l'autorisent.
> - **HTTP/HTTPS :** `http://api.open-notify.org` fonctionne en HTTP. Certains navigateurs peuvent √©mettre un avertissement √† ce sujet. Si vous travaillez depuis un site HTTPS, les requ√™tes vers des ressources HTTP peuvent √™tre bloqu√©es.
```