# **Chapitre 4.2 : Envoi de requ√™tes GET**
**Temps d'√©tude :** 45 minutes

---

#### **1. GET : Requ√™te de t√©l√©m√©trie de la flotte spatiale**
Une **requ√™te GET** est la commande principale pour r√©cup√©rer des donn√©es. Dans notre Centre de Contr√¥le de Mission (CCM), cela √©quivaut √† la requ√™te : "Centre de Gestion de Flotte, rapportez la situation !"

Nous allons utiliser `fetch` pour envoyer deux types de requ√™tes GET √† notre serveur FastAPI :

1.  **Obtention de toute la collection :** "Montrez-moi toute ma flotte".
2.  **Obtention d'une seule ressource :** "Donnez-moi les informations d√©taill√©es sur le vaisseau avec l'ID 2".

> üí° **Analogie spatiale :**

> `GET /spaceships` ‚Äî c'est une requ√™te de diffusion √† toute la flotte pour demander ses indicatifs d'appel.

> `GET /spaceships/3` ‚Äî c'est une requ√™te adress√©e √† un vaisseau sp√©cifique (ISS) pour qu'il transmette les donn√©es compl√®tes de ses syst√®mes.

---

#### **2. Le probl√®me CORS : "Interf√©rences interplan√©taires"**
Avant d'envoyer une requ√™te, nous devons r√©soudre un probl√®me important. Par d√©faut, pour des raisons de s√©curit√©, les navigateurs emp√™chent une page web (notre CCM), charg√©e √† partir d'un "domaine" (`file:///...` ou `http://localhost:5500`), de faire des requ√™tes vers une API sur un autre "domaine" (`http://127.0.0.1:8000`).

Cette politique est appel√©e **CORS (Cross-Origin Resource Sharing)**.

Pour permettre √† notre front-end de communiquer avec le back-end, nous devons configurer le serveur FastAPI pour qu'il dise au navigateur : "Tout va bien, je fais confiance aux requ√™tes provenant de cette adresse".

**√âtape 1 : Installation de `python-multipart`**
C'est n√©cessaire pour le bon fonctionnement du middleware.
```bash
pip install python-multipart
```

**√âtape 2 : Configuration de CORS dans `main.py`**
Ouvrez votre fichier `main.py` du projet FastAPI et ajoutez le code suivant :
```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware  # <-- Importation du middleware

# ... votre code restant (mod√®les, db_spaceships) ...

app = FastAPI(
    title="Fleet Management API",
    # ...
)

# --- CONFIGURATION CORS ---
# Sp√©cifie quels "domaines" (origines) peuvent envoyer des requ√™tes
origins = [
    "http://localhost",
    "http://localhost:8080",
    "http://127.0.0.1:5500",  # Adresse pour Live Server dans VS Code
    "null"  # Pour les requ√™tes provenant de fichiers locaux file:///
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # Autorise les origines sp√©cifi√©es
    allow_credentials=True,
    allow_methods=["*"],  # Autorise toutes les m√©thodes (GET, POST, etc.)
    allow_headers=["*"],  # Autorise tous les en-t√™tes
)

# --- VOS POINTS DE TERMINAISON CI-DESSOUS ---
@app.get("/")
# ...
```
Maintenant, notre serveur API est pr√™t √† accepter les requ√™tes du front-end. **Red√©marrez `uvicorn`** pour que les modifications prennent effet !

---

#### **3. R√©cup√©ration de la liste de tous les vaisseaux**
Nous allons cr√©er une interface pour afficher notre flotte.

**√âtape 1 : Mise √† jour de `index.html`**
```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>CCM - Gestion de Flotte</title>
    <style>
        body { font-family: sans-serif; }
        .ship-list { list-style: none; padding: 0; }
        .ship-list li { border: 1px solid #ccc; margin-bottom: 10px; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Panneau de contr√¥le de la flotte spatiale</h1>

    <button id="load-fleet-btn">Demander les donn√©es de la flotte</button>

    <h2>Liste des appareils :</h2>
    <ul id="fleet-list" class="ship-list">
        <li>En attente de commande...</li>
    </ul>

    <script src="app.js"></script> <!-- Connexion du script externe -->
</body>
</html>
```

**√âtape 2 : Cr√©ation de `app.js`**
√Ä c√¥t√© de `index.html`, cr√©ez un fichier `app.js`. Nous y d√©porterons toute la logique.
```javascript
// app.js

const API_BASE_URL = 'http://127.0.0.1:8000'; // URL de notre serveur FastAPI

const loadFleetBtn = document.getElementById('load-fleet-btn');
const fleetList = document.getElementById('fleet-list');

// Fonction pour charger et afficher la flotte
async function fetchAndDisplayFleet() {
    try {
        fleetList.innerHTML = '<li>Chargement de la t√©l√©m√©trie...</li>';

        // Envoi de la requ√™te GET vers /spaceships
        const response = await fetch(`${API_BASE_URL}/spaceships`);

        if (!response.ok) {
            throw new Error(`Erreur r√©seau : ${response.status}`);
        }

        const ships = await response.json(); // R√©cup√©ration du tableau de vaisseaux

        // Effacement de la liste et affichage des donn√©es
        fleetList.innerHTML = '';
        if (ships.length === 0) {
            fleetList.innerHTML = '<li>Aucun appareil n\'est enregistr√© dans le registre.</li>';
            return;
        }

        ships.forEach(ship => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <strong>${ship.name} (ID: ${ship.id})</strong><br>
                Type: ${ship.type}<br>
                Ann√©e de lancement: ${ship.launch_year}<br>
                Statut: ${ship.status}
            `;
            fleetList.appendChild(listItem);
        });

    } catch (error) {
        console.error('Impossible de charger les donn√©es de la flotte :', error);
        fleetList.innerHTML = `<li>Erreur : ${error.message}</li>`;
    }
}

// Ajout de l'√©couteur d'√©v√©nement au bouton
loadFleetBtn.addEventListener('click', fetchAndDisplayFleet);
```

- **async/await :** Nous avons utilis√© une nouvelle syntaxe, plus pratique, pour travailler avec les promesses. Nous l'examinerons en d√©tail au chapitre 4.5. Pour l'instant, sachez simplement que `await` "attend" l'ex√©cution d'une promesse sans bloquer la page.
- `try...catch` : Une excellente fa√ßon de g√©rer les erreurs dans les fonctions `async`.

**√âtape 3 : Testons**
Ouvrez `index.html` dans votre navigateur (id√©alement via l'extension Live Server de VS Code, qui le lancera sur `http://127.0.0.1:5500`). Cliquez sur le bouton "Demander les donn√©es de la flotte". La liste de vos vaisseaux de FastAPI devrait appara√Ætre sur la page !

---

#### **4. R√©cup√©ration des donn√©es d'un seul vaisseau**
Maintenant, ajoutons un formulaire pour demander des informations par ID sp√©cifique.

**√âtape 1 : Ajout du formulaire dans `index.html`**
```html
<!-- index.html, apr√®s la liste -->
<hr>
<h2>Requ√™te par ID</h2>
<form id="ship-form">
    <input type="number" id="ship-id-input" placeholder="Entrez l'ID de l'appareil" required>
    <button type="submit">Trouver l'appareil</button>
</form>
<div id="ship-details" class="ship-list"></div>
```

**√âtape 2 : Ajout de la logique dans `app.js`**
```javascript
// app.js, √† la fin du fichier

const shipForm = document.getElementById('ship-form');
const shipIdInput = document.getElementById('ship-id-input');
const shipDetails = document.getElementById('ship-details');

async function fetchShipById(event) {
    event.preventDefault(); // Emp√™che le rechargement de la page
    const shipId = shipIdInput.value;

    if (!shipId) {
        alert('Veuillez entrer un ID.');
        return;
    }

    try {
        shipDetails.innerHTML = '<li>Recherche de l\'appareil...</li>';

        // Envoi de la requ√™te GET vers /spaceships/{id}
        const response = await fetch(`${API_BASE_URL}/spaceships/${shipId}`);

        if (response.status === 404) {
             throw new Error('Aucun appareil avec cet ID n\'a √©t√© trouv√© dans le registre.');
        }
        if (!response.ok) {
            throw new Error(`Erreur r√©seau : ${response.status}`);
        }

        const ship = await response.json();

        shipDetails.innerHTML = `
            <li>
                <strong>${ship.name} (ID: ${ship.id})</strong><br>
                Type: ${ship.type}<br>
                Ann√©e de lancement: ${ship.launch_year}<br>
                Statut: ${ship.status}
            </li>
        `;
    } catch (error) {
        console.error(`Erreur lors de la recherche de l'appareil ${shipId}:`, error);
        shipDetails.innerHTML = `<li>Erreur : ${error.message}</li>`;
    }
}

shipForm.addEventListener('submit', fetchShipById);
```

- Nous avons ajout√© une gestion s√©par√©e du statut `404` pour donner √† l'utilisateur un message d'erreur plus clair.

**√âtape 3 : Testons**
Actualisez la page, entrez l'ID d'un vaisseau existant (par exemple, 1) et cliquez sur "Trouver l'appareil". Vous devriez voir ses donn√©es. Essayez d'entrer un ID inexistant (par exemple, 99) ‚Äî vous verrez un message d'erreur.

---

#### **Quiz de consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. La politique CORS dans le navigateur est n√©cessaire pour...</p>
      <label><input type="radio" name="q1" value="a"> a) Acc√©l√©rer le chargement des pages</label>
      <label><input type="radio" name="q1" value="b"> b) Prot√©ger contre les requ√™tes inter-sites malveillantes</label>
      <label><input type="radio" name="q1" value="c"> c) Compresser les donn√©es JSON</label>
    </div>
    <div class="question">
      <p>2. Pour permettre au front-end sur `localhost:5500` d'acc√©der √† FastAPI, il faut...</p>
      <label><input type="radio" name="q2" value="a"> a) Configurer `CORSMiddleware` dans FastAPI</label>
      <label><input type="radio" name="q2" value="b"> b) Modifier les param√®tres du navigateur</label>
      <label><input type="radio" name="q2" value="c"> c) Rien n'est n√©cessaire, cela fonctionne par d√©faut</label>
    </div>
    <div class="question">
      <p>3. Pour obtenir les donn√©es d'une ressource sp√©cifique avec l'ID=5, l'URL de la requ√™te ressemblera √† :</p>
      <label><input type="radio" name="q3" value="a"> a) `/resources?id=5`</label>
      <label><input type="radio" name="q3" value="b"> b) `/resources/5`</label>
      <label><input type="radio" name="q3" value="c"> c) `/get/resources/5`</label>
    </div>
    <div class="question">
      <p>4. Le mot-cl√© `await` en JavaScript ne peut √™tre utilis√© qu'√† l'int√©rieur d'une fonction d√©clar√©e avec...</p>
      <label><input type="radio" name="q4" value="a"> a) `function`</label>
      <label><input type="radio" name="q4" value="b"> b) `promise`</label>
      <label><input type="radio" name="q4" value="c"> c) `async`</label>
    </div>
    <div class="question">
      <p>5. `event.preventDefault()` dans le gestionnaire de soumission de formulaire est n√©cessaire pour...</p>
      <label><input type="radio" name="q5" value="a"> a) Emp√™cher le comportement standard du navigateur (rechargement de la page)</label>
      <label><input type="radio" name="q5" value="b"> b) Arr√™ter l'ex√©cution du script</label>
      <label><input type="radio" name="q5" value="c"> c) Annuler l'envoi de la requ√™te</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'b', q4: 'c', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

```
```html
      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> R√©ponse correcte : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Votre r√©sultat : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ R√©sum√© du chapitre :**

Vous avez configur√© avec succ√®s un canal de communication entre la "Terre" et l'"espace" et appris √† demander la t√©l√©m√©trie !

- üõ°Ô∏è Vous avez r√©solu le probl√®me des "interf√©rences interplan√©taires" en configurant **CORS** sur votre serveur FastAPI.
- üõ∞Ô∏è Vous avez impl√©ment√© une fonction pour r√©cup√©rer et afficher la **liste compl√®te** des engins spatiaux.
- üî≠ Vous avez cr√©√© une interface pour demander des donn√©es sur un **engin sp√©cifique** par son ID.

**Le centre de contr√¥le de mission re√ßoit les donn√©es !** Dans le prochain chapitre, nous passerons √† l'action : nous enverrons des commandes pour cr√©er, mettre √† jour et supprimer nos vaisseaux spatiaux.

> **üìå V√©rification :**

> - Assurez-vous que votre serveur FastAPI est en cours d'ex√©cution avec le `CORSMiddleware` configur√©.
> - V√©rifiez que la liste des vaisseaux appara√Æt sur la page lorsque vous cliquez sur le bouton "Demander des donn√©es".
> - Assurez-vous que le formulaire de recherche par ID trouve correctement les engins existants et signale une erreur pour les engins inexistants.

> **‚ö†Ô∏è En cas d'erreurs :**

> - **Erreur CORS dans la console du navigateur :** Soit vous n'avez pas red√©marr√© `uvicorn` apr√®s avoir ajout√© le `CORSMiddleware`, soit l'adresse de votre frontend (par exemple, `http://127.0.0.1:5500`) n'est pas ajout√©e √† la liste des `origins`.
> - **√âchec de la r√©cup√©ration (Failed to fetch) :** V√©rifiez que votre serveur FastAPI est en cours d'ex√©cution et accessible √† l'adresse sp√©cifi√©e dans `API_BASE_URL`.
```