# **Chapitre 4.3 : Envoi de requ√™tes POST/PUT/DELETE**
**Temps d'√©tude :** 1 heure

---

#### **1. Commandes actives : Du lancement au d√©classement**
Jusqu'√† pr√©sent, notre centre de contr√¥le (MCC) ne faisait que demander des informations (`GET`). Nous allons maintenant apprendre √† envoyer des **commandes actives** :

-   **POST :** "Lancer un nouveau satellite en orbite !"
-   **PUT :** "Effectuer une mise √† niveau compl√®te des syst√®mes de l'ISS !"
-   **DELETE :** "D√©sorbiter l'ancien appareil `Debris-123` !"

Pour ce faire, nous utiliserons `fetch`, mais avec des param√®tres suppl√©mentaires qui d√©crivent notre commande.

> üí° **Analogie spatiale :**

> Si `GET` est une √©coute passive de la radio, `POST`, `PUT` et `DELETE` sont une **transmission active de commandes**. Pour cela, il ne suffit pas d'indiquer la "fr√©quence" (URL), mais aussi le **contenu de la commande** (corps de la requ√™te) et le **protocole de communication** (en-t√™tes).

---

#### **2. Envoi d'une requ√™te POST : Lancement d'un nouveau vaisseau**
Pour cr√©er une nouvelle ressource, nous envoyons une requ√™te `POST`. Le plus important ici est de transmettre le **corps (body)** de la requ√™te avec les donn√©es du nouvel objet.

**√âtape 1 : Ajout du formulaire de cr√©ation dans `index.html`**
Pla√ßons-le apr√®s le bloc "Requ√™te par ID".
```html
<!-- index.html -->
<hr>
<h2>Lancer un nouvel appareil</h2>
<form id="create-ship-form">
    <input type="text" id="create-name" placeholder="Nom" required><br>
    <input type="text" id="create-type" placeholder="Type" required><br>
    <input type="number" id="create-year" placeholder="Ann√©e de lancement" required><br>
    <input type="text" id="create-status" placeholder="Statut" required><br>
    <button type="submit">Lancer</button>
</form>
<div id="create-status-message"></div>
```

**√âtape 2 : Ajout de la logique dans `app.js`**
```javascript
// app.js, √† la fin du fichier

const createShipForm = document.getElementById('create-ship-form');
const createStatusMessage = document.getElementById('create-status-message');

async function createShip(event) {
    event.preventDefault();

    // 1. Rassemble les donn√©es du formulaire dans un objet
    const shipData = {
        name: document.getElementById('create-name').value,
        type: document.getElementById('create-type').value,
        launch_year: parseInt(document.getElementById('create-year').value),
        status: document.getElementById('create-status').value
    };

    try {
        createStatusMessage.textContent = 'Envoi de la commande de lancement...';

        // 2. Envoie la requ√™te fetch avec les param√®tres
        const response = await fetch(`${API_BASE_URL}/spaceships`, {
            method: 'POST', // Indique la m√©thode
            headers: {
                'Content-Type': 'application/json' // Indique au serveur que nous envoyons du JSON
            },
            body: JSON.stringify(shipData) // Convertit l'objet JavaScript en cha√Æne JSON
        });

        if (!response.ok) {
            // Si le serveur a renvoy√© une erreur, essaie de lire son corps
            const errorData = await response.json();
            throw new Error(errorData.detail || `Erreur serveur : ${response.status}`);
        }

        const newShip = await response.json();
        createStatusMessage.textContent = `üöÄ Lancement r√©ussi ! L'appareil a l'ID : ${newShip.id}`;

        createShipForm.reset(); // Efface le formulaire
        fetchAndDisplayFleet(); // Met √† jour la liste g√©n√©rale de la flotte

    } catch (error) {
        console.error('Erreur lors du lancement de l\'appareil :', error);
        createStatusMessage.textContent = `üî¥ Erreur : ${error.message}`;
    }
}

createShipForm.addEventListener('submit', createShip);
```
**Points cl√©s de `fetch` pour POST :**

-   **`method: 'POST'`** : Il est imp√©ratif d'indiquer la m√©thode HTTP.
-   **`headers: { 'Content-Type': 'application/json' }`** : Cet en-t√™te est crucial. Il indique √† notre serveur FastAPI que le corps de la requ√™te contient du JSON et qu'il doit √™tre analys√©.
-   **`body: JSON.stringify(shipData)`** : Nous ne pouvons pas envoyer un objet JavaScript directement. Il doit √™tre s√©rialis√© (converti) en cha√Æne JSON.

---

#### **3. Envoi d'une requ√™te DELETE : D√©classement d'un appareil**
La requ√™te de suppression est plus simple : elle n'a g√©n√©ralement pas besoin de corps, seulement d'une URL avec l'ID de l'objet.

**√âtape 1 : Ajout du bouton "Supprimer" dans notre liste de vaisseaux**
Modifions la fonction `fetchAndDisplayFleet` dans `app.js` pour qu'elle ajoute un bouton de suppression pour chaque √©l√©ment.
```javascript
// app.js, √† l'int√©rieur de la fonction fetchAndDisplayFleet

// ...
ships.forEach(ship => {
    const listItem = document.createElement('li');
    // Ajoute un bouton avec un attribut data stockant l'ID
    listItem.innerHTML = `
        <strong>${ship.name} (ID: ${ship.id})</strong><br>
        Type: ${ship.type} | Ann√©e: ${ship.launch_year} | Statut: ${ship.status}<br>
        <button class="delete-btn" data-ship-id="${ship.id}">D√©classer l'appareil</button>
    `;
    fleetList.appendChild(listItem);
});
// ...
```

**√âtape 2 : Ajout d'un gestionnaire pour tous les boutons "Supprimer"**
Nous utilisons la d√©l√©gation d'√©v√©nements - un seul gestionnaire pour toute la liste.
```javascript
// app.js, √† la fin du fichier

async function deleteShip(shipId) {
    if (!confirm(`√ätes-vous s√ªr de vouloir d√©classer l'appareil avec l'ID ${shipId} ? Cette action est irr√©versible.`)) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/spaceships/${shipId}`, {
            method: 'DELETE' // Indique la m√©thode
        });

        if (!response.ok) {
            throw new Error(`√âchec du d√©classement de l'appareil. Statut : ${response.status}`);
        }

        alert(`L'appareil avec l'ID ${shipId} a √©t√© d√©class√© avec succ√®s.`);
        fetchAndDisplayFleet(); // Met √† jour la liste

    } catch (error) {
        console.error('Erreur lors du d√©classement :', error);
        alert(`Erreur : ${error.message}`);
    }
}

// D√©l√©gation d'√©v√©nements : √©coute les clics sur toute la liste
fleetList.addEventListener('click', (event) => {
    // V√©rifie si le clic a eu lieu sur un bouton avec la classe 'delete-btn'
    if (event.target.classList.contains('delete-btn')) {
        const shipId = event.target.dataset.shipId; // R√©cup√®re l'ID depuis l'attribut data
        deleteShip(shipId);
    }
});
```

**√âtape 3 : Ajout de l'id au mod√®le Spaceship**

Ajoutez l'id aux mod√®les et √† la base de donn√©es dans le fichier `main.py`.

```python
class Spaceship(BaseModel):
    id: int
	# Reste du code du mod√®le...

db_spaceships = {
    1: {
        "id": 1,
        # Donn√©es de l'√©l√©ment 1
    },
    2: {
        "id": 2,
        # Donn√©es de l'√©l√©ment 2
    },
    3: {
        "id": 3,
		# Donn√©es de l'√©l√©ment 3
    }
}
```


-   **`method: 'DELETE'`** : Indique la m√©thode. Le corps et les en-t√™tes ne sont pas n√©cessaires ici.
-   `confirm()` : Simple fen√™tre de confirmation int√©gr√©e pour √©viter de supprimer accidentellement quelque chose d'important.

---

#### **4. Envoi d'une requ√™te PUT (T√¢che autonome)**
L'impl√©mentation d'une requ√™te `PUT` pour la mise √† jour est tr√®s similaire √† `POST`.

**Votre mission, si vous choisissez de l'accepter :**

1.  Ajouter un bouton "Modifier" √† c√¥t√© du bouton "Supprimer" pour chaque vaisseau.
2.  Lorsque vous cliquez sur "Modifier", remplissez le formulaire (vous pouvez utiliser le m√™me que pour la cr√©ation) avec les donn√©es actuelles du vaisseau.
3.  Modifiez le texte du bouton "Lancer" en "Mettre √† jour".
4.  Lors de la soumission du formulaire, envoyez une requ√™te `PUT` √† `/spaceships/{id}` avec le corps complet de l'objet.
5.  Apr√®s une mise √† jour r√©ussie, mettez √† jour la liste de la flotte.

> **Indice :** Vous aurez besoin de `fetch` avec `method: 'PUT'`, les en-t√™tes `Content-Type` et `body` avec `JSON.stringify()`, exactement comme dans la requ√™te `POST`.

---

#### **Quiz pour la consolidation**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Quel param√®tre `fetch` est utilis√© pour transmettre des donn√©es dans le corps de la requ√™te ?</p>
      <label><input type="radio" name="q1" value="a"> a) `data`</label>
      <label><input type="radio" name="q1" value="b"> b) `body`</label>
      <label><input type="radio" name="q1" value="c"> c) `payload`</label>
    </div>
    <div class="question">
      <p>2. L'en-t√™te `'Content-Type': 'application/json'` indique au serveur que...</p>
      <label><input type="radio" name="q2" value="a"> a) Le client s'attend √† recevoir une r√©ponse au format JSON</label>
      <label><input type="radio" name="q2" value="b"> b) Le client envoie des donn√©es dans le corps de la requ√™te au format JSON</label>
      <label><input type="radio" name="q2" value="c"> c) La connexion doit √™tre chiffr√©e</label>
    </div>
    <div class="question">
      <p>3. Que fait la fonction `JSON.stringify(obj)` en JavaScript ?</p>
      <label><input type="radio" name="q3" value="a"> a) Convertit une cha√Æne JSON en objet</label>
      <label><input type="radio" name="q3" value="b"> b) V√©rifie la validit√© de l'objet</label>
      <label><input type="radio" name="q3" value="c"> c) Convertit un objet JavaScript en cha√Æne JSON</label>
    </div>
    <div class="question">
      <p>4. Pour envoyer une requ√™te `DELETE` avec `fetch`, il faut absolument indiquer :</p>
      <label><input type="radio" name="q4" value="a"> a) Un corps `body` vide</label>
      <label><input type="radio" name="q4" value="b"> b) `method: 'DELETE'`</label>
      <label><input type="radio" name="q4" value="c"> c) L'en-t√™te `Authorization`</label>
    </div>
    <div class="question">
      <p>5. La d√©l√©gation d'√©v√©nements en JavaScript, c'est quand...</p>
      <label><input type="radio" name="q5" value="a"> a) Nous attachons un seul gestionnaire √† l'√©l√©ment parent au lieu de plusieurs aux enfants</label>
      <label><input type="radio" name="q5" value="b"> b) Nous transf√©rons le droit d'ex√©cuter une fonction √† un autre script</label>
      <label><input type="radio" name="q5" value="c"> c) L'√©v√©nement se produit avec un d√©lai</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">V√©rifier</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>R√©sultats :</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:green;">Correct !</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:red;">Incorrect.</span> Bonne r√©ponse : <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Question ${question.slice(1)}: <span style="color:orange;">Pas de r√©ponse.</span></li>`;
      }
    }
</script>
resultsHTML += `</ul><p><b>Votre score : ${score} sur ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ R√©sum√© du chapitre :**

Votre Centre de Contr√¥le de Mission (CCM) dispose maintenant d'un ensemble complet de commandes pour g√©rer la flotte !

- ‚úÖ Vous avez appris √† envoyer des requ√™tes `POST` avec un corps et des en-t√™tes pour cr√©er de nouvelles ressources.
- ‚úÖ Vous avez impl√©ment√© des requ√™tes `DELETE` pour d√©sactiver les appareils obsol√®tes.
- ‚úÖ Vous avez re√ßu la t√¢che d'impl√©menter une requ√™te `PUT`, consolidant ainsi vos connaissances.

**Le contr√¥le total est √©tabli !** Mais que faire si la connexion est interrompue ou si le serveur signale une erreur ? Dans le prochain chapitre, nous allons cr√©er un syst√®me centralis√© de gestion des erreurs c√¥t√© front-end.

> **üìå V√©rification :**

> - Assurez-vous que le formulaire de cr√©ation d'un nouveau vaisseau fonctionne et qu'apr√®s une cr√©ation r√©ussie, la liste sur la page est mise √† jour.
> - V√©rifiez que le bouton "D√©sactiver l'appareil" fonctionne, demande confirmation et supprime le vaisseau de la liste.
> - Essayez de cr√©er un vaisseau avec des donn√©es non valides (par exemple, avec un nom tr√®s court) et observez l'erreur que votre serveur FastAPI renverra.

> **‚ö†Ô∏è En cas d'erreurs :**

> - **Erreur `422` du serveur :** Il est probable que les donn√©es que vous envoyez ne passent pas la validation Pydantic. V√©rifiez la console du navigateur ‚Äî `errorData.detail` indiquera le champ probl√©matique.
> - **Erreur `415 Unsupported Media Type` :** Vous avez oubli√© d'ajouter l'en-t√™te `'Content-Type': 'application/json'`.
> - **Les boutons de suppression ne fonctionnent pas :** V√©rifiez si la d√©l√©gation d'√©v√©nements fonctionne correctement et si vous r√©cup√©rez correctement `shipId` √† partir de `data-ship-id`.