# **Cap√≠tulo 2.7: Tratamento de Erros**
**Tempo de estudo:** 40 minutos

---

#### **1. Por que erros padr√£o s√£o ruins?**

Se ocorrer um erro em sua aplica√ß√£o Laravel (por exemplo, um registro n√£o encontrado no banco de dados) e voc√™ n√£o o tratar de nenhuma forma, o usu√°rio ver√° uma enorme p√°gina HTML com informa√ß√µes de depura√ß√£o ou uma mensagem n√£o informativa de "Server Error".

Para APIs, isso √© uma cat√°strofe. Seu aplicativo frontend espera receber JSON, n√£o HTML. Nossa tarefa √© interceptar qualquer erro e transform√°-lo em uma resposta JSON estruturada.

---

#### **2. Dispatcher Central de Erros: `bootstrap/app.php`**

Em vers√µes antigas do Laravel, havia um arquivo volumoso `App\Exceptions\Handler.php`. No Laravel 11/12, tudo se tornou muito mais simples e elegante. O centro de gerenciamento de erros agora est√° localizado diretamente no arquivo de configura√ß√£o do seu aplicativo ‚Äî `bootstrap/app.php`.

Abra `bootstrap/app.php`. No final, voc√™ ver√° o bloco `.withExceptions(...)`. Este √© o nosso "dispatcher central".

```php
<?php
// bootstrap/app.php

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {
        // ...
    })
    ->withExceptions(function (Exceptions $exceptions) {
        // <-- √â AQUI QUE VAMOS TRABALHAR
    })->create();
```

---

#### **3. Lidando com o erro mais comum: "N√£o Encontrado" (404)**

O erro mais comum em uma API √© quando o usu√°rio solicita um recurso que n√£o existe (por exemplo, `GET /api/planets/999`). O Laravel, neste caso, gera uma exce√ß√£o `ModelNotFoundException` ou `NotFoundHttpException`. Vamos intercept√°-las.

Adicione o seguinte c√≥digo dentro de `.withExceptions(...)`:

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // Interceptamos a exce√ß√£o quando o modelo n√£o √© encontrado no banco de dados
    $exceptions->render(function (ModelNotFoundException $e, Request $request) {
        // Verificamos se a requisi√ß√£o veio especificamente para nossa API
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'O recurso solicitado n√£o foi encontrado em nossa gal√°xia.'
            ], 404);
        }
    });

    // Interceptamos a exce√ß√£o quando a pr√≥pria rota n√£o √© encontrada
    $exceptions->render(function (NotFoundHttpException $e, Request $request) {
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'Essa rota espacial n√£o existe.'
            ], 404);
        }
    });

})->create();
```
**O que fizemos?**

1.  `$exceptions->render(...)` ‚Äî registramos um "handler" (manipulador). Ele diz: "Se ocorrer uma exce√ß√£o do tipo `ModelNotFoundException`, execute este c√≥digo".
2.  `if ($request->is('api/*'))` ‚Äî esta √© uma verifica√ß√£o importante. Ela garante que nossa bela resposta JSON ser√° enviada apenas para requisi√ß√µes de API, sem afetar p√°ginas web comuns.
3.  `return response()->json(...)` ‚Äî criamos e retornamos uma resposta JSON padronizada com c√≥digo 404.

Agora, se voc√™ solicitar um planeta inexistente, em vez de uma p√°gina HTML feia, voc√™ receber√° um JSON limpo.

---

#### **4. Exce√ß√µes Personalizadas: Criando nossos pr√≥prios "sinais de alarme"**

√Äs vezes, as exce√ß√µes padr√£o n√£o s√£o suficientes. Imagine que temos uma regra de neg√≥cio: "n√£o √© poss√≠vel deletar o planeta 'Terra'". Se algu√©m tentar fazer isso, devemos retornar um erro significativo.

**Passo 1: Criando nossa classe de exce√ß√£o**
Executaremos no terminal:
```bash
php artisan make:exception CannotDeleteEarthException
```

**Passo 2: Usando-o no controller**
Abriremos `PlanetController.php` e modificaremos o m√©todo `destroy`:

```php
<?php
// app/Http/Controllers/PlanetController.php
use App\Exceptions\CannotDeleteEarthException; // <-- Importamos nossa exce√ß√£o
use App\Models\Planet;

public function destroy(Planet $planet)
{
    // Nossa nova regra de neg√≥cio
    if (strtolower($planet->name) === '–∑–µ–º–ª—è') {
        throw new CannotDeleteEarthException('A exclus√£o do planeta Terra √© proibida pelo C√≥digo Gal√°ctico.');
    }

    $planet->delete();
    return response()->json(null, 204);
}
```
Agora, se algu√©m tentar executar `DELETE /api/planets/1` (onde 1 √© o ID da Terra), nosso c√≥digo lan√ßar√° uma exce√ß√£o `CannotDeleteEarthException`.

**Passo 3: Ensinando o Laravel a tratar nossa "emerg√™ncia" de forma elegante**
Voltaremos a `bootstrap/app.php` e adicionaremos um novo handler para nossa exce√ß√£o.

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // Nosso novo handler
    $exceptions->render(function (CannotDeleteEarthException $e, Request $request) {
        return response()->json([
            'message' => 'Opera√ß√£o proibida.',
            'details' => $e->getMessage() // Obtemos a mensagem que passamos no throw
        ], 403); // 403 Forbidden - "Acesso Proibido"
    });

    // ... (outros handlers para 404)

})->create();
```
Pronto! Criamos nossa pr√≥pria exce√ß√£o nomeada, que torna o c√≥digo do controller mais limpo, e ensinamos o Laravel a transform√°-la em uma resposta JSON bonita e significativa com o status HTTP correto.

---

#### **5. Tratamento de todas as outras falhas (500 Internal Server Error)**

O que fazer com todas as outras falhas inesperadas? Por exemplo, se o banco de dados cair ou houver um erro de sintaxe no c√≥digo. Para isso, podemos registrar um handler "universal" para o tipo de erro mais geral ‚Äî `Throwable`.

**Importante:** Este handler deve ser o **√∫ltimo**, para n√£o interceptar exce√ß√µes mais espec√≠ficas que definimos acima.

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // ... (handlers para CannotDeleteEarthException e 404)

    // HANDLER UNIVERSAL (no final)
    $exceptions->render(function (Throwable $e, Request $request) {
        if ($request->is('api/*')) {
            // Em modo de depura√ß√£o, a mensagem de erro real pode ser exibida
            $message = config('app.debug')
                ? 'Ocorreu um erro: ' . $e->getMessage()
                : 'Uma falha inesperada ocorreu a bordo. Os engenheiros j√° foram chamados.';

            return response()->json(['message' => $message], 500);
        }
    });

})->create();
```

Agora, qualquer exce√ß√£o "desconhecida" ser√° cuidadosamente interceptada e transformada em JSON com c√≥digo 500, sem quebrar sua API ou mostrar informa√ß√µes desnecess√°rias ao usu√°rio.

---

#### **6. Log de Erros: Caixa preta da nave espacial**
Configura√ß√µes de log em `config/logging.php`:
```php
<?php
'channels' => [
    'space_api' => [
        'driver' => 'daily',
        'path' => storage_path('logs/space_api.log'),
        'level' => 'error',
        'days' => 14,
    ],
],
```

**Adicionando um registro ao log:**
```php
<?php
try {
    // C√≥digo com risco de erro
} catch (Exception $e) {
    Log::channel('space_api')->error('Erro de acesso aos planetas', [
        'exception' => $e,
        'request' => request()->all(),
        'user_id' => auth()->id()
    ]);
    throw $e;
}
```

---

#### **Quiz para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Status HTTP para "Planeta n√£o encontrado":</p>
      <label><input type="radio" name="q1" value="a"> a) 400</label>
      <label><input type="radio" name="q1" value="b"> b) 404</label>
      <label><input type="radio" name="q1" value="c"> c) 500</label>
    </div>
    <div class="question">
      <p>2. Classe para tratamento global de erros:</p>
      <label><input type="radio" name="q2" value="a"> a) Handler.php</label>
      <label><input type="radio" name="q2" value="b"> b) ErrorController.php</label>
      <label><input type="radio" name="q2" value="c"> c) Middleware/Error.php</label>
    </div>
    <div class="question">
      <p>3. M√©todo para criar uma exce√ß√£o personalizada:</p>
      <label><input type="radio" name="q3" value="a"> a) php artisan make:exception</label>
      <label><input type="radio" name="q3" value="b"> b) php artisan exception:create</label>
      <label><input type="radio" name="q3" value="c"> c) php artisan generate:exception</label>
    </div>
    <div class="question">
      <p>4. Canal para log separado de erros da API:</p>
      <label><input type="radio" name="q4" value="a"> a) Configura√ß√£o em config/logging.php</label>
      <label><input type="radio" name="q4" value="b"> b) Par√¢metro em .env</label>
      <label><input type="radio" name="q4" value="c"> c) Indica√ß√£o no controller</label>
    </div>
    <div class="question">
      <p>5. Principal vantagem de criar exce√ß√µes personalizadas:</p>
      <label><input type="radio" name="q5" value="a"> a) Aumento de desempenho</label>
      <label><input type="radio" name="q5" value="b"> b) Cria√ß√£o de erros semanticamente compreens√≠veis para cen√°rios de neg√≥cios espec√≠ficos</label>
      <label><input type="radio" name="q5" value="c"> c) Adi√ß√£o autom√°tica ao .env</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>
<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'a', q4: 'a', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumo do cap√≠tulo:**

Voc√™ equipou sua API com um sistema de recupera√ß√£o robusto:

- üõü Intercepta√ß√£o global de erros padr√£o
- ü™ê Exce√ß√µes personalizadas com c√≥digos claros
- üìù Formato JSON unificado para todos os erros
- üîç Log com detalhes do incidente
- üì° Integra√ß√£o com sistemas de monitoramento

**A nave espacial est√° pronta para emerg√™ncias!** No cap√≠tulo final da se√ß√£o, testaremos todos os sistemas.

> **üìå Verifica√ß√£o:**

> 1. Crie uma exce√ß√£o `PlanetNotFoundException`
> 2. Adicione o tratamento de erros 404 em ```->withExceptions```
> 3. Teste uma requisi√ß√£o para um planeta inexistente

> **‚ö†Ô∏è Se os erros n√£o forem interceptados:**

> - Certifique-se de que `is('api/*')` corresponde √†s suas rotas
> - Verifique a ordem dos manipuladores em `register()`
> - Para exce√ß√µes personalizadas, use `throw new`
