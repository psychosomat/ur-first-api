# **Cap√≠tulo 2.3: Migra√ß√µes de Banco de Dados**
**Tempo de estudo:** 50 minutos

---

#### **1. Migra√ß√µes: Construindo uma Esta√ß√£o Espacial**
**Migra√ß√µes** no Laravel s√£o um sistema de controle de vers√£o para o seu banco de dados.

Imagine que voc√™ est√°:

1. üèóÔ∏è Criando um projeto de esta√ß√£o (migra√ß√£o `create_planets_table`)
2. üöÄ Implantando m√≥dulos (executando migra√ß√µes)
3. üîß Modernizando a constru√ß√£o (novas migra√ß√µes)
4. ‚è™ Pode reverter para uma vers√£o anterior (rollback)

> üí° **Importante:** As migra√ß√µes permitem que a equipe trabalhe de forma consistente ‚Äì como engenheiros em diferentes continentes construindo a ISS!

---

#### **2. Executando Migra√ß√µes**
Ap√≥s criar a migra√ß√£o no cap√≠tulo 2.2, execute:
```bash
php artisan migrate
```

**Sa√≠da no terminal:**
```
Migration table created successfully.
Migrating: 2014_10_12_000000_create_users_table
Migrated:  2014_10_12_000000_create_users_table (25.12ms)
Migrating: 2014_10_12_100000_create_password_reset_tokens_table
Migrated:  2014_10_12_100000_create_password_reset_tokens_table (18.07ms)
Migrating: 2019_08_19_000000_create_failed_jobs_table
Migrated:  2019_08_19_000000_create_failed_jobs_table (21.33ms)
Migrating: 2019_12_14_000001_create_personal_access_tokens_table
Migrated:  2019_12_14_000001_create_personal_access_tokens_table (30.45ms)
Migrating: 2025_08_04_000000_create_planets_table
Migrated:  2025_08_04_000000_create_planets_table (15.67ms)  # Sua tabela!
```

**Verifica√ß√£o no pgAdmin 4:**

1. Abra o banco de dados `space_api` ‚Üí Schemas ‚Üí Tables
2. Certifique-se de que apareceram:   - `planets`   - `users`   - `password_reset_tokens`

---

#### **3. Revertendo Migra√ß√µes: Retorno de Emerg√™ncia**
Se precisar corrigir a estrutura:
```bash
php artisan migrate:rollback  # Reverte o √∫ltimo lote de migra√ß√µes
```
```bash
php artisan migrate:reset    # Reverte todas as migra√ß√µes completamente
```

- ```php artisan migrate:fresh``` ‚Äî **a comando mais √∫til no desenvolvimento!** Ele remove todas as tabelas e executa novamente todas as migra√ß√µes.
- ```php artisan migrate:fresh --seed``` ‚Äî faz o mesmo que `fresh`, mas ap√≥s as migra√ß√µes, executa imediatamente os seeders. Este √© um comando para "recriar" completamente o banco de dados do zero.


**Cen√°rio de uso:**
```bash
# Passo 1: Percebemos que h√° um erro na migra√ß√£o. Recriamos completamente o banco de dados.
php artisan migrate:fresh
# Passo 2: Editamos a migra√ß√£o
# Passo 3: Recriamos novamente o banco de dados com a migra√ß√£o j√° corrigida
php artisan migrate:fresh
```

---

#### **4. Adicionando Novos Campos: Modernizando a Esta√ß√£o**
**Exemplo:** Adicionaremos o campo `is_habitable` (se o planeta √© habit√°vel).

**Passo 1: Criamos uma nova migra√ß√£o**
```bash
php artisan make:migration add_is_habitable_to_planets_table
```

**Passo 2: Editamos o arquivo** `database/migrations/..._add_is_habitable_to_planets_table.php`
```php
<?php
public function up()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->boolean('is_habitable')
              ->default(false);
    });
}

public function down()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->dropColumn('is_habitable');
    });
}
```

**Passo 3: Executamos a atualiza√ß√£o**
```bash
php artisan migrate
```

---

#### **5. Preenchendo o Banco de Dados: Primeiros Planetas**
Criamos um **seeder** ‚Äî um script para gerar dados de teste.

**Passo 1: Gera√ß√£o do seeder**
```bash
php artisan make:seeder PlanetSeeder
```

**Passo 2: Editamos** `database/seeders/PlanetSeeder.php`
```php
<?php
use App\Models\Planet; // Importamos o modelo do planeta - Sem ele, voc√™ receber√° um erro!


class PlanetSeeder extends Seeder
{
    public function run()
    {
        Planet::create([
            'name' => 'Terra',
            'description' => 'Planeta azul com vida diversa',
            'size_km' => 12742,
            'solar_system' => 'Sistema Solar',
            'image_url' => 'https://example.com/earth.jpg',
            'is_habitable' => true
        ]);

        Planet::create([
            'name' => 'Marte',
            'description' => 'Planeta vermelho, alvo de futuras coloniza√ß√µes',
            'size_km' => 6779,
            'solar_system' => 'Sistema Solar',
            'is_habitable' => false
        ]);
    }
}
```

**Passo 3: Registramos o seeder em** `database/seeders/DatabaseSeeder.php`
```php
<?php
public function run()
{
    $this->call([
        PlanetSeeder::class
    ]);
}
```

**Passo 4: Executando o preenchimento**
```bash
php artisan db:seed
```

---

#### **6. Trabalhando com PostgreSQL: Especificidades**
**Caracter√≠sticas do tipo de dados:**

| Funcionalidade | PostgreSQL | MySQL | Coment√°rio Laravel |
|---|---|---|---|
| **Tipo Booleano** | `boolean` (verdadeiro `true`/`false`) | `tinyint(1)` (armazena `0`/`1`) | `$table->boolean('...')` funciona para ambos |
| **JSON** | `jsonb` (bin√°rio, index√°vel) | `json` (textual) | `$table->jsonb('...')` - muito poderoso no PG |
| **Arrays** | `text[]`, `integer[]` (arrays nativos) | N√£o (emulado via JSON ou strings) | `$table->array('...')` (exclusivo para PG) |
| **Ordem das colunas** | N√£o pode ser controlado (`after()` n√£o funciona) | Pode ser controlado (`after()`) | Laravel abstrai isso, mas √© importante saber da limita√ß√£o |


**Exemplo de cria√ß√£o de √≠ndice:**
```php
// Na migra√ß√£o
$table->index('solar_system');
```

---

#### **7. Verificando dados no psql**

Voc√™ pode usar qualquer cliente gr√°fico e selecionar `space_api` l√° para visualiza√ß√£o.

Ao usar o console:
```bash
psql -U postgres -d space_api
# O terminal pode pedir a senha que voc√™ definiu durante a instala√ß√£o do PostgreSQL.
```
```sql
SELECT * FROM planets;
```

De qualquer forma, a sa√≠da deve ser a seguinte:

 id |  name  | description | size_km |  solar_system   | image_url | is_habitable |
|---|---|---|---|---|---|---|
  1 | Terra  | Planeta azul com vida diversa   |   12742 | Sistema Solar| ...       | true |
  2 | Marte   | Planeta vermelho, alvo de coloniza√ß√µes        |    6779 | Sistema Solar| null      | false |


---

#### **Quiz para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Comando para executar migra√ß√µes:</p>
      <label><input type="radio" name="q1" value="a"> a) php artisan migrate:run</label>
      <label><input type="radio" name="q1" value="b"> b) php artisan migrate</label>
      <label><input type="radio" name="q1" value="c"> c) php artisan db:migrate</label>
    </div>
    <div class="question">
      <p>2. Como reverter a √∫ltima migra√ß√£o?</p>
      <label><input type="radio" name="q2" value="a"> a) migrate:undo</label>
      <label><input type="radio" name="q2" value="b"> b) migrate:rollback</label>
      <label><input type="radio" name="q2" value="c"> c) migrate:reset</label>
    </div>
    <div class="question">
      <p>3. Seeders s√£o usados para:</p>
      <label><input type="radio" name="q3" value="a"> a) Excluir tabelas</label>
      <label><input type="radio" name="q3" value="b"> b) Preencher o BD com dados de teste</label>
      <label><input type="radio" name="q3" value="c"> c) Criar modelos</label>
    </div>
    <div class="question">
      <p>4. M√©todo para adicionar uma coluna a uma tabela existente:</p>
      <label><input type="radio" name="q4" value="a"> a) Schema::addColumn()</label>
      <label><input type="radio" name="q4" value="b"> b) Schema::table()</label>
      <label><input type="radio" name="q4" value="c"> c) Schema::modify()</label>
    </div>
    <div class="question">
      <p>5. Onde os seeders s√£o registrados?</p>
      <label><input type="radio" name="q5" value="a"> a) DatabaseSeeder.php</label>
      <label><input type="radio" name="q5" value="b"> b) .env</label>
      <label><input type="radio" name="q5" value="c"> c) config/database.php</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;
      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ Resumo do Cap√≠tulo:**

Voc√™ dominou a "constru√ß√£o de infraestrutura espacial":

- ‚úÖ Criou e executou migra√ß√µes
- üîß Modernizou a estrutura da tabela
- üåç Preencheu o BD com os primeiros planetas
- ‚öôÔ∏è Aprendeu a trabalhar com PostgreSQL

**Seu universo ganhou os primeiros mundos!** Agora voc√™ pode prosseguir para a cria√ß√£o de interfaces API para gerenciar planetas.

> **üìå Verifica√ß√£o:**

> 1. Execute `php artisan tinker`
> 2. Execute `App\Models\Planet::all()`
> 3. Certifique-se de que v√™ a Terra e Marte
