# **Cap√≠tulo 5.4: Trabalhando com Tokens CSRF**
**Tempo de estudo:** 30 minutos

---

### **1. O que √© um ataque CSRF? O "Sequestro" da sua nave**

Imagine que voc√™ est√° logado no painel de controle da sua frota espacial (`space-api.test`). Em uma aba vizinha, voc√™ abre um site inofensivo de gatinhos (`evil-cats.com`). Neste site, h√° um formul√°rio oculto que envia automaticamente uma requisi√ß√£o para o seu site no endere√ßo `POST /api/planets/1/delete`.

Como voc√™ j√° est√° autenticado em `space-api.test`, seu navegador gentilmente anexar√° todos os seus cookies a essa requisi√ß√£o. O servidor Laravel ver√° uma sess√£o v√°lida e pensar√° que foi voc√™ quem decidiu desativar o planeta. **O planeta ser√° exclu√≠do sem o seu conhecimento.**

Isso √© **CSRF (Cross-Site Request Forgery)** ‚Äî um ataque no qual um invasor for√ßa o navegador de um usu√°rio autenticado a executar uma a√ß√£o indesejada em um site confi√°vel.

> üí° **Analogia espacial:**

> Voc√™ √© o capit√£o da nave e tem um cart√£o-chave (sess√£o/cookie). O invasor n√£o pode roubar seu cart√£o. Mas ele pode, por engano, fazer voc√™ pass√°-lo em um terminal de descarte de recursos enquanto voc√™ est√° distra√≠do. O token CSRF √© como um c√≥digo PIN que precisa ser inserido junto com o cart√£o. O invasor n√£o sabe o c√≥digo PIN, e seu ataque falha.

---

### **2. Como o Laravel protege contra CSRF?**

Por padr√£o, o Laravel protege todas as requisi√ß√µes web "inseguras" (POST, PUT, PATCH, DELETE) usando um **token CSRF**.

1.  Ao gerar uma p√°gina, o Laravel cria um token √∫nico e aleat√≥rio para a sess√£o do usu√°rio.
2.  Este token √© incorporado nos formul√°rios HTML.
3.  Ao enviar o formul√°rio, o token √© enviado junto com a requisi√ß√£o.
4.  No servidor, o middleware `VerifyCsrfToken` compara o token da requisi√ß√£o com o token armazenado na sess√£o.
5.  **Se os tokens n√£o coincidirem, o Laravel interrompe a requisi√ß√£o com um erro 419 (Sess√£o Expirada/P√°gina Expirada).**

**Importante:** As rotas de API em `routes/api.php` **n√£o** s√£o protegidas por CSRF, pois elas presumem um mecanismo de autentica√ß√£o diferente (por exemplo, tokens Sanctum), e n√£o sess√µes baseadas em cookies. Nosso problema atual refere-se especificamente √†s rotas web e p√°ginas que criamos em `routes/web.php`.

---

### **3. Usando o Token CSRF em Formul√°rios HTML**
Este √© o cen√°rio mais simples. O Laravel fornece uma diretiva Blade especial para isso.

**Exemplo: Formul√°rio para criar um planeta**
Vamos criar um formul√°rio simples no arquivo `resources/views/planets/create.blade.php`:

```html
<h2>Formul√°rio para Lan√ßamento de um Novo Planeta</h2>
<form action="/planets" method="POST">
    @csrf {{-- Aqui est√° a m√°gica! --}}

    <label for="name">Nome:</label>
    <input type="text" id="name" name="name" required>

    <label for="solar_system">Sistema Solar:</label>
    <input type="text" id="solar_system" name="solar_system" required>

    {{-- ... outros campos ... --}}

    <button type="submit">Lan√ßar</button>
</form>
```

A diretiva `@csrf` gerar√° automaticamente um campo oculto no formul√°rio:
```html
<input type="hidden" name="_token" value="j2aK3dLf4gH5...token_√∫nico...">
```

Isso √© suficiente para proteger formul√°rios HTML padr√£o.

---

### **4. Usando o Token CSRF em Requisi√ß√µes AJAX/Fetch**

No cap√≠tulo anterior, enviamos uma requisi√ß√£o `DELETE` usando JavaScript. Agora, o Laravel a bloquear√° com um erro 419. Precisamos adicionar o token CSRF aos cabe√ßalhos da nossa requisi√ß√£o Fetch.

**Passo 1: Tornar o token dispon√≠vel para JavaScript**

Adicione uma meta tag com o token na `<head>` do seu layout mestre `resources/views/app.blade.php`. Esta √© uma pr√°tica padr√£o no Laravel.

```blade
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {{-- Adicionamos o token CSRF na meta tag --}}
    <meta name="csrf-token" content="{{ csrf_token() }}">

    {{-- ... --}}
</head>
```

A fun√ß√£o `csrf_token()` retorna o token atual.

**Passo 2: Modificar o JavaScript para enviar o token**

Agora, em nosso `public/js/planets.js`, podemos ler este token e adicion√°-lo aos cabe√ßalhos de todas as requisi√ß√µes "inseguras".

```javascript
// ... no arquivo public/js/planets.js ...

document.addEventListener('DOMContentLoaded', () => {
    // Obtenha o token da meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const deleteButtons = document.querySelectorAll('.delete-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            // ... l√≥gica de confirma√ß√£o ...

            try {
                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': csrfToken // <-- Adicionamos o token nos cabe√ßalhos!
                    }
                });

                // ... o resto da l√≥gica de processamento da resposta ...
            } catch (error) {
                // ...
            }
        });
    });
});
```

-   O nome do cabe√ßalho `X-CSRF-TOKEN` √© um padr√£o que o Laravel verifica por padr√£o.

Agora nossas requisi√ß√µes AJAX tamb√©m est√£o protegidas. Tente excluir um planeta novamente ‚Äî desta vez, a requisi√ß√£o ser√° bem-sucedida.

---

### **Question√°rio para Fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Qual ataque o token CSRF previne?</p>
      <label><input type="radio" name="q1" value="a"> a) Inje√ß√µes SQL</label>
      <label><input type="radio" name="q1" value="b"> b) Cross-site scripting</label>
      <label><input type="radio" name="q1" value="c"> c) Falsifica√ß√£o de requisi√ß√£o entre sites</label>
    </div>
    <div class="question">
      <p>2. Qual diretiva Blade adiciona um campo oculto com o token CSRF a um formul√°rio?</p>
      <label><input type="radio" name="q2" value="a"> a) @token</label>
      <label><input type="radio" name="q2" value="b"> b) @csrf</label>
      <label><input type="radio" name="q2" value="c"> c) @form_token</label>
    </div>
    <div class="question">
      <p>3. O que acontece se uma requisi√ß√£o POST for enviada para uma rota web sem o token CSRF?</p>
      <label><input type="radio" name="q3" value="a"> a) Erro 500 (Erro Interno do Servidor)</label>
      <label><input type="radio" name="q3" value="b"> b) Erro 403 (Proibido)</label>
      <label><input type="radio" name="q3" value="c"> c) Erro 419 (P√°gina Expirada / Sess√£o Expirada)</label>
    </div>
    <div class="question">
      <p>4. Qual cabe√ßalho HTTP padr√£o √© usado para enviar o token CSRF em requisi√ß√µes AJAX?</p>
      <label><input type="radio" name="q4" value="a"> a) Authorization</label>
      <label><input type="radio" name="q4" value="b"> b) X-CSRF-TOKEN</label>
      <label><input type="radio" name="q4" value="c"> c) Content-Type</label>
    </div>
    <div class="question">
      <p>5. Por que as rotas de API (`routes/api.php`) n√£o usam prote√ß√£o CSRF por padr√£o?</p>
      <label><input type="radio" name="q5" value="a"> a) Porque s√£o projetadas para autentica√ß√£o sem estado</label>
      <label><input type="radio" name="q5" value="b"> b) √â um erro no Laravel, elas precisam ser ativadas manualmente</label>
      <label><input type="radio" name="q5" value="c"> c) Porque requisi√ß√µes de API n√£o podem ser falsificadas</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---
**üöÄ Resumo do Cap√≠tulo:**

Voc√™ instalou um "sistema de identifica√ß√£o amigo ou inimigo" em sua nave espacial, protegendo-a de ataques CSRF. Voc√™ aprendeu a:

-   Compreender a natureza e o perigo dos ataques CSRF.
-   Proteger formul√°rios HTML padr√£o usando a diretiva `@csrf`.
-   Passar o token CSRF para JavaScript via meta tag.
-   Incluir o token nos cabe√ßalhos de requisi√ß√µes AJAX/Fetch para sua execu√ß√£o bem-sucedida.

**Suas interfaces web agora n√£o s√£o apenas interativas, mas tamb√©m seguras.** No pr√≥ximo cap√≠tulo, concluiremos a cria√ß√£o de nossa interface web, abordando como organizar corretamente o roteamento para p√°ginas web.