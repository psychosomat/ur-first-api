# **Cap√≠tulo 6.2: Configura√ß√µes CORS**
**Tempo de estudo:** 30 minutos

---
#### **1. CORS: O que √© e para que serve?**

Como descobrimos, **CORS (Cross-Origin Resource Sharing)** ‚Äî √© uma pol√≠tica de seguran√ßa do navegador. Ela previne situa√ß√µes em que um site malicioso `evil-site.com`, em seu nome (usando seus cookies), faz requisi√ß√µes para `your-bank.com` e rouba dados.

**Como funciona?**

1.  O Frontend (navegador) do dom√≠nio `A` quer obter dados do dom√≠nio `B`.
2.  O navegador envia para o dom√≠nio `B` uma requisi√ß√£o "pr√©via" especial (preflight request) com o m√©todo `OPTIONS`, perguntando: "Ei, dom√≠nio `B`, posso eu, dom√≠nio `A`, fazer uma requisi√ß√£o `GET` para voc√™?"
3.  O Backend (servidor no dom√≠nio `B`) deve responder com cabe√ßalhos HTTP especiais, por exemplo: `Access-Control-Allow-Origin: A`.
4.  Se a resposta do servidor permitir a requisi√ß√£o, o navegador envia a requisi√ß√£o `GET` principal. Caso contr√°rio, ele a bloqueia e exibe um erro CORS.

> üí° **Analogia espacial:**

> Antes de teletransportar o capit√£o para uma esta√ß√£o alien√≠gena (enviar uma requisi√ß√£o `POST`), a nave (navegador) envia um drone (requisi√ß√£o `OPTIONS`) com a pergunta: "Esta√ß√£o, voc√™s aceitam teletransporte da nave 'Enterprise'?". A esta√ß√£o (API) responde: "Sim, a recep√ß√£o da 'Enterprise' √© permitida" (cabe√ßalho `Access-Control-Allow-Origin`). Somente depois disso o teletransporte come√ßa.

---

#### **2. Configura√ß√£o CORS no Laravel (Abordagem moderna para Laravel 11+)**
No Laravel 11+, a configura√ß√£o CORS tornou-se significativamente mais simples e n√£o exige a publica√ß√£o do arquivo `config/cors.php`, se voc√™ precisar de configura√ß√µes b√°sicas. Tudo √© gerenciado atrav√©s do arquivo `.env` e `bootstrap/app.php`.

**Passo 1: Configura√ß√£o via vari√°veis de ambiente**

Abra seu arquivo `.env`. O Laravel j√° fornece vari√°veis padr√£o para gerenciar o CORS para a API.

```env
# .env

# ... outras vari√°veis

# Especifique os caminhos para os quais o CORS ser√° aplicado.
# 'api/*' - valor padr√£o para todas as rotas de API.
CORS_PATHS=api/*

# Especifique as origens (dom√≠nios) permitidas.
# Para desenvolvimento, especifique o endere√ßo do seu frontend.
# Podem ser listados separados por v√≠rgulas, sem espa√ßos.
CORS_ALLOWED_ORIGINS=http://localhost:5500,http://127.0.0.1:5500

# Outras configura√ß√µes (geralmente podem ser deixadas como padr√£o)
CORS_ALLOWED_METHODS=*
CORS_ALLOWED_HEADERS=*
CORS_EXPOSED_HEADERS=
CORS_MAX_AGE=0
CORS_SUPPORTS_CREDENTIALS=false
```

**Vari√°veis chave:**

- `CORS_ALLOWED_ORIGINS`: **A vari√°vel mais importante.** Aqui voc√™ lista os dom√≠nios dos quais as requisi√ß√µes s√£o permitidas. `*` permite a todos, mas isso √©

**extremamente inseguro para produ√ß√£o**.

- `CORS_PATHS`: Caminhos aos quais estas regras se aplicam. `api/*` significa tudo que come√ßa com `/api/`.

Ap√≥s alterar o `.env` **n√£o √© necess√°rio** reiniciar o servidor, se voc√™ estiver usando `php artisan serve`. As altera√ß√µes ser√£o carregadas automaticamente.

**Passo 2 (Opcional): Configura√ß√£o avan√ßada em `bootstrap/app.php`**

Se voc√™ precisar de uma l√≥gica mais complexa (por exemplo, permitir subdom√≠nios usando padr√µes), ainda precisar√° publicar o arquivo de configura√ß√£o e configurar o middleware. Mas para 95% dos casos, o arquivo `.env` √© suficiente.

O comando `php artisan install:api` configura automaticamente o middleware CORS b√°sico para rotas de API no arquivo `bootstrap/app.php`. Fica assim:

```php
// bootstrap/app.php
->withMiddleware(function (Middleware $middleware) {
    // Esta linha j√° ser√° adicionada pelo comando install:api
    // Ela inclui o tratamento CORS para todas as rotas de API
    $middleware->api(base_path('routes/api.php'));
})
```

Dentro de `->api()`, o Laravel j√° utiliza o middleware `HandleCors`, que l√™ as configura√ß√µes do seu `.env`. √â simples e funciona "out of the box".

> ‚ö†Ô∏è **Importante!** N√£o use `CORS_ALLOWED_ORIGINS='*'` em um servidor de produ√ß√£o, se sua API n√£o for totalmente p√∫blica. Isso abre uma potencial vulnerabilidade. Sempre liste os dom√≠nios espec√≠ficos do seu frontend.

---

#### **3. Configura√ß√£o CORS no FastAPI**

FastAPI usa o conceito de **Middleware** (software intermedi√°rio) para lidar com tarefas transversais como CORS.

**Passo 1: Abra o arquivo principal da sua aplica√ß√£o**

Este √© o arquivo onde voc√™ cria uma inst√¢ncia do FastAPI (geralmente `main.py`).

**Passo 2: Adicione `CORSMiddleware`**

FastAPI fornece um middleware pronto para configurar o CORS.

```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware # 1. Importa o middleware

app = FastAPI(
    title="SpaceAPI",
    description="API para gerenciar planetas na gal√°xia",
    version="1.0.0"
)

# 2. Lista de origens permitidas
origins = [
    "http://localhost:5500",
    "http://127.0.0.1:5500",
    # Em produ√ß√£o, aqui estar√° o dom√≠nio do seu frontend
    # "https://my-awesome-app.com",
]

# 3. Adiciona o middleware √† aplica√ß√£o
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # Permite as origens especificadas
    allow_credentials=True, # Permite cookies (necess√°rio para autentica√ß√£o)
    allow_methods=["*"],    # Permite todos os m√©todos (GET, POST, etc.)
    allow_headers=["*"],    # Permite todos os cabe√ßalhos
)

# ... aqui seus roteadores e o restante do c√≥digo
```

**Passo 3: Reinicie o servidor Uvicorn**
O servidor Uvicorn geralmente recarrega automaticamente quando o c√≥digo √© alterado. Se n√£o, reinicie-o manualmente. Agora, seu servidor FastAPI responder√° corretamente √†s requisi√ß√µes `OPTIONS` do frontend.

---

#### **Quiz para fixa√ß√£o**


<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. A requisi√ß√£o que o navegador envia antes da principal para verificar o CORS √© chamada de:</p>
      <label><input type="radio" name="q1" value="a"> a) CHECK request</label>
      <label><input type="radio" name="q1" value="b"> b) Preflight request</label>
      <label><input type="radio" name="q1" value="c"> c) Handshake request</label>
    </div>
    <div class="question">
      <p>2. No Laravel moderno (11+), as configura√ß√µes b√°sicas de CORS s√£o definidas principalmente em:</p>
      <label><input type="radio" name="q2" value="a"> a) Arquivo bootstrap/app.php</label>
      <label><input type="radio" name="q2" value="b"> b) Arquivo .env</label>
      <label><input type="radio" name="q2" value="c"> c) Arquivo routes/api.php</label>
    </div>
    <div class="question">
      <p>3. No FastAPI, para configurar o CORS, utiliza-se:</p>
      <label><input type="radio" name="q3" value="a"> a) O decorador @app.cors()</label>
      <label><input type="radio" name="q3" value="b"> b) A classe Security embutida</label>
      <label><input type="radio" name="q3" value="c"> c) O Middleware</label>
    </div>
    <div class="question">
      <p>4. Qual valor para CORS_ALLOWED_ORIGINS √© o mais seguro para produ√ß√£o?</p>
      <label><input type="radio" name="q4" value="a"> a) CORS_ALLOWED_ORIGINS='*'</label>
      <label><input type="radio" name="q4" value="b"> b) CORS_ALLOWED_ORIGINS=http://my-frontend.com,https://my-frontend.com`</label>
      <label><input type="radio" name="q4" value="c"> c) N√£o definir esta vari√°vel</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pergunta ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumo do Cap√≠tulo:**

Voc√™ se tornou um "diplomata de comunica√ß√µes interestelares"! Suas APIs agora podem interagir com seguran√ßa com aplicativos externos, utilizando abordagens modernas e corretas.
- ‚úÖ Entendemos o mecanismo de funcionamento do CORS e das solicita√ß√µes preflight.
- üîß Configuramos o CORS para Laravel 11+ atrav√©s do arquivo `.env`.
- ‚öôÔ∏è Configuramos o CORS para FastAPI usando `CORSMiddleware`.
- üõ∞Ô∏è Estabelecemos com sucesso a comunica√ß√£o entre o frontend e o backend.

**A ponte de comunica√ß√£o est√° constru√≠da e protegida.** Agora podemos pensar em como permitir a passagem nesta ponte apenas de "pessoal autorizado".

> **üìå Verifica√ß√£o:**

> - O principal crit√©rio de sucesso √© a aus√™ncia de erros CORS no console do navegador ao solicitar dados do frontend.
> - Na aba "Network" (Rede) nas ferramentas do desenvolvedor, voc√™ pode ver duas solicita√ß√µes para sua API: a primeira com o m√©todo `OPTIONS` (status 200/204) e a segunda com o m√©todo `GET` (status 200). Esta √© uma demonstra√ß√£o clara do funcionamento do CORS.