# **Cap√≠tulo 4.3: Envio de requisi√ß√µes POST/PUT/DELETE**
**Tempo de estudo:** 1 hora

---

#### **1. Comandos Ativos: Do Lan√ßamento √† Desativa√ß√£o**
At√© agora, nosso Centro de Controle da Miss√£o apenas solicitava informa√ß√µes (`GET`). Agora aprenderemos a enviar **comandos ativos**:

- **POST:** "Lan√ßar um novo sat√©lite em √≥rbita!"
- **PUT:** "Realizar uma moderniza√ß√£o completa dos sistemas na ISS!"
- **DELETE:** "Retirar da √≥rbita a antiga nave `Debris-123`!"

Para isso, usaremos `fetch`, mas com par√¢metros adicionais que descrevem nosso comando.

> üí° **Analogia Espacial:**

> Se `GET` √© a escuta passiva da transmiss√£o de r√°dio, ent√£o `POST`, `PUT` e `DELETE` s√£o a **transmiss√£o ativa de comandos**. Para isso, precisamos n√£o apenas especificar a "frequ√™ncia" (URL), mas tamb√©m o **conte√∫do do comando** (corpo da requisi√ß√£o) e o **protocolo de comunica√ß√£o** (cabe√ßalhos).

---

#### **2. Envio de requisi√ß√£o POST: Lan√ßamento de uma nova nave**
Para criar um novo recurso, enviamos uma requisi√ß√£o `POST`. O mais importante aqui √© passar o **corpo (body)** da requisi√ß√£o com os dados do novo objeto.

**Passo 1: Adicionar o formul√°rio de cria√ß√£o em `index.html`**
Vamos coloc√°-lo ap√≥s o bloco "Requisi√ß√£o por ID".
```html
<!-- index.html -->
<hr>
<h2>Lan√ßar nova nave</h2>
<form id="create-ship-form">
    <input type="text" id="create-name" placeholder="Nome" required><br>
    <input type="text" id="create-type" placeholder="Tipo" required><br>
    <input type="number" id="create-year" placeholder="Ano de Lan√ßamento" required><br>
    <input type="text" id="create-status" placeholder="Status" required><br>
    <button type="submit">Lan√ßar</button>
</form>
<div id="create-status-message"></div>
```

**Passo 2: Adicionar a l√≥gica em `app.js`**
```javascript
// app.js, no final do arquivo

const createShipForm = document.getElementById('create-ship-form');
const createStatusMessage = document.getElementById('create-status-message');

async function createShip(event) {
    event.preventDefault();

    // 1. Coletamos os dados do formul√°rio em um objeto
    const shipData = {
        name: document.getElementById('create-name').value,
        type: document.getElementById('create-type').value,
        launch_year: parseInt(document.getElementById('create-year').value),
        status: document.getElementById('create-status').value
    };

    try {
        createStatusMessage.textContent = 'Enviando comando de lan√ßamento...';

        // 2. Enviamos uma requisi√ß√£o fetch com par√¢metros
        const response = await fetch(`${API_BASE_URL}/spaceships`, {
            method: 'POST', // Especifica o m√©todo
            headers: {
                'Content-Type': 'application/json' // Dizemos ao servidor que estamos enviando JSON
            },
            body: JSON.stringify(shipData) // Transforma o objeto JavaScript em uma string JSON
        });

        if (!response.ok) {
            // Se o servidor retornou um erro, tentamos ler o corpo
            const errorData = await response.json();
            throw new Error(errorData.detail || `Erro do servidor: ${response.status}`);
        }

        const newShip = await response.json();
        createStatusMessage.textContent = `üöÄ Lan√ßamento bem-sucedido! ID atribu√≠do √† nave: ${newShip.id}`;

        createShipForm.reset(); // Limpa o formul√°rio
        fetchAndDisplayFleet(); // Atualiza a lista geral da frota

    } catch (error) {
        console.error('Erro ao lan√ßar a nave:', error);
        createStatusMessage.textContent = `üî¥ Erro: ${error.message}`;
    }
}

createShipForm.addEventListener('submit', createShip);
```
**Pontos chave do `fetch` para POST:**

- **`method: 'POST'`**: Obrigat√≥rio especificar o m√©todo HTTP.
- **`headers: { 'Content-Type': 'application/json' }`**: Cabe√ßalho crucial. Ele informa ao nosso servidor FastAPI que o corpo da requisi√ß√£o cont√©m JSON, e que precisa ser interpretado.
- **`body: JSON.stringify(shipData)`**: N√£o podemos enviar um objeto JavaScript diretamente. Ele precisa ser serializado (transformado) em uma string JSON.

---

#### **3. Envio de requisi√ß√£o DELETE: Desativa√ß√£o de uma nave**
A requisi√ß√£o de exclus√£o √© mais simples ‚Äî geralmente n√£o precisa de corpo, apenas a URL com o ID do objeto.

**Passo 1: Adicionar o bot√£o "Excluir" √† nossa lista de naves**
Modificaremos a fun√ß√£o `fetchAndDisplayFleet` em `app.js` para que ela adicione um bot√£o de exclus√£o para cada item.
```javascript
// app.js, dentro da fun√ß√£o fetchAndDisplayFleet

// ...
ships.forEach(ship => {
    const listItem = document.createElement('li');
    // Adiciona um bot√£o com um atributo data que armazena o ID
    listItem.innerHTML = `
        <strong>${ship.name} (ID: ${ship.id})</strong><br>
        Tipo: ${ship.type} | Ano: ${ship.launch_year} | Status: ${ship.status}<br>
        <button class="delete-btn" data-ship-id="${ship.id}">Desativar nave</button>
    `;
    fleetList.appendChild(listItem);
});
// ...
```

**Passo 2: Adicionar um manipulador para todos os bot√µes "Excluir"**
Usamos delega√ß√£o de eventos ‚Äî um √∫nico manipulador para toda a lista.
```javascript
// app.js, no final do arquivo

async function deleteShip(shipId) {
    if (!confirm(`Tem certeza de que deseja desativar a nave com ID ${shipId}? Esta a√ß√£o √© irrevers√≠vel.`)) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/spaceships/${shipId}`, {
            method: 'DELETE' // Especifica o m√©todo
        });

        if (!response.ok) {
            throw new Error(`N√£o foi poss√≠vel desativar a nave. Status: ${response.status}`);
        }

        alert(`Nave com ID ${shipId} desativada com sucesso.`);
        fetchAndDisplayFleet(); // Atualiza a lista

    } catch (error) {
        console.error('Erro ao desativar:', error);
        alert(`Erro: ${error.message}`);
    }
}

// Delega√ß√£o de eventos: escuta cliques em toda a lista
fleetList.addEventListener('click', (event) => {
    // Verifica se o clique foi em um bot√£o com a classe 'delete-btn'
    if (event.target.classList.contains('delete-btn')) {
        const shipId = event.target.dataset.shipId; // Obt√©m o ID do atributo data
        deleteShip(shipId);
    }
});
```

**Passo 3: Adicionar id ao modelo Spaceship**

Adiciona id ao modelo e ao banco de dados no arquivo `main.py`

```python
class Spaceship(BaseModel):
    id: int
	# Restante do c√≥digo do modelo...

db_spaceships = {
    1: {
        "id": 1,
        # Dados do elemento 1
    },
    2: {
        "id": 2,
        # Dados do elemento 2
    },
    3: {
        "id": 3,
		# Dados do elemento 3
    }
}
```


- **`method: 'DELETE'`**: Especifica o m√©todo. Corpo e cabe√ßalhos n√£o s√£o necess√°rios aqui.
- `confirm()`: Uma janela de confirma√ß√£o integrada simples para evitar a exclus√£o acidental de algo importante.

---

#### **4. Envio de requisi√ß√£o PUT (Tarefa Aut√¥noma)**
A implementa√ß√£o da requisi√ß√£o `PUT` para atualiza√ß√£o √© muito semelhante √† `POST`.

**Sua miss√£o, se decidir aceit√°-la:**

1.  Adicionar um bot√£o "Editar" ao lado do bot√£o "Excluir" para cada nave.
2.  Ao clicar em "Editar", preencher o formul√°rio (pode-se usar o mesmo de cria√ß√£o) com os dados atuais da nave.
3.  Mudar o texto do bot√£o "Lan√ßar" para "Atualizar".
4.  Ao enviar o formul√°rio, enviar uma requisi√ß√£o `PUT` para ` /spaceships/{id}` com o corpo completo do objeto.
5.  Ap√≥s a atualiza√ß√£o bem-sucedida, atualizar a lista da frota.

> **Dica:** Voc√™ precisar√° de `fetch` com `method: 'PUT'`, cabe√ßalhos `Content-Type` e `body` com `JSON.stringify()`, exatamente como na requisi√ß√£o POST.

---

#### **Quiz para fixa√ß√£o**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Qual par√¢metro `fetch` √© usado para enviar dados no corpo da requisi√ß√£o?</p>
      <label><input type="radio" name="q1" value="a"> a) `data`</label>
      <label><input type="radio" name="q1" value="b"> b) `body`</label>
      <label><input type="radio" name="q1" value="c"> c) `payload`</label>
    </div>
    <div class="question">
      <p>2. O cabe√ßalho `'Content-Type': 'application/json'` informa ao servidor que...</p>
      <label><input type="radio" name="q2" value="a"> a) O cliente espera receber uma resposta em formato JSON</label>
      <label><input type="radio" name="q2" value="b"> b) O cliente est√° enviando dados no corpo da requisi√ß√£o em formato JSON</label>
      <label><input type="radio" name="q2" value="c"> c) A conex√£o deve ser criptografada</label>
    </div>
    <div class="question">
      <p>3. A fun√ß√£o `JSON.stringify(obj)` em JavaScript faz o qu√™?</p>
      <label><input type="radio" name="q3" value="a"> a) Converte uma string JSON em um objeto</label>
      <label><input type="radio" name="q3" value="b"> b) Verifica a validade de um objeto</label>
      <label><input type="radio" name="q3" value="c"> c) Converte um objeto JavaScript em uma string JSON</label>
    </div>
    <div class="question">
      <p>4. Para enviar uma requisi√ß√£o `DELETE` usando `fetch`, √© obrigat√≥rio especificar:</p>
      <label><input type="radio" name="q4" value="a"> a) Um `body` vazio</label>
      <label><input type="radio" name="q4" value="b"> b) `method: 'DELETE'`</label>
      <label><input type="radio" name="q4" value="c"> c) O cabe√ßalho `Authorization`</label>
    </div>
    <div class="question">
      <p>5. Delega√ß√£o de eventos em JavaScript √© quando...</p>
      <label><input type="radio" name="q5" value="a"> a) N√≥s anexamos um √∫nico manipulador a um elemento pai em vez de v√°rios aos elementos filhos</label>
      <label><input type="radio" name="q5" value="b"> b) N√≥s transferimos o direito de executar uma fun√ß√£o para outro script</label>
      <label><input type="radio" name="q5" value="c"> c) O evento ocorre com um atraso</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:green;">Correto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:red;">Incorreto.</span> Resposta correta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Quest√£o ${question.slice(1)}: <span style="color:orange;">Sem resposta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Seu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ Resumo do Cap√≠tulo:**

Seu Centro de Controle da Miss√£o (CCM) agora possui um conjunto completo de comandos para gerenciar a frota!

- ‚úÖ Voc√™ aprendeu a enviar `POST`-requisi√ß√µes com corpo e cabe√ßalhos para criar novos recursos.
- ‚úÖ Voc√™ implementou `DELETE`-requisi√ß√µes para desativar equipamentos obsoletos.
- ‚úÖ Voc√™ recebeu a tarefa de implementar uma `PUT`-requisi√ß√£o, consolidando seu conhecimento.

**Controle total estabelecido!** Mas o que fazer se a conex√£o for perdida ou o servidor relatar um erro? No pr√≥ximo cap√≠tulo, criaremos um sistema centralizado de tratamento de erros no frontend.

> **üìå Verifica√ß√£o:**

> - Certifique-se de que o formul√°rio de cria√ß√£o de nova nave funcione e que a lista na p√°gina seja atualizada ap√≥s a cria√ß√£o bem-sucedida.
> - Verifique se o bot√£o "Desativar Equipamento" funciona, solicita confirma√ß√£o e remove a nave da lista.
> - Tente criar uma nave com dados inv√°lidos (por exemplo, com um nome muito curto) e veja o erro que seu servidor FastAPI retornar√°.

> **‚ö†Ô∏è Se houver erros:**

> - **Erro `422` do servidor:** Provavelmente, os dados que voc√™ est√° enviando n√£o passam pela valida√ß√£o do Pydantic. Verifique o console do navegador ‚Äî `errorData.detail` mostrar√° em qual campo est√° o problema.
> - **Erro `415 Unsupported Media Type`:** Voc√™ se esqueceu de adicionar o cabe√ßalho `'Content-Type': 'application/json'`.
> - **Os bot√µes de exclus√£o n√£o funcionam:** Verifique se a delega√ß√£o de eventos est√° funcionando corretamente e se voc√™ est√° obtendo o `shipId` do `data-ship-id`.
