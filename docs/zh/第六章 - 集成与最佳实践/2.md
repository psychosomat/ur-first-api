# **ç¬¬6.2ç« ï¼šCORSè®¾ç½®**
**å­¦ä¹ æ—¶é—´ï¼š** 30åˆ†é’Ÿ

---
#### **1. CORSï¼šå®ƒæ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**

æ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼Œ**CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰** æ˜¯ä¸€ç§æµè§ˆå™¨å®‰å…¨ç­–ç•¥ã€‚å®ƒæ—¨åœ¨é˜²æ­¢æ¶æ„ç½‘ç«™ `evil-site.com` ä»£è¡¨æ‚¨ï¼ˆä½¿ç”¨æ‚¨çš„ Cookieï¼‰å‘ `your-bank.com` å‘é€è¯·æ±‚å¹¶çªƒå–æ•°æ®çš„æƒ…å†µå‘ç”Ÿã€‚

**å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ**

1.  **å‰ç«¯ï¼ˆæµè§ˆå™¨ï¼‰** ä»åŸŸ `A` è¯·æ±‚è·å–åŸŸ `B` çš„æ•°æ®ã€‚
2.  æµè§ˆå™¨å‘åŸŸ `B` å‘é€ä¸€ä¸ªç‰¹æ®Šçš„â€œé¢„æ£€â€è¯·æ±‚ï¼ˆpreflight requestï¼‰ï¼Œä½¿ç”¨ `OPTIONS` æ–¹æ³•è¯¢é—®ï¼šâ€œå˜¿ï¼ŒåŸŸ `B`ï¼ŒåŸŸ `A` å¯ä»¥å‘ä½ å‘é€ `GET` è¯·æ±‚å—ï¼Ÿâ€
3.  **åç«¯ï¼ˆåŸŸ `B` ä¸Šçš„æœåŠ¡å™¨ï¼‰** å¿…é¡»ä½¿ç”¨ç‰¹æ®Šçš„ HTTP å¤´è¿›è¡Œå“åº”ï¼Œä¾‹å¦‚ï¼š`Access-Control-Allow-Origin: A`ã€‚
4.  å¦‚æœæœåŠ¡å™¨å“åº”å…è®¸è¯¥è¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šå‘é€ä¸» `GET` è¯·æ±‚ã€‚å¦åˆ™ï¼Œå®ƒä¼šé˜»æ­¢è¯¥è¯·æ±‚å¹¶å‘å‡º CORS é”™è¯¯ã€‚

> ğŸ’¡ **å¤ªç©ºç±»æ¯”ï¼š**

> åœ¨å°†èˆ¹é•¿ä¼ é€åˆ°å¤–æ˜Ÿç«™ï¼ˆå‘é€ `POST` è¯·æ±‚ï¼‰ä¹‹å‰ï¼Œé£èˆ¹ï¼ˆæµè§ˆå™¨ï¼‰ä¼šæ´¾å‡ºä¸€æ¶æ— äººæœºï¼ˆ`OPTIONS` è¯·æ±‚ï¼‰è¯¢é—®ï¼šâ€œç©ºé—´ç«™ï¼Œä½ ä»¬æ¥å—â€˜ä¼ä¸šå·â€™é£èˆ¹çš„ä¼ é€å—ï¼Ÿâ€ç©ºé—´ç«™ï¼ˆAPIï¼‰å›ç­”ï¼šâ€œæ˜¯çš„ï¼Œå…è®¸â€˜ä¼ä¸šå·â€™çš„ä¼ é€â€ï¼ˆ`Access-Control-Allow-Origin` å¤´ï¼‰ã€‚åªæœ‰åœ¨é‚£ä¹‹åï¼Œä¼ é€æ‰ä¼šå¼€å§‹ã€‚

---

#### **2. Laravel ä¸­çš„ CORS è®¾ç½®ï¼ˆLaravel 11+ çš„ç°ä»£æ–¹æ³•ï¼‰**
åœ¨ Laravel 11+ ä¸­ï¼ŒCORS é…ç½®å˜å¾—æ›´åŠ ç®€å•ï¼Œå¦‚æœæ‚¨åªéœ€è¦åŸºæœ¬è®¾ç½®ï¼Œåˆ™æ— éœ€å‘å¸ƒ `config/cors.php` æ–‡ä»¶ã€‚æ‰€æœ‰å†…å®¹éƒ½é€šè¿‡ `.env` æ–‡ä»¶å’Œ `bootstrap/app.php` è¿›è¡Œç®¡ç†ã€‚

**æ­¥éª¤ 1ï¼šé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®**

æ‰“å¼€æ‚¨çš„ `.env` æ–‡ä»¶ã€‚Laravel é»˜è®¤å·²ç»æä¾›äº†ç”¨äºç®¡ç† API CORS çš„å˜é‡ã€‚

```env
# .env

# ... å…¶ä»–å˜é‡

# æŒ‡å®š CORS å°†ç”Ÿæ•ˆçš„è·¯å¾„ã€‚
# 'api/*' - æ‰€æœ‰ API è·¯ç”±çš„æ ‡å‡†å€¼ã€‚
CORS_PATHS=api/*

# æŒ‡å®šå…è®¸çš„æ¥æºï¼ˆåŸŸï¼‰ã€‚
# å¯¹äºå¼€å‘ç¯å¢ƒï¼Œè¯·æŒ‡å®šæ‚¨å‰ç«¯çš„åœ°å€ã€‚
# å¯ä»¥ç”¨é€—å·åˆ†éš”ï¼Œä¸è¦æœ‰ç©ºæ ¼ã€‚
CORS_ALLOWED_ORIGINS=http://localhost:5500,http://127.0.0.1:5500

# å…¶ä»–è®¾ç½®ï¼ˆé€šå¸¸å¯ä»¥ä¿ç•™é»˜è®¤å€¼ï¼‰
CORS_ALLOWED_METHODS=*
CORS_ALLOWED_HEADERS=*
CORS_EXPOSED_HEADERS=
CORS_MAX_AGE=0
CORS_SUPPORTS_CREDENTIALS=false
```

**å…³é”®å˜é‡ï¼š**

- `CORS_ALLOWED_ORIGINS`ï¼š**æœ€é‡è¦çš„å˜é‡ã€‚** æ‚¨åœ¨æ­¤å¤„åˆ—å‡ºå…è®¸è¯·æ±‚çš„åŸŸã€‚ `*` å…è®¸æ‰€æœ‰åŸŸï¼Œä½†è¿™**å¯¹äºç”Ÿäº§ç¯å¢ƒæ¥è¯´æä¸å®‰å…¨**ã€‚

- `CORS_PATHS`ï¼šè¿™äº›è§„åˆ™é€‚ç”¨çš„è·¯å¾„ã€‚`api/*` è¡¨ç¤ºæ‰€æœ‰ä»¥ `/api/` å¼€å¤´çš„è·¯å¾„ã€‚

æ›´æ”¹ `.env` åï¼Œå¦‚æœæ‚¨ä½¿ç”¨ `php artisan serve`ï¼Œåˆ™**æ— éœ€**é‡å¯æœåŠ¡å™¨ã€‚æ›´æ”¹ä¼šè‡ªåŠ¨ç”Ÿæ•ˆã€‚

**æ­¥éª¤ 2ï¼ˆå¯é€‰ï¼‰ï¼š`bootstrap/app.php` ä¸­çš„é«˜çº§è®¾ç½®**

å¦‚æœæ‚¨éœ€è¦æ›´å¤æ‚çš„é€»è¾‘ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨æ¨¡å¼å…è®¸å­åŸŸï¼‰ï¼Œæ‚¨ä»ç„¶éœ€è¦å‘å¸ƒé…ç½®æ–‡ä»¶å¹¶è®¾ç½®ä¸­é—´ä»¶ã€‚ä½†å¯¹äº 95% çš„æƒ…å†µï¼Œ`.env` æ–‡ä»¶å°±è¶³å¤Ÿäº†ã€‚

å‘½ä»¤ `php artisan install:api` ä¼šè‡ªåŠ¨åœ¨ `bootstrap/app.php` æ–‡ä»¶ä¸­ä¸º API è·¯ç”±é…ç½®åŸºæœ¬çš„ CORS ä¸­é—´ä»¶ã€‚å®ƒçœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```php
// bootstrap/app.php
->withMiddleware(function (Middleware $middleware) {
    // è¿™ä¸€è¡Œå°†ç”± install:api å‘½ä»¤è‡ªåŠ¨æ·»åŠ 
    // å®ƒåŒ…å«äº†æ‰€æœ‰ API è·¯ç”±çš„ CORS å¤„ç†
    $middleware->api(base_path('routes/api.php'));
})
```

åœ¨ `->api()` å†…éƒ¨ï¼ŒLaravel å·²ç»ä½¿ç”¨äº† `HandleCors` ä¸­é—´ä»¶ï¼Œå®ƒä¼šä»æ‚¨çš„ `.env` æ–‡ä»¶ä¸­è¯»å–è®¾ç½®ã€‚ä¸€åˆ‡éƒ½éå¸¸ç®€å•ï¼Œå¼€ç®±å³ç”¨ã€‚

> âš ï¸ **é‡è¦ï¼** å¦‚æœæ‚¨çš„ API å¹¶éå®Œå…¨å…¬å¼€ï¼Œè¯·å‹¿åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šä½¿ç”¨ `CORS_ALLOWED_ORIGINS='*'`ã€‚è¿™ä¼šå¸¦æ¥æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚è¯·åŠ¡å¿…åˆ—å‡ºæ‚¨å‰ç«¯çš„å…·ä½“åŸŸã€‚

---

#### **3. FastAPI ä¸­çš„ CORS è®¾ç½®**

FastAPI ä½¿ç”¨ **ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰** çš„æ¦‚å¿µæ¥å¤„ç† CORS ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚

**æ­¥éª¤ 1ï¼šæ‰“å¼€æ‚¨çš„ä¸»åº”ç”¨ç¨‹åºæ–‡ä»¶**

è¿™æ˜¯æ‚¨åˆ›å»º FastAPI å®ä¾‹çš„æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ `main.py`ï¼‰ã€‚

**æ­¥éª¤ 2ï¼šæ·»åŠ  `CORSMiddleware`**

FastAPI æä¾›äº†ç°æˆçš„ä¸­é—´ä»¶ç”¨äº CORS é…ç½®ã€‚

```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware # 1. å¯¼å…¥ä¸­é—´ä»¶

app = FastAPI(
    title="SpaceAPI",
    description="API ç”¨äºç®¡ç†é“¶æ²³ç³»ä¸­çš„è¡Œæ˜Ÿ",
    version="1.0.0"
)

# 2. å…è®¸çš„æ¥æºåˆ—è¡¨ï¼ˆoriginsï¼‰
origins = [
    "http://localhost:5500",
    "http://127.0.0.1:5500",
    # åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šæ˜¯æ‚¨å‰ç«¯çš„åŸŸå
    # "https://my-awesome-app.com",
]

# 3. å°†ä¸­é—´ä»¶æ·»åŠ åˆ°åº”ç”¨ç¨‹åº
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # å…è®¸æŒ‡å®šçš„æ¥æº
    allow_credentials=True, # å…è®¸ Cookieï¼ˆèº«ä»½éªŒè¯æ—¶éœ€è¦ï¼‰
    allow_methods=["*"],    # å…è®¸æ‰€æœ‰æ–¹æ³•ï¼ˆGET, POST ç­‰ï¼‰
    allow_headers=["*"],    # å…è®¸æ‰€æœ‰å¤´éƒ¨
)

# ... æ­¤å¤„æ˜¯æ‚¨çš„è·¯ç”±å’Œå…¶ä»–ä»£ç 
```

**æ­¥éª¤ 3ï¼šé‡å¯ Uvicorn æœåŠ¡å™¨**
Uvicorn æœåŠ¡å™¨é€šå¸¸åœ¨ä»£ç æ›´æ”¹æ—¶è‡ªåŠ¨é‡è½½ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·æ‰‹åŠ¨é‡å¯ã€‚ç°åœ¨æ‚¨çš„ FastAPI æœåŠ¡å™¨å°†æ­£ç¡®å“åº”æ¥è‡ªå‰ç«¯çš„ `OPTIONS` è¯·æ±‚ã€‚

---

#### **å·©å›ºçŸ¥è¯†å°æµ‹éªŒ**


<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. æµè§ˆå™¨åœ¨ä¸»è¦è¯·æ±‚ä¹‹å‰å‘é€çš„ç”¨äºæ£€æŸ¥ CORS çš„è¯·æ±‚ç§°ä¸ºï¼š</p>
      <label><input type="radio" name="q1" value="a"> a) CHECK request</label>
      <label><input type="radio" name="q1" value="b"> b) Preflight request</label>
      <label><input type="radio" name="q1" value="c"> c) Handshake request</label>
    </div>
    <div class="question">
      <p>2. åœ¨ç°ä»£ Laravel (11+) ä¸­ï¼ŒCORS çš„åŸºæœ¬è®¾ç½®ä¸»è¦åœ¨å“ªé‡Œé…ç½®ï¼š</p>
      <label><input type="radio" name="q2" value="a"> a) bootstrap/app.php æ–‡ä»¶</label>
      <label><input type="radio" name="q2" value="b"> b) .env æ–‡ä»¶</label>
      <label><input type="radio" name="q2" value="c"> c) routes/api.php æ–‡ä»¶</label>
    </div>
    <div class="question">
      <p>3. åœ¨ FastAPI ä¸­ï¼Œç”¨äºé…ç½® CORS çš„æ˜¯ï¼š</p>
      <label><input type="radio" name="q3" value="a"> a) @app.cors() è£…é¥°å™¨</label>
      <label><input type="radio" name="q3" value="b"> b) å†…ç½®çš„ Security ç±»</label>
      <label><input type="radio" name="q3" value="c"> c) ä¸­é—´ä»¶ï¼ˆ`Middleware`ï¼‰</label>
    </div>
    <div class="question">
      <p>4. å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå“ªä¸ª CORS_ALLOWED_ORIGINS å€¼æœ€å®‰å…¨ï¼Ÿ</p>
      <label><input type="radio" name="q4" value="a"> a) CORS_ALLOWED_ORIGINS='*'</label>
      <label><input type="radio" name="q4" value="b"> b) CORS_ALLOWED_ORIGINS=http://my-frontend.com,https://my-frontend.com`</label>
      <label><input type="radio" name="q4" value="c"> c) ä¸è®¾ç½®æ­¤å˜é‡</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">æ£€æŸ¥</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>ç»“æœï¼š</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:green;">æ­£ç¡®ï¼</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:red;">é”™è¯¯ã€‚</span>æ­£ç¡®ç­”æ¡ˆï¼š<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:orange;">æœªä½œç­”ã€‚</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>æ‚¨çš„å¾—åˆ†ï¼š${score} / ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**ğŸš€ æœ¬ç« æ€»ç»“ï¼š**

æ‚¨å·²æˆä¸ºâ€œæ˜Ÿé™…é€šä¿¡å¤–äº¤å®˜â€ï¼æ‚¨çš„ API ç°åœ¨å¯ä»¥å®‰å…¨åœ°ä¸å¤–éƒ¨åº”ç”¨ç¨‹åºäº¤äº’ï¼Œé‡‡ç”¨ç°ä»£ä¸”æ­£ç¡®çš„æ–¹æ³•ã€‚

- âœ… ç†è§£äº† CORS å’Œé¢„æ£€è¯·æ±‚çš„å·¥ä½œæœºåˆ¶ã€‚
- ğŸ”§ é€šè¿‡ `.env` æ–‡ä»¶ä¸º Laravel 11+ é…ç½®äº† CORSã€‚
- âš™ï¸ ä½¿ç”¨ `CORSMiddleware` ä¸º FastAPI é…ç½®äº† CORSã€‚
- ğŸ›°ï¸ æˆåŠŸå»ºç«‹äº†å‰ç«¯å’Œåç«¯ä¹‹é—´çš„è¿æ¥ã€‚

**é€šä¿¡æ¡¥æ¢å·²å»ºæˆå¹¶å—åˆ°ä¿æŠ¤ã€‚** ç°åœ¨å¯ä»¥è€ƒè™‘å¦‚ä½•åªå…è®¸â€œæˆæƒäººå‘˜â€é€šè¿‡è¿™åº§æ¡¥æ¢ã€‚

> **ğŸ“Œ æ£€æŸ¥ï¼š**

> - æˆåŠŸçš„ä¸»è¦æ ‡å‡†æ˜¯ï¼šå½“å‰ç«¯è¯·æ±‚æ•°æ®æ—¶ï¼Œæµè§ˆå™¨æ§åˆ¶å°ä¸­æ²¡æœ‰ CORS é”™è¯¯ã€‚
> - åœ¨å¼€å‘è€…å·¥å…·çš„â€œç½‘ç»œâ€ï¼ˆNetworkï¼‰é€‰é¡¹å¡ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å¯¹æ‚¨çš„ API å‘é€äº†ä¸¤ä¸ªè¯·æ±‚ï¼šç¬¬ä¸€ä¸ªæ˜¯ `OPTIONS` æ–¹æ³•ï¼ˆçŠ¶æ€ 200/204ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯ `GET` æ–¹æ³•ï¼ˆçŠ¶æ€ 200ï¼‰ã€‚è¿™æ˜¯ CORS å·¥ä½œåŸç†çš„ç›´è§‚æ¼”ç¤ºã€‚