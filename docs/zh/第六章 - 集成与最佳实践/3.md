# **ç¬¬å…­ç«  6.3: åŸºç¡€è®¤è¯**
**å­¦ä¹ æ—¶é—´:** 1 å°æ—¶

---

#### **1. API è®¤è¯: è¿›å…¥é£è¡Œæ§åˆ¶ä¸­å¿ƒçš„é€šè¡Œè¯**
**è®¤è¯** æ˜¯éªŒè¯ç”¨æˆ·èº«ä»½çš„è¿‡ç¨‹ã€‚ä¸ä½¿ç”¨ä¼šè¯å’Œ Cookie çš„ç½‘ç«™ä¸åŒï¼Œæ— çŠ¶æ€ (stateless) API é€šå¸¸ä½¿ç”¨ **ä»¤ç‰Œ**ã€‚

**æµç¨‹å¦‚ä¸‹ï¼š**

1.  ç”¨æˆ·å°†å…¶ç™»å½•åå’Œå¯†ç å‘é€åˆ°ç‰¹å®šçš„ç«¯ç‚¹ï¼ˆä¾‹å¦‚ï¼Œ`/login`ï¼‰ã€‚
2.  æœåŠ¡å™¨éªŒè¯å®ƒä»¬ã€‚å¦‚æœæ­£ç¡®ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ã€åŠ å¯†çš„ **ä»¤ç‰Œ**ï¼ˆä¸€ä¸ªé•¿å­—ç¬¦ä¸²ï¼‰å¹¶å°†å…¶å‘é€å›ã€‚
3.  æ¯æ¬¡åç»­è¯·æ±‚è®¿é—®å—ä¿æŠ¤èµ„æºï¼ˆä¾‹å¦‚ï¼Œ`POST /planets`ï¼‰æ—¶ï¼Œç”¨æˆ·å¿…é¡»åœ¨ `Authorization` å¤´éƒ¨ä¸­é™„åŠ æ­¤ä»¤ç‰Œã€‚
4.  æœåŠ¡å™¨éªŒè¯ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼Œå¦‚æœä»¤ç‰Œæ­£ç¡®ï¼Œåˆ™æ‰§è¡Œè¯·æ±‚ã€‚

> ğŸ’¡ **å¤ªç©ºç±»æ¯”ï¼š**

> - **ç™»å½•å/å¯†ç ** = æ‚¨çš„ç”Ÿç‰©è¯†åˆ«æ‰«æï¼Œç”¨äºè·å–é€šè¡Œè¯ã€‚
> - **ä»¤ç‰Œ** = æ‚¨åœ¨è¿›å…¥é£è¡Œæ§åˆ¶ä¸­å¿ƒæ—¶è·å¾—çš„ç”µå­é€šè¡Œè¯ï¼ˆID å¡ï¼‰ã€‚
> - **`Authorization: Bearer <ä»¤ç‰Œ>` å¤´éƒ¨** = æ‚¨å°†é€šè¡Œè¯è´´åœ¨æ¯ä¸ªå—ä¿æŠ¤é—¨æ—çš„è¯»å¡å™¨ä¸Šã€‚
> - **å—ä¿æŠ¤çš„ç«¯ç‚¹ (POST, PUT, DELETE)** = æœåŠ¡å™¨æœºæˆ¿æˆ–å¯åŠ¨æ§åˆ¶å°çš„é—¨ã€‚

---

#### **2. Laravel ä¸­çš„è®¤è¯: Sanctum**
Laravel ä¸º API è®¤è¯æä¾›äº†ä¸€ä¸ªä¼˜é›…çš„è§£å†³æ–¹æ¡ˆâ€”â€”**Laravel Sanctum**ã€‚å®ƒéå¸¸é€‚åˆ SPAï¼ˆå•é¡µåº”ç”¨ç¨‹åºï¼‰ã€ç§»åŠ¨åº”ç”¨ç¨‹åºå’Œç®€å•çš„åŸºäºä»¤ç‰Œçš„ APIã€‚

**æ­¥éª¤ 1: å®‰è£…å’Œé…ç½® Sanctum**

*Sanctum å·²åœ¨æ ‡å‡†çš„ Laravel åº”ç”¨ç¨‹åºä¸­å®‰è£…ï¼Œä½†æˆ‘ä»¬å°†æ£€æŸ¥é…ç½®ã€‚*

1.  **å‘å¸ƒé…ç½® (å¦‚æœå°šæœªå®Œæˆ):**
    ```bash
    php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
    ```
2.  **è¿è¡Œè¿ç§» (å°†åˆ›å»º `personal_access_tokens` è¡¨):**
    ```bash
    php artisan migrate
    ```
3.  **åœ¨ `User` æ¨¡å‹ä¸­æ·»åŠ  Trait:**
    æ‰“å¼€ `app/Models/User.php` å¹¶ç¡®ä¿å®ƒä½¿ç”¨äº† `HasApiTokens` traitã€‚
    ```php
    // app/Models/User.php
    use Laravel\Sanctum\HasApiTokens;

    class User extends Authenticatable
    {
        use HasApiTokens, HasFactory, Notifiable;
        // ...
    }
    ```

**æ­¥éª¤ 2: åˆ›å»ºä»¤ç‰Œé¢å‘ç«¯ç‚¹**
æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨æˆ·å°†å‘é€ç™»å½•å/å¯†ç çš„è·¯ç”±ã€‚

æ·»åŠ åˆ° `routes/api.php`ï¼š
```php
// routes/api.php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use App\Models\User;
use Illuminate\Validation\ValidationException;

Route::post('/login', function (Request $request) {
    $request->validate([
        'email' => 'required|email',
        'password' => 'required',
    ]);

    $user = User::where('email', $request->email)->first();

    if (! $user || ! Hash::check($request->password, $user->password)) {
        throw ValidationException::withMessages([
            'email' => ['å‡­æ®æ— æ•ˆã€‚'],
        ]);
    }

    // è¿”å›ä»¤ç‰Œ
    return response()->json([
        'token' => $user->createToken('api-token')->plainTextToken
    ]);
});
```

*æ‚¨å¯ä»¥é€šè¿‡ Seeder æˆ– Tinker åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨æˆ·ã€‚*

**æ­¥éª¤ 3: ä¿æŠ¤è·¯ç”±**
ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¿æŠ¤æˆ‘ä»¬çš„ CRUD æ“ä½œã€‚ä¿®æ”¹ `routes/api.php`ï¼š

```php
// routes/api.php
use App\Http\Controllers\PlanetController;

// ç”¨äºæŸ¥çœ‹è¡Œæ˜Ÿçš„å…¬å…±è·¯ç”±
Route::get('/planets', [PlanetController::class, 'index']);
Route::get('/planets/{planet}', [PlanetController::class, 'show']);

// å—ä¿æŠ¤çš„è·¯ç”±ç»„
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/planets', [PlanetController::class, 'store']);
    Route::put('/planets/{planet}', [PlanetController::class, 'update']);
    Route::delete('/planets/{planet}', [PlanetController::class, 'destroy']);

    // é€€å‡ºè·¯ç”± (åˆ é™¤ä»¤ç‰Œ)
    Route::post('/logout', function (Request $request) {
        $request->user()->currentAccessToken()->delete();
        return response()->json(['message' => 'æ‚¨å·²æˆåŠŸé€€å‡º'], 200);
    });
});
```

ä¸­é—´ä»¶ `auth:sanctum` å°†æ£€æŸ¥ `Authorization` å¤´éƒ¨ä¸­æ˜¯å¦å­˜åœ¨æœ‰æ•ˆçš„ä»¤ç‰Œã€‚

---

#### **3. FastAPI ä¸­çš„è®¤è¯: OAuth2 å’Œ JWT**

FastAPI æ²¡æœ‰å†…ç½®çš„è®¤è¯ç³»ç»Ÿï¼Œä½†æœ‰å¼ºå¤§çš„å·¥å…·æ¥å®ç°åœ¨æ­¤ã€‚äº‹å®æ ‡å‡†æ˜¯ **OAuth2 ä¸ JWT ä»¤ç‰Œ**ã€‚

**æ­¥éª¤ 1: å®‰è£…ä¾èµ–**
```bash
pip install "python-jose[cryptography]" "passlib[bcrypt]" "python-multipart"
```

- `python-jose`: ç”¨äºåˆ›å»ºå’ŒéªŒè¯ JWT ä»¤ç‰Œã€‚
- `passlib`: ç”¨äºå“ˆå¸Œå’ŒéªŒè¯å¯†ç ã€‚
- `python-multipart`: ç”¨äºå¤„ç†è¡¨å•æ•°æ® (`username` å’Œ `password`)ã€‚

**æ­¥éª¤ 2: åˆ›å»ºå®‰å…¨æ¨¡å— (`security.py`)**
è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µâ€”â€”å°†æ‰€æœ‰è®¤è¯é€»è¾‘æå–åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¸­ã€‚

**åˆ›å»ºæ–‡ä»¶ `security.py`ï¼š**

```python
# security.py
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from passlib.context import CryptContext
from datetime import datetime, timedelta, timezone

# --- è®¾ç½® ---
SECRET_KEY = "your-super-secret-key-that-is-long-and-random" # âš ï¸ è¯·æ›¿æ¢ä¸ºæ‚¨çš„å¯†é’¥ï¼
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

# --- å·¥å…· ---
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/login")

# --- å‡½æ•° ---
def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password):
    return pwd_context.hash(password)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.now(timezone.utc) + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

# --- ä»¤ç‰ŒéªŒè¯ä¾èµ–å‡½æ•° ---
def get_current_user(token: str = Depends(oauth2_scheme)):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="æ— æ³•éªŒè¯å‡­æ®",
        headers={"WWW-Authenticate": "Bearer"},
    )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    # åœ¨è¿™é‡Œå¯ä»¥ä»æ•°æ®åº“è¿”å›ç”¨æˆ·ï¼Œç›®å‰åªæ˜¯è¿”å›ç”¨æˆ·å
    return {"username": username}
```

**æ­¥éª¤ 3: é›†æˆåˆ° `main.py`**
ç°åœ¨ï¼Œæˆ‘ä»¬å°†å…¶è¿æ¥åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

1.  **åˆ›å»º `/login` ç«¯ç‚¹:**
    ```python
    # main.py
    from fastapi.security import OAuth2PasswordRequestForm
    from fastapi import Depends, APIRouter
    from . import security # å¯¼å…¥æˆ‘ä»¬çš„æ¨¡å—

    # ... æ‚¨çš„ FastAPI ä»£ç  ...
    router = APIRouter(prefix="/api/v1")

    @router.post("/login")
    def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends()):
        # è¿™é‡Œåº”è¯¥æœ‰æ•°æ®åº“ä¸­çš„ç”¨æˆ·éªŒè¯
        # ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·
        is_user_valid = (form_data.username == "testuser" and
                         security.verify_password("testpass", security.get_password_hash("testpass")))

        if not is_user_valid:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
            )
        access_token = security.create_access_token(data={"sub": form_data.username})
        return {"access_token": access_token, "token_type": "bearer"}

    # ...
    app.include_router(router)
    ```

2.  **ä¿æŠ¤ç«¯ç‚¹:**

    æˆ‘ä»¬ä½¿ç”¨ `get_current_user` ä¾èµ–ã€‚
    ```python
    # main.py æˆ–åœ¨æ‚¨çš„è¡Œæ˜Ÿè·¯ç”±ä¸­

    @router.post("/planets", status_code=status.HTTP_201_CREATED)
    def create_planet(
        planet: PlanetCreate,
        current_user: dict = Depends(security.get_current_user) # <-- ä¿æŠ¤ï¼
    ):
        # åˆ›å»ºè¡Œæ˜Ÿçš„é€»è¾‘...
        print(f"ç”¨æˆ· {current_user['username']} æ­£åœ¨åˆ›å»ºè¡Œæ˜Ÿã€‚")
        # ...
        return new_planet

    # åŒæ ·ä¿æŠ¤ PUT å’Œ DELETE
    ```

---

#### **4. å‰ç«¯ä½¿ç”¨ä»¤ç‰Œ**

æˆ‘ä»¬çš„å‰ç«¯ç°åœ¨åº”è¯¥é¦–å…ˆè·å–ä»¤ç‰Œï¼Œä¿å­˜å®ƒï¼ˆä¾‹å¦‚ï¼Œåœ¨ `localStorage` ä¸­ï¼‰ï¼Œå¹¶å°†å…¶é™„åŠ åˆ°æ¯ä¸ªå—ä¿æŠ¤çš„è¯·æ±‚ä¸­ã€‚

**JavaScript ç¤ºä¾‹ (`fetch`):**
```javascript
// 1. ç™»å½•
async function login(email, password) {
    const response = await fetch('http://localhost:8001/api/login', { // Laravel API åœ°å€
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email, password})
    });
    const data = await response.json();

    if (data.token) {
        localStorage.setItem('api_token', data.token); // ä¿å­˜ä»¤ç‰Œ
    }
}

// 2. å‘é€å—ä¿æŠ¤çš„è¯·æ±‚
async function createPlanet(planetData) {
    const token = localStorage.getItem('api_token');

    const response = await fetch('http://localhost:8001/api/planets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` // <--- é™„åŠ ä»¤ç‰Œï¼
        },
        body: JSON.stringify(planetData)
    });
    // ...
}
```

---

#### **å·©å›ºç»ƒä¹ **


<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. æ— çŠ¶æ€ API æœ€å¸¸ç”¨äºè®¤è¯ï¼š</p>
      <label><input type="radio" name="q1" value="a"> a) ä¼šè¯å’Œ Cookie</label>
      <label><input type="radio" name="q1" value="b"> b) ä»¤ç‰Œ (ä¾‹å¦‚ï¼ŒJWT)</label>
      <label><input type="radio" name="q1" value="c"> c) IP åœ°å€</label>
    </div>
    <div class="question">
      <p>2. åœ¨ Laravel ä¸­ï¼Œä½¿ç”¨ä»¤ç‰Œä¿æŠ¤è·¯ç”±æ‰€ä½¿ç”¨çš„ä¸­é—´ä»¶æ˜¯ï¼š</p>
      <label><input type="radio" name="q2" value="a"> a) auth:api</label>
      <label><input type="radio" name="q2" value="b"> b) auth:sanctum</label>
      <label><input type="radio" name="q2" value="c"> c) verified</label>
    </div>
    <div class="question">
      <p>3. åœ¨ FastAPI ä¸­ï¼Œç”¨äºä»ç™»å½•è¡¨å•è·å–æ•°æ®çš„ä¾èµ–é¡¹æ˜¯ï¼š</p>
      <label><input type="radio" name="q3" value="a"> a) Body()</label>
      <label><input type="radio" name="q3" value="b"> b) Form()</label>
      <label><input type="radio" name="q3" value="c"> c) OAuth2PasswordRequestForm = Depends()</label>
    </div>
    <div class="question">
      <p>4. ä»¤ç‰Œå¦‚ä½•åœ¨å—ä¿æŠ¤çš„è¯·æ±‚ä¸­ä»å®¢æˆ·ç«¯ä¼ è¾“åˆ°æœåŠ¡å™¨ï¼Ÿ</p>
      <label><input type="radio" name="q4" value="a"> a) åœ¨ URL å‚æ•°ä¸­ `?token=...`</label>
      <label><input type="radio" name="q4" value="b"> b) åœ¨è¯·æ±‚ä½“ä¸­</label>
      <label><input type="radio" name="q4" value="c"> c) åœ¨ HTTP å¤´éƒ¨ `Authorization: Bearer <ä»¤ç‰Œ>` ä¸­</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">æ£€æŸ¥</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>
<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'c' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>ç»“æœ:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:green;">æ­£ç¡®ï¼</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:red;">é”™è¯¯ã€‚</span> æ­£ç¡®ç­”æ¡ˆ: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:orange;">æ— ç­”æ¡ˆã€‚</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>æ‚¨çš„å¾—åˆ†: ${score} å…± ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**ğŸš€ ç« èŠ‚æ€»ç»“:**

æ‚¨å·²ä¸ºæ‚¨çš„ API è®¾ç½®äº†â€œè®¿é—®æ§åˆ¶ç³»ç»Ÿâ€ã€‚ç°åœ¨ï¼Œä¸æ˜¯æ¯ä¸ªæƒ³è¦çš„äººéƒ½èƒ½ä¿®æ”¹æ‚¨çš„â€œé“¶æ²³æ•°æ®åº“â€äº†ã€‚

- âœ… ç†è§£äº†åŸºäºä»¤ç‰Œçš„èº«ä»½éªŒè¯åŸåˆ™ã€‚
- ğŸ” åœ¨ Laravel Sanctum ä¸­å®ç°äº†ä»¤ç‰Œé¢å‘å’Œè·¯ç”±ä¿æŠ¤ã€‚
- âš™ï¸ åœ¨ FastAPI ä¸­é…ç½®äº†åŸºäº OAuth2 å’Œ JWT çš„èº«ä»½éªŒè¯ã€‚
- ğŸ›°ï¸ äº†è§£äº†å‰ç«¯å¦‚ä½•ä¿å­˜å’Œä½¿ç”¨ä»¤ç‰Œã€‚

**æ‚¨çš„ API ä¸ä»…åŠŸèƒ½é½å…¨ï¼Œè€Œä¸”å®‰å…¨å¯é ã€‚** ç„¶è€Œï¼Œä¸ºäº†è®©å…¶ä»–å¼€å‘äººå‘˜èƒ½å¤Ÿä½¿ç”¨å®ƒä»¬ï¼Œä»–ä»¬éœ€è¦â€œæ“ä½œè¯´æ˜â€ã€‚

> **ğŸ“Œ æ£€æŸ¥:**

> - å°è¯•ä½¿ç”¨ Postman æˆ– Insomnia å¯¹ `/api/planets` (åœ¨ Laravel ä¸­) æˆ– `/api/v1/planets` (åœ¨ FastAPI ä¸­) å‘é€ä¸å¸¦ä»¤ç‰Œçš„ `POST` è¯·æ±‚ã€‚æ‚¨åº”è¯¥ä¼šæ”¶åˆ° `401 Unauthorized` é”™è¯¯ã€‚
> - è¯·æ±‚ `/login`ï¼Œè·å–ä»¤ç‰Œï¼Œå°†å…¶æ·»åŠ åˆ° `Authorization` æ ‡å¤´ä¸­ï¼Œç„¶åé‡å¤ `POST` è¯·æ±‚ã€‚å®ƒåº”è¯¥ä¼šæˆåŠŸæ‰§è¡Œã€‚