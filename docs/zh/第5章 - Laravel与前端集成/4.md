# **ç¬¬äº”ç« ç¬¬å››èŠ‚ï¼šå¤„ç† CSRF ä»¤ç‰Œ**
**å­¦ä¹ æ—¶é—´ï¼š** 30 åˆ†é’Ÿ

---

### **1. ä»€ä¹ˆæ˜¯ CSRF æ”»å‡»ï¼Ÿâ€œåŠ«æŒâ€æ‚¨çš„é£èˆ¹**

æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨å·²ç™»å½•åˆ°æ‚¨çš„å¤ªç©ºèˆ°é˜Ÿæ§åˆ¶é¢æ¿ (`space-api.test`)ã€‚åœ¨ç›¸é‚»çš„æ ‡ç­¾é¡µä¸­ï¼Œæ‚¨æ‰“å¼€äº†ä¸€ä¸ªæ— å®³çš„çŒ«å’ªç½‘ç«™ (`evil-cats.com`)ã€‚è¯¥ç½‘ç«™æœ‰ä¸€ä¸ªéšè—çš„è¡¨å•ï¼Œä¼šè‡ªåŠ¨å‘æ‚¨çš„ç½‘ç«™ `POST /api/planets/1/delete` åœ°å€å‘é€è¯·æ±‚ã€‚

ç”±äºæ‚¨å·²åœ¨ `space-api.test` ä¸Šæˆæƒï¼Œæ‚¨çš„æµè§ˆå™¨ä¼šå‹å¥½åœ°å°†æ‚¨çš„æ‰€æœ‰ Cookie é™„åŠ åˆ°æ­¤è¯·æ±‚ä¸­ã€‚Laravel æœåŠ¡å™¨å°†çœ‹åˆ°æœ‰æ•ˆçš„ä¼šè¯ï¼Œå¹¶è®¤ä¸ºè¿™æ˜¯æ‚¨è‡ªå·±å†³å®šæŠ¥åºŸè¡Œæ˜Ÿã€‚**è¡Œæ˜Ÿå°†åœ¨æ‚¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¢«åˆ é™¤ã€‚**

è¿™å°±æ˜¯ **CSRF (Cross-Site Request Forgery)** â€”â€” ä¸€ç§æ”»å‡»ï¼Œæ”»å‡»è€…è¯±éª—ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æµè§ˆå™¨åœ¨å—ä¿¡ä»»çš„ç½‘ç«™ä¸Šæ‰§è¡Œä¸å¸Œæœ›çš„æ“ä½œã€‚

> ğŸ’¡ **å®‡å®™ç±»æ¯”ï¼š**

> æ‚¨æ˜¯é£èˆ¹çš„èˆ¹é•¿ï¼Œæ‹¥æœ‰ä¸€å¼ é’¥åŒ™å¡ï¼ˆä¼šè¯/Cookieï¼‰ã€‚æ”»å‡»è€…æ— æ³•çªƒå–æ‚¨çš„å¡ã€‚ä½†ä»–ä»¬å¯ä»¥åœ¨æ‚¨åˆ†å¿ƒæ—¶ï¼Œæ¬ºéª—æ‚¨å°†å¡åˆ·å‘èµ„æºæŠ¥åºŸç»ˆç«¯ã€‚CSRF ä»¤ç‰Œå°±åƒä¸€ä¸ª PIN ç ï¼Œéœ€è¦ä¸å¡ä¸€èµ·è¾“å…¥ã€‚æ”»å‡»è€…ä¸çŸ¥é“ PIN ç ï¼Œä»–ä»¬çš„æ”»å‡»å°±ä¼šå¤±è´¥ã€‚

---

### **2. Laravel å¦‚ä½•é˜²èŒƒ CSRFï¼Ÿ**

Laravel é»˜è®¤ä½¿ç”¨ **CSRF ä»¤ç‰Œ**ä¿æŠ¤æ‰€æœ‰â€œä¸å®‰å…¨â€çš„ Web è¯·æ±‚ (POST, PUT, PATCH, DELETE)ã€‚

1.  ç”Ÿæˆé¡µé¢æ—¶ï¼ŒLaravel ä¼šä¸ºç”¨æˆ·ä¼šè¯åˆ›å»ºä¸€ä¸ªç‹¬ç‰¹çš„éšæœºä»¤ç‰Œã€‚
2.  æ­¤ä»¤ç‰Œè¢«åµŒå…¥åˆ° HTML è¡¨å•ä¸­ã€‚
3.  æäº¤è¡¨å•æ—¶ï¼Œä»¤ç‰Œéšè¯·æ±‚ä¸€èµ·å‘é€ã€‚
4.  åœ¨æœåŠ¡å™¨ç«¯ï¼Œ`VerifyCsrfToken` ä¸­é—´ä»¶ä¼šå°†è¯·æ±‚ä¸­çš„ä»¤ç‰Œä¸ä¼šè¯ä¸­å­˜å‚¨çš„ä»¤ç‰Œè¿›è¡Œæ¯”è¾ƒã€‚
5.  **å¦‚æœä»¤ç‰Œä¸åŒ¹é…ï¼ŒLaravel ä¼šä»¥ 419 é”™è¯¯ï¼ˆä¼šè¯è¿‡æœŸ/é¡µé¢è¿‡æœŸï¼‰ä¸­æ–­è¯·æ±‚ã€‚**

**é‡è¦æç¤ºï¼š** `routes/api.php` ä¸­çš„ API è·¯ç”±**ä¸**å— CSRF ä¿æŠ¤ï¼Œå› ä¸ºå®ƒä»¬å‡å®šä½¿ç”¨ä¸åŒçš„èº«ä»½éªŒè¯æœºåˆ¶ï¼ˆä¾‹å¦‚ Sanctum ä»¤ç‰Œï¼‰ï¼Œè€Œä¸æ˜¯åŸºäº Cookie çš„ä¼šè¯ã€‚æˆ‘ä»¬å½“å‰çš„é—®é¢˜ä¸“é—¨æ¶‰åŠæˆ‘ä»¬åœ¨ `routes/web.php` ä¸­åˆ›å»ºçš„ Web è·¯ç”±å’Œé¡µé¢ã€‚

---

### **3. åœ¨ HTML è¡¨å•ä¸­ä½¿ç”¨ CSRF ä»¤ç‰Œ**
è¿™æ˜¯æœ€ç®€å•çš„åœºæ™¯ã€‚Laravel ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„ Blade æŒ‡ä»¤ã€‚

**ç¤ºä¾‹ï¼šåˆ›å»ºæ˜Ÿçƒçš„è¡¨å•**
æˆ‘ä»¬å°†åœ¨ `resources/views/planets/create.blade.php` æ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ªç®€å•è¡¨å•ï¼š

```html
<h2>å¯åŠ¨æ–°æ˜Ÿçƒè¡¨å•</h2>
<form action="/planets" method="POST">
    @csrf {{-- è¿™å°±æ˜¯é­”æ³•ï¼ --}}

    <label for="name">åç§°ï¼š</label>
    <input type="text" id="name" name="name" required>

    <label for="solar_system">å¤ªé˜³ç³»ï¼š</label>
    <input type="text" id="solar_system" name="solar_system" required>

    {{-- ... å…¶ä»–å­—æ®µ ... --}}

    <button type="submit">å¯åŠ¨</button>
</form>
```

`@csrf` æŒ‡ä»¤å°†è‡ªåŠ¨åœ¨è¡¨å•ä¸­ç”Ÿæˆä¸€ä¸ªéšè—å­—æ®µï¼š
```html
<input type="hidden" name="_token" value="j2aK3dLf4gH5...å”¯ä¸€ä»¤ç‰Œ...">
```

è¿™è¶³ä»¥ä¿æŠ¤æ ‡å‡† HTML è¡¨å•ã€‚

---

### **4. åœ¨ AJAX/Fetch è¯·æ±‚ä¸­ä½¿ç”¨ CSRF ä»¤ç‰Œ**

åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ JavaScript å‘é€äº† `DELETE` è¯·æ±‚ã€‚ç°åœ¨ Laravel å°†ä»¥ 419 é”™è¯¯é˜»æ­¢å®ƒã€‚æˆ‘ä»¬éœ€è¦å°† CSRF ä»¤ç‰Œæ·»åŠ åˆ°æˆ‘ä»¬çš„ Fetch è¯·æ±‚å¤´ä¸­ã€‚

**æ­¥éª¤ 1ï¼šä½¿ä»¤ç‰Œå¯ä¾› JavaScript è®¿é—®**

å°†å¸¦æœ‰ä»¤ç‰Œçš„ meta æ ‡ç­¾æ·»åŠ åˆ°æ‚¨çš„ä¸»å¸ƒå±€ `resources/views/app.blade.php` çš„ `<head>` ä¸­ã€‚è¿™æ˜¯ Laravel ä¸­çš„æ ‡å‡†åšæ³•ã€‚

```blade
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {{-- å°† CSRF ä»¤ç‰Œæ·»åŠ åˆ° meta æ ‡ç­¾ä¸­ --}}
    <meta name="csrf-token" content="{{ csrf_token() }}">

    {{-- ... --}}
</head>
```

`csrf_token()` å‡½æ•°è¿”å›å½“å‰çš„ä»¤ç‰Œã€‚

**æ­¥éª¤ 2ï¼šä¿®æ”¹ JavaScript ä»¥å‘é€ä»¤ç‰Œ**

ç°åœ¨åœ¨æˆ‘ä»¬çš„ `public/js/planets.js` ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å–æ­¤ä»¤ç‰Œå¹¶å°†å…¶æ·»åŠ åˆ°æ‰€æœ‰â€œä¸å®‰å…¨â€è¯·æ±‚çš„è¯·æ±‚å¤´ä¸­ã€‚

```javascript
// ... åœ¨ public/js/planets.js æ–‡ä»¶ä¸­ ...

document.addEventListener('DOMContentLoaded', () => {
    // ä» meta æ ‡ç­¾ä¸­è·å–ä»¤ç‰Œ
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    const deleteButtons = document.querySelectorAll('.delete-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            // ... ç¡®è®¤é€»è¾‘ ...

            try {
                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': csrfToken // <-- å°†ä»¤ç‰Œæ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ï¼
                    }
                });

                // ... å‰©ä½™çš„å“åº”å¤„ç†é€»è¾‘ ...
            } catch (error) {
                // ...
            }
        });
    });
});
```

-   è¯·æ±‚å¤´åç§° `X-CSRF-TOKEN` æ˜¯ Laravel é»˜è®¤æ£€æŸ¥çš„æ ‡å‡†ã€‚

ç°åœ¨æˆ‘ä»¬çš„ AJAX è¯·æ±‚ä¹Ÿå—åˆ°ä¿æŠ¤äº†ã€‚å°è¯•å†æ¬¡åˆ é™¤æ˜Ÿçƒâ€”â€”è¿™æ¬¡è¯·æ±‚å°†æˆåŠŸé€šè¿‡ã€‚

---

### **å·©å›ºç»ƒä¹ å°æµ‹**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. CSRF ä»¤ç‰Œå¯ä»¥é˜²æ­¢å“ªç§æ”»å‡»ï¼Ÿ</p>
      <label><input type="radio" name="q1" value="a"> a) SQL æ³¨å…¥</label>
      <label><input type="radio" name="q1" value="b"> b) è·¨ç«™è„šæœ¬</label>
      <label><input type="radio" name="q1" value="c"> c) è·¨ç«™è¯·æ±‚ä¼ªé€ </label>
    </div>
    <div class="question">
      <p>2. å“ªä¸ª Blade æŒ‡ä»¤ä¼šå‘è¡¨å•ä¸­æ·»åŠ ä¸€ä¸ªå¸¦æœ‰ CSRF ä»¤ç‰Œçš„éšè—å­—æ®µï¼Ÿ</p>
      <label><input type="radio" name="q2" value="a"> a) @token</label>
      <label><input type="radio" name="q2" value="b"> b) @csrf</label>
      <label><input type="radio" name="q2" value="c"> c) @form_token</label>
    </div>
    <div class="question">
      <p>3. å¦‚æœå‘ Web è·¯ç”±å‘é€ä¸å¸¦ CSRF ä»¤ç‰Œçš„ POST è¯·æ±‚ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
      <label><input type="radio" name="q3" value="a"> a) 500 é”™è¯¯ (Internal Server Error)</label>
      <label><input type="radio" name="q3" value="b"> b) 403 é”™è¯¯ (Forbidden)</label>
      <label><input type="radio" name="q3" value="c"> c) 419 é”™è¯¯ (Page Expired / Session Expired)</label>
    </div>
    <div class="question">
      <p>4. åœ¨ AJAX è¯·æ±‚ä¸­ï¼Œå“ªä¸ªæ ‡å‡†çš„ HTTP å¤´ç”¨äºå‘é€ CSRF ä»¤ç‰Œï¼Ÿ</p>
      <label><input type="radio" name="q4" value="a"> a) Authorization</label>
      <label><input type="radio" name="q4" value="b"> b) X-CSRF-TOKEN</label>
      <label><input type="radio" name="q4" value="c"> c) Content-Type</label>
    </div>
    <div class="question">
      <p>5. ä¸ºä»€ä¹ˆ API è·¯ç”± (`routes/api.php`) é»˜è®¤ä¸ä½¿ç”¨ CSRF ä¿æŠ¤ï¼Ÿ</p>
      <label><input type="radio" name="q5" value="a"> a) å› ä¸ºå®ƒä»¬æ—¨åœ¨ç”¨äºæ— çŠ¶æ€è®¤è¯</label>
      <label><input type="radio" name="q5" value="b"> b) è¿™æ˜¯ Laravel ä¸­çš„ä¸€ä¸ªé”™è¯¯ï¼Œéœ€è¦æ‰‹åŠ¨å¯ç”¨</label>
      <label><input type="radio" name="q5" value="c"> c) å› ä¸º API è¯·æ±‚æ— æ³•è¢«ä¼ªé€ </label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">æ£€æŸ¥</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>ç»“æœï¼š</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:green;">æ­£ç¡®ï¼</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:red;">é”™è¯¯ã€‚</span> æ­£ç¡®ç­”æ¡ˆï¼š<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:orange;">æ²¡æœ‰å›ç­”ã€‚</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>æ‚¨çš„å¾—åˆ†ï¼š${score} / ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**ğŸš€ æœ¬ç« æ€»ç»“ï¼š**

æ‚¨å·²åœ¨æ‚¨çš„å®‡å®™é£èˆ¹ä¸Šå®‰è£…äº†â€œæ•Œæˆ‘è¯†åˆ«ç³»ç»Ÿâ€ï¼Œä¿æŠ¤å®ƒå…å— CSRF æ”»å‡»ã€‚æ‚¨å­¦ä¼šäº†ï¼š

-   ç†è§£ CSRF æ”»å‡»çš„æœ¬è´¨å’Œå±é™©æ€§ã€‚
-   ä½¿ç”¨ `@csrf` æŒ‡ä»¤ä¿æŠ¤æ ‡å‡† HTML è¡¨å•ã€‚
-   é€šè¿‡ meta æ ‡ç­¾å°† CSRF ä»¤ç‰Œä¼ é€’ç»™ JavaScriptã€‚
-   å°†ä»¤ç‰ŒåŒ…å«åœ¨ AJAX/Fetch è¯·æ±‚å¤´ä¸­ä»¥ç¡®ä¿å…¶æˆåŠŸæ‰§è¡Œã€‚

**æ‚¨çš„ Web ç•Œé¢ç°åœ¨ä¸ä»…å…·æœ‰äº¤äº’æ€§ï¼Œè€Œä¸”æ˜¯å®‰å…¨çš„ã€‚** åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡æ¢è®¨å¦‚ä½•æ­£ç¡®ç»„ç»‡ Web é¡µé¢çš„è·¯ç”±æ¥å®Œæˆæˆ‘ä»¬çš„ Web ç•Œé¢åˆ›å»ºã€‚