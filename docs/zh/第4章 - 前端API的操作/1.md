# **ç¬¬ 4.1 ç« ï¼šFetch API åŸºç¡€**
**å­¦ä¹ æ—¶é—´ï¼š** 45 åˆ†é’Ÿ

---

#### **1. Fetch APIï¼šâ€œä»»åŠ¡æ§åˆ¶ä¸­å¿ƒâ€çš„ä¸»å¤©çº¿**
æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çš„é£è¡Œä»»åŠ¡æ§åˆ¶ä¸­å¿ƒï¼ˆĞ¦Ğ£ĞŸï¼‰æ‹¥æœ‰ä¸€æ ¹**å·¨å¤§çš„æ— çº¿ç”µå¤©çº¿**ï¼Œç”¨äºä¸èˆªå¤©å™¨é€šä¿¡ã€‚ä½ å¯ä»¥å°†å…¶è°ƒè°åˆ°æ‰€éœ€çš„é¢‘ç‡ï¼Œå‘é€æŒ‡ä»¤å¹¶ç­‰å¾…å“åº”ã€‚

**Fetch API** å°±æ˜¯ç°ä»£æµè§ˆå™¨ä¸­è¿™æ ·ä¸€ç§â€œå†…ç½®å¤©çº¿â€ã€‚å®ƒæ˜¯ JavaScript ç”¨äºå‘æœåŠ¡å™¨æ‰§è¡Œ HTTP è¯·æ±‚çš„æ ‡å‡†æ¥å£ã€‚å®ƒå…è®¸ï¼š

- ğŸ“¡ å‘æˆ‘ä»¬çš„ API å‘é€â€œæŒ‡ä»¤â€ï¼ˆGETã€POSTã€PUTã€DELETEï¼‰ã€‚
- ğŸ›°ï¸ ä»æœåŠ¡å™¨æ¥æ”¶â€œé¥æµ‹æ•°æ®â€ï¼ˆJSON æ•°æ®ï¼‰ã€‚
- âš™ï¸ å¼‚æ­¥å·¥ä½œï¼Œåœ¨ç­‰å¾…å“åº”æ—¶ä¸ä¼šâ€œå†»ç»“â€ç”¨æˆ·ç•Œé¢ã€‚

> ğŸ’¡ **å¤ªç©ºç±»æ¯”ï¼š**

> `fetch()` å‘½ä»¤å°±åƒæ˜¯â€œå¤©çº¿ï¼Œå»ºç«‹è¿æ¥ï¼â€ã€‚ä½ å‘å®ƒä¼ é€’ï¼š

> - **ç›®æ ‡åæ ‡**ï¼ˆæˆ‘ä»¬ API çš„ URLï¼‰ã€‚
> - **æŒ‡ä»¤ç±»å‹**ï¼ˆæ–¹æ³•ï¼šGETã€POSTï¼‰ã€‚
> - **æŒ‡ä»¤å†…å®¹**ï¼ˆè¯·æ±‚ä½“ã€è¯·æ±‚å¤´ï¼‰ã€‚

> ä½œä¸ºå“åº”ï¼Œä½ ä¸ä¼šç«‹å³æ”¶åˆ°æ•°æ®æœ¬èº«ï¼Œè€Œæ˜¯æ”¶åˆ°ä¸€ä¸ª**æ‰¿è¯º (Promise)**ï¼Œå³æ•°æ®å°†ä¼šåˆ°æ¥ã€‚

---

#### **2. å¼‚æ­¥ï¼šå…‰é€Ÿé€šä¿¡**
ä¸é¥è¿œçš„èˆªå¤©å™¨é€šä¿¡éœ€è¦æ—¶é—´ã€‚ä½ ä¸èƒ½ä»…ä»…æš‚åœä»»åŠ¡æ§åˆ¶ä¸­å¿ƒçš„æ‰€æœ‰å·¥ä½œï¼Œç„¶åç­‰å¾…å“åº”åˆ°æ¥ã€‚ä½ å‘é€æŒ‡ä»¤å¹¶**ç»§ç»­å·¥ä½œ**ï¼Œå½“å“åº”åˆ°è¾¾æ—¶ï¼Œç³»ç»Ÿä¼šé€šçŸ¥ä½ ã€‚

è¿™å°±æ˜¯**å¼‚æ­¥**ã€‚JavaScript åœ¨ç­‰å¾…æœåŠ¡å™¨å“åº”æ—¶ä¸ä¼šé˜»å¡å…¶ä»–ä»£ç çš„æ‰§è¡Œã€‚ä¸ºäº†ç®¡ç†è¿™ä¸ªè¿‡ç¨‹ï¼ŒFetch API ä½¿ç”¨äº†**æ‰¿è¯º (Promises)**ã€‚

**æ‰¿è¯º (Promise)** æ˜¯ä½ å‘é€è¯·æ±‚çš„â€œæ”¶æ®â€ã€‚å®ƒæœ‰ä¸‰ç§çŠ¶æ€ï¼š

- **`pending` (å¾…å®š)ï¼š** ä¿¡å·ä»åœ¨é€”ä¸­ã€‚
- **`fulfilled` (å·²å®Œæˆ)ï¼š** æˆåŠŸæ”¶åˆ°å“åº”ï¼
- **`rejected` (å·²æ‹’ç»)ï¼š** å‘ç”Ÿäº†é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œæ²¡æœ‰è¿æ¥ï¼‰ã€‚

---

#### **3. ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼šäº†è§£å›½é™…ç©ºé—´ç«™çš„ä½ç½®**
è®©æˆ‘ä»¬ä½¿ç”¨ `fetch` å‘é€æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè¯·æ±‚ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ HTML æ–‡ä»¶å’Œ `<script>` æ ‡ç­¾ã€‚

**æ­¥éª¤ 1ï¼šåˆ›å»º `index.html`**
åœ¨ä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ä¸­ï¼ˆä¾‹å¦‚ï¼Œ`frontend_fleet_control`ï¼‰åˆ›å»ºä¸€ä¸ª `index.html` æ–‡ä»¶ã€‚
```html
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä»»åŠ¡æ§åˆ¶ä¸­å¿ƒ - Fetch API</title>
</head>
<body>
    <h1>å›½é™…ç©ºé—´ç«™é€šä¿¡çŠ¶æ€</h1>
    <div id="iss-status">ç­‰å¾…æ•°æ®...</div>

    <script>
        // æˆ‘ä»¬çš„ JavaScript ä»£ç å°†åœ¨è¿™é‡Œ
    </script>
</body>
</html>
```

**æ­¥éª¤ 2ï¼šç¼–å†™ `fetch` ä»£ç **
åœ¨ `<script>` æ ‡ç­¾å†…éƒ¨ï¼Œæ·»åŠ æˆ‘ä»¬å¯¹ Open Notify å…¬å…± API çš„ç¬¬ä¸€ä¸ª `fetch` è¯·æ±‚ã€‚
```javascript
// index.html -> <script>

const issApiUrl = 'http://api.open-notify.org/iss-now.json';
const statusDiv = document.getElementById('iss-status');

console.log('æ­£åœ¨å‘é€è¯·æ±‚ä»¥è·å–å›½é™…ç©ºé—´ç«™åæ ‡...');

fetch(issApiUrl)
    .then(response => {
        // ç¬¬ä¸€ä¸ª .then() å¤„ç† HTTP å“åº”æœ¬èº«
        console.log('å·²ä»æœåŠ¡å™¨æ”¶åˆ°å“åº”ï¼', response);
        // å°†å“åº”ä½“è½¬æ¢ä¸º JSONï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œ
        return response.json();
    })
    .then(data => {
        // ç¬¬äºŒä¸ª .then() è·å–å·²è§£æçš„ JSON æ•°æ®
        console.log('æ•°æ®å·²æˆåŠŸè½¬æ¢ä¸º JSONï¼', data);
        const position = data.iss_position;
        statusDiv.innerHTML = `å›½é™…ç©ºé—´ç«™å½“å‰ä½äºæ­¤å¤„ï¼š
                               <strong>çº¬åº¦ï¼š</strong> ${position.latitude},
                               <strong>ç»åº¦ï¼š</strong> ${position.longitude}`;
    })
    .catch(error => {
        // .catch() å°†åœ¨å‘ç”Ÿç½‘ç»œé”™è¯¯æ—¶è§¦å‘
        console.error('ä¸å›½é™…ç©ºé—´ç«™é€šä¿¡é”™è¯¯ï¼', error);
        statusDiv.textContent = 'æœªèƒ½è·å–æ•°æ®ã€‚è¯·æ£€æŸ¥è¿æ¥ã€‚';
    });
```

- **`fetch(url)`ï¼š** å‘é€ GET è¯·æ±‚ã€‚è¿”å›ä¸€ä¸ª Promiseã€‚
- **`.then(callback)`ï¼š** å½“ Promise æˆåŠŸè§£å†³ï¼ˆ`fulfilled`ï¼‰æ—¶æ‰§è¡Œã€‚ç¬¬ä¸€ä¸ª `.then` æ¥æ”¶ä¸€ä¸ª `Response` å¯¹è±¡ã€‚
- **`response.json()`ï¼š** è¯»å–å“åº”ä½“å¹¶å°†å…¶è§£æä¸º JSON çš„æ–¹æ³•ã€‚å®ƒä¹Ÿè¿”å›ä¸€ä¸ª Promiseï¼
- **`.catch(callback)`ï¼š** å½“ Promise è¢«æ‹’ç»ï¼ˆ`rejected`ï¼‰æ—¶æ‰§è¡Œï¼Œä¾‹å¦‚ç”±äºç½‘ç»œé”™è¯¯ã€‚

**æ­¥éª¤ 3ï¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€**
åªéœ€åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `index.html` æ–‡ä»¶ã€‚ä½ åº”è¯¥ä¼šçœ‹åˆ°â€œç­‰å¾…æ•°æ®...â€å˜ä¸ºå›½é™…ç©ºé—´ç«™çš„å½“å‰åæ ‡ã€‚æ‰“å¼€å¼€å‘è€…æ§åˆ¶å°ï¼ˆF12ï¼‰ä»¥æŸ¥çœ‹æ—¥å¿—ã€‚

---

#### **4. â€œå¦‚æœâ€¦â€¦â€ï¼šæœåŠ¡å™¨é”™è¯¯å¤„ç†**
å¦‚æœæˆ‘ä»¬è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„ URL ä¼šæ€æ ·ï¼Ÿ
`fetch('http://api.open-notify.org/non-existent-endpoint')`

Fetch çš„è®¾è®¡æ˜¯ï¼Œ`.catch()` åªä¼šåœ¨**ç½‘ç»œé”™è¯¯**ï¼ˆæ— äº’è”ç½‘è¿æ¥ã€DNS æœªæ‰¾åˆ°ï¼‰æ—¶è§¦å‘ã€‚ä½†æ˜¯ï¼Œå¯¹äº `fetch` æ¥è¯´ï¼Œè¿”å› `404` æˆ– `500` ä»£ç çš„å“åº”æ˜¯**æˆåŠŸæ”¶åˆ°çš„å“åº”**ï¼å®ƒåªæ˜¯åŒ…å«é”™è¯¯ä»£ç ã€‚

**æ­£ç¡®çš„æ£€æŸ¥æ–¹æ³•ï¼š**
```javascript
fetch('http://api.open-notify.org/non-existent-endpoint')
    .then(response => {
        // æ£€æŸ¥ .ok å±æ€§ï¼Œå¯¹äº 200-299 çŠ¶æ€ç ï¼Œå®ƒä¸º true
        if (!response.ok) {
            // å¦‚æœå“åº”ä¸æ˜¯â€œOKâ€ï¼Œåˆ™åˆ›å»ºè‡ªå·±çš„é”™è¯¯ä»¥è¿›å…¥ .catch()
            throw new Error(`HTTP é”™è¯¯ï¼çŠ¶æ€ç ï¼š${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(data);
    })
    .catch(error => {
        console.error('æ‰§è¡Œè¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ï¼š', error);
    });
```

- `response.ok`ï¼šè¿™æ˜¯ä½ ä¸»è¦çš„æˆåŠŸæŒ‡ç¤ºå™¨ã€‚
- `throw new Error()`ï¼šæˆ‘ä»¬æ‰‹åŠ¨â€œä¸­æ–­â€Promise é“¾ï¼Œä»¥è¿›å…¥ `.catch` å—ã€‚

---

#### **å·©å›ºçŸ¥è¯†å°æµ‹éªŒ**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Fetch API æ˜¯...</p>
      <label><input type="radio" name="q1" value="a"> a) ä¸€ä¸ªéœ€è¦ä¸‹è½½çš„å¤–éƒ¨åº“</label>
      <label><input type="radio" name="q1" value="b"> b) ä¸€ä¸ªå†…ç½®äºæµè§ˆå™¨çš„ HTTP è¯·æ±‚æ¥å£</label>
      <label><input type="radio" name="q1" value="c"> c) ä¸€ç§ç”¨äºç½‘ç»œç¼–ç¨‹çš„è¯­è¨€</label>
    </div>
    <div class="question">
      <p>2. è°ƒç”¨ `fetch(url)` è¿”å›ä»€ä¹ˆï¼Ÿ</p>
      <label><input type="radio" name="q2" value="a"> a) ç›´æ¥è¿”å› JSON æ•°æ®</label>
      <label><input type="radio" name="q2" value="b"> b) ä¸€ä¸ª `Promise` å¯¹è±¡ï¼ˆæ‰¿è¯ºï¼‰</label>
      <label><input type="radio" name="q2" value="c"> c) ä¸€ä¸ª HTML é¡µé¢</label>
    </div>
    <div class="question">
      <p>3. Promise é“¾ä¸­çš„ `.then()` æ–¹æ³•åœ¨ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ï¼Ÿ</p>
      <label><input type="radio" name="q3" value="a"> a) å‘ç”Ÿç½‘ç»œé”™è¯¯æ—¶</label>
      <label><input type="radio" name="q3" value="b"> b) è¯·æ±‚æˆåŠŸå®Œæˆæ—¶</label>
      <label><input type="radio" name="q3" value="c"> c) ç”¨æˆ·å…³é—­æ ‡ç­¾é¡µæ—¶</label>
    </div>
    <div class="question">
      <p>4. `response.json()` æ–¹æ³•ç”¨äº...</p>
      <label><input type="radio" name="q4" value="a"> a) å°†å“åº”ä½“è½¬æ¢ä¸º JavaScript å¯¹è±¡</label>
      <label><input type="radio" name="q4" value="b"> b) æ£€æŸ¥å“åº”æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ JSON</label>
      <label><input type="radio" name="q4" value="c"> c) ä»¥ JSON æ ¼å¼å‘æœåŠ¡å™¨å‘é€æ•°æ®</label>
    </div>
    <div class="question">
      <p>5. å¦‚ä½•æ­£ç¡®æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ²¡æœ‰è¿”å›é”™è¯¯ï¼ˆä¾‹å¦‚ 404ï¼‰ï¼Ÿ</p>
      <label><input type="radio" name="q5" value="a"> a) æ£€æŸ¥ `response.ok` å±æ€§</label>
      <label><input type="radio" name="q5" value="b"> b) æŸ¥çœ‹ `.catch()` å—æ˜¯å¦ä¼šè§¦å‘</label>
      <label><input type="radio" name="q5" value="c"> c) æ£€æŸ¥ `response.status` æ˜¯å¦ç­‰äºâ€œOKâ€</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">æ£€æŸ¥</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'a', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>ç»“æœï¼š</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}ï¼š<span style="color:green;">æ­£ç¡®ï¼</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}ï¼š<span style="color:red;">é”™è¯¯ã€‚</span>æ­£ç¡®ç­”æ¡ˆï¼š<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}ï¼š<span style="color:orange;">æœªä½œç­”ã€‚</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>ä½ çš„å¾—åˆ†ï¼š${score} / ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**ğŸš€ æœ¬ç« æ€»ç»“ï¼š**

ä½ å·²ç»è®¾ç½®å¥½äº†ä½ çš„ä»»åŠ¡æ§åˆ¶ä¸­å¿ƒï¼ˆĞ¦Ğ£ĞŸï¼‰çš„â€œä¸»å¤©çº¿â€ï¼Œå¹¶å­¦ä¼šäº†å‘é€è¯·æ±‚å’Œæ¥æ”¶å“åº”ã€‚

- ğŸ“¡ ä½ æŒæ¡äº† `fetch()` çš„åŸºæœ¬è¯­æ³•ã€‚
- ğŸ›°ï¸ ç†è§£äº†ä»€ä¹ˆæ˜¯**æ‰¿è¯º (Promises)** ä»¥åŠå¦‚ä½•ä½¿ç”¨ `.then()` å’Œ `.catch()`ã€‚
- âš™ï¸ å­¦ä¼šäº†é€šè¿‡æ£€æŸ¥ `response.ok` æ¥æ­£ç¡®å¤„ç†æœåŠ¡å™¨å“åº”ã€‚

**è¿æ¥å·²å»ºç«‹ï¼** åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„ä»»åŠ¡æ§åˆ¶ä¸­å¿ƒè¿æ¥åˆ°æˆ‘ä»¬ä½¿ç”¨ FastAPI åˆ›å»ºçš„å¤ªç©ºèˆ°é˜Ÿ APIï¼Œå¹¶å­¦ä¹ å¦‚ä½•è·å–å’Œæ˜¾ç¤ºæˆ‘ä»¬çš„é£èˆ¹åˆ—è¡¨ã€‚

> **ğŸ“Œ æ£€æŸ¥ï¼š**

> - ç¡®ä¿ä½ çš„ `index.html` æ–‡ä»¶æ­£ç¡®æ˜¾ç¤ºå›½é™…ç©ºé—´ç«™çš„åæ ‡ã€‚
> - å°è¯•æ•…æ„ç ´å URLï¼Œå¹¶åœ¨å¼€å‘è€…æ§åˆ¶å°ä¸­æŸ¥çœ‹ä¼šè¾“å‡ºä»€ä¹ˆé”™è¯¯ã€‚

> **âš ï¸ å¦‚æœä»£ç ä¸å·¥ä½œï¼š**

> - **CORS é”™è¯¯ï¼š** å¦‚æœä½ å°è¯•ä»ä¸€ä¸ªä»¥ `file:///...` æ–¹å¼æ‰“å¼€çš„æ–‡ä»¶å‘ä½ çš„æœ¬åœ° FastAPI APIï¼ˆä¾‹å¦‚ `http://127.0.0.1:8000`ï¼‰å‘é€è¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šå› ä¸º CORS å®‰å…¨ç­–ç•¥è€Œé˜»æ­¢è¯¥è¯·æ±‚ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ç« ä¸­è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç›®å‰æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å…è®¸è¿™ç§æ“ä½œçš„å…¬å…± APIã€‚
> - **HTTP/HTTPSï¼š** `http://api.open-notify.org` é€šè¿‡ HTTP å·¥ä½œã€‚ä¸€äº›æµè§ˆå™¨å¯èƒ½ä¼šå¯¹æ­¤å‘å‡ºè­¦å‘Šã€‚å¦‚æœä½ ä» HTTPS ç½‘ç«™æ“ä½œï¼Œå¯¹ HTTP èµ„æºçš„è¯·æ±‚å¯èƒ½ä¼šè¢«é˜»æ­¢ã€‚