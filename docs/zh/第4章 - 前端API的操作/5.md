# **ç¬¬ 4.5 ç« ï¼šAsync/await å¯¹æ¯” Promise**
**å­¦ä¹ æ—¶é—´ï¼š** 30 åˆ†é’Ÿ

---

#### **1. å¼‚æ­¥ï¼šä¸¤ç§â€œç©ºé—´é€šä¿¡â€ç®¡ç†æ–¹å¼**
æƒ³è±¡ä¸€ä¸‹ï¼Œä»»åŠ¡æ§åˆ¶ä¸­å¿ƒï¼ˆMCCï¼‰å‘ç«æ˜Ÿå‘é€äº†ä¸€æ¡æŒ‡ä»¤ã€‚å›å¤å°†åœ¨å‡ åˆ†é’Ÿåæ‰èƒ½æ”¶åˆ°ã€‚åœ¨è¿™æ®µæ—¶é—´å†…å¦‚ä½•å®‰æ’å·¥ä½œï¼Ÿ

**æ–¹å¼ 1ï¼šâ€œå›è°ƒåè®®â€ï¼ˆå¸¦ `.then()` çš„ Promiseï¼‰**
ä½ å‘é€ä¸€æ¡æŒ‡ä»¤å¹¶ç»™å‡ºæŒ‡ç¤ºï¼šâ€œ**å½“**æ”¶åˆ°å›å¤æ—¶ï¼Œ**é‚£ä¹ˆ**æ‰§è¡Œè¿™ä¸ªå‡½æ•°â€ã€‚è¿™å°±åƒä¸€ä¸ªäº‹ä»¶é“¾ã€‚

**æ–¹å¼ 2ï¼šâ€œç­‰å¾…æ¨¡å¼â€ï¼ˆAsync/awaitï¼‰**
ä½ è¯´ï¼šâ€œæˆ‘å°†**ç­‰å¾…**è¿™æ¡æŒ‡ä»¤çš„å›å¤ï¼Œä½†ä¸ä¼šé˜»å¡å…¶ä»–æ§åˆ¶å°ã€‚â€ ä½ å°±åƒæ˜¯å°†*è¿™ä¸ªç‰¹å®šä»»åŠ¡*çš„æ‰§è¡Œæš‚åœï¼Œè®©ä»»åŠ¡æ§åˆ¶ä¸­å¿ƒçš„å…¶ä»–éƒ¨åˆ†ç»§ç»­å·¥ä½œã€‚

ä¸¤ç§æ–¹å¼éƒ½è§£å†³äº†åŒä¸€ä¸ªé—®é¢˜â€”â€”ç®¡ç†å¼‚æ­¥æ“ä½œã€‚`async/await` åªæ˜¯ä¸€ç§æ›´ç°ä»£ã€æ›´æ˜“è¯»çš„è¯­æ³•ï¼Œå®ƒåœ¨ Promise çš„åŸºç¡€ä¸Šå·¥ä½œã€‚

> ğŸ’¡ **å¤ªç©ºç±»æ¯”ï¼š**

> - **å¸¦ `.then()` çš„ Promise**ï¼šè¿™å°±åƒåœ¨ä¾¿åˆ©è´´ä¸Šå†™é“ï¼šâ€œå½“ç«æ˜Ÿè½¦å‘é€ç…§ç‰‡æ—¶ï¼Œå°†å…¶ä¼ è¾“åˆ°åˆ†æéƒ¨é—¨ã€‚â€
> - **Async/await**ï¼šè¿™å°±åƒå¯¹åŠ©æ‰‹è¯´ï¼šâ€œç­‰ç­‰ç«æ˜Ÿè½¦çš„ç…§ç‰‡ï¼Œæˆ‘å…ˆå»è®¡ç®—æ–°ç«ç®­çš„å‘å°„æ•°æ®ã€‚â€

---

#### **2. å¸¦ `.then()` çš„ Promiseï¼šç»å…¸å‘½ä»¤é“¾**
è¿™æ˜¯ JavaScript ä¸­å¤„ç†å¼‚æ­¥çš„åŸºæœ¬æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ç¬¬ 4.1 ç« ä¸­æ›¾ä½¿ç”¨è¿‡ã€‚

**å›é¡¾æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªä»£ç ï¼š**
```javascript
function getIssPositionWithPromises() {
    console.log('æ­£åœ¨é€šè¿‡â€œPromiseâ€åè®®å‘é€è¯·æ±‚...');

    fetch('http://api.open-notify.org/iss-now.json')
        .then(response => {
            // é˜¶æ®µ 1ï¼šæ”¶åˆ°å“åº”
            if (!response.ok) {
                throw new Error(`HTTP é”™è¯¯ï¼š${response.status}`);
            }
            return response.json(); // è¿”å›ä¸€ä¸ªæ–°çš„ Promise
        })
        .then(data => {
            // é˜¶æ®µ 2ï¼šæ•°æ®å·²è§£æ
            console.log('é€šè¿‡â€œPromiseâ€åè®®è·å–çš„æ•°æ®ï¼š', data.iss_position);
        })
        .catch(error => {
            // é˜¶æ®µ 3ï¼ˆé”™è¯¯ï¼‰ï¼šåœ¨ä»»ä½•é˜¶æ®µéƒ½å‡ºé”™äº†
            console.error('â€œPromiseâ€åè®®é€šä¿¡å¤±è´¥ï¼š', error);
        });

    console.log('...å‘½ä»¤å·²å‘é€ï¼Œä»»åŠ¡æ§åˆ¶ä¸­å¿ƒç»§ç»­å·¥ä½œ...');
}
```

**ä¼˜ç‚¹ï¼š**

- æ¸…æ™°çš„åŠ¨ä½œé“¾ã€‚
- éå¸¸é€‚åˆç®€å•çš„é¡ºåºæ“ä½œã€‚

**ç¼ºç‚¹ï¼š**

- **â€œå›è°ƒåœ°ç‹±â€ï¼ˆCallback Hellï¼‰ï¼š** å½“æœ‰å¤§é‡åµŒå¥—å¼‚æ­¥æ“ä½œæ—¶ï¼Œä»£ç å¯èƒ½å˜æˆä¸€ä¸ªç”± `.then()` ç»„æˆçš„â€œé˜¶æ¢¯â€ï¼Œéš¾ä»¥é˜…è¯»ã€‚
- é”™è¯¯å¤„ç†å¯èƒ½ä¸å¤Ÿç›´è§‚ã€‚

---

#### **3. Async/awaitï¼šç°ä»£åŒæ­¥é£æ ¼**
`async/await` æ˜¯ Promise ä¹‹ä¸Šçš„â€œè¯­æ³•ç³–â€ï¼Œå®ƒå…è®¸ä½ åƒç¼–å†™åŒæ­¥ä»£ç ä¸€æ ·ç¼–å†™å¼‚æ­¥ä»£ç ã€‚

**ä½¿ç”¨è§„åˆ™ï¼š**

1.  å…³é”®å­— `await` **åªèƒ½åœ¨æ ‡è®°ä¸º `async` çš„å‡½æ•°å†…éƒ¨**ä½¿ç”¨ã€‚
2.  `await` æ”¾ç½®åœ¨è¿”å› Promise çš„è°ƒç”¨ï¼ˆä¾‹å¦‚ `fetch()` æˆ– `response.json()`ï¼‰ä¹‹å‰ã€‚
3.  `await` ä¼šâ€œæš‚åœâ€ `async` å‡½æ•°çš„æ‰§è¡Œï¼Œç›´åˆ° Promise è¢«è§£å†³ï¼ˆresolvedï¼‰ï¼Œå¹¶è¿”å›å…¶ç»“æœã€‚

**ç›¸åŒçš„ä»£ç ï¼Œç”¨ `async/await` é‡å†™ï¼š**
```javascript
async function getIssPositionWithAsyncAwait() {
    console.log('æ­£åœ¨é€šè¿‡â€œAsync/awaitâ€åè®®å‘é€è¯·æ±‚...');

    try {
        // é˜¶æ®µ 1ï¼šç­‰å¾…æœåŠ¡å™¨å“åº”
        const response = await fetch('http://api.open-notify.org/iss-now.json');

        if (!response.ok) {
            throw new Error(`HTTP é”™è¯¯ï¼š${response.status}`);
        }

        // é˜¶æ®µ 2ï¼šç­‰å¾…å“åº”ä½“è½¬æ¢ä¸º JSON
        const data = await response.json();

        console.log('é€šè¿‡â€œAsync/awaitâ€åè®®è·å–çš„æ•°æ®ï¼š', data.iss_position);
    } catch (error) {
        // é˜¶æ®µ 3ï¼ˆé”™è¯¯ï¼‰ï¼šæ•è· try å—ä¸­çš„ä»»ä½•é”™è¯¯
        console.error('â€œAsync/awaitâ€åè®®é€šä¿¡å¤±è´¥ï¼š', error);
    }

    console.log('...å‘½ä»¤å·²å‘é€ï¼Œä»»åŠ¡æ§åˆ¶ä¸­å¿ƒç»§ç»­å·¥ä½œ...');
}
```

**ä¼˜ç‚¹ï¼š**

- **å¯è¯»æ€§ï¼š** ä»£ç çœ‹èµ·æ¥å‡ ä¹å’Œæ™®é€šçš„åŒæ­¥ä»£ç ä¸€æ ·ï¼Œå¾ˆå®¹æ˜“ä»ä¸Šåˆ°ä¸‹é˜…è¯»ã€‚
- **é”™è¯¯å¤„ç†ï¼š** ä½¿ç”¨æ ‡å‡†ä¸”ç†Ÿæ‚‰çš„ `try...catch` å—ã€‚
- **è°ƒè¯•ï¼š** æ›´å®¹æ˜“è°ƒè¯•ï¼Œå› ä¸ºå¯ä»¥åœ¨æ¯ä¸ªå¸¦æœ‰ `await` çš„è¡Œä¸Šè®¾ç½®æ–­ç‚¹ï¼ˆbreakpointsï¼‰ã€‚

**ç¼ºç‚¹ï¼š**

- å®¹æ˜“å¿˜è®° `await` æˆ– `async`ï¼Œè¿™ä¼šå¯¼è‡´é”™è¯¯ã€‚

---

#### **4. ä½•æ—¶ä½¿ç”¨å“ªç§åè®®ï¼Ÿ**

| æƒ…å†µ | æ¨èæ–¹æ³• | åŸå› ï¼Ÿ |
|---|---|---|
| **å¤§å¤šæ•°æƒ…å†µ** | **`async/await`** | ä»£ç æ›´æ¸…æ™°ï¼Œæ›´æ˜“è¯»å’Œè°ƒè¯•ã€‚è¿™æ˜¯ç°ä»£æ ‡å‡†ã€‚ |
| **ç®€å• 1-2 æ­¥é“¾** | å¸¦ `.then()` çš„ Promise | å®Œå…¨é€‚ç”¨ï¼Œä»£ç ä¿æŒç´§å‡‘ã€‚ |
| **å¹¶è¡Œæ‰§è¡Œå¤šä¸ªè¯·æ±‚** | `Promise.all()` | æ­¤æ–¹æ³•å…è®¸åŒæ—¶å¯åŠ¨å¤šä¸ª Promise å¹¶ç­‰å¾…å®ƒä»¬å…¨éƒ¨å®Œæˆã€‚`async/await` ä¸å®ƒå®Œç¾ç»“åˆã€‚ |

**`Promise.all()` ç¤ºä¾‹ï¼š**
```javascript
async function getParallelData() {
    try {
        // åŒæ—¶å¯åŠ¨ä¸¤ä¸ªè¯·æ±‚
        const [shipsResponse, launchesResponse] = await Promise.all([
            fetch('https://api.spacexdata.com/v4/rockets'),
            fetch('https://api.spacexdata.com/v4/launches/latest')
        ]);

        if (!shipsResponse.ok || !launchesResponse.ok) {
            throw new Error('å…¶ä¸­ä¸€ä¸ªè¯·æ±‚å¤±è´¥äº†ï¼');
        }

        const rockets = await shipsResponse.json();
        const latestLaunch = await launchesResponse.json();

        console.log(`èˆ°é˜Ÿä¸­çš„ç«ç®­æ€»æ•°ï¼š${rockets.length}`);
        console.log(`æœ€æ–°å‘å°„ï¼š${latestLaunch.name}`);
    } catch (error) {
        console.error('è·å–å¹¶è¡Œæ•°æ®æ—¶å‡ºé”™ï¼š', error);
    }
}
```

---

#### **å·©å›ºæµ‹éªŒ**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. `async/await` æ˜¯...</p>
      <label><input type="radio" name="q1" value="a"> a) Promise çš„æ›¿ä»£å“ï¼Œå·¥ä½œæ–¹å¼ä¸åŒ</label>
      <label><input type="radio" name="q1" value="b"> b) å¤„ç† Promise æ›´ä¾¿æ·çš„è¯­æ³•</label>
      <label><input type="radio" name="q1" value="c"> c) ä½¿ JavaScript åŒæ­¥çš„æ–¹å¼</label>
    </div>
    <div class="question">
      <p>2. åœ¨ä½¿ç”¨ `await` çš„å‡½æ•°å†…éƒ¨ï¼Œå“ªä¸ªå…³é”®å­—æ˜¯å¿…éœ€çš„ï¼Ÿ</p>
      <label><input type="radio" name="q2" value="a"> a) `promise`</label>
      <label><input type="radio" name="q2" value="b"> b) `function`</label>
      <label><input type="radio" name="q2" value="c"> c) `async`</label>
    </div>
    <div class="question">
      <p>3. `async/await` ç›¸å¯¹äº `.then()` çš„ä¸»è¦ä¼˜åŠ¿æ˜¯ï¼š</p>
      <label><input type="radio" name="q3" value="a"> a) æ›´é«˜çš„æ‰§è¡Œé€Ÿåº¦</label>
      <label><input type="radio" name="q3" value="b"> b) æ›´å¥½çš„ä»£ç å¯è¯»æ€§å’Œé€šè¿‡ `try...catch` æ–¹ä¾¿çš„é”™è¯¯å¤„ç†</label>
      <label><input type="radio" name="q3" value="c"> c) æ— éœ€ Polyfill å³å¯åœ¨æ—§æµè§ˆå™¨ä¸­è¿è¡Œ</label>
    </div>
    <div class="question">
      <p>4. å¦‚æœåœ¨ `async` å‡½æ•°å†…éƒ¨å¿˜è®°åœ¨ `fetch()` å‰æ·»åŠ  `await`ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
      <label><input type="radio" name="q4" value="a"> a) ä»£ç ä¼šæ‰§è¡Œï¼Œæ²¡æœ‰é”™è¯¯ï¼Œä½†å˜é‡å°†åŒ…å«ä¸€ä¸ª Promise è€Œéç»“æœ</label>
      <label><input type="radio" name="q4" value="b"> b) JavaScript ä¼šæŠ›å‡ºè¯­æ³•é”™è¯¯</label>
      <label><input type="radio" name="q4" value="c"> c) é¡µé¢å°†â€œæŒ‚èµ·â€ç­‰å¾…å“åº”</label>
    </div>
    <div class="question">
      <p>5. `Promise.all()` ç”¨äºï¼š</p>
      <label><input type="radio" name="q5" value="a"> a) ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œ Promise</label>
      <label><input type="radio" name="q5" value="b"> b) å¹¶è¡Œå¯åŠ¨å¤šä¸ª Promise å¹¶ç­‰å¾…å®ƒä»¬å…¨éƒ¨å®Œæˆ</label>
      <label><input type="radio" name="q5" value="c"> c) ä»å¤šä¸ª Promise ä¸­é€‰æ‹©æœ€å¿«çš„é‚£ä¸ª</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">æ£€æŸ¥</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'c', q3: 'b', q4: 'a', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>ç»“æœï¼š</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:green;">æ­£ç¡®ï¼</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:red;">é”™è¯¯ã€‚</span> æ­£ç¡®ç­”æ¡ˆï¼š<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:orange;">æ²¡æœ‰å›ç­”ã€‚</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>ä½ çš„å¾—åˆ†ï¼š${score} åˆ†ï¼Œæ€»åˆ† ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**ğŸš€ æœ¬ç« æ€»ç»“ï¼š**

ä½ å­¦ä¹ äº†ä¸¤ç§ç®¡ç†å¼‚æ­¥æ“ä½œçš„è¯­æ³•ï¼Œå¹¶ç†è§£äº†ä¸ºä»€ä¹ˆ `async/await` åœ¨å¤§å¤šæ•°ç°ä»£é¡¹ç›®ä¸­æ˜¯é¦–é€‰ã€‚

- ğŸ”— ä½ å›é¡¾äº†å…³äº**å¸¦ `.then()` çš„ Promise** çš„çŸ¥è¯†ã€‚
- ğŸ› ï¸ ä½ æ·±å…¥ç†è§£äº† **`async/await`** çš„å·¥ä½œåŸç†åŠå…¶ä¼˜åŠ¿ã€‚
- âš¡ ä½ äº†è§£äº† `Promise.all` ç”¨äºæ‰§è¡Œå¹¶è¡Œè¯·æ±‚ã€‚

**é€šä¿¡åè®®å·²æŒæ¡ï¼** åœ¨æœ¬èŠ‚çš„æœ€åä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠæ‰€æœ‰çŸ¥è¯†èä¼šè´¯é€šï¼Œå¹¶å®Œå–„æˆ‘ä»¬çš„â€œé£è¡Œæ§åˆ¶ä¸­å¿ƒâ€ï¼Œä¸ºæ‰€æœ‰ CRUD æ“ä½œåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„ç•Œé¢ã€‚

> **ğŸ“Œ å®è·µï¼š**

> - å°†ä½  `app.js` ä¸­æ‰€æœ‰ä»ç„¶ä½¿ç”¨ `.then()` çš„å‡½æ•°é‡å†™ä¸º `async/await` è¯­æ³•ã€‚
> - å°è¯•åœ¨ `Promise.all()` ä¸­æ·»åŠ å¦ä¸€ä¸ªè¯·æ±‚ï¼ˆä¾‹å¦‚ï¼Œè®¿é—® `https://api.spacexdata.com/v4/starlink`ï¼‰å¹¶è¾“å‡ºæ•°æ®ã€‚

> **âš ï¸ å¦‚æœå‡ºç°é”™è¯¯ï¼š**

> - `await is only valid in async functions`ï¼šç¡®ä¿ä½ ä½¿ç”¨ `await` çš„å‡½æ•°å·²è¢«æ ‡è®°ä¸º `async`ã€‚
> - å˜é‡åŒ…å« `[object Promise]`ï¼šä½ å¿˜è®°åœ¨è¿”å› Promise çš„å‡½æ•°å‰åŠ ä¸Š `await`ã€‚