# **ç¬¬ 3.6 ç« ï¼šé”™è¯¯å¤„ç†ä¸æ•°æ®éªŒè¯**
**å­¦ä¹ æ—¶é—´ï¼š** 50 åˆ†é’Ÿ

---

#### **1. é”™è¯¯å¤„ç†ï¼šâ€œé£èˆ¹çš„åº”æ€¥æŠ¤ç›¾â€**
å³ä½¿æ˜¯æœ€å®Œç¾çš„é£èˆ¹ï¼Œä¹Ÿå¯èƒ½å‘ç”Ÿæ„æƒ³ä¸åˆ°çš„æƒ…å†µï¼š

- **æ¥è‡ªä»»åŠ¡æ§åˆ¶ä¸­å¿ƒçš„é”™è¯¯æŒ‡ä»¤ï¼š** å®¢æˆ·ç«¯å‘é€äº†ä¸æ­£ç¡®çš„æ•°æ®ã€‚
- **ä¸æ¨¡å—å¤±å»è”ç³»ï¼š** æ•°æ®åº“ä¸­æœªæ‰¾åˆ°èµ„æºã€‚
- **ååº”å †æ•…éšœï¼š** æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ã€‚

**æ­£ç¡®çš„é”™è¯¯å¤„ç†**æ˜¯ä¸€å¥—â€œåº”æ€¥æŠ¤ç›¾â€ç³»ç»Ÿã€‚å®ƒä¸ä¼šè®©é£èˆ¹è§£ä½“ï¼Œè€Œæ˜¯å‘ä»»åŠ¡æ§åˆ¶ä¸­å¿ƒå‘é€æ¸…æ™°çš„ä¿¡å·ï¼Œå‘ŠçŸ¥å“ªé‡Œå‡ºäº†é—®é¢˜ã€‚

> ğŸ’¡ **å¤ªç©ºç±»æ¯”ï¼š**

> ä¸€ä¸ªä¼˜ç§€çš„æœºè½½ç”µè„‘ä¸ä¼šåªå‘ä»»åŠ¡æ§åˆ¶ä¸­å¿ƒå‘é€â€œç´§æ€¥æƒ…å†µï¼â€çš„ä¿¡å·ï¼Œè€Œæ˜¯ä¼šå‘é€ä¸€ä»½ç»“æ„åŒ–çš„æŠ¥å‘Šï¼š
> ```json
> {
>   "error_code": "ENGINE_OVERHEAT",
>   "message": "2å·å‘åŠ¨æœºæ¸©åº¦è¶…è¿‡æ­£å¸¸å€¼",
>   "suggested_action": "å¯åŠ¨å†·å´ç³»ç»Ÿ"
> }
> ```
> è¿™ä½¿å¾—åœ°çƒä¸Šçš„å·¥ç¨‹å¸ˆèƒ½å¤Ÿå¿«é€Ÿç†è§£é—®é¢˜å¹¶é‡‡å–æªæ–½ã€‚

---

#### **2. Pydantic æ•°æ®éªŒè¯ï¼šå†…ç½®çš„â€œæœºè½½ç”µè„‘â€**
æˆ‘ä»¬å·²ç»è§è¯†è¿‡ Pydantic çš„é­”åŠ›ã€‚å¦‚æœä½ å°è¯•åˆ›å»ºä¸€ä¸ªåŒ…å«é”™è¯¯æ•°æ®ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œå°† `launch_year` è®¾ä¸ºå­—ç¬¦ä¸²ï¼‰çš„é£èˆ¹ï¼ŒFastAPI ä¼šè‡ªåŠ¨è¿”å› `422 Unprocessable Entity` é”™è¯¯ï¼Œå¹¶é™„å¸¦è¯¦ç»†è¯´æ˜å“ªä¸ªå­—æ®µä»¥åŠä¸ºä½•æœªé€šè¿‡éªŒè¯ã€‚

**`POST /spaceships` è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "name": "X-Wing",
  "type": "Ğ˜ÑÑ‚Ñ€ĞµĞ±Ğ¸Ñ‚ĞµĞ»ÑŒ",
  "launch_year": "Ğ´Ğ°Ğ²Ğ½Ğ¾",  // <-- ç±»å‹é”™è¯¯ï¼
  "status": "Ğ’ ÑÑ‚Ñ€Ğ¾Ñ"
}
```

**FastAPI è‡ªåŠ¨å“åº”ï¼š**
```json
{
  "detail": [
    {
      "loc": [
        "body",
        "launch_year"
      ],
      "msg": "value is not a valid integer",
      "type": "type_error.integer"
    }
  ]
}
```
è¿™éå¸¸å¼ºå¤§ï¼ä½ æ— éœ€ç¼–å†™ç±»å‹æ£€æŸ¥ä»£ç â€”â€”FastAPI å’Œ Pydantic ä¼šä¸ºä½ å®Œæˆã€‚

---

#### **3. å¤„ç†â€œèµ„æºæœªæ‰¾åˆ°â€ï¼š`HTTPException` å¼‚å¸¸**
æˆ‘ä»¬å·²ç»åœ¨ CRUD æ“ä½œä¸­ä½¿ç”¨äº†å®ƒã€‚`HTTPException` æ˜¯ FastAPI ä¸­æ­¢è¯·æ±‚æ‰§è¡Œå¹¶ç«‹å³å‘å®¢æˆ·ç«¯è¿”å›é”™è¯¯å“åº”çš„æ ‡å‡†æ–¹å¼ã€‚

**å›é¡¾ `GET /spaceships/{ship_id}` ä¸­çš„ä»£ç ï¼š**
```python
# main.py
from fastapi import FastAPI, HTTPException # ç¡®ä¿å·²å¯¼å…¥ HTTPException

# ...

@app.get("/spaceships/{ship_id}", response_model=Spaceship, tags=["èˆªå¤©å™¨"])
def get_spaceship(ship_id: int):
    ship = db_spaceships.get(ship_id)
    if not ship:
        # å¦‚æœé£èˆ¹æœªæ‰¾åˆ°ï¼Œåˆ™â€œæŠ›å‡ºâ€ 404 å¼‚å¸¸
        raise HTTPException(status_code=404, detail=f"ID ä¸º {ship_id} çš„èˆªå¤©å™¨æœªæ‰¾åˆ°")
    return ship
```

- `raise HTTPException(...)`ï¼šæ­¤è°ƒç”¨ä¼šåœæ­¢å‡½æ•°æ‰§è¡Œã€‚
- `status_code=404`ï¼šè®¾ç½® HTTP å“åº”çŠ¶æ€ç ã€‚
- `detail`ï¼šå°†é€šè¿‡ JSON å“åº”ä½“å‘é€ç»™å®¢æˆ·ç«¯çš„æ¶ˆæ¯ã€‚

---

#### **4. è‡ªå®šä¹‰éªŒè¯å™¨ï¼šâ€œå¯åŠ¨å‰çš„ç‰¹æ®Šæ£€æŸ¥â€**
å¦‚æœæˆ‘ä»¬æƒ³æ·»åŠ è‡ªå·±çš„ã€æ›´å¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ€ä¹ˆåŠï¼Ÿä¾‹å¦‚ï¼Œç¦æ­¢å‘å°„åä¸ºâ€œæ­»æ˜Ÿâ€çš„é£èˆ¹ã€‚

ä¸ºæ­¤ï¼ŒPydantic æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·â€”â€”**éªŒè¯å™¨**ã€‚

**æ­¥éª¤ 1ï¼šåœ¨ `SpaceshipCreate` æ¨¡å‹ä¸­æ·»åŠ éªŒè¯å™¨**
```python
# main.py
from pydantic import BaseModel, Field, validator

class SpaceshipCreate(BaseModel):
    name: str = Field(..., min_length=3, max_length=50)
    type: str
    launch_year: int = Field(..., gt=1950)
    status: str

    @validator('name')
    def name_must_not_be_forbidden(cls, v):
        """æ£€æŸ¥é£èˆ¹åç§°æ˜¯å¦åœ¨ç¦æ­¢åˆ—è¡¨ä¸­ã€‚"""
        if 'Death Star' in v:
            raise ValueError('æ ¹æ®å¸å›½æ³•ä»¤ï¼Œç¦æ­¢ä½¿ç”¨â€œæ­»æ˜Ÿâ€ä¹‹ç±»çš„åç§°ï¼')
        return v.title() # åŒæ—¶å°†åç§°è½¬æ¢ä¸ºé¦–å­—æ¯å¤§å†™
```

- `@validator('name')`ï¼šä¸€ä¸ªå°†æ­¤å‡½æ•°â€œç»‘å®šâ€åˆ° `name` å­—æ®µçš„è£…é¥°å™¨ã€‚
- `cls, v`ï¼šè¯¥æ–¹æ³•æ¥æ”¶ç±»æœ¬èº«ï¼ˆ`cls`ï¼‰å’Œå­—æ®µçš„å€¼ï¼ˆ`v`ï¼‰ã€‚
- `raise ValueError(...)`ï¼šå¦‚æœéªŒè¯æœªé€šè¿‡ï¼Œæˆ‘ä»¬å°†å¼•å‘æ ‡å‡†çš„ Python å¼‚å¸¸ã€‚FastAPI ä¼šæ•è·å®ƒå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ¼‚äº®çš„ `422` é”™è¯¯ã€‚
- `return v.title()`ï¼šå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬**å¿…é¡»è¿”å›ä¸€ä¸ªå€¼**ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹å®ƒï¼ˆä¾‹å¦‚ï¼Œè½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ï¼‰ã€‚

**æ­¥éª¤ 2ï¼šæµ‹è¯•**
é‡å¯ `uvicorn` å¹¶å°è¯•é€šè¿‡ `/docs` åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç¦ç”¨åç§°çš„é£èˆ¹ã€‚ä½ å°†æ”¶åˆ°ä¸€ä¸ªå¸¦æœ‰ä½ çš„è‡ªå®šä¹‰æ¶ˆæ¯çš„ `422` é”™è¯¯ï¼

---

#### **5. å…¨å±€é”™è¯¯å¤„ç†ï¼šâ€œç«™ç‚¹çš„åº”æ€¥åè®®â€**
æœ‰æ—¶éœ€è¦æ•è·æ„å¤–é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œè¿æ¥åˆ°çœŸå®æ•°æ®åº“å¤±è´¥ï¼‰å¹¶è¿”å›ç»Ÿä¸€ã€æ ‡å‡†åŒ–çš„å“åº”æ ¼å¼ã€‚

ä¸ºæ­¤ï¼Œå¯ä»¥ä½¿ç”¨ `@app.exception_handler` è£…é¥°å™¨ã€‚

**ç¤ºä¾‹ï¼šæ•è·æ‰€æœ‰ `ValueError` é”™è¯¯**
```python
# main.py
from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse

# ...

@app.exception_handler(ValueError)
async def value_error_exception_handler(request: Request, exc: ValueError):
    """
    æ‰€æœ‰ ValueError é”™è¯¯çš„å…¨å±€å¤„ç†ç¨‹åºï¼Œ
    ç”¨äºè¿”å›æ ‡å‡†åŒ–çš„ JSONã€‚
    """
    return JSONResponse(
        status_code=400,
        content={"message": f"æ•°æ®é”™è¯¯ï¼š{str(exc)}"},
    )
```

- `@app.exception_handler(ValueError)`ï¼šå‘Šè¯‰ FastAPIï¼Œæ­¤å‡½æ•°åº”å¤„ç†æ‰€æœ‰ä¹‹å‰æœªè¢«æ•è·çš„ `ValueError`ã€‚
- `async def ...`ï¼šå¼‚å¸¸å¤„ç†ç¨‹åºå¿…é¡»æ˜¯å¼‚æ­¥çš„ï¼ˆ`async`ï¼‰ã€‚
- `JSONResponse`ï¼šå…è®¸å®Œå…¨æ§åˆ¶å“åº”ä½“å’ŒçŠ¶æ€ã€‚

ç°åœ¨ï¼Œå½“æˆ‘ä»¬çš„è‡ªå®šä¹‰éªŒè¯å™¨è§¦å‘æ—¶ï¼Œå“åº”å°†é‡‡ç”¨æˆ‘ä»¬å®šä¹‰çš„æ›´å‹å¥½çš„æ ¼å¼ã€‚

---

#### **å·©å›ºæµ‹éªŒ**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. å¦‚æœå®¢æˆ·ç«¯å‘é€äº†é”™è¯¯ç±»å‹çš„æ•°æ®ï¼ˆå­—ç¬¦ä¸²è€Œä¸æ˜¯æ•°å­—ï¼‰ï¼ŒFastAPI å°†è‡ªåŠ¨è¿”å›çŠ¶æ€ç ...</p>
      <label><input type="radio" name="q1" value="a"> a) 500 Internal Server Error</label>
      <label><input type="radio" name="q1" value="b"> b) 404 Not Found</label>
      <label><input type="radio" name="q1" value="c"> c) 422 Unprocessable Entity</label>
    </div>
    <div class="question">
      <p>2. `raise HTTPException(status_code=404)` æ˜¯ä¸ºäº†...</p>
      <label><input type="radio" name="q2" value="a"> a) ç»ˆæ­¢æ•´ä¸ªæœåŠ¡å™¨çš„è¿è¡Œ</label>
      <label><input type="radio" name="q2" value="b"> b) ä¸­æ­¢è¯·æ±‚æ‰§è¡Œå¹¶å‘å®¢æˆ·ç«¯è¿”å› 404 é”™è¯¯</label>
      <label><input type="radio" name="q2" value="c"> c) å°†é”™è¯¯å†™å…¥æ—¥å¿—ï¼Œä½†ç»§ç»­æ‰§è¡Œ</label>
    </div>
    <div class="question">
      <p>3. Pydantic ä¸­çš„ `@validator('field_name')` è£…é¥°å™¨ç”¨äºï¼š</p>
      <label><input type="radio" name="q3" value="a"> a) ä¸ºç‰¹å®šå­—æ®µåˆ›å»ºè‡ªå®šä¹‰éªŒè¯é€»è¾‘</label>
      <label><input type="radio" name="q3" value="b"> b) æŒ‡ç¤ºå­—æ®µä¸ºå¿…å¡«é¡¹</label>
      <label><input type="radio" name="q3" value="c"> c) åŠ å¯†å­—æ®µçš„å€¼</label>
    </div>
    <div class="question">
      <p>4. å¦‚æœæ•°æ®æ­£ç¡®ï¼ŒPydantic ä¸­çš„éªŒè¯å™¨å‡½æ•°åº”è¯¥åšä»€ä¹ˆï¼Ÿ</p>
      <label><input type="radio" name="q4" value="a"> a) ä¸è¿”å›ä»»ä½•å†…å®¹ï¼ˆNoneï¼‰</label>
      <label><input type="radio" name="q4" value="b"> b) å¿…é¡»è¿”å›å€¼ï¼ˆå¯èƒ½å·²ä¿®æ”¹ï¼‰</label>
      <label><input type="radio" name="q4" value="c"> c) è¿”å› `True`</label>
    </div>
    <div class="question">
      <p>5. `@app.exception_handler()` å…è®¸...</p>
      <label><input type="radio" name="q5" value="a"> a) åˆ›å»ºæ–°çš„å¼‚å¸¸ç±»å‹</label>
      <label><input type="radio" name="q5" value="b"> b) å…¨å±€æ•è·å¼‚å¸¸å¹¶ä¸ºå…¶å®šä¹‰è‡ªå®šä¹‰å“åº”</label>
      <label><input type="radio" name="q5" value="c"> c) å¿½ç•¥æ‰€æœ‰é”™è¯¯å¹¶å§‹ç»ˆè¿”å›çŠ¶æ€ 200</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">æ£€æŸ¥</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'a', q4: 'b', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>ç»“æœï¼š</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}ï¼š<span style="color:green;">æ­£ç¡®ï¼</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}ï¼š<span style="color:red;">é”™è¯¯ã€‚</span>æ­£ç¡®ç­”æ¡ˆï¼š<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}ï¼š<span style="color:orange;">æœªä½œç­”ã€‚</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>ä½ çš„åˆ†æ•°ï¼š${score} å…± ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**ğŸš€ æœ¬ç« æ€»ç»“ï¼š**

ä½ å·²ä¸ºä½ çš„ API é£èˆ¹å®‰è£…äº†å¼ºå¤§çš„é˜²æŠ¤ç³»ç»Ÿå’Œåº”æ€¥åè®®ã€‚ç°åœ¨å®ƒèƒ½å¤Ÿï¼š

- ğŸ›¡ï¸ å€ŸåŠ© Pydantic è‡ªåŠ¨æŠµå¾¡â€œä¸æ­£ç¡®æ•°æ®â€çš„æ”»å‡»ã€‚
- ğŸš¨ é€šè¿‡ `HTTPException` å¦¥å–„æŠ¥å‘Šèµ„æºç¼ºå¤±ï¼ˆ`404 Not Found`ï¼‰ã€‚
- âš™ï¸ ä½¿ç”¨è‡ªå®šä¹‰éªŒè¯å™¨è¿›è¡Œâ€œç‰¹æ®Šæ£€æŸ¥â€ã€‚
- ğŸ§¯ å…¨å±€æ•è·æ„å¤–æ•…éšœå¹¶ç»™å‡ºæ ‡å‡†åŒ–å“åº”ã€‚

**ä½ çš„â€œè¶…å…‰é€Ÿå¼•æ“â€ä¸ä»…é€Ÿåº¦å¿«ï¼Œè€Œä¸”æå…¶å¯é ï¼**

> **ğŸ“Œ æ£€æŸ¥ï¼š**

> - å°è¯•åˆ›å»ºä¸€ä¸ªåä¸ºâ€œæ­»æ˜Ÿâ€çš„é£èˆ¹ï¼Œå¹¶ç¡®è®¤ä½ æ”¶åˆ°äº†å¸¦æœ‰ä½ çš„è‡ªå®šä¹‰æ¶ˆæ¯çš„ `400` é”™è¯¯ã€‚
> - å°è¯•è¯·æ±‚ `GET /spaceships/999`ï¼Œå¹¶ç¡®è®¤ä½ æ”¶åˆ°äº† `404` é”™è¯¯ã€‚
> - å°è¯•å‘é€ä¸€ä¸ª `POST` è¯·æ±‚ï¼Œå°† `launch_year` è®¾ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶ç¡®è®¤ä½ æ”¶åˆ°äº† `422` é”™è¯¯ã€‚

> **âš ï¸ å¦‚æœæœ‰é”™è¯¯ï¼š**

> - ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„æ¨¡å—ï¼ˆ`HTTPException`ã€`validator`ã€`Request`ã€`JSONResponse`ï¼‰éƒ½å·²å¯¼å…¥ã€‚
> - æ£€æŸ¥ `@validator` å’Œ `@app.exception_handler` è£…é¥°å™¨æ˜¯å¦æ²¡æœ‰æ‹¼å†™é”™è¯¯ã€‚

**æ­å–œä½ å®Œæˆç¬¬ 3 ç« ï¼** ä½ å·²ç»ä»é›¶å¼€å§‹æ„å»ºå¹¶å¯åŠ¨äº†ä¸€ä¸ªå¼ºå¤§ã€æœ‰æ–‡æ¡£è®°å½•ä¸”å—ä¿æŠ¤çš„ FastAPI APIã€‚ä½ å·²å‡†å¤‡å¥½æ‰§è¡ŒçœŸæ­£çš„å¤ªç©ºä»»åŠ¡ã€‚