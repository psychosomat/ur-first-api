# **第2.4章：PlanetController API 控制器**
**学习时间：** 1 小时

---

#### **1. 控制器：宇宙对象管理中心**
在 MVC 架构中，**控制器**是模型和请求之间的中介：

- 📡 接收 HTTP 请求 (GET, POST, PUT, DELETE)
- 🔍 通过模型从数据库中提取数据
- 📦 格式化 API 的 JSON 响应

> 💡 **宇宙类比：**
> `PlanetController` = 任务控制中心：

> - 接收来自地球的请求（`GET /planets`）
> - 向“探测器”（模型）发出指令
> - 以 JSON 格式返回遥测数据

---

#### **2. 创建资源控制器**
资源控制器自动包含用于 CRUD 操作的方法。

**步骤 1：生成控制器**
```bash
php artisan make:controller PlanetController --api --model=Planet
```

**将在 `app/Http/Controllers/PlanetController.php` 中创建以下内容：**
```php
<?php

namespace App\Http\Controllers;

use App\Models\Planet;
use Illuminate\Http\Request;
use Illuminate\Validation\Rule; // 别忘了添加此导入

class PlanetController extends Controller
{
    // 显示行星列表
    public function index(Request $request) {}

    // 创建新行星
    public function store(Request $request) {}

    // 显示特定行星
    public function show(Planet $planet) {}

    // 更新行星
    public function update(Request $request, Planet $planet) {}

    // 删除行星
    public function destroy(Planet $planet) {}
}
```

---

#### **3. 实现 API 方法**

**A. `index()` - 获取行星列表**
```php
<?php
public function index(Request $request)
{
    // 获取分页行星，每页 15 个
    $planets = Planet::paginate($request->get('per_page', 15));
    return response()->json($planets); // 自动 200 OK
}
```

**B. `store()` - 创建新行星**
```php
<?php
public function store(Request $request)
{
    $data = $request->validate([
        'name' => 'required|string|max:255|unique:planets',
        'description' => 'required|string',
        'size_km' => 'required|integer|min:100',
        'solar_system' => 'required|string|max:100',
        'image_url' => 'nullable|url',
        'is_habitable' => 'boolean'
    ]);

    $planet = Planet::create($data);
    return response()->json($planet, 201); // 201 Created
}
```

**C. `show()` - 查看单个行星**
```php
<?php
public function show(Planet $planet)
{
    return response()->json($planet); // 自动 200 OK
}
```

**D. `update()` - 更新行星**
```php
<?php
public function update(Request $request, Planet $planet)
{
    $data = $request->validate([
        'name' => [
            'string',
            'max:255',
            Rule::unique('planets')->ignore($planet->id),
        ],
        'description' => 'sometimes|string', // 'sometimes' - 仅当字段存在时才验证
        'size_km' => 'sometimes|integer|min:100',
        'solar_system' => 'sometimes|string|max:100',
        'image_url' => 'sometimes|nullable|url',
        'is_habitable' => 'sometimes|boolean'
    ]);

    $planet->update($data);
    return response()->json($planet); // 200 OK
}
```

**E. `destroy()` - 删除行星**
```php
<?php
public function destroy(Planet $planet)
{
    $planet->delete();
    return response()->json(null, 204); // 204 No Content
}
```

---

#### **4. 路由模型绑定 (Route Model Binding)**
Laravel 根据 ID 自动注入行星对象：
```php
// 在路由中: GET /planets/{planet}
// 在方法中: show(Planet $planet)
```

- 如果行星未找到 → 自动 404
- 无需手动调用 `findOrFail()` 查询

---

#### **5. 响应格式化**
**`index()` 方法的改进响应示例：**
```php
<?php
public function index()
{
    return response()->json([
        'success' => true,
        'data' => Planet::all(),
        'message' => '行星获取成功'
    ]);
}
```

**404 错误响应（自动）：**
```json
{
    "message": "No query results for model [App\\Models\\Planet] 123",
    "exception": "Symfony\\Component\\HttpKernel\\Exception\\NotFoundHttpException"
}
```

---

#### **巩固测验**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. 用于创建 API 控制器的标志：</p>
      <label><input type="radio" name="q1" value="a"> a) --api</label>
      <label><input type="radio" name="q1" value="b"> b) --resource</label>
      <label><input type="radio" name="q1" value="c"> c) --model</label>
    </div>
    <div class="question">
      <p>2. 成功创建时应返回什么状态？</p>
      <label><input type="radio" name="q2" value="a"> a) 200 OK</label>
      <label><input type="radio" name="q2" value="b"> b) 201 Created</label>
      <label><input type="radio" name="q2" value="c"> c) 204 No Content</label>
    </div>
    <div class="question">
      <p>3. 路由模型绑定允许：</p>
      <label><input type="radio" name="q3" value="a"> a) 自动根据 ID 获取对象</label>
      <label><input type="radio" name="q3" value="b"> b) 生成 HTML 表单</label>
      <label><input type="radio" name="q3" value="c"> c) 缓存请求</label>
    </div>
    <div class="question">
      <p>4. 删除行星时返回：</p>
      <label><input type="radio" name="q4" value="a"> a) 包含行星数据的 JSON</label>
      <label><input type="radio" name="q4" value="b"> b) null 和 204 状态码</label>
      <label><input type="radio" name="q4" value="c"> c) 空字符串</label>
    </div>
    <div class="question">
      <p>5. $request->validate() 用于：</p>
      <label><input type="radio" name="q5" value="a"> a) 验证输入数据</label>
      <label><input type="radio" name="q5" value="b"> b) 加密请求</label>
      <label><input type="radio" name="q5" value="c"> c) 缓存响应</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">检查</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'a', q2: 'b', q3: 'a', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>结果：</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>问题 ${question.slice(1)}: <span style="color:green;">正确！</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>问题 ${question.slice(1)}: <span style="color:red;">错误。</span> 正确答案：<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>问题 ${question.slice(1)}: <span style="color:orange;">未作答。</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>您的得分：${score} / ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**🚀 本章总结：**

您已经创建了行星系统的“控制台”！现在您的控制器能够：

- 🌌 显示行星列表（`index`）
- 🪐 创建新世界（`store`）
- 🔭 详细显示行星数据（`show`）
- 🛠️ 更新信息（`update`）
- 💥 销毁行星（`destroy`）

**剩下的就是配置路由了！** 在下一章中，我们将把控制器连接到 API 路由。

> **📌 检查：**

> 确保 `app/Http/Controllers` 中存在包含 5 个方法的 `PlanetController.php` 文件。

> **⚠️ 如果有错误：**

> - 检查模型名称：`use App\Models\Planet;`
> - 检查导入
> - 对于 PostgreSQL：确保 `Planet::all()` 返回数据
> - 如果 Tinker 出现问题：执行 `composer dump-autoload`