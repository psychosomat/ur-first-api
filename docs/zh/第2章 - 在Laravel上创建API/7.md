# **ç¬¬ 2.7 ç« ï¼šé”™è¯¯å¤„ç†**
**å­¦ä¹ æ—¶é—´ï¼š** 40 åˆ†é’Ÿ

---

#### **1. ä¸ºä»€ä¹ˆæ ‡å‡†é”™è¯¯å¾ˆç³Ÿç³•ï¼Ÿ**

å¦‚æœæ‚¨çš„ Laravel åº”ç”¨ç¨‹åºå‘ç”Ÿé”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œåœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°è®°å½•ï¼‰ï¼Œè€Œæ‚¨æ²¡æœ‰è¿›è¡Œä»»ä½•å¤„ç†ï¼Œç”¨æˆ·å°†ä¼šçœ‹åˆ°ä¸€ä¸ªåŒ…å«è°ƒè¯•ä¿¡æ¯çš„å·¨å¤§ HTML é¡µé¢ï¼Œæˆ–è€…ä¸€æ¡ä¸å…·ä¿¡æ¯é‡çš„â€œæœåŠ¡å™¨é”™è¯¯â€æ¶ˆæ¯ã€‚

å¯¹äº API æ¥è¯´ï¼Œè¿™æ˜¯ä¸€åœºç¾éš¾ã€‚æ‚¨çš„å‰ç«¯åº”ç”¨ç¨‹åºæœŸæœ›æ¥æ”¶ JSONï¼Œè€Œä¸æ˜¯ HTMLã€‚æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯æ‹¦æˆªä»»ä½•é”™è¯¯å¹¶å°†å…¶è½¬æ¢ä¸ºç»“æ„åŒ–çš„ JSON å“åº”ã€‚

---

#### **2. é”™è¯¯ä¸­å¤®è°ƒåº¦å™¨ï¼š`bootstrap/app.php`**

åœ¨æ—§ç‰ˆ Laravel ä¸­ï¼Œæœ‰ä¸€ä¸ªç¬¨é‡çš„ `App\Exceptions\Handler.php` æ–‡ä»¶ã€‚åœ¨ Laravel 11/12 ä¸­ï¼Œä¸€åˆ‡éƒ½å˜å¾—æ›´åŠ ç®€å•å’Œä¼˜é›…ã€‚é”™è¯¯ç®¡ç†ä¸­å¿ƒç°åœ¨ç›´æ¥ä½äºæ‚¨çš„åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶ä¸­ â€” `bootstrap/app.php`ã€‚

æ‰“å¼€ `bootstrap/app.php`ã€‚åœ¨æœ€åº•éƒ¨ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ª `.withExceptions(...)` å—ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„â€œä¸­å¤®è°ƒåº¦å™¨â€ã€‚

```php
<?php
// bootstrap/app.php

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {
        // ...
    })
    ->withExceptions(function (Exceptions $exceptions) {
        // <-- æˆ‘ä»¬å°†åœ¨è¿™é‡Œå·¥ä½œ
    })->create();
```

---

#### **3. å¤„ç†æœ€å¸¸è§çš„é”™è¯¯ï¼šâ€œæœªæ‰¾åˆ°â€ (404)**

API ä¸­æœ€å¸¸è§çš„é”™è¯¯æ˜¯ç”¨æˆ·è¯·æ±‚ä¸å­˜åœ¨çš„èµ„æºï¼ˆä¾‹å¦‚ï¼Œ`GET /api/planets/999`ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒLaravel ä¼šç”Ÿæˆ `ModelNotFoundException` æˆ– `NotFoundHttpException` å¼‚å¸¸ã€‚è®©æˆ‘ä»¬æ¥æ‹¦æˆªå®ƒä»¬ã€‚

å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ° `.withExceptions(...)` å†…éƒ¨ï¼š

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // å½“åœ¨æ•°æ®åº“ä¸­æ‰¾ä¸åˆ°æ¨¡å‹æ—¶ï¼Œæ‹¦æˆªå¼‚å¸¸
    $exceptions->render(function (ModelNotFoundException $e, Request $request) {
        // æ£€æŸ¥è¯·æ±‚æ˜¯å¦æ¥è‡ªæˆ‘ä»¬çš„ API
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'åœ¨æˆ‘ä»¬çš„é“¶æ²³ç³»ä¸­æœªæ‰¾åˆ°æ‰€è¯·æ±‚çš„èµ„æºã€‚'
            ], 404);
        }
    });

    // å½“è·¯ç”±æœ¬èº«æœªæ‰¾åˆ°æ—¶ï¼Œæ‹¦æˆªå¼‚å¸¸
    $exceptions->render(function (NotFoundHttpException $e, Request $request) {
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'ä¸å­˜åœ¨è¿™æ ·çš„å®‡å®™è·¯çº¿ã€‚'
            ], 404);
        }
    });

})->create();
```
**æˆ‘ä»¬åšäº†ä»€ä¹ˆï¼Ÿ**

1.  `$exceptions->render(...)` â€” æˆ‘ä»¬æ³¨å†Œäº†ä¸€ä¸ªâ€œå¤„ç†ç¨‹åºâ€ã€‚å®ƒè¡¨ç¤ºï¼šâ€œå¦‚æœå‘ç”Ÿ `ModelNotFoundException` ç±»å‹çš„å¼‚å¸¸ï¼Œåˆ™æ‰§è¡Œæ­¤ä»£ç ã€‚â€
2.  `if ($request->is('api/*'))` â€” è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„æ£€æŸ¥ã€‚å®ƒç¡®ä¿æˆ‘ä»¬æ¼‚äº®çš„ JSON å“åº”ä»…å‘é€ç»™ API è¯·æ±‚ï¼Œè€Œä¸å½±å“æ™®é€šçš„ç½‘é¡µã€‚
3.  `return response()->json(...)` â€” æˆ‘ä»¬åˆ›å»ºå¹¶è¿”å›å¸¦æœ‰ 404 ä»£ç çš„æ ‡å‡†åŒ– JSON å“åº”ã€‚

ç°åœ¨ï¼Œå¦‚æœæ‚¨è¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„æ˜Ÿçƒï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªæ•´æ´çš„ JSONï¼Œè€Œä¸æ˜¯ä¸‘é™‹çš„ HTML é¡µé¢ã€‚

---

#### **4. è‡ªå®šä¹‰å¼‚å¸¸ï¼šåˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„â€œè­¦æŠ¥ä¿¡å·â€**

æœ‰æ—¶æ ‡å‡†å¼‚å¸¸æ˜¯ä¸å¤Ÿçš„ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸šåŠ¡è§„åˆ™ï¼šâ€œä¸èƒ½åˆ é™¤â€˜åœ°çƒâ€™è¿™ä¸ªæ˜Ÿçƒâ€ã€‚å¦‚æœæœ‰äººè¯•å›¾è¿™æ ·åšï¼Œæˆ‘ä»¬å¿…é¡»è¿”å›ä¸€ä¸ªæœ‰æ„ä¹‰çš„é”™è¯¯ã€‚

**æ­¥éª¤ 1ï¼šåˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„å¼‚å¸¸ç±»**
åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œï¼š
```bash
php artisan make:exception CannotDeleteEarthException
```

**æ­¥éª¤ 2ï¼šåœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨å®ƒ**
æ‰“å¼€ `PlanetController.php` å¹¶ä¿®æ”¹ `destroy` æ–¹æ³•ï¼š

```php
<?php
// app/Http/Controllers/PlanetController.php
use App\Exceptions\CannotDeleteEarthException; // <-- å¯¼å…¥æˆ‘ä»¬çš„å¼‚å¸¸
use App\Models\Planet;

public function destroy(Planet $planet)
{
    // æˆ‘ä»¬çš„æ–°ä¸šåŠ¡è§„åˆ™
    if (strtolower($planet->name) === 'Ğ·ĞµĞ¼Ğ»Ñ') {
        throw new CannotDeleteEarthException('æ ¹æ®é“¶æ²³æ³•å…¸ï¼Œç¦æ­¢åˆ é™¤åœ°çƒã€‚');
    }

    $planet->delete();
    return response()->json(null, 204);
}
```
ç°åœ¨ï¼Œå¦‚æœæœ‰äººè¯•å›¾æ‰§è¡Œ `DELETE /api/planets/1`ï¼ˆå…¶ä¸­ 1 æ˜¯åœ°çƒçš„ IDï¼‰ï¼Œæˆ‘ä»¬çš„ä»£ç å°†æŠ›å‡º `CannotDeleteEarthException` å¼‚å¸¸ã€‚

**æ­¥éª¤ 3ï¼šæ•™ Laravel ä¼˜é›…åœ°å¤„ç†æˆ‘ä»¬çš„â€œè­¦æŠ¥â€**
å›åˆ° `bootstrap/app.php` å¹¶ä¸ºæˆ‘ä»¬çš„å¼‚å¸¸æ·»åŠ ä¸€ä¸ªæ–°çš„å¤„ç†ç¨‹åºã€‚

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // æˆ‘ä»¬çš„æ–°å¤„ç†ç¨‹åº
    $exceptions->render(function (CannotDeleteEarthException $e, Request $request) {
        return response()->json([
            'message' => 'æ“ä½œè¢«ç¦æ­¢ã€‚',
            'details' => $e->getMessage() // è·å–æˆ‘ä»¬é€šè¿‡ throw ä¼ é€’çš„æ¶ˆæ¯
        ], 403); // 403 Forbidden - â€œç¦æ­¢è®¿é—®â€
    });

    // ... (404 çš„å…¶ä»–å¤„ç†ç¨‹åº)

})->create();
```
å®Œæˆï¼æˆ‘ä»¬åˆ›å»ºäº†è‡ªå·±å‘½åçš„å¼‚å¸¸ï¼Œè¿™ä½¿å¾—æ§åˆ¶å™¨ä»£ç æ›´æ¸…æ™°ï¼Œå¹¶æ•™ä¼š Laravel å°†å…¶è½¬æ¢ä¸ºå…·æœ‰æ­£ç¡® HTTP çŠ¶æ€çš„æ¼‚äº®ã€æœ‰æ„ä¹‰çš„ JSON å“åº”ã€‚

---

#### **5. å¤„ç†æ‰€æœ‰å…¶ä»–æ•…éšœ (500 Internal Server Error)**

å¦‚ä½•å¤„ç†æ‰€æœ‰å…¶ä»–æ„å¤–é”™è¯¯ï¼Ÿä¾‹å¦‚ï¼Œå¦‚æœæ•°æ®åº“å´©æºƒæˆ–ä»£ç ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæœ€å¸¸è§çš„é”™è¯¯ç±»å‹ â€” `Throwable` â€” æ³¨å†Œä¸€ä¸ªâ€œé€šç”¨â€å¤„ç†ç¨‹åºã€‚

**é‡è¦æç¤ºï¼š** è¿™ä¸ªå¤„ç†ç¨‹åºå¿…é¡»æ˜¯**æœ€åä¸€ä¸ª**ï¼Œä»¥å…æ‹¦æˆªæˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„æ›´å…·ä½“çš„å¼‚å¸¸ã€‚

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // ... (CannotDeleteEarthException å’Œ 404 çš„å¤„ç†ç¨‹åº)

    // é€šç”¨å¤„ç†ç¨‹åºï¼ˆåœ¨æœ€æœ«å°¾ï¼‰
    $exceptions->render(function (Throwable $e, Request $request) {
        if ($request->is('api/*')) {
            // åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œå¯ä»¥æ˜¾ç¤ºçœŸå®çš„é”™è¯¯æ¶ˆæ¯
            $message = config('app.debug')
                ? 'å‘ç”Ÿé”™è¯¯ï¼š' . $e->getMessage()
                : 'èˆ¹ä¸Šå‘ç”Ÿäº†æ„å¤–é”™è¯¯ã€‚å·¥ç¨‹å¸ˆå·²è¢«å¬é›†ã€‚';

            return response()->json(['message' => $message], 500);
        }
    });

})->create();
```

ç°åœ¨ï¼Œä»»ä½•â€œæœªçŸ¥â€å¼‚å¸¸éƒ½å°†è¢«å·§å¦™åœ°æ‹¦æˆªå¹¶è½¬æ¢ä¸ºå¸¦æœ‰ 500 ä»£ç çš„ JSONï¼Œè€Œä¸ä¼šç ´åæ‚¨çš„ API æˆ–å‘ç”¨æˆ·æ˜¾ç¤ºå¤šä½™çš„ä¿¡æ¯ã€‚

---

#### **6. é”™è¯¯æ—¥å¿—è®°å½•ï¼šå®‡å®™é£èˆ¹çš„é»‘åŒ£å­**
`config/logging.php` ä¸­çš„æ—¥å¿—é…ç½®ï¼š
```php
<?php
'channels' => [
    'space_api' => [
        'driver' => 'daily',
        'path' => storage_path('logs/space_api.log'),
        'level' => 'error',
        'days' => 14,
    ],
],
```

**æ·»åŠ æ—¥å¿—è®°å½•ï¼š**
```php
<?php
try {
    // æœ‰é”™è¯¯é£é™©çš„ä»£ç 
} catch (Exception $e) {
    Log::channel('space_api')->error('è®¿é—®æ˜Ÿçƒæ—¶å‡ºé”™', [
        'exception' => $e,
        'request' => request()->all(),
        'user_id' => auth()->id()
    ]);
    throw $e;
}
```

---

#### **å·©å›ºæµ‹éªŒ**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. â€œæ˜Ÿçƒæœªæ‰¾åˆ°â€çš„ HTTP çŠ¶æ€ç ï¼š</p>
      <label><input type="radio" name="q1" value="a"> a) 400</label>
      <label><input type="radio" name="q1" value="b"> b) 404</label>
      <label><input type="radio" name="q1" value="c"> c) 500</label>
    </div>
    <div class="question">
      <p>2. ç”¨äºå…¨å±€é”™è¯¯å¤„ç†çš„ç±»ï¼š</p>
      <label><input type="radio" name="q2" value="a"> a) Handler.php</label>
      <label><input type="radio" name="q2" value="b"> b) ErrorController.php</label>
      <label><input type="radio" name="q2" value="c"> c) Middleware/Error.php</label>
    </div>
    <div class="question">
      <p>3. åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸çš„æ–¹æ³•ï¼š</p>
      <label><input type="radio" name="q3" value="a"> a) php artisan make:exception</label>
      <label><input type="radio" name="q3" value="b"> b) php artisan exception:create</label>
      <label><input type="radio" name="q3" value="c"> c) php artisan generate:exception</label>
    </div>
    <div class="question">
      <p>4. ç”¨äº API é”™è¯¯å•ç‹¬æ—¥å¿—è®°å½•çš„é€šé“ï¼š</p>
      <label><input type="radio" name="q4" value="a"> a) config/logging.php ä¸­çš„é…ç½®</label>
      <label><input type="radio" name="q4" value="b"> b) .env ä¸­çš„å‚æ•°</label>
      <label><input type="radio" name="q4" value="c"> c) æ§åˆ¶å™¨ä¸­çš„æŒ‡å®š</label>
    </div>
    <div class="question">
      <p>5. åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸çš„ä¸»è¦ä¼˜åŠ¿ï¼š</p>
      <label><input type="radio" name="q5" value="a"> a) æé«˜æ€§èƒ½</label>
      <label><input type="radio" name="q5" value="b"> b) ä¸ºç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯åˆ›å»ºè¯­ä¹‰æ¸…æ™°çš„é”™è¯¯</label>
      <label><input type="radio" name="q5" value="c"> c) è‡ªåŠ¨æ·»åŠ åˆ° .env</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">æ£€æŸ¥</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'a', q4: 'a', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>ç»“æœï¼š</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:green;">æ­£ç¡®ï¼</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:red;">é”™è¯¯ã€‚</span>æ­£ç¡®ç­”æ¡ˆï¼š<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>é—®é¢˜ ${question.slice(1)}: <span style="color:orange;">æœªä½œç­”ã€‚</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>æ‚¨çš„åˆ†æ•°ï¼š${score} / ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**ğŸš€ æœ¬ç« æ€»ç»“ï¼š**

æ‚¨ä¸ºæ‚¨çš„ API é…å¤‡äº†å¯é çš„æ•‘æ´ç³»ç»Ÿï¼š
- ğŸ›Ÿ å…¨å±€æ•è·æ ‡å‡†é”™è¯¯
- ğŸª å¸¦æœ‰å¯ç†è§£ä»£ç çš„è‡ªå®šä¹‰å¼‚å¸¸
- ğŸ“ æ‰€æœ‰é”™è¯¯ç»Ÿä¸€ä½¿ç”¨ JSON æ ¼å¼
- ğŸ” è®°å½•äº‹ä»¶è¯¦æƒ…æ—¥å¿—
- ğŸ“¡ ä¸ç›‘æ§ç³»ç»Ÿé›†æˆ

**å®‡å®™é£èˆ¹å·²å‡†å¤‡å¥½åº”å¯¹ç´§æ€¥æƒ…å†µï¼** åœ¨æœ¬ç« çš„æœ€åä¸€èŠ‚ï¼Œæˆ‘ä»¬å°†æµ‹è¯•æ‰€æœ‰ç³»ç»Ÿã€‚

> **ğŸ“Œ æ£€æŸ¥ï¼š**

> 1. åˆ›å»º `PlanetNotFoundException` å¼‚å¸¸
> 2. åœ¨ ```->withExceptions``` ä¸­æ·»åŠ  404 é”™è¯¯å¤„ç†
> 3. æµ‹è¯•å¯¹ä¸å­˜åœ¨è¡Œæ˜Ÿçš„è¯·æ±‚

> **âš ï¸ å¦‚æœé”™è¯¯æœªè¢«æ•è·ï¼š**

> - ç¡®ä¿ `is('api/*')` ä¸æ‚¨çš„è·¯ç”±åŒ¹é…
> - æ£€æŸ¥ `register()` ä¸­çš„å¤„ç†ç¨‹åºé¡ºåº
> - å¯¹äºè‡ªå®šä¹‰å¼‚å¸¸ï¼Œè¯·ä½¿ç”¨ `throw new`