# **第 2.2 章：创建 Planet 模型**
**学习时间：** 45 分钟

---

#### **1. Laravel 中的模型：宇宙对象的蓝图**
在 MVC 架构（Model-View-Controller）中，**模型** 是：

- 📦 数据的容器（行星参数）
- 🔌 数据库操作接口
- 🛡️ 应用程序业务逻辑的中心

> 💡 **宇宙类比：**
> `Planet` 模型 = 任务控制中心计算机中的行星蓝图。通过它可以：

> - 在目录中创建新行星 (`INSERT`)
> - 获取火星数据 (`SELECT`)
> - 更新大气层信息 (`UPDATE`)

---

#### **2. 创建模型和迁移**
Laravel 使用 Artisan CLI — 您的项目“控制台”。

**步骤 1：生成带迁移的模型**
```bash
php artisan make:model Planet -m
```

**已创建文件：**
```
app/
  └── Models/
      └── Planet.php    ← 模型
database/
  └── migrations/
      └── 2025_08_04_000000_create_planets_table.php  ← 迁移
```

**Artisan 标志：**

- `-m` → 创建迁移
- `-c` → 创建控制器
- `-r` → 资源控制器

> 💡 **专业提示：** 这些标志可以组合使用以获得最大效率。命令 `php artisan make:model Planet -mcr` 将立即创建模型、迁移和用于管理该模型的资源控制器。这节省了大量时间。

---

#### **3. 配置 Planet 模型**
打开 `app/Models/Planet.php`：
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Planet extends Model
{
    // 表名（默认为：'planets'）
	// Laravel 默认假定表名是模型名的小写复数形式 (Planet -> planets)。
     // 因此，此处此属性并非必需，但有助于提高可读性。
    protected $table = 'planets';

    // 允许批量赋值的字段
    protected $fillable = [
        'name',
        'description',
        'size_km',
        'solar_system',
        'image_url'
    ];

    // 自动类型转换
    protected $casts = [
        'size_km' => 'integer'
    ];
}
```

**属性说明：**

| 属性         | 值                         | 数据示例              |
|------------------|----------------------------------|----------------------------|
| `$table`         | 数据库中的表名                 | `planets`                  |
| `$fillable`      | 允许批量赋值的字段    | `name`, `size_km`          |
| `$casts`         | 自动类型转换 | `size_km: integer`       |

---

#### **4. 行星表设计**
在编辑迁移文件之前，我们先定义“行星”的结构：

| 字段             | 数据类型       | 描述                     | 示例值       |
|------------------|------------------|------------------------------|-----------------------|
| `id`             | BIGINT (PK)      | 唯一 ID                | 1                     |
| `name`           | VARCHAR(255)     | 行星名称             | "火星"                |
| `description`    | TEXT             | 描述                     | "红色行星..."  |
| `size_km`        | INTEGER          | 直径（公里）                 | 6779                  |
| `solar_system`   | VARCHAR(100)     | 太阳系            | "太阳系"   |
| `image_url`      | VARCHAR(2048)    | 图片 URL（可为空）   | "https://..."         |
| `created_at`     | TIMESTAMP        | 创建日期                | 2025-08-04 12:00:00   |
| `updated_at`     | TIMESTAMP        | 更新日期              | 2025-08-05 09:30:00   |

---

#### **5. 编辑迁移文件**
打开 `database/migrations/..._create_planets_table.php` 中的迁移文件：

```php
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreatePlanetsTable extends Migration
{
    public function up()
    {
        Schema::create('planets', function (Blueprint $table) {
            $table->id(); // BIGINT 自增

            $table->string('name')->unique();
            $table->text('description');
            $table->integer('size_km');
            $table->string('solar_system', 100);
            $table->string('image_url', 2048)->nullable();

            $table->timestamps(); // created_at + updated_at
        });
    }

    public function down()
    {
        Schema::dropIfExists('planets');
    }
}
```

**要点：**

- `->unique()` → 确保名称的唯一性
- `->nullable()` → 字段可以为空
- `timestamps()` → 自动管理日期时间

---

#### **6. 运行迁移（预览）**
虽然迁移将在第 2.3 章中运行，但我们先看看它会是什么样子：
```bash
php artisan migrate
```

**预期输出：**
```
Migrating: 2025_08_04_000000_create_planets_table
Migrated:  2025_08_04_000000_create_planets_table (32.15ms)
```

**在 pgAdmin 4 中检查：**

1. 打开 `space_api` 数据库 → Schemas → Tables
2. 应该会出现 `planets` 表和您的字段

---

#### **7. 替代方法：代码生成器**
为了加速开发，可以使用以下包：

- **Laravel Blueprint** - 根据 YAML 描述创建模型/迁移
- **InfyOm Laravel Generator** - 基于数据库 schema 的生成器

**Blueprint 示例：**
```yaml
models:
  Planet:
    name: string:255
    description: text
    size_km: integer
    solar_system: string:100
    image_url: string:2048? # '?' 符号表示字段可为空
```

---

#### **巩固测验**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. 用于创建模型及其相关迁移的 Artisan 命令：</p>
      <label><input type="radio" name="q1" value="a"> a) php artisan make:model Planet -m</label>
      <label><input type="radio" name="q1" value="b"> b) php artisan create:model Planet</label>
      <label><input type="radio" name="q1" value="c"> c) php artisan model:new Planet --m</label>
    </div>
    <div class="question">
      <p>2. 模型中的 `$fillable` 属性用于</p>
      <label><input type="radio" name="q2" value="a"> a) 防止批量赋值</label>
      <label><input type="radio" name="q2" value="b"> b) 自动加密数据</label>
      <label><input type="radio" name="q2" value="c"> c) 描述外键</label>
    </div>
    <div class="question">
      <p>3. 迁移中的 `nullable()` 意味着：</p>
      <label><input type="radio" name="q3" value="a"> a) 字段必须填写</label>
      <label><input type="radio" name="q3" value="b"> b) 字段可以为空</label>
      <label><input type="radio" name="q3" value="c"> c) 字段将被删除</label>
    </div>
    <div class="question">
      <p>4. 用于行星长描述的字段类型：</p>
      <label><input type="radio" name="q4" value="a"> a) string</label>
      <label><input type="radio" name="q4" value="b"> b) text</label>
      <label><input type="radio" name="q4" value="c"> c) varchar</label>
    </div>
    <div class="question">
      <p>5. `timestamps()` 方法创建：</p>
      <label><input type="radio" name="q5" value="a"> a) 仅 created_at</label>
      <label><input type="radio" name="q5" value="b"> b) created_at 和 updated_at</label>
      <label><input type="radio" name="q5" value="c"> c) id, created_at, updated_at</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">检查</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'a', q2: 'a', q3: 'b', q4: 'b', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>结果：</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>问题 ${question.slice(1)}: <span style="color:green;">正确！</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>问题 ${question.slice(1)}: <span style="color:red;">错误。</span> 正确答案：<b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>问题 ${question.slice(1)}: <span style="color:orange;">无答案。</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>您的得分：${score} / ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**🚀 本章总结：**
您已经创建了行星的“数字孪生”！现在您的项目拥有：

- 🪐 包含业务逻辑的 `Planet` 模型
- 📊 用于 PostgreSQL 中 `planets` 表的迁移
- 🛠️ 配置好的模型属性（`fillable`、`casts`）

**准备好数据库！** 在下一章中，我们将运行迁移并用第一批行星填充宇宙。

> **📌 检查：**

> 确保 `Planet.php` 和 `..._create_planets_table.php` 文件已在正确的目录中创建。

> **⚠️ 如果 Artisan 报错：**

> - 检查您是否在项目文件夹中
> - 确保已安装依赖项（`composer install`）
> - 对于 Windows：将 PHP 和 Composer 添加到 PATH