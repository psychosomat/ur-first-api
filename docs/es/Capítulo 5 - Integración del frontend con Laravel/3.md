# **Cap√≠tulo 5.3: Incrustaci√≥n de JavaScript en Vistas de Laravel**
**Tiempo de estudio:** 50 minutos

---

### **1. Dos enfoques de JavaScript en la web**
Hasta ahora hemos trabajado con **Server-Side Rendering (SSR)** ‚Äî el servidor (Laravel) generaba el HTML listo (a trav√©s de Blade) y lo enviaba al navegador. Esto es excelente para el SEO y una carga inicial r√°pida.

Ahora a√±adiremos **Client-Side Interactions** ‚Äî el navegador, una vez cargada la p√°gina, ejecutar√° c√≥digo JavaScript para:

-   Enviar solicitudes a nuestra API sin recargar la p√°gina.
-   Actualizar din√°micamente partes de la p√°gina (por ejemplo, a√±adir un nuevo planeta a la lista).
-   Mostrar notificaciones y ventanas modales.

> üí° **Analog√≠a espacial:**

> Imagine que **SSR** es recibir un mapa completo de un sistema estelar, impreso en el Centro de Control de Misiones (servidor). Usted ve todos los objetos en el momento de la impresi√≥n.

> **Client-Side JS** es su tableta personal (navegador), que se comunica en tiempo real con los sat√©lites (API) y actualiza la posici√≥n de los objetos en su mapa, sin solicitar un nuevo mapa de papel del Centro de Control de Misiones.

---

### **2. D√≥nde almacenar y c√≥mo incluir c√≥digo JS**
Como ya hemos descubierto, todos los recursos p√∫blicos (CSS, JS, im√°genes) deben ubicarse en la carpeta `public`.

**Estructura correcta:**

1.  **Archivos fuente:** Todo su c√≥digo JS principal debe estar en `public/js/`. Por ejemplo, `public/js/planets.js`.
2.  **Inclusi√≥n en Blade:** Utilice el ayudante `asset()` para generar la URL correcta.

**Ejemplo de inclusi√≥n en la plantilla `layouts/app.blade.php`:**
```blade
<!DOCTYPE html>
<html>
<head>
    {{-- ... --}}
</head>
<body>
    {{-- ... header y main ... --}}

    <footer>
        <p>&copy; {{ date('Y') }} Space Command.</p>
    </footer>

    {{-- Es mejor incluir los scripts al final del body para acelerar el renderizado de la p√°gina --}}
    <script src="{{ asset('js/planets.js') }}"></script>
    @stack('scripts') {{-- Creamos un "slot" para scripts de una p√°gina espec√≠fica --}}
</body>
</html>
```

-   `@stack('scripts')` ‚Äî esta es una potente directiva de Blade. Permite a las vistas hijas "empujar" su propio c√≥digo JS a esta ubicaci√≥n. Esto es √∫til cuando una p√°gina necesita un script √∫nico, y otra no.

---

### **3. Ejemplo: Bot√≥n "Eliminar" con confirmaci√≥n**
Vamos a a√±adir un bot√≥n "Eliminar" a la p√°gina de la lista de planetas (`planets/index.blade.php`) para cada planeta, que funcionar√° a trav√©s de JavaScript y la API Fetch.

**Paso 1: A√±adir el bot√≥n en `resources/views/planets/index.blade.php`**

Modifique la tarjeta del planeta, a√±adiendo un bot√≥n con atributos de datos:
```html
{{-- ... dentro del bucle @forelse ... --}}
<div class="planet-card" id="planet-card-{{ $planet->id }}">
    <h3>{{ $planet->name }}</h3>
    <p>Sistema solar: {{ $planet->solar_system }}</p>
    <p>Di√°metro: {{ number_format($planet->size_km, 0, '.', ' ') }} km</p>
    <a href="/planets/{{ $planet->id }}">Saber m√°s &rarr;</a>
    <button class="delete-btn" data-id="{{ $planet->id }}" data-url="/api/planets/{{ $planet->id }}">
        Dar de baja
    </button>
</div>
<!-- ... Antes de la etiqueta de cierre del body ... -->
<script src="{{ asset('js/planets.js') }}" defer></script>
```

-   `id="planet-card-{{ $planet->id }}"` ‚Äî un ID √∫nico para toda la tarjeta, para que podamos eliminarla del DOM.
-   `data-id` y `data-url` ‚Äî una forma conveniente de pasar datos de PHP (Blade) a JavaScript.

**Paso 2: Escribir la l√≥gica JavaScript**

Cree el archivo `public/js/planets.js` y a√±ada el siguiente c√≥digo:
```javascript
document.addEventListener('DOMContentLoaded', () => {
    // Encontrar todos los botones "Eliminar"
    const deleteButtons = document.querySelectorAll('.delete-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async (event) => {
            const planetId = event.target.dataset.id;
            const apiUrl = event.target.dataset.url;

            if (!confirm(`¬øEst√° seguro de que desea dar de baja el planeta con ID ${planetId}? Esta acci√≥n es irreversible.`)) {
                return; // El usuario hizo clic en "Cancelar"
            }

            try {
                // Enviar una solicitud DELETE a nuestra API
                const response = await fetch(apiUrl, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        // M√°s tarde a√±adiremos el token CSRF aqu√≠
                    }
                });

                if (response.status === 204) { // 204 No Content - eliminaci√≥n exitosa
                    // Eliminar la tarjeta del planeta de la p√°gina
                    const cardToRemove = document.getElementById(`planet-card-${planetId}`);
                    if (cardToRemove) {
                        cardToRemove.remove();
                    }
                    alert('El planeta ha sido dado de baja exitosamente.');
                } else {
                    // Si la API devolvi√≥ un error
                    const errorData = await response.json();
                    alert(`Error: ${errorData.message || 'No se pudo eliminar el planeta.'}`);
                }
            } catch (error) {
                console.error('Error al enviar la solicitud:', error);
                alert('Ocurri√≥ un error de red. Int√©ntelo de nuevo.');
            }
        });
    });
});
```

Ahora, si actualiza la p√°gina `/planets`, aparecer√°n los botones de "Dar de baja", y al hacer clic en ellos se activar√° nuestro c√≥digo JavaScript!

---

### **4. Pasar datos de Blade a JavaScript**
A veces es necesario pasar a JS no solo una cadena, sino un array o un objeto completo.

**Forma incorrecta (vulnerable):**
```javascript
let planets = {{ $planets }}; // Esto causar√° un error de sintaxis y es inseguro
```

**Forma correcta (a trav√©s de JSON):**
Utilice la directiva `@json`. Transforma de forma segura un array/objeto PHP en un objeto JSON v√°lido.

**Ejemplo en `planets/index.blade.php`:**
```blade
@extends('layouts.app')
{{-- ... --}}
@section('content')
    {{-- ... --}}
@endsection

@push('scripts') {{-- "Empujamos" nuestro script al slot @stack('scripts') en la plantilla --}}
<script>
    // Laravel convierte de forma segura la colecci√≥n $planets en un array JSON
    const planetsData = @json($planets);

    // Ahora podemos trabajar con este array en JS
    console.log('Datos de los planetas, pasados desde Blade:', planetsData);
    alert(`¬°Se han cargado ${planetsData.length} planetas!`);
</script>
@endpush
```

-   `@push('scripts')` coloca el contenido dentro de `@stack('scripts')` en `layouts/app.blade.php`. Esto permite a√±adir scripts solo a las p√°ginas donde realmente se necesitan.

---

### **Cuestionario de refuerzo**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. ¬øD√≥nde deben almacenarse los archivos JS y CSS p√∫blicos en un proyecto Laravel?</p>
      <label><input type="radio" name="q1" value="a"> a) resources/js</label>
      <label><input type="radio" name="q1" value="b"> b) storage/app/public</label>
      <label><input type="radio" name="q1" value="c"> c) public/</label>
    </div>
    <div class="question">
      <p>2. ¬øQu√© ayudante de Blade se utiliza para generar correctamente la URL de los recursos (JS, CSS)?</p>
      <label><input type="radio" name="q2" value="a"> a) url()</label>
      <label><input type="radio" name="q2" value="b"> b) asset()</label>
      <label><input type="radio" name="q2" value="c"> c) public_path()</label>
    </div>
    <div class="question">
      <p>3. ¬øQu√© hace el par de directivas `@push('scripts')` / `@stack('scripts')`?</p>
      <label><input type="radio" name="q3" value="a"> a) Permite que una vista hija a√±ada su propio c√≥digo JS en un lugar espec√≠fico de la plantilla padre</label>
      <label><input type="radio" name="q3" value="b"> b) Combina todos los archivos JS en uno</label>
      <label><input type="radio" name="q3" value="c"> c) Env√≠a el c√≥digo JS al servidor</label>
    </div>
    <div class="question">
      <p>4. ¬øC√≥mo se pasa de forma segura un array PHP `$data` a JavaScript desde Blade?</p>
      <label><input type="radio" name="q4" value="a"> a) let jsData = {{ $data }};</label>
      <label><input type="radio" name="q4" value="b"> b) let jsData = '@php echo json_encode($data); @endphp';</label>
      <label><input type="radio" name="q4" value="c"> c) let jsData = @json($data);</label>
    </div>
    <div class="question">
      <p>5. ¬øPor qu√© se recomienda incluir los scripts JS al final de la etiqueta body?</p>
      <label><input type="radio" name="q5" value="a"> a) Para que no bloqueen el renderizado del contenido HTML principal de la p√°gina</label>
      <label><input type="radio" name="q5" value="b"> b) Es un requisito del est√°ndar HTML5</label>
      <label><input type="radio" name="q5" value="c"> c) As√≠ los scripts se ejecutan m√°s r√°pido</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'a', q4: 'c', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';
for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumen del cap√≠tulo:**

Has aprendido a dar vida a las p√°ginas est√°ticas de Blade, a√±adiendo l√≥gica del lado del cliente. Habilidades clave:

-   Organizaci√≥n y conexi√≥n correctas de archivos JS en un proyecto Laravel.
-   Uso de atributos `data-*` para pasar datos de HTML a JS.
-   Interacci√≥n din√°mica con la API usando Fetch sin recargar la p√°gina.
-   Paso seguro de variables PHP a JavaScript usando la directiva `@json`.
-   Organizaci√≥n de scripts usando `@push` y `@stack`.

**Tus "paneles de control" se han vuelto interactivos.** Sin embargo, nuestras solicitudes de modificaci√≥n (POST, PUT, DELETE) son actualmente vulnerables. En el pr√≥ximo cap√≠tulo a√±adiremos un mecanismo de protecci√≥n crucial: los tokens CSRF.
