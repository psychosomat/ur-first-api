# **Cap√≠tulo 5.5: Enrutamiento para p√°ginas web**
**Tiempo de estudio:** 40 minutos

---

### **1. `routes/web.php` vs `routes/api.php`: Dos paneles de control diferentes**

Es importante consolidar una vez m√°s la diferencia fundamental:

| Caracter√≠stica          | `routes/web.php` (Panel web)                               | `routes/api.php` (Panel API)                                  |
| ----------------------- | ---------------------------------------------------------- | ------------------------------------------------------------- |
| **Tarea principal**     | Visualizaci√≥n de p√°ginas HTML, procesamiento de formularios                   | Provisi√≥n de datos en formato JSON para otras aplicaciones     |
| **Estado**   | **Stateful** (con estado) ‚Äî utiliza sesiones y cookies | **Stateless** (sin estado) ‚Äî cada solicitud es independiente        |
| **Middleware predeterminado** | `web` (incluye sesiones, protecci√≥n CSRF, cifrado de cookies) | `api` (incluye "throttling" ‚Äî limitaci√≥n de la frecuencia de solicitudes) |
| **Prefijo de URL**         | No (ra√≠z de su sitio)                                  | `/api/` (configurable en `RouteServiceProvider`)              |
| **Autenticaci√≥n**      | Normalmente a trav√©s de sesiones (Login/Contrase√±a)                       | Normalmente a trav√©s de tokens (Sanctum, Passport)                        |

Trabajamos con `routes/web.php` para construir una interfaz para un ser humano.

---

### **2. Rutas de recursos para la web**

Similar a `Route::apiResource`, para la web existe `Route::resource`. Crea rutas para el ciclo CRUD completo, incluyendo p√°ginas para mostrar formularios de creaci√≥n y edici√≥n.

Creemos un conjunto completo de rutas para gestionar nuestras planetas a trav√©s de la interfaz web.

**Paso 1: Creamos la ruta en `routes/web.php`**

Comente o elimine las rutas antiguas para `/planets` y reempl√°celas con una sola l√≠nea:

```php
use App\Http\Controllers\Web\PlanetPageController;

// Route::get('/planets', [PlanetPageController::class, 'index']);
// Route::get('/planets/{planet}', [PlanetPageController::class, 'show']);

Route::resource('planets', PlanetPageController::class);
```

**Paso 2: Veamos qu√© se cre√≥**
Ejecute en la terminal el comando `php artisan route:list --except-vendor`:

```
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
| Method | URI       | Name                   | Action           | Middleware                                      |
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
| GET|HEAD | planets                | planets.index          | ...\PlanetPageController@index                    | web        |
| POST   | planets                | planets.store          | ...\PlanetPageController@store                    | web        |
| GET|HEAD | planets/create         | planets.create         | ...\PlanetPageController@create                   | web        |
| GET|HEAD | planets/{planet}       | planets.show           | ...\PlanetPageController@show                     | web        |
| PUT|PATCH | planets/{planet}       | planets.update         | ...\PlanetPageController@update                   | web        |
| DELETE | planets/{planet}       | planets.destroy        | ...\PlanetPageController@destroy                  | web        |
| GET|HEAD | planets/{planet}/edit  | planets.edit           | ...\PlanetPageController@edit                     | web        |
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
```

`Route::resource` cre√≥ para nosotros 7 rutas, incluyendo:

-   `planets.create` (GET `/planets/create`): p√°gina con el formulario de creaci√≥n.
-   `planets.store` (POST `/planets`): procesamiento de este formulario.
-   `planets.edit` (GET `/planets/{planet}/edit`): p√°gina con el formulario de edici√≥n.
-   `planets.update` (PUT/PATCH `/planets/{planet}`): procesamiento del formulario de edici√≥n.
-   `planets.destroy` (DELETE `/planets/{planet}`): eliminaci√≥n del recurso.

---

### **3. Rutas con nombre: Convenientes "coordenadas c√≥smicas"**
Preste atenci√≥n a la columna `Name`. Laravel asign√≥ autom√°ticamente un nombre √∫nico a cada ruta (por ejemplo, `planets.index`). Usar nombres en lugar de URL codificadas es una **mejor pr√°ctica**.

**¬øPor qu√©?** Si decide cambiar la URL de `/planets` a `/worlds`, no tendr√° que buscar y cambiar todos los enlaces en sus plantillas. Simplemente lo cambia en un solo lugar ‚Äî en el archivo de rutas, y los nombres permanecen iguales.

**Ejemplo de uso en Blade:**

Antes escrib√≠amos as√≠:

```blade
<a href="/planets/{{ $planet->id }}">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ &rarr;</a>
```

Ahora escribiremos as√≠, usando el helper `route()`:
```blade
<a href="{{ route('planets.show', ['planet' => $planet->id]) }}">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ &rarr;</a>
```

-   `route('planets.show', ...)` ‚Äî genera la URL para la ruta con el nombre `planets.show`.
-   `['planet' => $planet->id]` ‚Äî pasa los par√°metros necesarios a la URL. Laravel mismo sustituir√° el ID en `{planet}`. Incluso se puede pasar el modelo completo: `['planet' => $planet]`.

---

### **4. Implementaci√≥n de los m√©todos faltantes en el controlador**
`Route::resource` cre√≥ las rutas, pero necesitamos crear nosotros mismos los m√©todos correspondientes en `PlanetPageController`.

Abra `app/Http/Controllers/Web/PlanetPageController.php` y agregu√©moslos.

```php
<?php
use Illuminate\Http\Request; // <-- A√±adir

class PlanetPageController extends Controller
{
    // Ya tenemos index() y show()

    /**
     * Muestra el formulario para crear un nuevo planeta.
     */
    public function create()
    {
        return view('planets.create'); // Simplemente retornamos la vista con el formulario
    }

    /**
     * Guarda un nuevo planeta en la base de datos.
     */
    public function store(Request $request)
    {
        // Validaci√≥n de los datos del formulario
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:planets',
            'solar_system' => 'required|string|max:100',
            // ... otras reglas
        ]);

        Planet::create($validated);

        // Redirigimos al usuario a la p√°gina de la lista con un mensaje de √©xito
        return redirect()->route('planets.index')->with('success', '¬°Planeta creado exitosamente!');
    }

    /**
     * Muestra el formulario para editar un planeta.
     */
    public function edit(Planet $planet)
    {
        return view('planets.edit', ['planet' => $planet]);
    }

    /**
     * Actualiza los datos de un planeta en la base de datos.
     */
    public function update(Request $request, Planet $planet)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:planets,name,' . $planet->id,
            'solar_system' => 'required|string|max:100',
        ]);

        $planet->update($validated);

        return redirect()->route('planets.show', $planet)->with('success', '¬°Datos del planeta actualizados!');
    }

    /**
     * Elimina un planeta.
     */
    public function destroy(Planet $planet)
    {
        $planet->delete();

        return redirect()->route('planets.index')->with('success', 'Planeta dado de baja.');
    }
}
```

-   `redirect()->route(...)` ‚Äî redirige al usuario a otra ruta con nombre.
-   `->with('success', '...')` ‚Äî a√±ade un "mensaje flash" a la sesi√≥n, que estar√° disponible en la siguiente p√°gina exactamente una vez. Podemos mostrarlo en nuestra plantilla Blade.

---

### **5. Agrupaci√≥n de rutas**
Si tiene muchas rutas con caracter√≠sticas comunes (por ejemplo, todas son para el panel de administraci√≥n y deben tener el prefijo `/admin` y un middleware especial), pueden agruparse.

```php
<?php
Route::middleware(['auth', 'admin'])->prefix('admin')->name('admin.')->group(function () {
    // Todas las rutas dentro de este grupo tendr√°n:
    // 1. Middleware 'auth' y 'admin'
    // 2. Prefijo de URL '/admin' (por ejemplo, /admin/planets)
    // 3. Prefijo de nombre 'admin.' (por ejemplo, admin.planets.index)

    Route::resource('planets', PlanetPageController::class);
    // Route::get('/dashboard', ...)->name('dashboard'); // -> admin.dashboard
});
```

---

### **Cuestionario para afianzar conocimientos**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. ¬øQu√© comando en `routes/web.php` crear√° un conjunto completo de rutas CRUD para la interfaz web?</p>
      <label><input type="radio" name="q1" value="a"> a) Route::crud('planets', Controller::class)</label>
      <label><input type="radio" name="q1" value="b"> b) Route::apiResource('planets', Controller::class)</label>
      <label><input type="radio" name="q1" value="c"> c) Route::resource('planets', Controller::class)</label>
    </div>
    <div class="question">
      <p>2. ¬øCu√°l es la principal ventaja de usar rutas nombradas?</p>
      <label><input type="radio" name="q2" value="a"> a) Funcionan m√°s r√°pido que las URL directas</label>
      <label><input type="radio" name="q2" value="b"> b) Permiten cambiar f√°cilmente las URL en el archivo de rutas sin romper los enlaces en las plantillas</label>
      <label><input type="radio" name="q2" value="c"> c) Est√°n autom√°ticamente protegidos contra CSRF</label>
    </div>
    <div class="question">
      <p>3. ¬øQu√© ruta se generar√° para el m√©todo `create()` en `Route::resource('articles', ...)`?</p>
      <label><input type="radio" name="q3" value="a"> a) GET `/articles/new`</label>
      <label><input type="radio" name="q3" value="b"> b) GET `/articles/create`</label>
      <label><input type="radio" name="q3" value="c"> c) POST `/articles/create`</label>
    </div>
    <div class="question">
      <p>4. ¬øQu√© hace el c√≥digo `redirect()->route('home')->with('status', 'OK')`?</p>
      <label><input type="radio" name="q4" value="a"> a) Devuelve JSON con 'status' => 'OK' a la URL `/home`</label>
      <label><input type="radio" name="q4" value="b"> b) Redirige a la ruta nombrada `home` y a√±ade un mensaje temporal 'status' a la sesi√≥n</label>
      <label><input type="radio" name="q4" value="c"> c) Muestra la vista `home.blade.php` con la variable `$status`</label>
    </div>
    <div class="question">
      <p>5. ¬øPara qu√© se usa `Route::prefix('dashboard')`?</p>
      <label><input type="radio" name="q5" value="a"> a) Para a√±adir un prefijo a todas las URL dentro del grupo</label>
      <label><input type="radio" name="q5" value="b"> b) Para a√±adir un prefijo a todos los nombres de las rutas dentro del grupo</label>
      <label><input type="radio" name="q5" value="c"> c) Para aplicar el middleware `dashboard`</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

**üöÄ Resumen del cap√≠tulo:**

Has dominado un enfoque estructurado y profesional para la organizaci√≥n de rutas web en Laravel. Ahora sabes c√≥mo:

-   Distinguir las rutas `web` y `api` y su prop√≥sito.
-   Usar `Route::resource` para generar r√°pidamente rutas CRUD est√°ndar.
-   Aplicar rutas nombradas para crear c√≥digo flexible y mantenible.
-   Crear operaciones CRUD completas en el controlador con validaci√≥n y redirecciones.
-   Agrupar rutas para aplicar reglas comunes.

**El sistema de navegaci√≥n de su "nave" ahora es tolerante a fallos y est√° listo para expandirse.** En el cap√≠tulo final de esta secci√≥n, combinaremos todo el conocimiento adquirido y mostraremos los datos de los planetas, obtenidos a trav√©s de Fetch, en nuestra p√°gina Blade.
