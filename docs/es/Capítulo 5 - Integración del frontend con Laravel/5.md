# **Capítulo 5.5: Enrutamiento para páginas web**
**Tiempo de estudio:** 40 minutos

---

### **1. `routes/web.php` vs `routes/api.php`: Dos paneles de control diferentes**

Es importante consolidar una vez más la diferencia fundamental:

| Característica          | `routes/web.php` (Panel web)                               | `routes/api.php` (Panel API)                                  |
| ----------------------- | ---------------------------------------------------------- | ------------------------------------------------------------- |
| **Tarea principal**     | Visualización de páginas HTML, procesamiento de formularios                   | Provisión de datos en formato JSON para otras aplicaciones     |
| **Estado**   | **Stateful** (con estado) — utiliza sesiones y cookies | **Stateless** (sin estado) — cada solicitud es independiente        |
| **Middleware predeterminado** | `web` (incluye sesiones, protección CSRF, cifrado de cookies) | `api` (incluye "throttling" — limitación de la frecuencia de solicitudes) |
| **Prefijo de URL**         | No (raíz de su sitio)                                  | `/api/` (configurable en `RouteServiceProvider`)              |
| **Autenticación**      | Normalmente a través de sesiones (Login/Contraseña)                       | Normalmente a través de tokens (Sanctum, Passport)                        |

Trabajamos con `routes/web.php` para construir una interfaz para un ser humano.

---

### **2. Rutas de recursos para la web**

Similar a `Route::apiResource`, para la web existe `Route::resource`. Crea rutas para el ciclo CRUD completo, incluyendo páginas para mostrar formularios de creación y edición.

Creemos un conjunto completo de rutas para gestionar nuestras planetas a través de la interfaz web.

**Paso 1: Creamos la ruta en `routes/web.php`**

Comente o elimine las rutas antiguas para `/planets` y reemplácelas con una sola línea:

```php
use App\Http\Controllers\Web\PlanetPageController;

// Route::get('/planets', [PlanetPageController::class, 'index']);
// Route::get('/planets/{planet}', [PlanetPageController::class, 'show']);

Route::resource('planets', PlanetPageController::class);
```

**Paso 2: Veamos qué se creó**
Ejecute en la terminal el comando `php artisan route:list --except-vendor`:

```
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
| Method | URI       | Name                   | Action           | Middleware                                      |
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
| GET|HEAD | planets                | planets.index          | ...\PlanetPageController@index                    | web        |
| POST   | planets                | planets.store          | ...\PlanetPageController@store                    | web        |
| GET|HEAD | planets/create         | planets.create         | ...\PlanetPageController@create                   | web        |
| GET|HEAD | planets/{planet}       | planets.show           | ...\PlanetPageController@show                     | web        |
| PUT|PATCH | planets/{planet}       | planets.update         | ...\PlanetPageController@update                   | web        |
| DELETE | planets/{planet}       | planets.destroy        | ...\PlanetPageController@destroy                  | web        |
| GET|HEAD | planets/{planet}/edit  | planets.edit           | ...\PlanetPageController@edit                     | web        |
+--------+-----------+------------------------+------------------+-------------------------------------------------+------------+
```

`Route::resource` creó para nosotros 7 rutas, incluyendo:

-   `planets.create` (GET `/planets/create`): página con el formulario de creación.
-   `planets.store` (POST `/planets`): procesamiento de este formulario.
-   `planets.edit` (GET `/planets/{planet}/edit`): página con el formulario de edición.
-   `planets.update` (PUT/PATCH `/planets/{planet}`): procesamiento del formulario de edición.
-   `planets.destroy` (DELETE `/planets/{planet}`): eliminación del recurso.

---

### **3. Rutas con nombre: Convenientes "coordenadas cósmicas"**
Preste atención a la columna `Name`. Laravel asignó automáticamente un nombre único a cada ruta (por ejemplo, `planets.index`). Usar nombres en lugar de URL codificadas es una **mejor práctica**.

**¿Por qué?** Si decide cambiar la URL de `/planets` a `/worlds`, no tendrá que buscar y cambiar todos los enlaces en sus plantillas. Simplemente lo cambia en un solo lugar — en el archivo de rutas, y los nombres permanecen iguales.

**Ejemplo de uso en Blade:**

Antes escribíamos así:

```blade
<a href="/planets/{{ $planet->id }}">Узнать больше &rarr;</a>
```

Ahora escribiremos así, usando el helper `route()`:
```blade
<a href="{{ route('planets.show', ['planet' => $planet->id]) }}">Узнать больше &rarr;</a>
```

-   `route('planets.show', ...)` — genera la URL para la ruta con el nombre `planets.show`.
-   `['planet' => $planet->id]` — pasa los parámetros necesarios a la URL. Laravel mismo sustituirá el ID en `{planet}`. Incluso se puede pasar el modelo completo: `['planet' => $planet]`.

---

### **4. Implementación de los métodos faltantes en el controlador**
`Route::resource` creó las rutas, pero necesitamos crear nosotros mismos los métodos correspondientes en `PlanetPageController`.

Abra `app/Http/Controllers/Web/PlanetPageController.php` y agreguémoslos.

```php
<?php
use Illuminate\Http\Request; // <-- Añadir

class PlanetPageController extends Controller
{
    // Ya tenemos index() y show()

    /**
     * Muestra el formulario para crear un nuevo planeta.
     */
    public function create()
    {
        return view('planets.create'); // Simplemente retornamos la vista con el formulario
    }

    /**
     * Guarda un nuevo planeta en la base de datos.
     */
    public function store(Request $request)
    {
        // Validación de los datos del formulario
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:planets',
            'solar_system' => 'required|string|max:100',
            // ... otras reglas
        ]);

        Planet::create($validated);

        // Redirigimos al usuario a la página de la lista con un mensaje de éxito
        return redirect()->route('planets.index')->with('success', '¡Planeta creado exitosamente!');
    }

    /**
     * Muestra el formulario para editar un planeta.
     */
    public function edit(Planet $planet)
    {
        return view('planets.edit', ['planet' => $planet]);
    }

    /**
     * Actualiza los datos de un planeta en la base de datos.
     */
    public function update(Request $request, Planet $planet)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:planets,name,' . $planet->id,
            'solar_system' => 'required|string|max:100',
        ]);

        $planet->update($validated);

        return redirect()->route('planets.show', $planet)->with('success', '¡Datos del planeta actualizados!');
    }

    /**
     * Elimina un planeta.
     */
    public function destroy(Planet $planet)
    {
        $planet->delete();

        return redirect()->route('planets.index')->with('success', 'Planeta dado de baja.');
    }
}
```

-   `redirect()->route(...)` — redirige al usuario a otra ruta con nombre.
-   `->with('success', '...')` — añade un "mensaje flash" a la sesión, que estará disponible en la siguiente página exactamente una vez. Podemos mostrarlo en nuestra plantilla Blade.

---

### **5. Agrupación de rutas**
Si tiene muchas rutas con características comunes (por ejemplo, todas son para el panel de administración y deben tener el prefijo `/admin` y un middleware especial), pueden agruparse.

```php
<?php
Route::middleware(['auth', 'admin'])->prefix('admin')->name('admin.')->group(function () {
    // Todas las rutas dentro de este grupo tendrán:
    // 1. Middleware 'auth' y 'admin'
    // 2. Prefijo de URL '/admin' (por ejemplo, /admin/planets)
    // 3. Prefijo de nombre 'admin.' (por ejemplo, admin.planets.index)

    Route::resource('planets', PlanetPageController::class);
    // Route::get('/dashboard', ...)->name('dashboard'); // -> admin.dashboard
});
```

---

### **Cuestionario para afianzar conocimientos**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. ¿Qué comando en `routes/web.php` creará un conjunto completo de rutas CRUD para la interfaz web?</p>
      <label><input type="radio" name="q1" value="a"> a) Route::crud('planets', Controller::class)</label>
      <label><input type="radio" name="q1" value="b"> b) Route::apiResource('planets', Controller::class)</label>
      <label><input type="radio" name="q1" value="c"> c) Route::resource('planets', Controller::class)</label>
    </div>
    <div class="question">
      <p>2. ¿Cuál es la principal ventaja de usar rutas nombradas?</p>
      <label><input type="radio" name="q2" value="a"> a) Funcionan más rápido que las URL directas</label>
      <label><input type="radio" name="q2" value="b"> b) Permiten cambiar fácilmente las URL en el archivo de rutas sin romper los enlaces en las plantillas</label>
      <label><input type="radio" name="q2" value="c"> c) Están automáticamente protegidos contra CSRF</label>
    </div>
    <div class="question">
      <p>3. ¿Qué ruta se generará para el método `create()` en `Route::resource('articles', ...)`?</p>
      <label><input type="radio" name="q3" value="a"> a) GET `/articles/new`</label>
      <label><input type="radio" name="q3" value="b"> b) GET `/articles/create`</label>
      <label><input type="radio" name="q3" value="c"> c) POST `/articles/create`</label>
    </div>
    <div class="question">
      <p>4. ¿Qué hace el código `redirect()->route('home')->with('status', 'OK')`?</p>
      <label><input type="radio" name="q4" value="a"> a) Devuelve JSON con 'status' => 'OK' a la URL `/home`</label>
      <label><input type="radio" name="q4" value="b"> b) Redirige a la ruta nombrada `home` y añade un mensaje temporal 'status' a la sesión</label>
      <label><input type="radio" name="q4" value="c"> c) Muestra la vista `home.blade.php` con la variable `$status`</label>
    </div>
    <div class="question">
      <p>5. ¿Para qué se usa `Route::prefix('dashboard')`?</p>
      <label><input type="radio" name="q5" value="a"> a) Para añadir un prefijo a todas las URL dentro del grupo</label>
      <label><input type="radio" name="q5" value="b"> b) Para añadir un prefijo a todos los nombres de las rutas dentro del grupo</label>
      <label><input type="radio" name="q5" value="c"> c) Para aplicar el middleware `dashboard`</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¡Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

**🚀 Resumen del capítulo:**

Has dominado un enfoque estructurado y profesional para la organización de rutas web en Laravel. Ahora sabes cómo:

-   Distinguir las rutas `web` y `api` y su propósito.
-   Usar `Route::resource` para generar rápidamente rutas CRUD estándar.
-   Aplicar rutas nombradas para crear código flexible y mantenible.
-   Crear operaciones CRUD completas en el controlador con validación y redirecciones.
-   Agrupar rutas para aplicar reglas comunes.

**El sistema de navegación de su "nave" ahora es tolerante a fallos y está listo para expandirse.** En el capítulo final de esta sección, combinaremos todo el conocimiento adquirido y mostraremos los datos de los planetas, obtenidos a través de Fetch, en nuestra página Blade.
