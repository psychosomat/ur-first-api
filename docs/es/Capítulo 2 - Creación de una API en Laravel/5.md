# **Cap√≠tulo 2.5: Rutas API**
**Tiempo de estudio:** 45 minutos

---
#### **1. ¬øQu√© es una ruta? Explicaci√≥n sencilla**

Imagina que tu controlador (`PlanetController`) es un gran centro de oficinas, y cada uno de sus m√©todos (`index`, `store`, `show`) es un departamento separado que realiza su trabajo.

Una **Ruta (Route)** es una placa de direcci√≥n en la entrada del edificio. Dice:

- "Si alguien lleg√≥ a la direcci√≥n `/planets` con el m√©todo **GET** ‚Äî env√≠elo al departamento `index` (mostrar todo)".
- "Si alguien lleg√≥ a la direcci√≥n `/planets` con el m√©todo **POST** con un paquete (datos) ‚Äî env√≠elo al departamento `store` (crear uno nuevo)".

Sin rutas, ninguna solicitud del mundo exterior encontrar√° el departamento que necesita en tu c√≥digo. El archivo principal para estas "placas de direcci√≥n" en la API es `routes/api.php`.

En Laravel 11+, por defecto no hay una "libreta de direcciones API". La creamos nosotros mismos ejecutando el comando `php artisan install:api`. Ahora tenemos el archivo `routes/api.php`, que es el centro de control principal para todas las rutas de nuestra API.

Diferencia clave entre `api.php` y `web.php`:

- Prefijo `/api`: Laravel a√±ade autom√°ticamente `/api` a todas las URLs de este archivo. La ruta `/planets` se convierte en `/api/planets`.
- "Sin estado" (Stateless): Aqu√≠ no hay sesiones ni cookies, como en la web normal. Cada solicitud es independiente y debe contener toda la informaci√≥n para la autenticaci√≥n (normalmente, un token de API en los encabezados).

---

#### **2. El camino del novato: Creaci√≥n manual de una ruta**

Vamos a crear una √∫nica ruta manualmente para entender el principio. Nuestro objetivo es hacer que la URL `/api/planets` muestre una lista de todos los planetas.

Abre `routes/api.php` y escribe:

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\PlanetController; // Indicamos d√≥nde est√° nuestro controlador

//                    (1)           (2)                     (3)
Route::get(      '/planets',    [PlanetController::class, 'index']     );
//   ^               ^                       ^
// (M√©todo HTTP)   (URL)             (Qu√© controlador y m√©todo llamar)
```

**Analicemos esta l√≠nea por partes:**

1.  `Route::get(...)` ‚Äî decimos: "Esta ruta solo funciona para **solicitudes GET**".
2.  `'/planets'` ‚Äî es la URL que Laravel escuchar√°. Con el prefijo `/api`, la direcci√≥n completa ser√° `http://space-api.test/api/planets`.
3.  `[PlanetController::class, 'index']` ‚Äî es el "punto de destino". Decimos: "Cuando llegue la solicitud, encuentra la clase `PlanetController` y llama a su m√©todo `index()`".

**¬°Ahora todo est√° conectado!** Solicitud -> Ruta -> Controlador -> M√©todo.

¬øY si necesitamos obtener un planeta por su ID? Por ejemplo, `/api/planets/5`.

```php
// Ruta para obtener un planeta espec√≠fico
Route::get('/planets/{planet}', [PlanetController::class, 'show']);
```

Aqu√≠ `{planet}` es una "plantilla" o variable. Laravel entiende que en este lugar puede haber cualquier cosa (ID, slug). Luego, pasa este valor al m√©todo `show(Planet $planet)`. Esta "magia", cuando Laravel encuentra el planeta por ID autom√°ticamente, se llama **Route Model Binding**.

---

#### **3. El camino del maestro: `apiResource` ‚Äî una l√≠nea para gobernarlos a todos**

Crear cada ruta manualmente (para `index`, `show`, `store`, `update`, `destroy`) es tedioso. Los desarrolladores de Laravel lo entienden, por eso crearon un asistente potente ‚Äî `apiResource`.

Elimina todo lo que escribimos y reempl√°zalo con una sola l√≠nea:

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\PlanetController;

Route::apiResource('planets', PlanetController::class);
```

**¬øQu√© hace esta sola l√≠nea bajo el cap√≥?** Crea autom√°ticamente un conjunto completo de rutas para las operaciones CRUD est√°ndar que ya implementamos en el controlador.

| M√©todo | URL | Se dirige al m√©todo | Prop√≥sito |
|---|---|---|---|
| **GET** | `/api/planets` | `index()` | Obtener una lista de todos los planetas |
| **POST** | `/api/planets` | `store()` | Crear un nuevo planeta |
| **GET** | `/api/planets/{planet}`| `show()` | Mostrar un planeta espec√≠fico |
| **PUT/PATCH**| `/api/planets/{planet}`| `update()` | Actualizar un planeta existente |
| **DELETE** | `/api/planets/{planet}`| `destroy()` | Eliminar un planeta |

Puedes Verificarlo t√∫ mismo. Ejecuta el siguiente comando en la terminal:

```bash
php artisan route:list --path=api
```

Ver√°s una tabla con todas las rutas creadas. `apiResource` es tu mejor amigo para ahorrar tiempo al crear APIs est√°ndar.

---

#### **4. Misiones especiales y orden de las rutas**

¬øQu√© pasa si necesitamos una ruta no est√°ndar, que no est√° en `apiResource`? Por ejemplo, obtener un planeta aleatorio en la direcci√≥n `/api/planets/random`.

Vamos a a√±adirla. Pero aqu√≠ hay una **trampa mortal** en la que caen 9 de cada 10 novatos.

**Orden incorrecto (¬°NO FUNCIONA!):**
```php
Route::apiResource('planets', PlanetController::class);
Route::get('/planets/random', [PlanetController::class, 'random']); // <-- NO FUNCIONAR√Å
```
**¬øPor qu√©?** Laravel lee las rutas de arriba a abajo. Ver√° `Route::apiResource`, que cre√≥ la ruta `GET /planets/{planet}`. Cuando solicites `/planets/random`, Laravel pensar√° que "random" es el ID de un planeta e intentar√° encontrar en la base de datos un planeta con el ID "random", y obtendr√°s un error.

**Orden correcto (¬°FUNCIONA!):**
```php
<?php
use App\Http\Controllers\PlanetController;
use Illuminate\Support\Facades\Route;

// 1. Primero declaramos las rutas ESPEC√çFICAS
Route::get('/planets/random', [PlanetController::class, 'random']);

// 2. Y solo despu√©s declaramos las rutas GENERALES con variables
Route::apiResource('planets', PlanetController::class);
```

> #### ‚ö†Ô∏è ¬°Importante!
> Para probar la ruta `api/planets/random`, debes a√±adir un nuevo manejador en `PlanetController`:

>```php
><?php
>public function random(Request $request)
>{
>	$planet = Planet::inRandomOrder()->first();
>	return response()->json($planet);
>}
>```


**Regla:** Declara siempre las rutas m√°s espec√≠ficas (como `/random`) **antes** de las rutas m√°s generales y con plantillas (como `/{planet}`).

---

#### **5. Agrupaci√≥n: Poniendo orden**

Cuando hay muchas rutas, se pueden y se deben agrupar.

**A. Versionado de la API**
Para no romper las aplicaciones antiguas que usan tu API en el futuro, es costumbre a√±adir una versi√≥n en la URL, por ejemplo `/api/v1/...`.

```php
<?php
Route::prefix('v1')->group(function () {
    // Todas las rutas dentro de este grupo obtendr√°n el prefijo /v1
    // URL final: /api/v1/planets
    Route::get('/planets/random', [PlanetController::class, 'random']);
    Route::apiResource('planets', PlanetController::class);
});
```

**B. Protecci√≥n de rutas (Middleware)**
Imagina que cualquiera puede ver los planetas, pero solo los usuarios autorizados pueden crearlos, actualizarlos y eliminarlos.

```php
<?php
// Rutas p√∫blicas, accesibles para todos
Route::get('/planets', [PlanetController::class, 'index']);
Route::get('/planets/{planet}', [PlanetController::class, 'show']);

// Grupo de rutas que requieren un "pase" (autenticaci√≥n)
Route::middleware('auth:sanctum')->group(function () {
    Route::post('/planets', [PlanetController::class, 'store']);
    Route::put('/planets/{planet}', [PlanetController::class, 'update']);
    Route::delete('/planets/{planet}', [PlanetController::class, 'destroy']);
});
```

Aqu√≠ `middleware('auth:sanctum')` es como un guardia de seguridad que comprueba el "pase" de cualquiera que intente acceder a las rutas dentro del grupo.

---

#### **6. Pruebas con Postman**

Ahora que todas las rutas est√°n establecidas, es hora de probarlas.

1.  **Si usas Herd:** Tu sitio ya est√° funcionando en una direcci√≥n como `http://space-api.test`.
2.  **Si no:** Inicia el servidor local con el comando `php artisan serve`. La direcci√≥n ser√° `http://localhost:8000`.

Abre Postman y env√≠a las solicitudes:

- `GET http://space-api.test/api/planets`
- `GET http://space-api.test/api/planets/random`
- `POST http://space-api.test/api/planets` (no olvides a√±adir el cuerpo de la solicitud JSON en la pesta√±a `Body` -> `raw` -> `JSON`).

**Ejemplo de solicitud POST:**
```json
{
    "name": "Kepler-186f",
    "description": "Primera planeta de tama√±o terrestre en la zona habitable",
    "size_km": 15000,
    "solar_system": "Kepler-186",
    "is_habitable": true
}
```

---

#### **8. Errores comunes de enrutamiento**

1. **404 Not Found**
   >- URL incorrecta (`/api/planet` en lugar de `/api/planets`)
   >- Olvidaste `php artisan serve`
2. **405 Method Not Allowed**
   >- M√©todo HTTP incorrecto (por ejemplo, GET en lugar de POST)
3. **Missing Controller**
   >- Error tipogr√°fico en el nombre del controlador (`PlanetControler`)
4. **Route Name Collision**
   >- Nombres de ruta duplicados

---

#### **Cuestionario de refuerzo**

<style>
    #quiz-container {
        border-radius: 8px; /* Contenedor del cuestionario */
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px; /* Pregunta individual */
    }
    .question p {
        font-weight: bold; /* Texto de la pregunta */
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block; /* Opciones de respuesta */
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none; /* Bot√≥n de env√≠o */
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px; /* Resultados del cuestionario */
        padding: 15px;
        border-radius: 5px;
    }
</style>
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Archivo para rutas API en Laravel:</p>
      <label><input type="radio" name="q1" value="a"> a) routes/web.php</label>
      <label><input type="radio" name="q1" value="b"> b) routes/api.php</label>
      <label><input type="radio" name="q1" value="c"> c) routes/console.php</label>
    </div>
    <div class="question">
      <p>2. Prefijo autom√°tico para rutas API:</p>
      <label><input type="radio" name="q2" value="a"> a) /admin</label>
      <label><input type="radio" name="q2" value="b"> b) /api</label>
      <label><input type="radio" name="q2" value="c"> c) /v1</label>
    </div>
    <div class="question">
      <p>3. M√©todo para crear 5 rutas CRUD:</p>
      <label><input type="radio" name="q3" value="a"> a) Route::api()</label>
      <label><input type="radio" name="q3" value="b"> b) Route::resource()</label>
      <label><input type="radio" name="q3" value="c"> c) Route::apiResource()</label>
    </div>
    <div class="question">
      <p>4. Route::prefix('v1') se usa para:</p>
      <label><input type="radio" name="q4" value="a"> a) Autenticaci√≥n</label>
      <label><input type="radio" name="q4" value="b"> b) Versionamiento de API</label>
      <label><input type="radio" name="q4" value="c"> c) Cach√©</label>
    </div>
    <div class="question">
      <p>5. Ver todas las rutas:</p>
      <label><input type="radio" name="q5" value="a"> a) php artisan route:list</label>
      <label><input type="radio" name="q5" value="b"> b) php artisan list:routes</label>
      <label><input type="radio" name="q5" value="c"> c) php routes</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumen del cap√≠tulo:**

¬°Has construido las "rutas hiperespaciales" para la API espacial! Ahora:

- üó∫Ô∏è Todos los endpoints est√°n disponibles en `/api/...`
- üîó Las rutas de recursos est√°n conectadas al controlador
- üõ°Ô∏è Se han a√±adido rutas personalizadas para operaciones especiales
- ‚úÖ Las rutas se han probado con Postman

**¬°El universo est√° abierto a solicitudes!** A continuaci√≥n, a√±adiremos protecci√≥n contra la "basura espacial": la validaci√≥n de datos.

> **üìå Verificaci√≥n:**

> 1. Ejecuta `php artisan route:list`
> 2. Aseg√∫rate de ver 5+ rutas para planets
> 3. Verifica el funcionamiento de GET /api/planets en el navegador/Postman

> **‚ö†Ô∏è Si error 404:**

> - Verifica la presencia de `Route::apiResource` en `routes/api.php`
> - Aseg√∫rate de que el servidor est√© en ejecuci√≥n (`php artisan serve`)
> - Para Windows: permite el puerto 8000 en el firewall
