# **Cap√≠tulo 2.3: Migraciones de la base de datos**
**Tiempo de estudio:** 50 minutos

---

#### **1. Migraciones: Construcci√≥n de una estaci√≥n espacial**
Las **migraciones** en Laravel son un sistema de control de versiones para tu base de datos.

Imagina que est√°s:

1. üèóÔ∏è Creando el plano de una estaci√≥n (migraci√≥n `create_planets_table`)
2. üöÄ Desplegando m√≥dulos (ejecuci√≥n de migraciones)
3. üîß Modernizando la estructura (nuevas migraciones)
4. ‚è™ Puedes revertir a una versi√≥n anterior (rollback)

> üí° **Importante:** Las migraciones permiten que el equipo trabaje de forma coordinada, ¬°como ingenieros en diferentes continentes construyendo la ISS!

---

#### **2. Ejecuci√≥n de migraciones**
Despu√©s de crear la migraci√≥n en el cap√≠tulo 2.2, ejecuta:
```bash
php artisan migrate
```

**Salida en la terminal:**
```
Migration table created successfully.
Migrating: 2014_10_12_000000_create_users_table
Migrated:  2014_10_12_000000_create_users_table (25.12ms)
Migrating: 2014_10_12_100000_create_password_reset_tokens_table
Migrated:  2014_10_12_100000_create_password_reset_tokens_table (18.07ms)
Migrating: 2019_08_19_000000_create_failed_jobs_table
Migrated:  2019_08_19_000000_create_failed_jobs_table (21.33ms)
Migrating: 2019_12_14_000001_create_personal_access_tokens_table
Migrated:  2019_12_14_000001_create_personal_access_tokens_table (30.45ms)
Migrating: 2025_08_04_000000_create_planets_table
Migrated:  2025_08_04_000000_create_planets_table (15.67ms)  # ¬°Tu tabla!
```

**Verificaci√≥n en pgAdmin 4:**

1. Abre la base de datos `space_api` ‚Üí Schemas ‚Üí Tables
2. Aseg√∫rate de que aparezcan:   - `planets`   - `users`   - `password_reset_tokens`

---

#### **3. Revertir migraciones: Retorno de emergencia**
Si necesitas corregir la estructura:
```bash
php artisan migrate:rollback  # Revertir el √∫ltimo lote de migraciones
```
```bash
php artisan migrate:reset    # Reversi√≥n completa de todas las migraciones
```

- ```php artisan migrate:fresh``` ‚Äî **¬°el comando m√°s √∫til en desarrollo!** Elimina todas las tablas y vuelve a ejecutar todas las migraciones.
- ```php artisan migrate:fresh --seed``` ‚Äî hace lo mismo que `fresh`, pero despu√©s de las migraciones, ejecuta inmediatamente los seeders. Este es un comando para la "recreaci√≥n" completa de la base de datos desde cero.


**Escenario de uso:**
```bash
# Paso 1: Nos dimos cuenta de que hay un error en la migraci√≥n. Recreamos completamente la base de datos.
php artisan migrate:fresh
# Paso 2: Editamos la migraci√≥n
# Paso 3: Volvemos a crear la base de datos con la migraci√≥n ya corregida.
php artisan migrate:fresh
```

---

#### **4. Adici√≥n de nuevos campos: Modernizaci√≥n de la estaci√≥n**
**Ejemplo:** A√±adiremos el campo `is_habitable` (¬øes habitable el planeta?).

**Paso 1: Creamos una nueva migraci√≥n**
```bash
php artisan make:migration add_is_habitable_to_planets_table
```

**Paso 2: Editamos el archivo** `database/migrations/..._add_is_habitable_to_planets_table.php`
```php
<?php
public function up()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->boolean('is_habitable')
              ->default(false);
    });
}

public function down()
{
    Schema::table('planets', function (Blueprint $table) {
        $table->dropColumn('is_habitable');
    });
}
```

**Paso 3: Ejecutamos la actualizaci√≥n**
```bash
php artisan migrate
```

---

#### **5. Rellenar la base de datos: Los primeros planetas**
Creamos un **seeder** ‚Äî un script para generar datos de prueba.

**Paso 1: Generaci√≥n del seeder**
```bash
php artisan make:seeder PlanetSeeder
```

**Paso 2: Editamos** `database/seeders/PlanetSeeder.php`
```php
<?php
use App\Models\Planet; // ¬°Importamos el modelo de planeta - Sin esto, obtendr√°s un error!


class PlanetSeeder extends Seeder
{
    public function run()
    {
        Planet::create([
            'name' => 'Tierra',
            'description' => 'Planeta azul con vida diversa',
            'size_km' => 12742,
            'solar_system' => 'Sistema Solar',
            'image_url' => 'https://example.com/earth.jpg',
            'is_habitable' => true
        ]);

        Planet::create([
            'name' => 'Marte',
            'description' => 'Planeta rojo, objetivo de futuras colonizaciones',
            'size_km' => 6779,
            'solar_system' => 'Sistema Solar',
            'is_habitable' => false
        ]);
    }
}
```

**Paso 3: Registramos el seeder en** `database/seeders/DatabaseSeeder.php`
```php
<?php
public function run()
{
    $this->call([
        PlanetSeeder::class
    ]);
}
```

**Paso 4: Ejecuci√≥n del relleno**
```bash
php artisan db:seed
```

---

#### **6. Trabajar con PostgreSQL: Especificidades**
**Caracter√≠sticas del tipo de datos:**

| Caracter√≠stica | PostgreSQL | MySQL | Comentario de Laravel |
|---|---|---|---|
| **Tipo l√≥gico** | `boolean` (verdadero `true`/`false`) | `tinyint(1)` (almacena `0`/`1`) | `$table->boolean('...')` funciona para ambos |
| **JSON** | `jsonb` (binario, indexable) | `json` (de texto) | `$table->jsonb('...')` - muy potente en PG |
| **Arrays** | `text[]`, `integer[]` (arrays nativos) | No (emulado a trav√©s de JSON o cadenas) | `$table->array('...')` (exclusivo para PG) |
| **Orden de columnas** | No se puede controlar (`after()` no funciona) | Se puede controlar (`after()`) | Laravel lo abstrae, pero es necesario conocer la limitaci√≥n |


**Ejemplo de creaci√≥n de √≠ndice:**
```php
// En la migraci√≥n
$table->index('solar_system');
```

---

#### **7. Verificaci√≥n de datos en psql**

Puedes usar cualquier cliente gr√°fico y seleccionar `space_api` para visualizar los datos.

Al usar la consola:
```bash
psql -U postgres -d space_api
# La terminal puede solicitar la contrase√±a que configuraste al instalar PostgreSQL.
```
```sql
SELECT * FROM planets;
```

En cualquier caso, la salida deber√≠a ser la siguiente:

 id |  name  | description | size_km |  solar_system   | image_url | is_habitable |
|---|---|---|---|---|---|---|
  1 | Tierra | Planeta azul con vida diversa   |   12742 | Sistema Solar| ...       | true |
  2 | Marte  | Planeta rojo, objetivo de colonizaciones        |    6779 | Sistema Solar| null      | false |


---

#### **Cuestionario de repaso**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Comando para ejecutar migraciones:</p>
      <label><input type="radio" name="q1" value="a"> a) php artisan migrate:run</label>
      <label><input type="radio" name="q1" value="b"> b) php artisan migrate</label>
      <label><input type="radio" name="q1" value="c"> c) php artisan db:migrate</label>
    </div>
    <div class="question">
      <p>2. ¬øC√≥mo revertir la √∫ltima migraci√≥n?</p>
      <label><input type="radio" name="q2" value="a"> a) migrate:undo</label>
      <label><input type="radio" name="q2" value="b"> b) migrate:rollback</label>
      <label><input type="radio" name="q2" value="c"> c) migrate:reset</label>
    </div>
    <div class="question">
      <p>3. Los seeders se utilizan para:</p>
      <label><input type="radio" name="q3" value="a"> a) Eliminar tablas</label>
      <label><input type="radio" name="q3" value="b"> b) Rellenar la BD con datos de prueba</label>
      <label><input type="radio" name="q3" value="c"> c) Crear modelos</label>
    </div>
    <div class="question">
      <p>4. M√©todo para a√±adir una columna a una tabla existente:</p>
      <label><input type="radio" name="q4" value="a"> a) Schema::addColumn()</label>
      <label><input type="radio" name="q4" value="b"> b) Schema::table()</label>
      <label><input type="radio" name="q4" value="c"> c) Schema::modify()</label>
    </div>
    <div class="question">
      <p>5. ¬øD√≥nde se registran los seeders?</p>
      <label><input type="radio" name="q5" value="a"> a) DatabaseSeeder.php</label>
      <label><input type="radio" name="q5" value="b"> b) .env</label>
      <label><input type="radio" name="q5" value="c"> c) config/database.php</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;
if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ Resumen del cap√≠tulo:**

Has dominado la "construcci√≥n de infraestructura espacial":

- ‚úÖ Creaste y lanzaste migraciones
- üîß Modernizaste la estructura de la tabla
- üåç Llenaste la BD con los primeros planetas
- ‚öôÔ∏è Aprendiste a trabajar con PostgreSQL

**¬°Tu universo ha adquirido sus primeros mundos!** Ahora puedes pasar a la creaci√≥n de interfaces API para la gesti√≥n de planetas.

> **üìå Verificaci√≥n:**

> 1. Ejecuta `php artisan tinker`
> 2. Ejecuta `App\Models\Planet::all()`
> 3. Aseg√∫rate de ver la Tierra y Marte
