# **Cap√≠tulo 2.7: Gesti√≥n de Errores**
**Tiempo de estudio:** 40 minutos

---

#### **1. ¬øPor qu√© los errores est√°ndar son malos?**

Si ocurre un error en su aplicaci√≥n Laravel (por ejemplo, no se encuentra un registro en la base de datos) y no lo maneja de ninguna manera, el usuario ver√° una enorme p√°gina HTML con informaci√≥n de depuraci√≥n o un mensaje poco informativo de "Error del Servidor".

Para una API, esto es una cat√°strofe. Su aplicaci√≥n frontend espera recibir JSON, no HTML. Nuestra tarea es interceptar cualquier error y convertirlo en una respuesta JSON estructurada.

---

#### **2. El despachador central de errores: `bootstrap/app.php`**

En las versiones antiguas de Laravel, hab√≠a un archivo voluminoso `App\Exceptions\Handler.php`. En Laravel 11/12, todo es mucho m√°s simple y elegante. El centro de gesti√≥n de errores ahora se encuentra directamente en el archivo de configuraci√≥n de su aplicaci√≥n: `bootstrap/app.php`.

Abra `bootstrap/app.php`. Al final, ver√° el bloque `.withExceptions(...)`. Este es nuestro "despachador central".

```php
<?php
// bootstrap/app.php

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        api: __DIR__.'/../routes/api.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {
        // ...
    })
    ->withExceptions(function (Exceptions $exceptions) {
        // <-- AQU√ç ES DONDE TRABAJAREMOS
    })->create();
```

---

#### **3. Manejando el error m√°s com√∫n: "No encontrado" (404)**

El error m√°s com√∫n en una API es cuando el usuario solicita un recurso que no existe (por ejemplo, `GET /api/planets/999`). Laravel en este caso genera una excepci√≥n `ModelNotFoundException` o `NotFoundHttpException`. Vamos a interceptarlas.

Agregue el siguiente c√≥digo dentro de `.withExceptions(...)`:

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // Interceptamos la excepci√≥n cuando el modelo no se encuentra en la base de datos
    $exceptions->render(function (ModelNotFoundException $e, Request $request) {
        // Verificamos que la solicitud provenga espec√≠ficamente de nuestra API
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'El recurso solicitado no se encuentra en nuestra galaxia.'
            ], 404);
        }
    });

    // Interceptamos la excepci√≥n cuando la ruta misma no se encuentra
    $exceptions->render(function (NotFoundHttpException $e, Request $request) {
        if ($request->is('api/*')) {
            return response()->json([
                'message' => 'Esta ruta c√≥smica no existe.'
            ], 404);
        }
    });

})->create();
```
**¬øQu√© hicimos?**

1.  `$exceptions->render(...)` ‚Äî Registramos un "manejador". Dice: "Si ocurre una excepci√≥n de tipo `ModelNotFoundException`, ejecuta este c√≥digo".
2.  `if ($request->is('api/*'))` ‚Äî Esta es una verificaci√≥n importante. Garantiza que nuestra bonita respuesta JSON solo se enviar√° para solicitudes de API, sin afectar las p√°ginas web normales.
3.  `return response()->json(...)` ‚Äî Creamos y devolvemos una respuesta JSON estandarizada con el c√≥digo 404.

Ahora, si solicita un planeta inexistente, en lugar de una p√°gina HTML fea, recibir√° un JSON ordenado.

---

#### **4. Excepciones personalizadas: Creando nuestras propias "se√±ales de alarma"**

A veces, las excepciones est√°ndar no son suficientes. Imaginemos que tenemos una regla de negocio: "no se puede eliminar el planeta 'Tierra'". Si alguien intenta hacerlo, debemos devolver un error significativo.

**Paso 1: Creamos nuestra propia clase de excepci√≥n**
Ejecutamos en la terminal:
```bash
php artisan make:exception CannotDeleteEarthException
```

**Paso 2: La usamos en el controlador**
Abrimos `PlanetController.php` y modificamos el m√©todo `destroy`:

```php
<?php
// app/Http/Controllers/PlanetController.php
use App\Exceptions\CannotDeleteEarthException; // <-- Importamos nuestra excepci√≥n
use App\Models\Planet;

public function destroy(Planet $planet)
{
    // Nuestra nueva regla de negocio
    if (strtolower($planet->name) === '–∑–µ–º–ª—è') {
        throw new CannotDeleteEarthException('La eliminaci√≥n del planeta Tierra est√° prohibida por el C√≥digo Gal√°ctico.');
    }

    $planet->delete();
    return response()->json(null, 204);
}
```
Ahora, si alguien intenta ejecutar `DELETE /api/planets/1` (donde 1 es el ID de la Tierra), nuestro c√≥digo lanzar√° una excepci√≥n `CannotDeleteEarthException`.

**Paso 3: Ense√±amos a Laravel a manejar bellamente nuestra "alarma"**
Volvamos a `bootstrap/app.php` y agreguemos un nuevo manejador para nuestra excepci√≥n.

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // Nuestro nuevo manejador
    $exceptions->render(function (CannotDeleteEarthException $e, Request $request) {
        return response()->json([
            'message' => 'Operaci√≥n prohibida.',
            'details' => $e->getMessage() // Obtenemos el mensaje que pasamos en throw
        ], 403); // 403 Forbidden - "Acceso denegado"
    });

    // ... (otros manejadores para 404)

})->create();
```
¬°Listo! Creamos nuestra propia excepci√≥n con nombre, que hace que el c√≥digo del controlador sea m√°s limpio, y ense√±amos a Laravel a convertirla en una respuesta JSON hermosa y significativa con el estado HTTP correcto.

---

#### **5. Gesti√≥n de todos los dem√°s fallos (500 Internal Server Error)**

¬øQu√© hacer con todos los dem√°s errores inesperados? Por ejemplo, si la base de datos se cae o hay un error de sintaxis en el c√≥digo. Para esto, podemos registrar un manejador "universal" para el tipo de error m√°s general: `Throwable`.

**Importante:** Este manejador debe ser el **√∫ltimo** para no interceptar excepciones m√°s espec√≠ficas que definimos anteriormente.

```php
<?php
// bootstrap/app.php

->withExceptions(function (Exceptions $exceptions) {

    // ... (manejadores para CannotDeleteEarthException y 404)

    // MANEJADOR UNIVERSAL (al final de todo)
    $exceptions->render(function (Throwable $e, Request $request) {
        if ($request->is('api/*')) {
            // En modo de depuraci√≥n, se puede mostrar el mensaje de error real
            $message = config('app.debug')
                ? 'Ha ocurrido un error: ' . $e->getMessage()
                : 'Ha ocurrido un error inesperado a bordo. Los ingenieros ya han sido llamados.';

            return response()->json(['message' => $message], 500);
        }
    });

})->create();
```

Ahora, cualquier excepci√≥n "desconocida" ser√° interceptada cuidadosamente y convertida en JSON con el c√≥digo 500, sin romper su API ni mostrar informaci√≥n innecesaria al usuario.

---

#### **6. Registro de errores: La caja negra de la nave espacial**
Configuraci√≥n de registro en `config/logging.php`:
```php
<?php
'channels' => [
    'space_api' => [
        'driver' => 'daily',
        'path' => storage_path('logs/space_api.log'),
        'level' => 'error',
        'days' => 14,
    ],
],
```

**A√±adir un registro al log:**
```php
<?php
try {
    // C√≥digo con riesgo de error
} catch (Exception $e) {
    Log::channel('space_api')->error('Error de acceso a los planetas', [
        'exception' => $e,
        'request' => request()->all(),
        'user_id' => auth()->id()
    ]);
    throw $e;
}
```

---

#### **Quiz de afianzamiento**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Estado HTTP para "Planeta no encontrado":</p>
      <label><input type="radio" name="q1" value="a"> a) 400</label>
      <label><input type="radio" name="q1" value="b"> b) 404</label>
      <label><input type="radio" name="q1" value="c"> c) 500</label>
    </div>
    <div class="question">
      <p>2. Clase para el manejo global de errores:</p>
      <label><input type="radio" name="q2" value="a"> a) Handler.php</label>
      <label><input type="radio" name="q2" value="b"> b) ErrorController.php</label>
      <label><input type="radio" name="q2" value="c"> c) Middleware/Error.php</label>
    </div>
    <div class="question">
      <p>3. M√©todo para crear una excepci√≥n personalizada:</p>
      <label><input type="radio" name="q3" value="a"> a) php artisan make:exception</label>
      <label><input type="radio" name="q3" value="b"> b) php artisan exception:create</label>
      <label><input type="radio" name="q3" value="c"> c) php artisan generate:exception</label>
    </div>
    <div class="question">
      <p>4. Canal para el registro separado de errores de API:</p>
      <label><input type="radio" name="q4" value="a"> a) Configuraci√≥n en config/logging.php</label>
      <label><input type="radio" name="q4" value="b"> b) Par√°metro en .env</label>
      <label><input type="radio" name="q4" value="c"> c) Indicaci√≥n en el controlador</label>
    </div>
    <div class="question">
      <p>5. Principal ventaja de crear excepciones personalizadas:</p>
      <label><input type="radio" name="q5" value="a"> a) Aumento del rendimiento</label>
      <label><input type="radio" name="q5" value="b"> b) Creaci√≥n de errores sem√°nticamente comprensibles para escenarios de negocio espec√≠ficos</label>
      <label><input type="radio" name="q5" value="c"> c) Adici√≥n autom√°tica a .env</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>
<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'a', q4: 'a', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';
    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });
      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;
      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }
    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumen del cap√≠tulo:**

Has equipado tu API con un robusto sistema de rescate:

- üõü Intercepci√≥n global de errores est√°ndar
- ü™ê Excepciones personalizadas con c√≥digos comprensibles
- üìù Formato JSON unificado para todos los errores
- üîç Registro con detalles del incidente
- üì° Integraci√≥n con sistemas de monitoreo

**¬°La nave espacial est√° lista para emergencias!** En el cap√≠tulo final de la secci√≥n, probaremos todos los sistemas.

> **üìå Verificaci√≥n:**

> 1. Crea la excepci√≥n `PlanetNotFoundException`
> 2. Agrega el manejo de errores 404 en ```->withExceptions```
> 3. Prueba la solicitud a un planeta inexistente

> **‚ö†Ô∏è Si los errores no se interceptan:**

> - Aseg√∫rate de que `is('api/*')` coincide con tus rutas
> - Verifica el orden de los manejadores en `register()`
> - Para excepciones personalizadas, usa `throw new`
