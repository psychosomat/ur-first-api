# **Cap√≠tulo 6.5: Fundamentos de la seguridad de API**
**Tiempo de estudio:** 45 minutos

---

#### **1. Seguridad API: Defensa multinivel de la estaci√≥n**

Imagine que su estaci√≥n espacial (API) se encuentra en un sector hostil del espacio. Un solo campo de fuerza (autenticaci√≥n) no es suficiente. Necesita un sistema de defensa integral:

- **Escudos (HTTPS):** Cifrado de todo el tr√°fico.
- **Sensores de anomal√≠as (Rate Limiting):** Protecci√≥n contra solicitudes demasiado frecuentes.
- **Mamparos internos (Autorizaci√≥n):** Separaci√≥n de derechos de acceso.
- **Inspecci√≥n de cargas (Validaci√≥n):** No confiar en ning√∫n dato entrante.
- **Caja fuerte secreta (Variables de entorno):** Almacenamiento seguro de claves.

Configuremos cada uno de estos niveles.

---

#### **2. Escudos: Siempre use HTTPS**

**¬øQu√© es esto?** HTTPS (HyperText Transfer Protocol Secure) es una versi√≥n del protocolo HTTP que cifra todos los datos entre el cliente y el servidor. Sin √©l, cualquiera que est√© "escuchando" la red (por ejemplo, en una red Wi-Fi p√∫blica) puede interceptar inicios de sesi√≥n, contrase√±as y tokens.

**¬øC√≥mo implementarlo?**

- **En producci√≥n ‚Äî obligatorio.** Al desplegar su API en un servidor real (Heroku, DigitalOcean, etc.), configure el servidor web (Nginx, Apache) para trabajar con un certificado SSL. Servicios como **Let's Encrypt** proporcionan certificados gratuitos.
- **En el desarrollo local,** es menos cr√≠tico, pero herramientas como **Laravel Herd** o **mkcert** permiten configurar f√°cilmente HTTPS local.

> üí° **Regla n.¬∫ 1 en seguridad de API:** **No hay HTTPS, no hay seguridad.**

---

#### **3. Sensores de anomal√≠as: Limitaci√≥n de la tasa de solicitudes (Rate Limiting)**

**¬øQu√© es esto?** Protecci√≥n contra **ataques de fuerza bruta** (cuando un atacante intenta adivinar una contrase√±a enviando miles de solicitudes por segundo) y contra **ataques DoS** (cuando el servidor es "bombardeado" con solicitudes para que deje de responder). Rate Limiting limita el n√∫mero de solicitudes que un usuario (o direcci√≥n IP) puede realizar en un per√≠odo de tiempo determinado.

**¬øC√≥mo implementarlo?**

- **En Laravel:** ¬°El Middleware para la limitaci√≥n ya est√° integrado!
  Abra `app/Http/Kernel.php` y busque la clave `middlewareGroups['api']`. Ya existe `'throttle:api'`. La configuraci√≥n de esta limitaci√≥n se encuentra en `app/Providers/RouteServiceProvider.php` en el m√©todo `configureRateLimiting()`.
  ```php
  // app/Providers/RouteServiceProvider.php
  protected function configureRateLimiting()
  {
      RateLimiter::for('api', function (Request $request) {
          return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
      });
  }
  ```
  // Esto significa: 60 solicitudes por minuto por usuario (si est√° autenticado) o por direcci√≥n IP.

- **En FastAPI:** Se utiliza un paquete de terceros, por ejemplo, **`slowapi`**.

  1.  Instalaci√≥n: `pip install slowapi`
  2.  Integraci√≥n en `main.py`:
      ```python
      # main.py
      from slowapi import Limiter, _rate_limit_exceeded_handler
      from slowapi.util import get_remote_address
      from slowapi.errors import RateLimitExceeded

      limiter = Limiter(key_func=get_remote_address)
      app = FastAPI(...)

      # Conectamos el manejador de errores y el limitador.
      app.state.limiter = limiter
      app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

      # Aplicamos a un endpoint espec√≠fico.
      @router.get("/planets")
      @limiter.limit("5/minute") # 5 solicitudes por minuto
      def get_planets(request: Request):
          # ...
      ```

---

#### **4. Mamparos internos: Autorizaci√≥n (¬°no confundir con autenticaci√≥n!)**

**¬øQu√© es esto?**

- **Autenticaci√≥n** responde a la pregunta "¬øQui√©n eres?".
- **Autorizaci√≥n** responde a la pregunta "¬øQu√© se te permite hacer?".

Por ejemplo, un usuario normal puede ver planetas, pero solo un usuario con el rol de "administrador" puede eliminarlos.

**¬øC√≥mo implementarlo?**

- **En Laravel:** Se utilizan **Policies** (Pol√≠ticas) o **Gates** (Compuertas).

  1.  Creamos una pol√≠tica: `php artisan make:policy PlanetPolicy --model=Planet`
  2.  Describimos las reglas en `app/Policies/PlanetPolicy.php`:
      ```php
      class PlanetPolicy
      {
          // Permitir la eliminaci√≥n solo a usuarios con el rol 'admin'
          public function delete(User $user, Planet $planet): bool
          {
              return $user->role === 'admin';
          }
      }
      ```
  3.  Aplicamos la pol√≠tica en el controlador `PlanetController.php`:
      ```php
      public function destroy(Planet $planet)
      {
          // Verificamos si el usuario actual tiene derecho a eliminar
          $this->authorize('delete', $planet);

          $planet->delete();
          return response()->json(null, 204);
      }
      ```

- **En FastAPI:** La l√≥gica de autorizaci√≥n generalmente se escribe manualmente dentro de los endpoints, utilizando la informaci√≥n del usuario obtenida del token.

  ```python
  # (asumimos que el token tiene un campo 'roles')
  def get_current_active_user(token: str = Depends(oauth2_scheme)):
      # ... decodificamos el token y obtenemos el usuario con roles de la BD
      # user = get_user_from_db(username)
      return user # devolvemos el objeto de usuario

  @router.delete("/planets/{planet_id}")
  def delete_planet(
      planet_id: int,
      current_user: User = Depends(get_current_active_user)
  ):
      if "admin" not in current_user.roles:
          raise HTTPException(
              status_code=status.HTTP_403_FORBIDDEN,
              detail="Permisos insuficientes para realizar esta operaci√≥n",
          )
      # ... l√≥gica de eliminaci√≥n ...
  ```

---

#### **5. Inspecci√≥n de cargas y Caja fuerte secreta: Validaci√≥n y Variables de entorno**

Estos dos puntos ya los hemos implementado, pero es importante recalcar su papel en la seguridad.

- **Nunca conf√≠e en los datos entrantes (Validaci√≥n):**

  - Hemos utilizado `$request->validate()` en Laravel y modelos Pydantic en FastAPI. Esto nos protege de **inyecciones SQL** (al usar Eloquent/SQLAlchemy) y de datos incorrectos que pueden romper la aplicaci√≥n. **¬°Siempre valide todo lo que viene del exterior!**

- **Guarde los secretos en `.env` (Variables de entorno):**

  - Las claves de las bases de datos, las claves secretas para JWT (`SECRET_KEY`), las claves de servicios de terceros ‚Äî todo esto **nunca** debe ir al sistema de control de versiones (Git). Para ello existen los archivos `.env`, que se a√±aden a `.gitignore`.

---

#### **Cuestionario para afianzar**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. Para proteger contra la interceptaci√≥n de datos en redes p√∫blicas se utiliza:</p>
      <label><input type="radio" name="q1" value="a"> a) Rate Limiting</label>
      <label><input type="radio" name="q1" value="b"> b) HTTPS</label>
      <label><input type="radio" name="q1" value="c"> c) CORS</label>
    </div>
    <div class="question">
      <p>2. La limitaci√≥n de la tasa de solicitudes (Rate Limiting) protege principalmente contra:</p>
      <label><input type="radio" name="q2" value="a"> a) Inyecciones SQL</label>
      <label><input type="radio" name="q2" value="b"> b) Ataques de fuerza bruta y DoS</label>
      <label><input type="radio" name="q2" value="c"> c) Scripting entre sitios (XSS)</label>
    </div>
    <div class="question">
      <p>3. La pregunta "¬øQu√© se le permite hacer a este usuario?" la resuelve:</p>
      <label><input type="radio" name="q3" value="a"> a) Autenticaci√≥n</label>
      <label><input type="radio" name="q3" value="b"> b) Autorizaci√≥n</label>
      <label><input type="radio" name="q3" value="c"> c) Validaci√≥n</label>
    </div>
    <div class="question">
      <p>4. Las claves secretas de API y las contrase√±as de la base de datos deben almacenarse:</p>
      <label><input type="radio" name="q4" value="a"> a) Directamente en el c√≥digo para mayor comodidad</label>
      <label><input type="radio" name="q4" value="b"> b) En un repositorio p√∫blico en GitHub</label>
      <label><input type="radio" name="q4" value="c"> c) En un archivo `.env` que est√° excluido de Git</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'b', q4: 'c' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;
      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Finalizaci√≥n del curso**
**¬°Felicidades, comandante! Has completado todas las misiones con √©xito.**

Has pasado de ser un novato que solo hab√≠a o√≠do hablar de las API a un ingeniero capaz de dise√±ar, desarrollar, documentar, proteger y probar de forma independiente un servicio web completo utilizando las dos tecnolog√≠as m√°s populares en sus respectivos ecosistemas.

Has dominado el lenguaje universal REST, aprendido Laravel y FastAPI y construido un "Centro de Control de Vuelo" para ellos usando JavaScript puro.

**Este es un logro enorme.** El mundo del desarrollo de API est√° ahora abierto para ti. Contin√∫a explorando, aprendiendo y construyendo cosas asombrosas.

**Fin de la transmisi√≥n.** üöÄ
---
<h2>‚òÑ Apoya la misi√≥n</h2>
<p>La creaci√≥n de este tutorial es un viaje largo y complejo que requiere mucho tiempo y energ√≠a. Si el material te ha sido √∫til, puedes ayudar a rellenar los tanques de combustible de nuestra expedici√≥n. Cada apoyo es otra √≥rbita hacia nuevos materiales √∫tiles.</p>
<a href='https://ko-fi.com/K3K41JFJ32' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi4.png?v=6' border='0' alt='Buy Me a Coffee at ko-fi.com' /></a>
```
