# **Cap√≠tulo 6.1: Conectando FastAPI con el frontend**
**Tiempo de estudio:** 30 minutos

---

#### **1. Volviendo al "hiperpropulsor": Comparaci√≥n de protocolos**
En el cap√≠tulo anterior, acoplamos nuestro Centro de Control de Misiones (frontend) a la "ISS" (API de Laravel). Ahora, volveremos a nuestro **caza supers√≥nico** (FastAPI) y realizaremos la misma operaci√≥n.

El objetivo de este cap√≠tulo no es simplemente repetir acciones, sino **comparar dos enfoques**. Es como si la misma nave Dragon se acoplara primero a la ISS y luego a la estaci√≥n espacial china "Tiangong". El puerto de acoplamiento es el mismo (REST), pero puede haber matices en los procedimientos y la ubicaci√≥n de los puertos.

> üí° **Analog√≠a espacial:**

> El proceso es el mismo: acercarse, alinearse, acoplarse. Pero para la "ISS" tuvimos que usar el puerto `/api/planets`, y para "Tiangong", el puerto `/spaceships`. Nuestro operador en el Centro de Control de Misiones debe conocer estos detalles para que la misi√≥n tenga √©xito.

---

#### **2. Preparando el "caza" (FastAPI) para el acoplamiento**

Ya lo hicimos en el Cap√≠tulo 4.2, pero asegur√©monos de que todo est√© en su lugar.

**Paso 1: Iniciando el servidor FastAPI**

1.  Detenga el servidor Laravel si est√° en ejecuci√≥n (para evitar conflictos de puertos).
2.  Abra una terminal en la carpeta de su proyecto FastAPI.
3.  Active el entorno virtual:

    - **Windows:** `.\venv\Scripts\Activate.ps1`
    - **macOS / Linux:** `source venv/bin/activate`

4.  Inicie el servidor:
    ```bash
    uvicorn main:app --reload
    ```
    El servidor estar√° disponible en la direcci√≥n `http://127.0.0.1:8000`.

**Paso 2: Verificando la configuraci√≥n CORS en `main.py`**

Aseg√∫rese de que su proyecto FastAPI tenga configurado el `CORSMiddleware` que agregamos anteriormente. Debe permitir solicitudes desde la direcci√≥n de su frontend.
```python
# main.py
from fastapi.middleware.cors import CORSMiddleware

# ...

origins = [
    "http://127.0.0.1:5500", # Direcci√≥n de Live Server
    "null", # Para file:///
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ...
```
Si todo est√° en su lugar, su servidor FastAPI est√° completamente listo.

---

#### **3. Reconfigurando la "antena" del Centro de Control de Misiones de vuelta a FastAPI**

Ahora lo m√°s interesante: los cambios m√≠nimos que debemos hacer en nuestro JavaScript para que funcione de nuevo con FastAPI.

**Paso 1: Cambiando la URL base**

Abra `api.js` y restaure `API_BASE_URL` a su valor original.
```javascript
// api.js

// Especificamos la URL de nuestra API FastAPI
const API_BASE_URL = 'http://127.0.0.1:8000'; // <-- ¬°Sin /api!

// ... el resto del c√≥digo de apiRequest ...
```

**Paso 2: Adaptaci√≥n a la estructura de respuesta de FastAPI**

Recordemos que nuestro `GET /spaceships` en FastAPI devuelve un **array simple**, no un objeto con paginaci√≥n. Esto significa que necesitamos restaurar el c√≥digo de `fetchAndDisplayFleet` a su forma original.

**Modifique la funci√≥n `fetchAndDisplayFleet` en `app.js`:**
```javascript
// app.js

async function fetchAndDisplayFleet() {
    try {
        fleetListContainer.innerHTML = '<p>Cargando telemetr√≠a de FastAPI...</p>';
        const ships = await apiRequest('/spaceships'); // <-- Solicitud a /spaceships

        // En FastAPI tenemos un array simple, ¬°as√≠ que la clave .data no es necesaria!

        fleetListContainer.innerHTML = '';
        if (ships.length === 0) {
            fleetListContainer.innerHTML = '<p>No hay naves en el registro.</p>';
            return;
        }

        ships.forEach(ship => {
            // Restauramos nuestra funci√≥n original para crear tarjetas
            const card = createShipCard(ship);
            fleetListContainer.appendChild(card);
        });
    } catch (error) {
        fleetListContainer.innerHTML = `<p style="color: #ff6b6b;">Error al cargar la flota: ${error.message}</p>`;
    }
}

// Funci√≥n original para crear tarjetas de naves
function createShipCard(ship) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <h3>${ship.name} (ID: ${ship.id})</h3>
        <p>Tipo: ${ship.type}</p>
        <p>A√±o de lanzamiento: ${ship.launch_year}</p>
        <p>Estado: ${ship.status}</p>
        <div class="card-actions">
            <button class="edit-btn" data-ship-id="${ship.id}">Editar</button>
            <button class="delete-btn" data-ship-id="${ship.id}">Dar de baja</button>
        </div>
    `;
    return card;
}
```

**Paso 3: Verificando las operaciones CRUD**

Dado que nuestros modelos Pydantic en FastAPI y los campos del formulario HTML coinciden (`name`, `type`, `launch_year`, `status`), las funciones `handleSaveShip` y `handleDeleteShip` deber√≠an funcionar **sin cambios**, ya que ya apuntan al endpoint `/spaceships`.

---

#### **4. Conclusiones de la comparaci√≥n: ¬øQu√© significa esto para un desarrollador frontend?**

- **Universalidad de REST:** Ha comprobado visualmente que para el frontend no importa en qu√© est√© escrito el backend (PHP/Laravel o Python/FastAPI), siempre que siga los principios de REST.
- **Importancia de la documentaci√≥n:** Las principales diferencias radicaron en las **URLs de los endpoints** y la **estructura de las respuestas JSON**. Esto es precisamente lo que debe describirse en la documentaci√≥n de la API. Sin ella, el desarrollador frontend trabajar√≠a "a ciegas".
- **Flexibilidad del frontend:** Su c√≥digo JavaScript debe ser lo suficientemente flexible para adaptarse f√°cilmente a diferentes formatos de datos (por ejemplo, verificar si hay una clave `data`, o si es simplemente un array).

**Conclusi√≥n:** La habilidad de trabajar con una API REST es una **clave universal** que abre las puertas a la interacci√≥n con cualquier backend moderno.

---

#### **Cuestionario de repaso**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. La principal diferencia en la URL entre nuestra API de Laravel y la API de FastAPI fue en...</p>
      <label><input type="radio" name="q1" value="a"> a) El uso de diferentes puertos</label>
      <label><input type="radio" name="q1" value="b"> b) La presencia del prefijo `/api` en Laravel</label>
      <label><input type="radio" name="q1" value="c"> c) El uso de HTTPS en FastAPI</label>
    </div>
    <div class="question">
      <p>2. ¬øCu√°l fue el principal cambio requerido en el c√≥digo JS al cambiar de la respuesta paginada de Laravel a un array simple de FastAPI?</p>
      <label><input type="radio" name="q2" value="a"> a) Dejar de acceder a `responseData.data` y usar `responseData` directamente</label>
      <label><input type="radio" name="q2" value="b"> b) Usar un m√©todo `fetch` diferente</label>
      <label><input type="radio" name="q2" value="c"> c) Cambiar el `Content-Type` en los encabezados</label>
    </div>
    <div class="question">
      <p>3. Este experimento demuestra que para un desarrollador frontend...</p>
      <label><input type="radio" name="q3" value="a"> a) Es importante conocer tanto PHP como Python</label>
      <label><input type="radio" name="q3" value="b"> b) Es importante entender los principios REST y saber leer la documentaci√≥n de la API</label>
      <label><input type="radio" name="q3" value="c"> c) Laravel y FastAPI son absolutamente id√©nticos</label>
    </div>
    <div class="question">
      <p>4. La configuraci√≥n de CORS es tarea de...</p>
      <label><input type="radio" name="q4" value="a"> a) El desarrollador frontend</label>
      <label><input type="radio" name="q4" value="b"> b) El administrador de sistemas</label>
      <label><input type="radio" name="q4" value="c"> c) El desarrollador backend</label>
    </div>
    <div class="question">
      <p>5. Si FastAPI utilizara paginaci√≥n, como en Laravel, ¬øqu√© tendr√≠amos que hacer en el frontend?</p>
      <label><input type="radio" name="q5" value="a"> a) Nada, el c√≥digo funcionar√≠a por s√≠ solo</label>
      <label><input type="radio" name="q5" value="b"> b) Cambiar de nuevo la l√≥gica para extraer el array de la clave `data` (o similar)</label>
      <label><input type="radio" name="q5" value="c"> c) Cambiar de `fetch` a la librer√≠a Axios</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'b', q4: 'c', q5: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;
if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumen del cap√≠tulo:**

Has cambiado con √©xito los "protocolos de comunicaci√≥n" de tu Centro de Control de Misi√≥n y has comparado en la pr√°ctica el trabajo con dos sistemas de backend diferentes.

- ‚úÖ Has consolidado la habilidad de configurar `API_BASE_URL` para cambiar entre servidores.
- ‚úÖ Has comprendido la importancia de la estructura de la respuesta (`data` vs un array simple) y c√≥mo adaptar el frontend a ella.
- ‚úÖ Te has dado cuenta de que un buen desarrollador frontend debe estar preparado para trabajar con cualquier API RESTful, estudiando cuidadosamente su documentaci√≥n.

**¬°Habilidad de acoplamiento universal adquirida!** Ahora que sabemos configurar la conexi√≥n b√°sica, es hora de hablar de protocolos m√°s complejos: CORS, autenticaci√≥n y seguridad.

> **üìå Verificaci√≥n:**

> - Aseg√∫rate de que tu servidor FastAPI est√° en ejecuci√≥n.
> - Aseg√∫rate de que has restaurado `API_BASE_URL` y la l√≥gica de manejo de respuestas en `app.js` a la variante para FastAPI.
> - Verifica que tu frontend realiza de nuevo correctamente todas las operaciones CRUD con el backend de FastAPI.

> **‚ö†Ô∏è Si hay errores:**

> - **CORS error:** Aseg√∫rate de que el servidor FastAPI est√° en ejecuci√≥n con la configuraci√≥n CORS correcta.
> - **Error `Cannot read properties of undefined (reading 'length')`:** Es posible que hayas olvidado eliminar la referencia a `.data` de `responseData`.
> - **404 Not Found:** Comprueba `API_BASE_URL` ‚Äî FastAPI no tiene el prefijo `/api`.
