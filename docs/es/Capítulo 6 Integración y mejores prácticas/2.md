# **Cap√≠tulo 6.2: Configuraci√≥n de CORS**
**Tiempo de estudio:** 30 minutos

---
#### **1. CORS: ¬øQu√© es y por qu√© es necesario?**

Como hemos descubierto, **CORS (Cross-Origin Resource Sharing)** es una pol√≠tica de seguridad del navegador. Previene la situaci√≥n en la que un sitio web malicioso `evil-site.com` en su nombre (usando sus cookies) realiza solicitudes a `your-bank.com` y roba datos.

**¬øC√≥mo funciona?**

1.  **Frontend (navegador)** desde el dominio `A` quiere obtener datos del dominio `B`.
2.  El navegador env√≠a al dominio `B` una solicitud "preliminar" especial (solicitud preflight) con el m√©todo `OPTIONS`, preguntando: "Oye, dominio `B`, ¬øpuedo, el dominio `A`, hacerte una solicitud `GET`?"
3.  **Backend (servidor en el dominio `B`)** debe responder con encabezados HTTP especiales, por ejemplo: `Access-Control-Allow-Origin: A`.
4.  Si la respuesta del servidor permite la solicitud, el navegador env√≠a la solicitud `GET` principal. Si no, la bloquea y emite un error CORS.

> üí° **Analog√≠a espacial:**

> Antes de teletransportar al capit√°n a una estaci√≥n extranjera (enviar una solicitud `POST`), la nave (navegador) env√≠a un dron (solicitud `OPTIONS`) con la pregunta: "Estaci√≥n, ¬øaceptan teletransportaci√≥n desde la nave 'Enterprise'?". La estaci√≥n (API) responde: "S√≠, la recepci√≥n desde la 'Enterprise' est√° permitida" (encabezado `Access-Control-Allow-Origin`). Solo despu√©s de eso comienza la teletransportaci√≥n.

---

#### **2. Configuraci√≥n de CORS en Laravel (Enfoque moderno para Laravel 11+)**
En Laravel 11+, la configuraci√≥n de CORS se ha vuelto mucho m√°s sencilla y no requiere la publicaci√≥n del archivo `config/cors.php` si necesita configuraciones b√°sicas. Todo se gestiona a trav√©s de los archivos `.env` y `bootstrap/app.php`.

**Paso 1: Configuraci√≥n a trav√©s de variables de entorno**

Abra su archivo `.env`. Laravel ya proporciona variables predeterminadas para gestionar CORS para las API.

```env
# .env

# ... otras variables

# Especifique las rutas para las cuales CORS estar√° activo.
# 'api/*' - valor est√°ndar para todas las rutas API.
CORS_PATHS=api/*

# Especifique los or√≠genes permitidos (dominios).
# Para desarrollo, especifique la direcci√≥n de su frontend.
# Se pueden enumerar separados por comas, sin espacios.
CORS_ALLOWED_ORIGINS=http://localhost:5500,http://127.0.0.1:5500

# Otras configuraciones (generalmente se pueden dejar por defecto)
CORS_ALLOWED_METHODS=*
CORS_ALLOWED_HEADERS=*
CORS_EXPOSED_HEADERS=
CORS_MAX_AGE=0
CORS_SUPPORTS_CREDENTIALS=false
```

**Variables clave:**

- `CORS_ALLOWED_ORIGINS`: **La variable m√°s importante.** Aqu√≠ enumera los dominios desde los cuales se permiten las solicitudes. `*` permite a todos, pero esto es

**extremadamente inseguro para producci√≥n**.

- `CORS_PATHS`: Rutas a las que se aplican estas reglas. `api/*` significa todo lo que comienza con `/api/`.

Despu√©s de cambiar `.env` **no es necesario** reiniciar el servidor si est√° usando `php artisan serve`. Los cambios se aplicar√°n autom√°ticamente.

**Paso 2 (Opcional): Configuraci√≥n avanzada en `bootstrap/app.php`**

Si necesita una l√≥gica m√°s compleja (por ejemplo, permitir subdominios usando patrones), a√∫n tendr√° que publicar el archivo de configuraci√≥n y configurar el middleware. Pero para el 95% de los casos, el archivo `.env` es suficiente.

El comando `php artisan install:api` configura autom√°ticamente el middleware CORS b√°sico para las rutas de la API en el archivo `bootstrap/app.php`. Se ve as√≠:

```php
// bootstrap/app.php
->withMiddleware(function (Middleware $middleware) {
    // Esta l√≠nea ya ser√° a√±adida por el comando install:api
    // Es la que habilita el procesamiento de CORS para todas las rutas API
    $middleware->api(base_path('routes/api.php'));
})
```

Dentro de `->api()`, Laravel ya usa el middleware `HandleCors`, que lee las configuraciones de su `.env`. Todo es simple y viene listo para usar.

> ‚ö†Ô∏è **¬°Importante!** No use `CORS_ALLOWED_ORIGINS='*'` en un servidor de producci√≥n si su API no es completamente p√∫blica. Esto abre una vulnerabilidad potencial. Siempre enumere los dominios espec√≠ficos de su frontend.

---

#### **3. Configuraci√≥n de CORS en FastAPI**

FastAPI utiliza el concepto de **Middleware** (software intermedio) para manejar tareas transversales como CORS.

**Paso 1: Abra el archivo principal de su aplicaci√≥n**

Este es el archivo donde crea la instancia de FastAPI (normalmente `main.py`).

**Paso 2: A√±ada `CORSMiddleware`**

FastAPI proporciona un middleware listo para usar para la configuraci√≥n de CORS.

```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware # 1. Importamos el middleware

app = FastAPI(
    title="SpaceAPI",
    description="API para gesti√≥n de planetas en la galaxia",
    version="1.0.0"
)

# 2. Lista de or√≠genes permitidos (origins)
origins = [
    "http://localhost:5500",
    "http://127.0.0.1:5500",
    # En producci√≥n, aqu√≠ estar√° el dominio de su frontend
    # "https://my-awesome-app.com",
]

# 3. A√±adimos el middleware a la aplicaci√≥n
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # Permitimos los or√≠genes especificados
    allow_credentials=True, # Permitimos las cookies (ser√° necesario para la autenticaci√≥n)
    allow_methods=["*"],    # Permitimos todos los m√©todos (GET, POST, etc.)
    allow_headers=["*"],    # Permitimos todos los encabezados
)

# ... aqu√≠ sus routers y el resto del c√≥digo
```

**Paso 3: Reinicie el servidor Uvicorn**
El servidor Uvicorn normalmente se recarga autom√°ticamente al cambiar el c√≥digo. Si no, rein√≠cielo manualmente. Ahora su servidor FastAPI responder√° correctamente a las solicitudes `OPTIONS` desde el frontend.

---

#### **Cuestionario de repaso**


<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. La solicitud que el navegador env√≠a antes de la principal para verificar CORS se llama:</p>
      <label><input type="radio" name="q1" value="a"> a) CHECK request</label>
      <label><input type="radio" name="q1" value="b"> b) Preflight request</label>
      <label><input type="radio" name="q1" value="c"> c) Handshake request</label>
    </div>
    <div class="question">
      <p>2. En Laravel moderno (11+), las configuraciones b√°sicas de CORS se establecen principalmente en:</p>
      <label><input type="radio" name="q2" value="a"> a) El archivo bootstrap/app.php</label>
      <label><input type="radio" name="q2" value="b"> b) El archivo .env</label>
      <label><input type="radio" name="q2" value="c"> c) El archivo routes/api.php</label>
    </div>
    <div class="question">
      <p>3. En FastAPI, para configurar CORS se utiliza:</p>
      <label><input type="radio" name="q3" value="a"> a) El decorador @app.cors()</label>
      <label><input type="radio" name="q3" value="b"> b) La clase incorporada Security</label>
      <label><input type="radio" name="q3" value="c"> c) El middleware</label>
    </div>
    <div class="question">
      <p>4. ¬øQu√© valor de CORS_ALLOWED_ORIGINS es el m√°s seguro para producci√≥n?</p>
      <label><input type="radio" name="q4" value="a"> a) CORS_ALLOWED_ORIGINS='*'</label>
      <label><input type="radio" name="q4" value="b"> b) CORS_ALLOWED_ORIGINS=http://my-frontend.com,https://my-frontend.com</label>
      <label><input type="radio" name="q4" value="c"> c) No establecer esta variable</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Su resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumen del cap√≠tulo:**

¬°Se ha convertido en un "diplom√°tico de comunicaciones interestelares"! Sus APIs ahora pueden interactuar de forma segura con aplicaciones externas, utilizando enfoques modernos y correctos.
- ‚úÖ Entendimos el mecanismo de funcionamiento de CORS y las solicitudes preflight.
- üîß Configuramos CORS para Laravel 11+ a trav√©s del archivo `.env`.
- ‚öôÔ∏è Configuramos CORS para FastAPI usando `CORSMiddleware`.
- üõ∞Ô∏è Establecimos con √©xito la conexi√≥n entre el frontend y el backend.

**El puente de comunicaci√≥n est√° construido y protegido.** Ahora podemos pensar en c√≥mo permitir que solo "personal autorizado" utilice este puente.

> **üìå Verificaci√≥n:**

> - El criterio principal de √©xito es la ausencia de errores CORS en la consola del navegador al solicitar datos desde el frontend.
> - En la pesta√±a "Network" (Red) de las herramientas del desarrollador, puede ver dos solicitudes a su API: la primera con el m√©todo `OPTIONS` (estado 200/204) y la segunda con el m√©todo `GET` (estado 200). Esta es una demostraci√≥n clara del funcionamiento de CORS.
