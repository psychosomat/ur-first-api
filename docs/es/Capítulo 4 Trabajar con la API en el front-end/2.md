# **Cap√≠tulo 4.2: Env√≠o de solicitudes GET**
**Tiempo de estudio:** 45 minutos

---

#### **1. GET: Solicitud de telemetr√≠a de la flota espacial**
Una **solicitud GET** es el comando principal para obtener datos. En nuestro MCC (Centro de Control de Misiones), esto es equivalente a la solicitud: "¬°Centro de Gesti√≥n de Flotas, informen la situaci√≥n!"

Usaremos `fetch` para enviar dos tipos de solicitudes GET a nuestro servidor FastAPI:

1.  **Obtener la colecci√≥n completa:** "Mu√©strame toda mi flota".
2.  **Obtener un solo recurso:** "Dame informaci√≥n detallada sobre la nave con ID 2".

> üí° **Analog√≠a espacial:**

> `GET /spaceships` es una solicitud de difusi√≥n a toda la flota pidiendo que informen sus distintivos de llamada.

> `GET /spaceships/3` es una solicitud dirigida a una nave espec√≠fica (ISS) pidiendo que transmita datos completos sobre sus sistemas.

---

#### **2. Problema de CORS: "Interferencia interplanetaria"**
Antes de enviar la solicitud, debemos resolver un problema importante. Por defecto, por razones de seguridad, los navegadores impiden que una p√°gina web (nuestro MCC), cargada desde un "dominio" (`file:///...` o `http://localhost:5500`), realice solicitudes a una API en otro "dominio" (`http://127.0.0.1:8000`).

Esta pol√≠tica se llama **CORS (Cross-Origin Resource Sharing)**.

Para permitir que nuestro frontend se comunique con el backend, debemos configurar el servidor FastAPI para que le diga al navegador: "Est√° bien, conf√≠o en las solicitudes de esta direcci√≥n".

**Paso 1: Instalar `python-multipart`**
Esto es necesario para que el middleware funcione correctamente.
```bash
pip install python-multipart
```

**Paso 2: Configurar CORS en `main.py`**
Abre tu archivo `main.py` del proyecto FastAPI y a√±ade el siguiente c√≥digo:
```python
# main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware  # <-- Importamos el middleware

# ... tu c√≥digo restante (modelos, db_spaceships) ...

app = FastAPI(
    title="Fleet Management API",
    # ...
)

# --- CONFIGURACI√ìN CORS ---
# Especificamos qu√© "dominios" (origins) pueden enviar solicitudes
origins = [
    "http://localhost",
    "http://localhost:8080",
    "http://127.0.0.1:5500",  # Direcci√≥n para Live Server en VS Code
    "null"  # Para solicitudes desde archivos locales file:///
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,  # Permitimos los origins especificados
    allow_credentials=True,
    allow_methods=["*"],  # Permitimos todos los m√©todos (GET, POST, etc.)
    allow_headers=["*"],  # Permitimos todos los encabezados
)

# --- TUS ENDPOINTS ABAJO ---
@app.get("/")
# ...
```
Ahora nuestro servidor API est√° listo para aceptar solicitudes del frontend. **¬°Reinicia `uvicorn`** para que los cambios surtan efecto!

---

#### **3. Obtener la lista de todas las naves**
Crearemos una interfaz para mostrar nuestra flota.

**Paso 1: Actualizar `index.html`**
```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MCC - Gesti√≥n de Flotas</title>
    <style>
        body { font-family: sans-serif; }
        .ship-list { list-style: none; padding: 0; }
        .ship-list li { border: 1px solid #ccc; margin-bottom: 10px; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Panel de control de la flota espacial</h1>

    <button id="load-fleet-btn">Solicitar datos de la flota</button>

    <h2>Lista de naves:</h2>
    <ul id="fleet-list" class="ship-list">
        <li>Esperando comando...</li>
    </ul>

    <script src="app.js"></script> <!-- Conectando script externo -->
</body>
</html>
```

**Paso 2: Crear `app.js`**
Junto a `index.html`, crea el archivo `app.js`. En √©l, trasladaremos toda la l√≥gica.
```javascript
// app.js

const API_BASE_URL = 'http://127.0.0.1:8000'; // URL de nuestro servidor FastAPI

const loadFleetBtn = document.getElementById('load-fleet-btn');
const fleetList = document.getElementById('fleet-list');

// Funci√≥n para cargar y mostrar la flota
async function fetchAndDisplayFleet() {
    try {
        fleetList.innerHTML = '<li>Cargando telemetr√≠a...</li>';

        // Enviamos una solicitud GET a /spaceships
        const response = await fetch(`${API_BASE_URL}/spaceships`);

        if (!response.ok) {
            throw new Error(`Error de red: ${response.status}`);
        }

        const ships = await response.json(); // Obtenemos un array de naves

        // Limpiamos la lista y mostramos los datos
        fleetList.innerHTML = '';
        if (ships.length === 0) {
            fleetList.innerHTML = '<li>No hay ninguna nave en el registro.</li>';
            return;
        }

        ships.forEach(ship => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <strong>${ship.name} (ID: ${ship.id})</strong><br>
                Tipo: ${ship.type}<br>
                A√±o de lanzamiento: ${ship.launch_year}<br>
                Estado: ${ship.status}
            `;
            fleetList.appendChild(listItem);
        });

    } catch (error) {
        console.error('No se pudieron cargar los datos de la flota:', error);
        fleetList.innerHTML = `<li>Error: ${error.message}</li>`;
    }
}

// A√±adimos el manejador de eventos al bot√≥n
loadFleetBtn.addEventListener('click', fetchAndDisplayFleet);
```

- **async/await:** Hemos utilizado una sintaxis nueva y m√°s conveniente para trabajar con promesas. La analizaremos en detalle en el Cap√≠tulo 4.5. Por ahora, simplemente sepan que `await` "espera" la ejecuci√≥n de una promesa sin bloquear la p√°gina.
- `try...catch`: Una excelente manera de manejar errores en funciones `async`.

**Paso 3: Probar**
Abre `index.html` en tu navegador (preferiblemente a trav√©s de la extensi√≥n Live Server en VS Code, que lo ejecutar√° en `http://127.0.0.1:5500`). Haz clic en el bot√≥n "Solicitar datos de la flota". ¬°La lista de tus naves de FastAPI deber√≠a aparecer en la p√°gina!

---

#### **4. Obtener los datos de una sola nave**
Ahora a√±adiremos un formulario para solicitar informaci√≥n por ID espec√≠fico.

**Paso 1: A√±adir formulario en `index.html`**
```html
<!-- index.html, despu√©s de la lista -->
<hr>
<h2>Solicitud por ID</h2>
<form id="ship-form">
    <input type="number" id="ship-id-input" placeholder="Introduce el ID de la nave" required>
    <button type="submit">Buscar nave</button>
</form>
<div id="ship-details" class="ship-list"></div>
```

**Paso 2: A√±adir l√≥gica en `app.js`**
```javascript
// app.js, al final del archivo

const shipForm = document.getElementById('ship-form');
const shipIdInput = document.getElementById('ship-id-input');
const shipDetails = document.getElementById('ship-details');

async function fetchShipById(event) {
    event.preventDefault(); // Prevenimos la recarga de la p√°gina
    const shipId = shipIdInput.value;

    if (!shipId) {
        alert('Por favor, introduce un ID.');
        return;
    }

    try {
        shipDetails.innerHTML = '<li>Buscando nave...</li>';

        // Enviamos una solicitud GET a /spaceships/{id}
        const response = await fetch(`${API_BASE_URL}/spaceships/${shipId}`);

        if (response.status === 404) {
             throw new Error('Nave con ese ID no encontrada en el registro.');
        }
        if (!response.ok) {
            throw new Error(`Error de red: ${response.status}`);
        }

        const ship = await response.json();

        shipDetails.innerHTML = `
            <li>
                <strong>${ship.name} (ID: ${ship.id})</strong><br>
                Tipo: ${ship.type}<br>
                A√±o de lanzamiento: ${ship.launch_year}<br>
                Estado: ${ship.status}
            </li>
        `;
    } catch (error) {
        console.error(`Error al buscar la nave ${shipId}:`, error);
        shipDetails.innerHTML = `<li>Error: ${error.message}</li>`;
    }
}

shipForm.addEventListener('submit', fetchShipById);
```

- Hemos a√±adido un manejo separado para el estado `404` para proporcionar al usuario un mensaje de error m√°s claro.

**Paso 3: Probar**
Actualiza la p√°gina, introduce el ID de una nave existente (por ejemplo, 1) y haz clic en "Buscar nave". Deber√≠as ver sus datos. Intenta introducir un ID inexistente (por ejemplo, 99) ‚Äî ver√°s un mensaje de error.

---

#### **Cuestionario para consolidar**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. La pol√≠tica CORS en el navegador es necesaria para...</p>
      <label><input type="radio" name="q1" value="a"> a) Acelerar la carga de p√°ginas</label>
      <label><input type="radio" name="q1" value="b"> b) Proteger contra solicitudes intersitio maliciosas</label>
      <label><input type="radio" name="q1" value="c"> c) Comprimir datos JSON</label>
    </div>
    <div class="question">
      <p>2. Para permitir que el frontend en `localhost:5500` acceda a FastAPI, es necesario...</p>
      <label><input type="radio" name="q2" value="a"> a) Configurar `CORSMiddleware` en FastAPI</label>
      <label><input type="radio" name="q2" value="b"> b) Cambiar la configuraci√≥n del navegador</label>
      <label><input type="radio" name="q2" value="c"> c) No es necesario hacer nada, funciona por defecto</label>
    </div>
    <div class="question">
      <p>3. Para obtener datos sobre un recurso espec√≠fico con ID=5, la URL de la solicitud se ver√° as√≠:</p>
      <label><input type="radio" name="q3" value="a"> a) `/resources?id=5`</label>
      <label><input type="radio" name="q3" value="b"> b) `/resources/5`</label>
      <label><input type="radio" name="q3" value="c"> c) `/get/resources/5`</label>
    </div>
    <div class="question">
      <p>4. La palabra clave `await` en JavaScript solo se puede usar dentro de una funci√≥n declarada con...</p>
      <label><input type="radio" name="q4" value="a"> a) `function`</label>
      <label><input type="radio" name="q4" value="b"> b) `promise`</label>
      <label><input type="radio" name="q4" value="c"> c) `async`</label>
    </div>
    <div class="question">
      <p>5. `event.preventDefault()` en el manejador de env√≠o de formularios es necesario para...</p>
      <label><input type="radio" name="q5" value="a"> a) Prevenir el comportamiento predeterminado del navegador (recarga de la p√°gina)</label>
      <label><input type="radio" name="q5" value="b"> b) Detener la ejecuci√≥n del script</label>
      <label><input type="radio" name="q5" value="c"> c) Cancelar el env√≠o de la solicitud</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'a', q3: 'b', q4: 'c', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ Resumen del cap√≠tulo:**

¬°Has configurado con √©xito un canal de comunicaci√≥n entre "Tierra" y "espacio" y has aprendido a solicitar telemetr√≠a!

- üõ°Ô∏è Has resuelto el problema de la "interferencia interplanetaria" configurando **CORS** en tu servidor FastAPI.
- üõ∞Ô∏è Has implementado una funci√≥n para obtener y mostrar la **lista completa** de naves espaciales.
- üî≠ Has creado una interfaz para solicitar datos sobre un **aparato espec√≠fico** por su ID.

**¬°El Centro de Control de la Misi√≥n recibe datos!** En el pr√≥ximo cap√≠tulo, pasaremos a la acci√≥n: enviaremos comandos para crear, actualizar y eliminar nuestras naves espaciales.

> **üìå Verificaci√≥n:**

> - Aseg√∫rate de que tu servidor FastAPI est√© en ejecuci√≥n con `CORSMiddleware` configurado.
> - Verifica que al hacer clic en el bot√≥n "Solicitar datos" en la p√°gina aparezca la lista de naves.
> - Aseg√∫rate de que el formulario de b√∫squeda por ID encuentre correctamente las naves existentes e informe un error para las que no existen.

> **‚ö†Ô∏è Si hay errores:**

> - **CORS error en la consola del navegador:** O no has reiniciado `uvicorn` despu√©s de a√±adir `CORSMiddleware`, o la direcci√≥n de tu frontend (por ejemplo, `http://127.0.0.1:5500`) no est√° a√±adida a la lista de `origins`.
> - **Failed to fetch:** Verifica que tu servidor FastAPI est√© en ejecuci√≥n y accesible en la direcci√≥n indicada en `API_BASE_URL`.
