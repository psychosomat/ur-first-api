# **Cap√≠tulo 4.3: Env√≠o de solicitudes POST/PUT/DELETE**
**Tiempo de estudio:** 1 hora

---

#### **1. Comandos activos: Del lanzamiento al desguace**
Hasta ahora, nuestro Centro de Control de Misi√≥n solo solicitaba informaci√≥n (`GET`). Ahora aprenderemos a enviar **comandos activos**:

- **POST:** "¬°Lanzar un nuevo sat√©lite a √≥rbita!"
- **PUT:** "¬°Realizar una modernizaci√≥n completa de los sistemas en la EEI!"
- **DELETE:** "¬°Retirar de √≥rbita la antigua nave `Debris-123`!"

Para ello, utilizaremos `fetch`, pero con par√°metros adicionales que describen nuestro comando.

> üí° **Analog√≠a espacial:**

> Si `GET` es una escucha pasiva del √©ter radiof√≥nico, entonces `POST`, `PUT` y `DELETE` son **transmisiones de comandos activas**. Para ello, no solo necesitamos especificar la "frecuencia" (URL), sino tambi√©n el **contenido del comando** (cuerpo de la solicitud) y el **protocolo de comunicaci√≥n** (encabezados).

---

#### **2. Env√≠o de solicitud POST: Lanzamiento de una nueva nave**
Para crear un nuevo recurso, enviamos una solicitud `POST`. Lo m√°s importante aqu√≠ es pasar el **cuerpo (body)** de la solicitud con los datos del nuevo objeto.

**Paso 1: A√±adimos el formulario de creaci√≥n en `index.html`**
Lo colocaremos despu√©s del bloque "Solicitud por ID".
```html
<!-- index.html -->
<hr>
<h2>Lanzar una nueva nave</h2>
<form id="create-ship-form">
    <input type="text" id="create-name" placeholder="Nombre" required><br>
    <input type="text" id="create-type" placeholder="Tipo" required><br>
    <input type="number" id="create-year" placeholder="A√±o de lanzamiento" required><br>
    <input type="text" id="create-status" placeholder="Estado" required><br>
    <button type="submit">Lanzar</button>
</form>
<div id="create-status-message"></div>
```

**Paso 2: A√±adimos la l√≥gica en `app.js`**
```javascript
// app.js, al final del archivo

const createShipForm = document.getElementById('create-ship-form');
const createStatusMessage = document.getElementById('create-status-message');

async function createShip(event) {
    event.preventDefault();

    // 1. Recopilamos los datos del formulario en un objeto
    const shipData = {
        name: document.getElementById('create-name').value,
        type: document.getElementById('create-type').value,
        launch_year: parseInt(document.getElementById('create-year').value),
        status: document.getElementById('create-status').value
    };

    try {
        createStatusMessage.textContent = 'Enviando comando de lanzamiento...';

        // 2. Enviamos la solicitud fetch con par√°metros
        const response = await fetch(`${API_BASE_URL}/spaceships`, {
            method: 'POST', // Indicamos el m√©todo
            headers: {
                'Content-Type': 'application/json' // Le decimos al servidor que enviamos JSON
            },
            body: JSON.stringify(shipData) // Convertimos el objeto JavaScript en una cadena JSON
        });

        if (!response.ok) {
            // Si el servidor devolvi√≥ un error, intentamos leer su cuerpo
            const errorData = await response.json();
            throw new Error(errorData.detail || `Error del servidor: ${response.status}`);
        }

        const newShip = await response.json();
        createStatusMessage.textContent = `üöÄ ¬°Lanzamiento exitoso! La nave ha recibido el ID: ${newShip.id}`;

        createShipForm.reset(); // Limpiamos el formulario
        fetchAndDisplayFleet(); // Actualizamos la lista general de la flota

    } catch (error) {
        console.error('Error al lanzar la nave:', error);
        createStatusMessage.textContent = `üî¥ Error: ${error.message}`;
    }
}

createShipForm.addEventListener('submit', createShip);
```
**Puntos clave de `fetch` para POST:**

- **`method: 'POST'`**: Es obligatorio especificar el m√©todo HTTP.
- **`headers: { 'Content-Type': 'application/json' }`**: Un encabezado cr√≠ticamente importante. Le informa a nuestro servidor FastAPI que el cuerpo de la solicitud contiene JSON y que debe ser parseado.
- **`body: JSON.stringify(shipData)`**: No podemos enviar un objeto JavaScript directamente. Necesita ser serializado (convertido) a una cadena JSON.

---

#### **3. Env√≠o de solicitud DELETE: Desguace de una nave**
La solicitud de eliminaci√≥n es m√°s sencilla: generalmente no necesita un cuerpo, solo la URL con el ID del objeto.

**Paso 1: A√±adimos un bot√≥n "Eliminar" a nuestra lista de naves**
Modificaremos la funci√≥n `fetchAndDisplayFleet` en `app.js` para que a√±ada un bot√≥n de eliminaci√≥n a cada elemento.
```javascript
// app.js, dentro de la funci√≥n fetchAndDisplayFleet

// ...
ships.forEach(ship => {
    const listItem = document.createElement('li');
    // A√±adimos un bot√≥n con un atributo data que almacena el ID
    listItem.innerHTML = `
        <strong>${ship.name} (ID: ${ship.id})</strong><br>
        Tipo: ${ship.type} | A√±o: ${ship.launch_year} | Estado: ${ship.status}<br>
        <button class="delete-btn" data-ship-id="${ship.id}">Desguazar nave</button>
    `;
    fleetList.appendChild(listItem);
});
// ...
```

**Paso 2: A√±adimos un controlador para todos los botones "Eliminar"**
Usamos delegaci√≥n de eventos: un solo controlador para toda la lista.
```javascript
// app.js, al final del archivo

async function deleteShip(shipId) {
    if (!confirm(`¬øEst√°s seguro de que quieres desguazar la nave con ID ${shipId}? Esta acci√≥n es irreversible.`)) {
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/spaceships/${shipId}`, {
            method: 'DELETE' // Indicamos el m√©todo
        });

        if (!response.ok) {
            throw new Error(`No se pudo desguazar la nave. Estado: ${response.status}`);
        }

        alert(`Nave con ID ${shipId} desguazada con √©xito.`);
        fetchAndDisplayFleet(); // Actualizamos la lista

    } catch (error) {
        console.error('Error al desguazar:', error);
        alert(`Error: ${error.message}`);
    }
}

// Delegaci√≥n de eventos: escuchamos clics en toda la lista
fleetList.addEventListener('click', (event) => {
    // Verificamos si el clic fue en un bot√≥n con la clase 'delete-btn'
    if (event.target.classList.contains('delete-btn')) {
        const shipId = event.target.dataset.shipId; // Obtenemos el ID del atributo data
        deleteShip(shipId);
    }
});
```

**Paso 3: A√±adimos id al modelo Spaceship**

A√±adimos id en el modelo y la base de datos en el archivo `main.py`

```python
class Spaceship(BaseModel):
    id: int
	# El resto del c√≥digo del modelo...

db_spaceships = {
    1: {
        "id": 1,
        # Datos del elemento 1
    },
    2: {
        "id": 2,
        # Datos del elemento 2
    },
    3: {
        "id": 3,
		# Datos del elemento 3
    }
}
```


- **`method: 'DELETE'`**: Indicamos el m√©todo. El cuerpo y los encabezados no son necesarios aqu√≠.
- `confirm()`: Una sencilla ventana de confirmaci√≥n integrada para evitar eliminar algo importante por error.

---

#### **4. Env√≠o de solicitud PUT (Tarea independiente)**
La implementaci√≥n de una solicitud `PUT` para actualizaci√≥n es muy similar a `POST`.

**Tu misi√≥n, si decides aceptarla:**

1.  A√±adir un bot√≥n "Modificar" junto al bot√≥n "Eliminar" para cada nave.
2.  Al hacer clic en "Modificar", rellenar el formulario (se puede usar el mismo que para crear) con los datos actuales de la nave.
3.  Cambiar el texto del bot√≥n "Lanzar" a "Actualizar".
4.  Al enviar el formulario, enviar una solicitud `PUT` a ` /spaceships/{id}` con el cuerpo completo del objeto.
5.  Despu√©s de una actualizaci√≥n exitosa, actualizar la lista de la flota.

> **Sugerencia:** Necesitar√°s `fetch` con `method: 'PUT'`, encabezados `Content-Type` y `body` con `JSON.stringify()`, exactamente igual que en la solicitud `POST`.

---

#### **Cuestionario de repaso**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>
<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. ¬øQu√© par√°metro de `fetch` se utiliza para pasar datos en el cuerpo de la solicitud?</p>
      <label><input type="radio" name="q1" value="a"> a) `data`</label>
      <label><input type="radio" name="q1" value="b"> b) `body`</label>
      <label><input type="radio" name="q1" value="c"> c) `payload`</label>
    </div>
    <div class="question">
      <p>2. El encabezado `'Content-Type': 'application/json'` le indica al servidor que...</p>
      <label><input type="radio" name="q2" value="a"> a) El cliente espera recibir una respuesta en formato JSON</label>
      <label><input type="radio" name="q2" value="b"> b) El cliente env√≠a datos en el cuerpo de la solicitud en formato JSON</label>
      <label><input type="radio" name="q2" value="c"> c) La conexi√≥n debe estar cifrada</label>
    </div>
    <div class="question">
      <p>3. ¬øQu√© hace la funci√≥n `JSON.stringify(obj)` en JavaScript?</p>
      <label><input type="radio" name="q3" value="a"> a) Convierte una cadena JSON en un objeto</label>
      <label><input type="radio" name="q3" value="b"> b) Valida la validez del objeto</label>
      <label><input type="radio" name="q3" value="c"> c) Convierte un objeto JavaScript en una cadena JSON</label>
    </div>
    <div class="question">
      <p>4. Para enviar una solicitud `DELETE` usando `fetch` es obligatorio especificar:</p>
      <label><input type="radio" name="q4" value="a"> a) Un cuerpo `body` vac√≠o</label>
      <label><input type="radio" name="q4" value="b"> b) `method: 'DELETE'`</label>
      <label><input type="radio" name="q4" value="c"> c) El encabezado `Authorization`</label>
    </div>
    <div class="question">
      <p>5. La delegaci√≥n de eventos en JavaScript es cuando...</p>
      <label><input type="radio" name="q5" value="a"> a) Adjuntamos un √∫nico controlador al elemento padre en lugar de m√∫ltiples a los elementos hijos</label>
      <label><input type="radio" name="q5" value="b"> b) Transferimos el derecho de ejecutar una funci√≥n a otro script</label>
      <label><input type="radio" name="q5" value="c"> c) El evento ocurre con un retraso</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'b', q2: 'b', q3: 'c', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;

      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>


---

**üöÄ Resumen del cap√≠tulo:**

¬°Su Centro de Control de Misi√≥n ahora tiene un conjunto completo de comandos para gestionar la flota!

- ‚úÖ Ha aprendido a enviar solicitudes `POST` con cuerpo y encabezados para crear nuevos recursos.
- ‚úÖ Ha implementado solicitudes `DELETE` para dar de baja equipos obsoletos.
- ‚úÖ Se le ha asignado la tarea de implementar una solicitud `PUT`, consolidando sus conocimientos.

**¬°Control total establecido!** Pero, ¬øqu√© hacer si la comunicaci√≥n se interrumpe o el servidor informa un error? En el pr√≥ximo cap√≠tulo, crearemos un sistema centralizado de manejo de errores en el frontend.

> **üìå Verificaci√≥n:**

> - Aseg√∫rese de que el formulario de creaci√≥n de nuevas naves funcione y que la lista en la p√°gina se actualice despu√©s de una creaci√≥n exitosa.
> - Verifique que el bot√≥n "Dar de baja equipo" funcione, solicite confirmaci√≥n y elimine la nave de la lista.
> - Intente crear una nave con datos no v√°lidos (por ejemplo, con un nombre muy corto) y observe el error que devolver√° su servidor FastAPI.

> **‚ö†Ô∏è Si hay errores:**

> - **Error `422` del servidor:** Lo m√°s probable es que los datos que est√° enviando no pasen la validaci√≥n de Pydantic. Verifique la consola del navegador ‚Äî `errorData.detail` mostrar√° en qu√© campo est√° el problema.
> - **Error `415 Unsupported Media Type`:** Olvid√≥ a√±adir el encabezado `'Content-Type': 'application/json'`.
> - **Los botones de eliminaci√≥n no funcionan:** Verifique si la delegaci√≥n de eventos funciona correctamente y si est√° obteniendo `shipId` de `data-ship-id` correctamente.
