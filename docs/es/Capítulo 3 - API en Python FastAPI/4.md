# **Cap√≠tulo 3.4: Operaciones CRUD para naves espaciales**
**Tiempo de estudio:** 1 hora

---

#### **1. CRUD: Ciclo completo de gesti√≥n de misiones espaciales**
Hasta ahora, solo hemos le√≠do datos (`Read`). Pero un verdadero Centro de Control de Misiones debe ser capaz de todo:

- **C**reate (Crear): Lanzar un nuevo sat√©lite a √≥rbita.
- **R**ead (Leer): Solicitar el estado de una nave existente.
- **U**pdate (Actualizar): Corregir la √≥rbita o actualizar el software.
- **D**elete (Eliminar): Retirar un sat√©lite antiguo de √≥rbita.

Estas cuatro operaciones ‚Äî **CRUD** ‚Äî constituyen la base de la mayor√≠a de las API. En este cap√≠tulo, implementaremos el ciclo completo para gestionar nuestra flota.

---

#### **2. Create: Lanzamiento de una nueva nave (POST)**
Para crear una nueva nave espacial, utilizaremos el m√©todo `POST`. Los datos para la nueva nave se enviar√°n en el cuerpo de la solicitud en formato JSON.

**Paso 1: Creamos un nuevo modelo Pydantic para los datos entrantes**
¬øPor qu√© se necesita un nuevo modelo? Porque al crear una nave, no conocemos su `id` ‚Äî este debe ser asignado por el servidor.

**A√±ada este modelo a `main.py`:**
```python
# main.py
from pydantic import BaseModel, Field

class SpaceshipCreate(BaseModel):
    """Modelo para crear una nueva nave (sin ID)."""
    name: str = Field(..., min_length=3, max_length=50)
    type: str
    launch_year: int = Field(..., gt=1950)
    status: str
```
Este modelo es casi id√©ntico a `Spaceship`, pero se utilizar√° para la **validaci√≥n de datos entrantes**.

**Paso 2: Implementamos el endpoint `POST /spaceships`**
```python
# main.py
import random # A√±ada esta importaci√≥n al principio del archivo

# ... resto del c√≥digo ...

@app.post("/spaceships", response_model=Spaceship, status_code=201)
def create_spaceship(ship: SpaceshipCreate):
    """
    A√±ade una nueva nave espacial al registro.
    """
    # Generamos un nuevo ID √∫nico para la nave
    new_id = max(db_spaceships.keys() or [0]) + 1

    # Creamos un objeto de nave que corresponde al modelo completo Spaceship
    new_ship = Spaceship(id=new_id, **ship.dict())

    # Guardamos en nuestra "base de datos"
    db_spaceships[new_id] = new_ship.dict()

    return new_ship
```
**Desglose:**

- `@app.post(...)`: Usamos el decorador para solicitudes `POST`.
- `status_code=201`: Indicamos que, en caso de creaci√≥n exitosa, se debe devolver el estado `201 Created`.
- `ship: SpaceshipCreate`: ¬°Aqu√≠ est√° la magia! FastAPI tomar√° autom√°ticamente el cuerpo de la solicitud (JSON), lo validar√° seg√∫n el modelo `SpaceshipCreate` y lo pasar√° a la funci√≥n como un objeto `ship`.
- `new_id = ...`: L√≥gica simple para generar un nuevo ID.
- `**ship.dict()`: "Desempaquetamos" los datos del modelo `ship` recibido en nuestro modelo completo.
- `response_model=Spaceship`: La respuesta corresponder√° al modelo completo, incluyendo el `id`.

---

#### **3. Update: Correcci√≥n de rumbo (PUT)**
Para la actualizaci√≥n completa de un recurso existente, se utiliza el m√©todo `PUT`.

**Implementamos el endpoint `PUT /spaceships/{ship_id}`:**
```python
# main.py
from fastapi import FastAPI, HTTPException # Actualice la importaci√≥n

# ... resto del c√≥digo ...

@app.put("/spaceships/{ship_id}", response_model=Spaceship)
def update_spaceship(ship_id: int, ship_update: SpaceshipCreate):
    """
    Actualiza completamente los datos de una nave espacial.
    """
    if ship_id not in db_spaceships:
        raise HTTPException(status_code=404, detail="Nave espacial no encontrada")

    updated_ship = Spaceship(id=ship_id, **ship_update.dict())
    db_spaceships[ship_id] = updated_ship.dict()

    return updated_ship
```

- `ship_update: SpaceshipCreate`: Volvemos a usar nuestro modelo para la validaci√≥n de los datos entrantes.
- `HTTPException`: Si no se encuentra una nave con ese `id`, "lanzamos" una excepci√≥n est√°ndar de FastAPI que se convertir√° en una bonita respuesta JSON con el c√≥digo `404`.

---

#### **4. Delete: Salida de √≥rbita (DELETE)**
Para eliminar un recurso, se utiliza el m√©todo `DELETE`. Normalmente, este tipo de endpoint no devuelve un cuerpo de respuesta.

**Implementamos el endpoint `DELETE /spaceships/{ship_id}`:**
```python
# main.py
from fastapi import FastAPI, HTTPException, Response, status # Actualice la importaci√≥n

# ... resto del c√≥digo ...

@app.delete("/spaceships/{ship_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_spaceship(ship_id: int):
    """
    Elimina una nave espacial del registro.
    """
    if ship_id not in db_spaceships:
        raise HTTPException(status_code=404, detail="Nave espacial no encontrada")

    del db_spaceships[ship_id]

    # Devolvemos una respuesta vac√≠a con el estado 204
    return Response(status_code=status.HTTP_204_NO_CONTENT)
```

- `status_code=status.HTTP_204_NO_CONTENT`: Indicamos expl√≠citamente el estado `204 No Content`.
- `del db_spaceships[ship_id]`: Eliminamos la entrada de nuestro diccionario.
- `return Response(...)`: Devolvemos una respuesta vac√≠a, ya que el cliente no necesita datos sobre el objeto eliminado.

---

#### **5. Pruebas del ciclo completo en `/docs`**
Su `uvicorn` deber√≠a haberse recargado.

1.  **Abra `http://127.0.0.1:8000/docs`**. ¬°Ahora tiene un conjunto completo de operaciones CRUD!
2.  **POST:** Expanda el endpoint `POST /spaceships`, haga clic en "Try it out", rellene el cuerpo JSON (por ejemplo, cree "James Webb Telescope") y haga clic en "Execute". Deber√≠a recibir una respuesta `201` con los datos del nuevo telescopio.
3.  **GET:** Ahora ejecute `GET /spaceships`. Su nuevo telescopio deber√≠a aparecer en la lista.
4.  **PUT:** Use el ID del nuevo telescopio para actualizar sus datos a trav√©s de `PUT /spaceships/{ship_id}`. Por ejemplo, cambie su estado.
5.  **DELETE:** Use el mismo ID para eliminar el telescopio a trav√©s de `DELETE /spaceships/{ship_id}`. Deber√≠a recibir una respuesta vac√≠a con el estado `204`.
6.  **Verificaci√≥n:** Ejecute `GET /spaceships` de nuevo para asegurarse de que el telescopio ha sido eliminado de la lista.

---

#### **Cuestionario de repaso**

<style>
    #quiz-container {
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question {
        margin-bottom: 15px;
    }
    .question p {
        font-weight: bold;
        margin-bottom: 10px;
    }
    #quiz-container label {
        display: block;
        margin-bottom: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
    }
    #quiz-container button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    #quiz-container button:hover {
    }
    #quiz-results {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
    }
</style>

<div id="quiz-container">
  <form id="quiz-form">
    <div class="question">
      <p>1. ¬øQu√© m√©todo HTTP se utiliza para crear un nuevo recurso?</p>
      <label><input type="radio" name="q1" value="a"> a) GET</label>
      <label><input type="radio" name="q1" value="b"> b) PUT</label>
      <label><input type="radio" name="q1" value="c"> c) POST</label>
    </div>
    <div class="question">
      <p>2. C√≥digo de estado est√°ndar de √©xito para la operaci√≥n `DELETE`:</p>
      <label><input type="radio" name="q2" value="a"> a) 200 OK</label>
      <label><input type="radio" name="q2" value="b"> b) 204 No Content</label>
      <label><input type="radio" name="q2" value="c"> c) 404 Not Found</label>
    </div>
    <div class="question">
      <p>3. ¬øC√≥mo obtiene FastAPI los datos del cuerpo de una solicitud POST?</p>
      <label><input type="radio" name="q3" value="a"> a) A trav√©s de la variable global `$_POST`</label>
      <label><input type="radio" name="q3" value="b"> b) Autom√°ticamente, si se especifica un modelo Pydantic en el argumento de la funci√≥n</label>
      <label><input type="radio" name="q3" value="c"> c) Se debe leer manualmente el flujo `request.body`</label>
    </div>
    <div class="question">
      <p>4. `raise HTTPException(status_code=404)` se utiliza para:</p>
      <label><input type="radio" name="q4" value="a"> a) Generar un error fatal del servidor (500)</label>
      <label><input type="radio" name="q4" value="b"> b) Devolver una respuesta HTTP correcta con un error al cliente</label>
      <label><input type="radio" name="q4" value="c"> c) Registrar el error en un archivo</label>
    </div>
    <div class="question">
      <p>5. ¬øPor qu√© creamos un modelo `SpaceshipCreate` separado para la creaci√≥n de recursos (`POST`)?</p>
      <label><input type="radio" name="q5" value="a"> a) Porque el objeto que se crea a√∫n no tiene `id`</label>
      <label><input type="radio" name="q5" value="b"> b) Porque FastAPI requiere nombres de modelos diferentes para cada endpoint</label>
      <label><input type="radio" name="q5" value="c"> c) Para acelerar la validaci√≥n</label>
    </div>
    <button type="button" onclick="checkQuizAnswers()">Verificar</button>
  </form>
  <div id="quiz-results" style="display:none;"></div>
</div>

<script>
  function checkQuizAnswers() {
    const correctAnswers = { q1: 'c', q2: 'b', q3: 'b', q4: 'b', q5: 'a' };
    const form = document.getElementById('quiz-form');
    const resultsContainer = document.getElementById('quiz-results');
    let score = 0;
    let resultsHTML = '<h4>Resultados:</h4><ul>';

    for (const [question, correctAnswer] of Object.entries(correctAnswers)) {
      const questionDiv = form.querySelector(`input[name="${question}"]`).closest('.question');
      const labels = questionDiv.querySelectorAll('label');
      labels.forEach(l => {
          l.style.color = 'inherit';
          l.style.fontWeight = 'normal';
          l.style.border = 'none';
      });

      const userAnswer = form.elements[question] ? form.elements[question].value : undefined;
      if (userAnswer) {
        const selectedLabel = form.querySelector(`input[name="${question}"][value="${userAnswer}"]`).parentElement;
        if (userAnswer === correctAnswer) {
          score++;
          selectedLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:green;">¬°Correcto!</span></li>`;
        } else {
          selectedLabel.style.fontWeight = 'bold';
          const correctLabel = form.querySelector(`input[name="${question}"][value="${correctAnswer}"]`).parentElement;
          correctLabel.style.fontWeight = 'bold';
          resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:red;">Incorrecto.</span> Respuesta correcta: <b>${correctAnswer.toUpperCase()}</b></li>`;
        }
      } else {
        resultsHTML += `<li>Pregunta ${question.slice(1)}: <span style="color:orange;">Sin respuesta.</span></li>`;
      }
    }

    resultsHTML += `</ul><p><b>Tu resultado: ${score} de ${Object.keys(correctAnswers).length}</b></p>`;
    resultsContainer.innerHTML = resultsHTML;
    resultsContainer.style.display = 'block';
  }
</script>

---

**üöÄ Resumen del cap√≠tulo:**

¬°Has implementado un ciclo **CRUD** completo y has transformado tu API de un simple "tablero informativo" en un completo **Centro de Control de Flota**!

- ‚úÖ **C**reate: `POST /spaceships` para lanzar nuevas naves.
- ‚úÖ **R**ead: `GET /spaceships` y `GET /spaceships/{id}` para obtener datos.
- ‚úÖ **U**pdate: `PUT /spaceships/{id}` para actualizar misiones.
- ‚úÖ **D**elete: `DELETE /spaceships/{id}` para dar de baja naves.

**¬°Tu flota bajo control total!** En el siguiente cap√≠tulo veremos c√≥mo FastAPI cre√≥ autom√°ticamente para nosotros una detallada "gu√≠a de operaci√≥n": la documentaci√≥n interactiva de Swagger.

> **üìå Verificaci√≥n:**

> - Todos los 5 endpoints (`GET` (2), `POST`, `PUT`, `DELETE`) son visibles y funcionan en `/docs`.
> - Puedes crear, leer, actualizar y eliminar un recurso con √©xito.
> - Al solicitar un ID inexistente, se devuelve un error `404`.

> **‚ö†Ô∏è Si hay errores:**

> - `NameError`: Verifica que has importado `HTTPException`, `Response`, `status`.
> - `KeyError`: Probablemente est√°s intentando acceder a un ID que ya ha sido eliminado.
> - Funcionamiento incorrecto de `PUT` o `POST`: Aseg√∫rate de que est√°s utilizando el modelo Pydantic correcto en el argumento de la funci√≥n (`SpaceshipCreate`).
```
